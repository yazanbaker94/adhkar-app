<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <title>أذكار وأوقات الصلاة</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* AR View Styles */
#arCamera {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
#arCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
}

#kaabaIndicator {
    position: absolute;
    width: 48px;
    height: 48px;
    top: 0;
    left: 0;
    will-change: transform;
    z-index: 100;
    pointer-events: none;
    /* Glow effect */
    filter: drop-shadow(0 0 12px rgba(255, 200, 50, 0.7));
}

#qiblaDegree {
    backdrop-filter: blur(10px);
    font-family: monospace;
    font-weight: bold;
}

/* Fix for iOS Safari */
@supports (-webkit-touch-callout: none) {
    #kaabaIndicator {
        transform: translateZ(0); /* Force hardware acceleration */
    }
}
        /* Fade-in and fade-out transitions */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease;
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-leave {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s ease;
        }
        .fade-leave-active {
            opacity: 0;
            transform: translateY(10px);
        }
        
        /* Prevent text selection during swipe */
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Add a click effect with a scale and fade-out effect */
        .clicked {
            transform: scale(1.1);  /* Slightly enlarge the element */
            opacity: 0.8;           /* Slightly fade the element */
            transition: transform 0.2s ease, opacity 0.2s ease; /* Smooth transition */
        }

        /* Tab styling */
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab.active {
            border-bottom-color: #3B82F6;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body class="bg-gradient-to-b from-gray-100 to-white dark:from-gray-900 dark:to-black text-gray-900 dark:text-white min-h-screen flex flex-col">

    <!-- Header Section -->
    <header class="p-4 text-center text-2xl font-bold bg-gradient-to-r from-green-400 to-blue-500 dark:from-gray-800 dark:to-gray-900 text-white shadow-lg rounded-b-3xl" id="pageTitle">
        أذكار وأوقات الصلاة
    </header>

    <!-- Tab Navigation -->
    <div class="flex justify-center border-b border-gray-200 dark:border-gray-700">
        <div class="tab" data-tab="qibla" id="qibla">qibla</div>

        <div class="tab active" data-tab="adhkar" id="adhkarTab">الأذكار</div>
        <div class="tab" data-tab="prayer" id="prayerTab">أوقات الصلاة</div>
    </div>

    <main class="flex-grow flex items-center justify-center">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 flex justify-center items-center bg-white dark:bg-black z-50">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>

        <!-- Adhkar Tab Content -->
        <div id="qiblaContent" class="tab-content w-full p-4 hidden">
            <!-- AR Viewport -->
            <div class="relative w-full h-[70vh] bg-black rounded-xl overflow-hidden">
                <!-- Camera Feed -->
                <video id="arCamera" autoplay playsinline class="w-full h-full object-cover"></video>
                
                <!-- AR Overlay Canvas -->
                <canvas id="arCanvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                
                <!-- UI Controls -->
                <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4">
                    <button id="flipCameraBtn" class="bg-white/20 text-white p-3 rounded-full">
                        <i class="fas fa-camera-rotate"></i>
                    </button>
                    <div id="qiblaDegree" class="bg-white/20 text-white px-4 py-2 rounded-full">
                        <i class="fas fa-compass mr-2"></i>
                        <span id="degreeValue">0°</span>
                    </div>
                </div>
                
                <!-- Kaaba Indicator -->
                <div id="kaabaIndicator" class="absolute w-12 h-12">
                    <img src="https://cdn-icons-png.flaticon.com/512/7222/7222554.png" alt="Kaaba" class="w-full h-full">
                </div>
            </div>
            
            <!-- Fallback Message -->
            <div id="arUnsupported" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg text-center mt-4">
                <i class="fas fa-triangle-exclamation text-yellow-500 text-3xl mb-3"></i>
                <h3 class="font-bold" id="arErrorTitle">AR Unsupported</h3>
                <p class="mb-4" id="arErrorMessage">Camera AR requires mobile devices with orientation sensors</p>
                <button onclick="initCompassFallback()" class="bg-blue-500 text-white px-6 py-2 rounded-lg">
                    <i class="fas fa-compass mr-2"></i>
                    <span id="fallbackBtnText">Use Basic Compass</span>
                </button>
            </div>
        </div>
        <div id="adhkarContent" class="tab-content active w-full">
            <!-- Main Buttons for Morning/Evening Adhkar -->
            <div id="home" class="space-y-4 text-center">
                <button onclick="loadAdhkar('sabah')" id="btnMorning" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-full shadow transition-transform hover:scale-105">أذكار الصباح</button>
                <button onclick="loadAdhkar('masaa')" id="btnEvening" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-full shadow transition-transform hover:scale-105">أذكار المساء</button>
            </div>

            <!-- Adhkar View Section -->
            <div id="adhkarView" class="hidden max-w-xl p-4 bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 space-y-4 text-center no-select mx-auto">
                <div id="swipeHint" class="text-sm text-gray-400 mb-2">
                    <i class="fas fa-arrows-alt-h mr-1"></i> <span id="swipeHintText">اسحب لليسار أو اليمين للتنقل</span>
                </div>
                <div id="clickHint" class="text-sm text-gray-400 mb-2">
                    <i class="fas fa-hand-pointer mr-1 cursor-pointer"></i> <span id="clickHintText">اضغظ للعد</span>
                </div>
                
                <h2 class="text-xl font-semibold" id="dhikrCounter"></h2>
                <p class="text-2xl leading-loose" id="arabicText"></p>
                <span id="repeatCount" class="text-sm text-gray-500 dark:text-gray-400">
                    <span id="repeatLabel">تكرار</span>: <span id="repeatValue"></span>
                </span>
                <p class="italic" id="transliterationText"></p>
                <p class="text-sm" id="translationText"></p>

                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-4">
                    <button onclick="prevDhikr()" id="btnPrev" class="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-300 px-6 py-3 rounded shadow hover:scale-105 transform transition-all duration-200 font-semibold">السابق</button>
                    <button onclick="nextDhikr()" id="btnNext" class="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-300 px-6 py-3 rounded shadow hover:scale-105 transform transition-all duration-200 font-semibold">التالي</button>            
                </div>

                <!-- Back to Home Button -->
                <button onclick="goHome()" id="btnBack" class="mt-4 text-blue-500 dark:text-blue-300 hover:underline">الرجوع للرئيسية</button>
            </div>
        </div>

        <!-- Prayer Times Tab Content -->
        <div id="prayerContent" class="tab-content w-full max-w-md p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-center mb-4" id="prayerTitle">أوقات الصلاة</h2>
                <p id="azan-location" class="text-center mb-6">جاري تحديد الموقع...</p>
                <ul class="space-y-3">
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-fajr">
                        <span>الفجر:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-dhuhr">
                        <span>الظهر:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-asr">
                        <span>العصر:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-maghrib">
                        <span>المغرب:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-isha">
                        <span>العشاء:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                </ul>
                <button id="btnRefresh" onclick="refreshPrayerTimes()" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg shadow transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
            </div>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="p-4 text-center space-x-2 border-t border-gray-200 dark:border-gray-700 mt-auto">
        <button onclick="switchLanguage()" id="langToggle" class="text-sm text-gray-600 dark:text-gray-300 hover:underline">English</button>
    </footer>

    <script>
        const adhkar = [];
        let current = 0;
        let filteredAdhkar = [];
        let currentLang = 'ar';
        let currentCity = "Amman";
        // AR Qibla Finder
let arActive = false;
let cameraStream = null;
let facingMode = "environment";
let currentHeading = 0;
let qiblaAngle = 0;
let animationFrameId = null;
        // Variables for swipe detection
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50; // Minimum distance to consider as a swipe

        const languages = {
            ar: {
                title: "أذكار وأوقات الصلاة",
                morning: "أذكار الصباح",
                evening: "أذكار المساء",
                previous: "السابق",
                next: "التالي",
                back: "الرجوع للرئيسية",
                langSwitch: "English",
                counter: (i, total) => `الذكر ${i} من ${total}`,
                repeatLabel: "تكرار",
                swipeHint: "اسحب لليسار أو اليمين للتنقل",
                clickHint: "اضغظ للعد",
                prayerTitle: "أوقات الصلاة",
                fajr: "الفجر",
                dhuhr: "الظهر",
                asr: "العصر",
                maghrib: "المغرب",
                isha: "العشاء",
                refresh: "تحديث",
                  adhkarTab: "الأذكار",
        prayerTab: "أوقات الصلاة",
                locationText: (city, timezone) => `المدينة: ${city} | المنطقة الزمنية: ${timezone}`
            },
            en: {
                title: "Adhkar & Prayer Times",
                morning: "Morning Adhkar",
                evening: "Evening Adhkar",
                previous: "Previous",
                next: "Next",
                back: "Back to Home",
                langSwitch: "العربية",
                counter: (i, total) => `Dhikr ${i} of ${total}`,
                repeatLabel: "Repeat",
                swipeHint: "Swipe left or right to navigate",
                clickHint: "Click to Count",
                prayerTitle: "Prayer Times",
                fajr: "Fajr",
                dhuhr: "Dhuhr",
                asr: "Asr",
                maghrib: "Maghrib",
                isha: "Isha",
                refresh: "Refresh",
                 adhkarTab: "Adhkar",
        prayerTab: "Prayer Times",
                locationText: (city, timezone) => `City: ${city} | Timezone: ${timezone}`
            }
        };

        // Add to languages object
languages.ar.arErrorTitle = "الواقع المعزز غير مدعوم";
languages.ar.arErrorMessage = "هذه الميزة تتطلب هاتفاً مزوداً بمستشعرات الحركة";
languages.ar.fallbackBtnText = "استخدام البوصلة الأساسية";

languages.en.arErrorTitle = "AR Unsupported";
languages.en.arErrorMessage = "This feature requires a mobile device with motion sensors";
languages.en.fallbackBtnText = "Use Basic Compass";

async function initARCamera() {
    // Check for required APIs
    if (!('DeviceOrientationEvent' in window) || !navigator.mediaDevices) {
        showARUnsupported();
        return;
    }

    try {
        // Get camera access
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: facingMode,
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });

        const video = document.getElementById('arCamera');
        video.srcObject = cameraStream;

        // Get precise location
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        });

        // Calculate Qibla direction
        qiblaAngle = calculateQiblaAngle(
            position.coords.latitude,
            position.coords.longitude
        );

        // Start AR rendering
        arActive = true;
        window.addEventListener('deviceorientation', handleOrientation);
        startARRenderLoop();

    } catch (error) {
        console.error("AR initialization failed:", error);
        showARUnsupported();
    }
}

function calculateQiblaAngle(lat, lng) {
    // Kaaba coordinates (21.4225° N, 39.8262° E)
    const kaabaLat = 21.422487;
    const kaabaLng = 39.826206;
    
    const φ1 = lat * (Math.PI / 180);
    const φ2 = kaabaLat * (Math.PI / 180);
    const Δλ = (kaabaLng - lng) * (Math.PI / 180);
    
    const y = Math.sin(Δλ);
    const x = (Math.cos(φ1) * Math.tan(φ2)) - (Math.sin(φ1) * Math.cos(Δλ));
    return Math.atan2(y, x) * (180 / Math.PI); // Convert to degrees
}

function handleOrientation(event) {
    if (event.alpha !== null) {
        // Adjust for device orientation
        currentHeading = (360 - event.alpha) % 360;
        updateDegreeDisplay();
    }
}

function updateDegreeDisplay() {
    const relativeAngle = (currentHeading + qiblaAngle + 360) % 360;
    document.getElementById('degreeValue').textContent = `${Math.round(relativeAngle)}°`;
}

function startARRenderLoop() {
    const video = document.getElementById('arCamera');
    const canvas = document.getElementById('arCanvas');
    const ctx = canvas.getContext('2d');
    const kaabaIndicator = document.getElementById('kaabaIndicator');

    function render() {
        if (!arActive) return;
        
        // Ensure video is ready
        if (video.readyState !== 4) {
            animationFrameId = requestAnimationFrame(render);
            return;
        }

        // Match canvas to video display size (not video intrinsic size)
        const displayWidth = video.clientWidth;
        const displayHeight = video.clientHeight;
        canvas.width = displayWidth;
        canvas.height = displayHeight;
        
        // Calculate relative angle (adjusted for device orientation)
        const relativeAngle = (360 - currentHeading + qiblaAngle) % 360;
        const rad = relativeAngle * (Math.PI / 180);
        
        // Calculate position with boundary checks
        const centerX = displayWidth / 2;
        const centerY = displayHeight / 2;
        const radius = Math.min(centerX, centerY) * 0.7; // 70% of screen radius
        
        let kaabaX = centerX + Math.sin(rad) * radius;
        let kaabaY = centerY - Math.cos(rad) * radius;
        
        // Keep indicator within bounds
        kaabaX = Math.max(30, Math.min(displayWidth - 30, kaabaX));
        kaabaY = Math.max(30, Math.min(displayHeight - 30, kaabaY));
        
        // Position Kaaba indicator with smooth transition
        kaabaIndicator.style.transform = `translate(${kaabaX - 24}px, ${kaabaY - 24}px)`;
        kaabaIndicator.style.opacity = '1';
        
        // Clear and redraw AR overlay
        ctx.clearRect(0, 0, displayWidth, displayHeight);
        
        // Draw direction line (only if Kaaba is off-screen)
        if (Math.abs(kaabaX - centerX) > 20 || Math.abs(kaabaY - centerY) > 20) {
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(kaabaX, kaabaY);
            ctx.strokeStyle = 'rgba(255, 50, 50, 0.8)';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Draw arrowhead
            const headLength = 15;
            const angle = Math.atan2(kaabaY - centerY, kaabaX - centerX);
            ctx.beginPath();
            ctx.moveTo(kaabaX, kaabaY);
            ctx.lineTo(
                kaabaX - headLength * Math.cos(angle - Math.PI/6),
                kaabaY - headLength * Math.sin(angle - Math.PI/6)
            );
            ctx.moveTo(kaabaX, kaabaY);
            ctx.lineTo(
                kaabaX - headLength * Math.cos(angle + Math.PI/6),
                kaabaY - headLength * Math.sin(angle + Math.PI/6)
            );
            ctx.strokeStyle = 'rgba(255, 80, 80, 0.9)';
            ctx.lineWidth = 3;
            ctx.stroke();
        }
        
        animationFrameId = requestAnimationFrame(render);
    }
    
    // Initial hide then fade in
    kaabaIndicator.style.opacity = '0';
    kaabaIndicator.style.transition = 'opacity 0.5s, transform 0.2s';
    render();
}

function showARUnsupported() {
    const el = document.getElementById('arUnsupported');
    el.classList.remove('hidden');
    el.querySelector('#arErrorTitle').textContent = languages[currentLang].arErrorTitle;
    el.querySelector('#arErrorMessage').textContent = languages[currentLang].arErrorMessage;
    el.querySelector('#fallbackBtnText').textContent = languages[currentLang].fallbackBtnText;
}

function initCompassFallback() {
    stopARCamera();
    // Implement basic compass version here
}

function stopARCamera() {
    arActive = false;
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
    }
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
    }
    window.removeEventListener('deviceorientation', handleOrientation);
}

// Event Listeners
document.getElementById('flipCameraBtn').addEventListener('click', () => {
    facingMode = facingMode === "user" ? "environment" : "user";
    stopARCamera();
    initARCamera();
});

        // Add this click handler function
        function handleDhikrClick() {
            // Add the 'clicked' class to the element
            const arabicText = document.getElementById('arabicText');
            arabicText.classList.add('clicked');
            
            // Optionally, remove the 'clicked' class after the effect completes
            setTimeout(() => {
                arabicText.classList.remove('clicked');
            }, 300);  // Time to match the animation duration

            if (filteredAdhkar[current].remainingRepeats > 0) {
                filteredAdhkar[current].remainingRepeats--;
                updateRepeatCounter();
            }
        }

        // Add this function to update counter display
        function updateRepeatCounter() {
            document.getElementById('repeatValue').innerText = filteredAdhkar[current].remainingRepeats;
        }

        function switchLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            updateUI();
            displayDhikr();
            updatePrayerTimesUI();
        }

        // Update UI Text Based on Language
        function updateUI() {
            const lang = languages[currentLang];
            document.getElementById('pageTitle').innerText = lang.title;
            document.getElementById('btnMorning').innerText = lang.morning;
            document.getElementById('btnEvening').innerText = lang.evening;
            document.getElementById('btnPrev').innerText = lang.previous;
            document.getElementById('btnNext').innerText = lang.next;
            document.getElementById('btnBack').innerText = lang.back;
            document.getElementById('langToggle').innerText = lang.langSwitch;
            document.getElementById('repeatLabel').innerText = lang.repeatLabel;
            document.getElementById('swipeHintText').innerText = lang.swipeHint;
            document.getElementById('clickHintText').innerText = lang.clickHint;
            document.getElementById('adhkarTab').innerText = lang.adhkarTab;
            document.getElementById('prayerTab').innerText = lang.prayerTab;
    document.getElementById('btnRefresh').innerHTML = `<i class="fas fa-sync-alt mr-2"></i> ${lang.refresh}`;

        }

        function updatePrayerTimesUI() {
            const lang = languages[currentLang];
            document.getElementById('prayerTitle').innerText = lang.prayerTitle;
            document.querySelector('#azan-fajr span:first-child').innerText = lang.fajr + ":";
            document.querySelector('#azan-dhuhr span:first-child').innerText = lang.dhuhr + ":";
            document.querySelector('#azan-asr span:first-child').innerText = lang.asr + ":";
            document.querySelector('#azan-maghrib span:first-child').innerText = lang.maghrib + ":";
            document.querySelector('#azan-isha span:first-child').innerText = lang.isha + ":";
        }

        // Fetch Adhkar Data
        fetch('adhkar.json')
            .then(res => res.json())
            .then(data => {
                adhkar.push(...data);
                document.getElementById('loadingSpinner').classList.add('hidden');
            })
            .catch(err => console.error("Error loading adhkar.json:", err));

        // Modify loadAdhkar function to initialize remainingRepeats
        function loadAdhkar(time) {
            filteredAdhkar = adhkar.filter(d => d.time === time).map(d => ({
                ...d,
                remainingRepeats: d.repeat
            }));
            current = 0;
            document.getElementById('home').classList.add('fade-leave');
            setTimeout(() => {
                document.getElementById('home').classList.add('hidden');
                document.getElementById('adhkarView').classList.remove('hidden', 'fade-leave');
                document.getElementById('adhkarView').classList.add('fade-enter');
                requestAnimationFrame(() => document.getElementById('adhkarView').classList.add('fade-enter-active'));
            }, 300);
            displayDhikr();
        }

        function displayDhikr() {
            if (!filteredAdhkar.length) return;
            const dhikr = filteredAdhkar[current];
            document.getElementById('arabicText').innerText = dhikr.arabic;
            document.getElementById('transliterationText').innerText = dhikr.transliteration;
            document.getElementById('translationText').innerText = dhikr.translation;
            document.getElementById('dhikrCounter').innerText = languages[currentLang].counter(current + 1, filteredAdhkar.length);
            document.getElementById('repeatValue').innerText = dhikr.remainingRepeats;
        }

        // Navigate to Next Dhikr
        function nextDhikr() {
            if (current < filteredAdhkar.length - 1) {
                current++;
                displayDhikr();
            }
        }

        // Navigate to Previous Dhikr
        function prevDhikr() {
            if (current > 0) {
                current--;
                displayDhikr();
            }
        }

        // Go Back to Home
        function goHome() {
            document.getElementById('adhkarView').classList.add('fade-leave');
            setTimeout(() => {
                document.getElementById('adhkarView').classList.add('hidden');
                document.getElementById('home').classList.remove('hidden');
                document.getElementById('home').classList.add('fade-enter');
                requestAnimationFrame(() => document.getElementById('home').classList.add('fade-enter-active'));
            }, 300);
        }
        
        // Swipe detection functions
        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
        }
        
        function handleTouchEnd(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }
        
        function handleSwipe() {
            const diff = touchEndX - touchStartX;
            
            // Check if swipe distance meets the threshold
            if (Math.abs(diff) < swipeThreshold) return;
            
            if (diff > 0) {
                // Swiped right to left (next in RTL)
                nextDhikr();
            } else {
                // Swiped left to right (previous in RTL)
                prevDhikr();
            }
        }

        // Prayer Times Functions
        async function fetchPrayerTimes(city = "Amman") {
            const today = new Date().toISOString().split('T')[0];
            const formattedDate = today.split('-').reverse().join('-');
            const url = `https://api.aladhan.com/v1/timingsByAddress/${formattedDate}?address=${encodeURIComponent(city)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.code === 200) {
                    const timings = data.data.timings;
                    const location = data.data.meta.timezone;

                    document.getElementById("azan-location").innerText = 
                        languages[currentLang].locationText(city, location);
                    
                    document.querySelector("#azan-fajr span:last-child").innerText = timings.Fajr;
                    document.querySelector("#azan-dhuhr span:last-child").innerText = timings.Dhuhr;
                    document.querySelector("#azan-asr span:last-child").innerText = timings.Asr;
                    document.querySelector("#azan-maghrib span:last-child").innerText = timings.Maghrib;
                    document.querySelector("#azan-isha span:last-child").innerText = timings.Isha;
                } else {
                    document.getElementById("azan-location").innerText = "Failed to fetch prayer times.";
                }

            } catch (error) {
                console.error("Error fetching prayer times:", error);
                document.getElementById("azan-location").innerText = "Error fetching prayer times.";
            }
        }

        async function detectCityAndFetchTimes() {
            try {
                const locationRes = await fetch("https://ipapi.co/json/");
                const locationData = await locationRes.json();
                currentCity = locationData.city || "Amman";
                fetchPrayerTimes(currentCity);
            } catch (error) {
                console.error("Could not detect city, falling back to Amman.", error);
                fetchPrayerTimes("Amman");
            }
        }

        function refreshPrayerTimes() {
            fetchPrayerTimes(currentCity);
        }

        // Tab switching functionality
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}Content`).classList.add('active');

                    if (tabId === 'qibla') {
                initARCamera();
            } else {
                stopARCamera();
            }

                });
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            const adhkarView = document.getElementById('adhkarView');
            const arabicText = document.getElementById('arabicText');
            
            if (adhkarView) {
                adhkarView.addEventListener('touchstart', handleTouchStart, false);
                adhkarView.addEventListener('touchend', handleTouchEnd, false);
            }
            
            if (arabicText) {
                arabicText.addEventListener('click', handleDhikrClick);
            }
            
            setupTabs();
            detectCityAndFetchTimes();
        });
    </script>
</body>
</html>