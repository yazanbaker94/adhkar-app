<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <!-- Add iOS-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="أذكار وأوقات الصلاة">
    <link rel="apple-touch-icon" href="icon1.png">
    <link rel="manifest" href="manifest.json">
    <!-- Add favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Reliable Quran fonts from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400&display=swap" rel="stylesheet">
    <title>أذكار وأوقات الصلاة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1a1a',
                            text: '#ffffff',
                            primary: '#3B82F6',
                            secondary: '#4B5563'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .buttonActive {
            color: #f39c12; /* Example color (golden/yellow) */
            transform: scale(1.2); /* Slightly enlarge the element */
            transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        /* Dark mode transitions */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* --- CONSOLIDATED ANIMATIONS START --- */
        @keyframes fadeInSimple {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes quranHookFadeInFromTop {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px); /* Include translateX for centering */
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0); /* Include translateX for centering */
    }
}

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeInFromBottom { /* For toast notifications */
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes fadeOutToBottom { /* For toast notifications */
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }

        @keyframes fadeInFromTop { /* For general UI elements */
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Animation Utility Classes */
        .animate-toast-in {
            animation: fadeInFromBottom 0.3s ease-out forwards;
        }

        .animate-toast-out {
            animation: fadeOutToBottom 0.3s ease-out forwards;
        }

        .animate-general-fade-in {
            animation: fadeInFromTop 0.5s ease-out forwards;
        }
        /* --- CONSOLIDATED ANIMATIONS END --- */

        /* Dark mode specific styles */
        .dark .toast {
            background: rgba(0, 0, 0, 0.9);
        }

        .dark .toast.success {
            background: rgba(34, 197, 94, 0.9);
        }

        .dark .toast.info {
            background: rgba(59, 130, 246, 0.9);
        }

        /* Dark mode for select elements */
        .dark select {
            background-color: #1f2937;
            color: #f3f4f6;
            border-color: #374151;
        }

        .dark select option {
            background-color: #1f2937;
            color: #f3f4f6;
        }

       /* Dark mode for buttons */
               .dark button:not(.bg-blue-500):not(.bg-green-500):not(#langToggle):not(#btnBack):not(.ayah-play-btn):not(#closeTafsirModal):not(#darkModeToggle):not(#closeTranslationModal):not(#closeSurahMenu):not(#selectedSurahText) { /* Added :not(#langToggle) */
            background-color: #374151;
            color: #f3f4f6;
        }

        .dark button:hover:not(.bg-blue-500):not(.bg-green-500):not(#langToggle):not(#btnBack):not(.ayah-play-btn):not(#ayahMenuPlay):not(#ayahMenuTranslation):not(#ayahMenuTafsir):not(#ayahMenuBookmark):not(#closeTafsirModal):not(#darkModeToggle):not(#closeTranslationModal):not(#closeSurahMenu):not(#selectedSurahText){
            background-color: #4b5563;
        }

        /* Dark mode for cards */
        .dark .bg-white {
            background-color: #1f2937;
        }

        /* Dark mode for text */
        .dark .text-gray-600 {
            color: #d1d5db;
        }

        .dark .text-gray-500 {
            color: #9ca3af;
        }

        /* Dark mode for borders */
        .dark .border-gray-200 {
            border-color: #374151;
        }

        /* Dark mode for hover states */
        .dark .hover\\:bg-gray-100:hover {
            background-color: #374151;
        }

        /* Dark mode for shadows */
        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        /* --- COMPONENT STYLES --- */
        
        /* Qibla / AR Styles */
        #compass {
            position: relative;
            width: 16rem;
            height: 16rem;
            animation: fadeInSimple 0.5s ease-in; /* USE CONSOLIDATED */
        }

        #qiblaNeedle {
            transition: transform 0.2s ease-out;
            transform-origin: bottom center;
        }

        #kaabaIndicator {
            position: absolute;
            width: 48px;
            height: 48px;
            top: 0;
            left: 0;
            will-change: transform, opacity;
            z-index: 100;
            pointer-events: none;
            filter: drop-shadow(0 0 12px rgba(255, 200, 50, 0.7));
            transition: transform 0.2s ease-out, opacity 0.3s ease; /* Used 0.3s from a later definition */
        }

        #arUnsupported {
            animation: slideIn 0.3s ease-out; /* USE CONSOLIDATED */
        }

        #arCamera {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #arCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        #qiblaDegree {
            backdrop-filter: blur(10px);
            font-family: monospace;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        #flipCameraBtn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
            transition: all 0.2s ease;
        }

        @supports (-webkit-touch-callout: none) { /* iOS Specific AR fix */
            #kaabaIndicator {
                transform: translateZ(0);
            }
        }

        /* General UI Element Styles */
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .clicked {
            transform: scale(1.03);
            opacity: 0.95;
            transition: transform 0.15s ease-out, opacity 0.15s ease-out;
        }

        /* Tab Navigation */
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab.active {
            border-bottom-color: #3B82F6;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease; /* This handles the show/hide opacity */
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .toast.show {
            opacity: 1;
        }

        .toast i {
            font-size: 1.2em;
        }

        /* Mobile Layout Fixes */
        @media (max-width: 768px) {
            /* Fix header and navigation */
            header {
                padding: 1rem;
                font-size: 1.5rem;
            }

            /* Fix tab navigation */
            .tab { /* This was duplicated, keeping one */
                padding: 0.5rem;
                font-size: 0.9rem;
                white-space: nowrap;
            }

            /* Fix Quran content layout - but NOT the sticky controls */
            /* Selectors like #quranContent .flex.justify-between might need review if #quranContent is used multiple times in HTML */
            /* Assuming #quranContent refers to the main Quran tab content area */
            div#quranContent.tab-content .flex.justify-between:not(.quran-controls-sticky) { /* Made selector more specific and exclude sticky controls */
                flex-direction: column;
                gap: 1rem;
            }

            div#quranContent.tab-content .flex.gap-2:not(.quran-controls-sticky *) { /* Made selector more specific and exclude sticky controls children */
                flex-wrap: wrap;
                justify-content: center;
            }

            /* Fix select dropdowns for iOS */
            select { /* General select styling, might be overridden by more specific rules below */
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 0.5rem center;
                background-size: 1.5em 1.5em;
                padding-right: 2.5rem; /* Ensure this is not overridden by iOS specific below if not intended */
            }

            /* Fix buttons layout */
            /* This selector seems quite generic, ensure it targets the correct element */
            /* For instance, if it's for Quran nav buttons: */
            div#quranContent.tab-content .flex.justify-between.mt-6 { 
                flex-direction: column;
                gap: 1rem;
            }

            div#quranContent.tab-content .flex.justify-between.mt-6 > * {
                width: 100%;
            }

            /* Fix navigation buttons */
            #btnPrevAyah, #btnNextAyah {
                width: 100%;
                margin: 0.5rem 0;
            }

            /* Fix reading mode buttons - but preserve our horizontal layout */
            /* This selector is also generic, assumed to be within Quran controls */
            .quran-controls-sticky .flex.gap-2:not(.flex.items-center.gap-1) {
                justify-content: center;
                width: 100%;
            }

            /* Fix translation toggle */
            #toggleTranslation, #toggleBookmark { /* This might be #toggleTafsir as well? */
                padding: 0.5rem;
            }

            /* Fix surah select container */
            #surahSelect, #translationSelect {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            /* Mobile responsive for horizontal header */
            .quran-controls-sticky {
                margin: -1rem -1rem 1rem -1rem;
                padding: 0.5rem 0.75rem;
                gap: 0.5rem;
                flex-wrap: nowrap !important;
                flex-direction: row !important;
                justify-content: space-between !important;
            }
            
            .quran-controls-sticky > div {
                flex-shrink: 0;
            }
            
            /* Force horizontal layout on mobile */
            .quran-controls-sticky.flex.items-center.justify-between {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
            }
            
            .quran-controls-sticky #selectedSurahText {
                max-width: 80px;
                font-size: 0.75rem;
            }
            
            .quran-controls-sticky button {
                padding: 0.4rem !important;
                font-size: 0.7rem;
            }

            .quran-controls-sticky .flex.items-center.gap-1 {
                gap: 0.125rem;
            }

            .quran-controls-sticky .flex.items-center.gap-1 button {
                padding: 0.4rem 0.5rem !important;
            }
        }

        /* iOS-specific fixes */
        @supports (-webkit-touch-callout: none) {
            select { /* This will override the general select styling on iOS */
                -webkit-appearance: none;
                appearance: none;
                background-color: #fff; /* Specific for iOS light mode */
                border-radius: 0.5rem;
                padding: 0.5rem 2.5rem 0.5rem 0.5rem; /* iOS specific padding */
                font-size: 1rem;
                width: 100%;
                border: 1px solid #e5e7eb;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 0.5rem center; /* RTL might need left */
                background-size: 1.5em 1.5em;
            }

            select:focus {
                outline: none;
                border-color: #3B82F6;
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
            }

            select option { /* iOS option styling */
                padding: 0.5rem;
                font-size: 1rem;
                background-color: #fff; /* Specific for iOS light mode */
            }

            /* Fix for iOS select dropdown */
            select::-ms-expand {
                display: none;
            }

            /* Ensure the select is clickable */
            select:active,
            select:focus {
                -webkit-tap-highlight-color: transparent;
            }

            /* Fix for iOS select text alignment */
            select option { /* This is duplicated, ensure it's intended */
                text-align: right;
                direction: rtl;
            }
        }

        /* Android-specific fixes */
        /* Styles for 'select' on Android if needed, currently basic */
        @supports not (-webkit-touch-callout: none) { /* This targets non-iOS, effectively Android for this context */
            select {
                background-color: #fff; /* Default light mode for Android */
                border-radius: 0.5rem;
                padding: 0.5rem;
                font-size: 1rem;
            }
        }
        
        /* Quran Sticky Controls */
        .quran-controls-sticky {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #fff; /* Default light mode */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            transition: transform 0.3s cubic-bezier(.4,2,.6,1), opacity 0.3s;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .quran-controls-sticky {
            background: #1f2937; /* Dark mode */
            border-bottom-color: #374151;
        }
        .quran-controls-hidden {
          transform: translateY(-120%);
          opacity: 0;
          pointer-events: none;
        }
   


        /* Prayer Time Highlighting */
        .next-prayer-highlight { /* Base for light mode */
            background-color: #e0f2fe !important; 
            border-left: 4px solid #0ea5e9 !important; /* Added !important for consistency */
            font-weight: 600 !important; /* Added !important for consistency */
            color: #0ea5e9 !important; /* Ensuring text color contrasts, added !important */
        }

        .dark .next-prayer-highlight { /* For dark mode */
            background-color: #80c8f7  !important; 
            border-left-color: #0ea5e9 !important; /* Added !important */
            color: #f0f9ff !important; 
        }

        

        /* Reset ALL pseudo-elements from any previous attempts on ANY li inside #prayerContent */
        #prayerContent ul li::before,
        #prayerContent ul li::after {
            content: none !important;
            display: none !important; 
        }

        /* Final Highlight Style for Prayer Item LI */
        #prayerContent ul li.next-prayer-highlight {
            background: #134E4A  !important; /* Light blue highlight for light mode, was #38bdf8 which is dark's */
            /* For light mode, let's use the intended light blue from .next-prayer-highlight */
            /* background-color: #e0f2fe !important; /* Overriding with light mode color */
            /* The above line will be overridden by the 'background' shorthand. Need to be careful. */
            /* Let's ensure the light mode color is correctly applied if not in dark mode. */
            /* This will be handled by the .next-prayer-highlight rule */

            color: #5EEAD4 !important; /* Default text color for highlighted, might need dark mode adjustment if bg is too light */
            border: none !important;             
            box-shadow: none !important;          
        }
        
        /* Correction for light mode highlight if the above uses dark blue always */
        html:not(.dark) #prayerContent ul li.next-prayer-highlight {
             background: #e0f2fe !important; /* Explicit light blue for light mode */
             color: #0ea5e9 !important; /* Text color for light mode highlight */
        }


        /* Child spans within highlighted prayer item */
        #prayerContent ul li.next-prayer-highlight span {
            background: transparent !important;
             /* Text color will inherit from parent LI or can be set specifically */
             /* color: white !important; /* If parent LI has light bg, white text might not be good */
        }
        html:not(.dark) #prayerContent ul li.next-prayer-highlight span {
            color: #0ea5e9 !important; /* Match text color for light mode highlight */
        }
         .dark #prayerContent ul li.next-prayer-highlight span {
            color: #f0f9ff !important; /* Match text color for dark mode highlight */
        }


        /* Ensure pseudo-elements are GONE on highlighted item */
        #prayerContent ul li.next-prayer-highlight::before,
        #prayerContent ul li.next-prayer-highlight::after {
            display: none !important;
            content: "" !important;
            background: transparent !important;
        }

        /* General Fade transitions (often used with JS toggles) */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px); /* This is different from fadeInFromTop */
            transition: all 0.4s ease;
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-leave {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s ease;
        }
        .fade-leave-active {
            opacity: 0;
            transform: translateY(10px);
        }

        /* Enhanced verse styling for better desktop reading */
        .ayah {
            transition: background-color 0.2s ease;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        
        .ayah:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .dark .ayah:hover {
            background-color: rgba(59, 130, 246, 0.2);
        }

        /* Better spacing for desktop reading */
        @media (min-width: 768px) {
            .text-2xl.leading-loose {
                line-height: 2.4 !important;
            }
        }

        /* Improved container for better reading flow */
        .quran-reading-container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        @media (min-width: 768px) {
            .quran-reading-container {
                padding: 3rem 2rem;
            }
        }
        @font-face {
            font-family: 'KFGQPC Uthmanic Script HAFS';
            src: url('https://cdn.jsdelivr.net/gh/quran/quran.com-frontend@master/static/fonts/KFGQPC-Uthmanic-Script-HAFS.woff2') format('woff2'),
                 url('https://cdn.jsdelivr.net/gh/quran/quran.com-frontend@master/static/fonts/KFGQPC-Uthmanic-Script-HAFS.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
    font-family: 'KFGQPC Uthman Taha Naskh';
    src: url('fonts/UtmanTahaNaskh.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}


        .quran-uthmani-font {
    font-family: 'Quran.com Font', Arial, sans-serif;
    font-size: 2rem;
    line-height: 2.5rem;
    letter-spacing: 0.01em;
    font-weight: bold;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
        }

        /* Font Family Options */
        .font-quran-original {
            font-family: 'UthmanicHafs1Ver18', 'Quran.com Font', Arial, sans-serif;
        }
        
        .font-utman-taha {
            font-family: 'KFGQPC Uthman Taha Naskh', 'UtmanTahaNaskh', Arial, sans-serif;
        }
        
        .font-al-mushaf {
            font-family: 'AlMushafQuran', Arial, sans-serif;
        }
        
        .font-system-arabic {
            font-family: Arial, Tahoma, 'Segoe UI', sans-serif;
        }

        /* Settings Menu Overlay */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }


        .ayah {
            display: inline;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .ayah:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .dark .ayah:hover {
            background-color: rgba(96, 165, 250, 0.2);
        }
        .ayah-playing {
            background-color: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        .dark .ayah-playing {
            background-color: rgba(96, 165, 250, 0.3);
            color: #60a5fa;
        }
            .verse-marker {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            cursor: pointer;
            margin: 0 0.25rem;
            vertical-align: middle;
            transition: box-shadow 0.25s, filter 0.25s;
        }
        .verse-marker:hover, .verse-marker:focus {
            z-index: 2;
        }
        .verse-marker:hover .verse-icon, .verse-marker:focus .verse-icon {
            filter: drop-shadow(0 0 8px #3b82f6aa) brightness(1.2);
            transition: filter 0.2s;
        }
        .dark .verse-marker:hover .verse-icon, .dark .verse-marker:focus .verse-icon {
            filter: drop-shadow(0 0 10px #60a5fa) brightness(1.3);
        }
        .verse-icon {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('icons/seperator.svg');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .verse-number {
            position: relative;
            z-index: 1;
            font-size: 0.8rem;
            font-weight: bold;
            color: #2d3748; /* gray-800 */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }
        
        /* Ensure page numbers and UI elements don't inherit Quran font */
        .page-header, .page-header *, .text-blue-700, .text-blue-300 {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }
        
        /* Quran.com exact font - UthmanicHafs1 Ver18 */
        @font-face {
            font-family: 'Quran.com Font';
            src: url('fonts/UthmanicHafs1Ver18.ttf?v=3') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'Quran.com Font';
            src: url('fonts/UthmanicHafs1Ver18.ttf?v=3') format('truetype');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        
        /* Local font fallback */
        @font-face {
            font-family: 'Uthmani Local';
            src: url('fonts/UtmanTahaNaskh.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        .dark .verse-number {
            color: #f7fafc; /* gray-100 */
        }

        /* Ayah Context Menu Popover */
        #ayahMenuPopover {
            display: none;
            position: absolute;
            z-index: 10000;
            min-width: 180px;
            max-width: 260px;
            background-color: #fff;
            border: 0.1px solid #ccc;
            border-radius: 0.375rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 10px;
            transition: opacity 0.3s ease;
            word-break: break-word;
            white-space: normal;
        }

        #ayahMenuPopover button {
            display: block;
            width: 100%;
            padding: 5px 0;
            color: #333;
            border: none;
            background: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-align: inherit;
            white-space: normal;
        }

        #ayahMenuPopover button:hover {
            background-color: #f0f0f0;
        }

        #ayahMenuPopover i {
            margin-right: 10px;
        }

        /* Ayah Context Menu Popover */
        #ayahMenuPopover {
            display: none;
            position: absolute;
            z-index: 10000;
            background-color: #fff;
            border: 0.1px solid #ccc;
            border-radius: 0.375rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 8px;
            transition: opacity 0.3s ease;
        }

        #ayahMenuPopover button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            color: #333;
            border: none;
            background: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border-radius: 4px;
        }

        #ayahMenuPopover button:hover {
            background-color: #f0f0f0;
        }

        .dark #ayahMenuPopover {
            background-color: #374151;
            border-color: #4b5563;
        }

        .dark #ayahMenuPopover button {
            color: #f3f4f6;
        }

        .dark #ayahMenuPopover button:hover {
            background-color: #4b5563;
        }
</style>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">
</head>

<body class="bg-gradient-to-b from-gray-100 to-white dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-300">
    <!-- Remove debug panel -->
    
    <!-- Header Section -->
    <header class="p-4 text-center text-2xl font-bold bg-gradient-to-r from-green-400 to-blue-500 dark:from-gray-800 dark:to-gray-900 text-white shadow-lg rounded-b-3xl flex justify-between items-center">
        <div class="w-8"></div> <!-- Spacer for balance -->
        <div id="pageTitle">أذكار وأوقات الصلاة</div>
        <button id="darkModeToggle" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Toggle Dark Mode - تبديل الوضع الليلي">
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:block"></i>
        </button>
    </header>

    <!-- Ayah Context Menu Popover -->
    <div id="ayahMenuPopover" style="display:none; position:absolute; z-index:10000;" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-2 animate-general-fade-in">
      <div class="flex gap-1">
        <button id="ayahMenuPlay" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Play Ayah"><i class="fas fa-play"></i></button>
        <button id="ayahMenuTranslation" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Show Translation"><i class="fas fa-language"></i></button>
        <button id="ayahMenuTafsir" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Show Tafsir"><i class="fas fa-book-open"></i></button>
        <button id="ayahMenuBookmark" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Bookmark"><i class="far fa-bookmark"></i></button>
      </div>
    </div>

        <!-- Add this script right after the header -->
        <script>
        // Dark mode functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const html = document.documentElement;
            
            // Check for saved theme preference or use system preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Set initial theme
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            
            // Toggle dark mode
            darkModeToggle.addEventListener('click', () => {
                html.classList.toggle('dark');
                const isDark = html.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                // Update toggle button icon
                const moonIcon = darkModeToggle.querySelector('.fa-moon');
                const sunIcon = darkModeToggle.querySelector('.fa-sun');
                if (isDark) {
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                } else {
                    moonIcon.classList.remove('hidden');
                    sunIcon.classList.add('hidden');
                }
            });
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        html.classList.add('dark');
                    } else {
                        html.classList.remove('dark');
                    }
                }
            });
        }

        // Call initDarkMode when the document is loaded
        document.addEventListener('DOMContentLoaded', initDarkMode);
    </script>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg text-right">
  
            <div class="text-center mb-4">
                <i class="fas fa-bell text-3xl text-blue-500 mb-2"></i>
                <h2 class="text-xl font-bold" id="tutorialTitle"></h2>
            </div>
  
            <div id="iosTutorial" class="hidden">
                <ol class="list-decimal list-inside space-y-3" id="iosSteps"></ol>
                <div class="mt-4 text-sm text-gray-500" id="iosNote"></div>
            </div>
  
            <div id="androidTutorial" class="hidden">
                <ol class="list-decimal list-inside space-y-3" id="androidSteps"></ol>
            </div>
  
            <div class="mt-6 flex justify-center">
                <button onclick="closeTutorial()" class="bg-blue-500 text-white px-6 py-2 rounded-lg" id="gotItButton"></button>
            </div>
        </div>
    </div>
  
  

    <!-- Tab Navigation -->
    <div class="flex justify-center border-b border-gray-200 dark:border-gray-700">
        <div class="tab" data-tab="qibla" id="qiblaTab" title="القبلة - Qibla Direction">القبلة</div>
        <div class="tab active" data-tab="adhkar" id="adhkarTab" title="الأذكار - Daily Remembrance">الأذكار</div>
        <div class="tab" data-tab="prayer" id="prayerTab" title="أوقات الصلاة - Prayer Times">أوقات الصلاة</div>
        <div class="tab" data-tab="quran" id="quranTab" title="القرآن - Holy Quran">القرآن</div>
    </div>

    <main class="flex-grow flex items-center justify-center">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 flex justify-center items-center bg-white dark:bg-black z-50">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>

        <!-- Quran Tab Content -->
        <div id="quranContent" class="tab-content w-full max-w-4xl p-4 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">

                <div class="quran-controls-sticky flex items-center justify-between px-4 py-2 mb-6 gap-2 flex-nowrap min-w-0">
                    <!-- Left Section: Controls -->
                    <div class="flex items-center gap-1 flex-shrink-0">
                        <!-- Settings Button -->
                        <button onclick="toggleQuranSettings()" class="bg-gray-100 dark:bg-gray-700 rounded-md p-2 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm flex-shrink-0" id="settingsBtn" title="Quran Settings - إعدادات القرآن">
                            <i class="fas fa-cog w-3 h-3"></i>
                        </button>
                        
                        <!-- Reading Mode Button -->
                        <button onclick="toggleReadingMode()" id="btnReadingMode" class="bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm flex-shrink-0" title="Toggle Reading Mode - تبديل وضع القراءة" disabled>
                            <i class="fas fa-book-open w-3 h-3"></i>
                        </button>
                        </div>

                    <!-- Right Section: Surah Selector -->
                    <div class="flex items-center flex-shrink min-w-0">
                        <button id="surahMenuBtn" class="hover:bg-gray-100 rounded-md px-3 py-2 flex items-center gap-2 text-sm min-w-0 max-w-full transition-colors" title="Select Surah - اختر السورة">
                            <span id="selectedSurahText" class="truncate flex-shrink min-w-0">اختر السورة</span>
                            <i class="fas fa-chevron-down text-xs flex-shrink-0"></i>
                        </button>
                        </div>
                        </div>
                        
                <!-- Quran Settings Side Menu -->
                <div id="quranSettingsMenu" class="fixed inset-y-0 right-0 w-80 bg-white dark:bg-gray-800 shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 hidden">
                    <div class="flex flex-col h-full">
                        <!-- Header -->
                        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold" id="settingsTitle">إعدادات القرآن</h3>
                            <button onclick="toggleQuranSettings()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors">
                                <i class="fas fa-times"></i>
                        </button>
                        </div>

                        <!-- Settings Content -->
                        <div class="flex-1 p-4 space-y-6 overflow-y-auto">
                            <!-- Font Size Settings -->
                            <div>
                                <h4 class="text-md font-medium mb-3 flex items-center gap-2">
                                    <i class="fas fa-text-height text-blue-500"></i>
                                    <span id="fontSizeTitle">حجم الخط</span>
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm" id="currentSizeLabel">حجم الخط الحالي</span>
                                        <span id="currentFontSize" class="text-sm font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">2rem</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="decreaseTextSize()" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 p-2 rounded-md transition-colors" id="decreaseBtn" title="تصغير الخط">
                                            <i class="fas fa-minus text-sm"></i>
                            </button>
                                        <div class="flex-1 mx-2">
                                            <input type="range" id="fontSizeSlider" min="1" max="4" step="0.1" value="2" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                                        </div>
                                        <button onclick="increaseTextSize()" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 p-2 rounded-md transition-colors" id="increaseBtn" title="تكبير الخط">
                                            <i class="fas fa-plus text-sm"></i>
                            </button>
                                    </div>
                                    <button onclick="resetTextSize()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors text-sm" id="resetSizeBtn">
                                        <i class="fas fa-undo mr-2"></i>
                                        <span id="resetSizeText">إعادة تعيين الحجم</span>
                            </button>
                            </div>
                        </div>

                            <!-- Font Family Settings -->
                            <div>
                                <h4 class="text-md font-medium mb-3 flex items-center gap-2">
                                    <i class="fas fa-font text-green-500"></i>
                                    <span id="fontFamilyTitle">نوع الخط</span>
                                </h4>
                                <div class="space-y-2">
                                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                                        <input type="radio" name="fontFamily" value="quran-font" class="mr-3" checked>
                                        <div class="flex-1">
                                            <div class="font-medium" id="font1Name">خط القرآن الأصلي</div>
                                            <div class="text-sm text-gray-500">UthmanicHafs1Ver18</div>
                    </div>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                                        <input type="radio" name="fontFamily" value="utman-taha" class="mr-3">
                                        <div class="flex-1">
                                            <div class="font-medium" id="font2Name">خط عثمان طه</div>
                                            <div class="text-sm text-gray-500">UtmanTahaNaskh</div>
                </div>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                                        <input type="radio" name="fontFamily" value="al-mushaf" class="mr-3">
                                        <div class="flex-1">
                                            <div class="font-medium" id="font3Name">خط المصحف</div>
                                            <div class="text-sm text-gray-500">AlMushafQuran</div>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                                        <input type="radio" name="fontFamily" value="system-arabic" class="mr-3">
                                        <div class="flex-1">
                                            <div class="font-medium" id="font4Name">خط النظام العربي</div>
                                            <div class="text-sm text-gray-500" id="font4Desc">Arial, Tahoma</div>
                                        </div>
                                    </label>
                                </div>
                            </div>



                            <!-- Audio Settings -->
                            <div>
                                <h4 class="text-md font-medium mb-3 flex items-center gap-2">
                                    <i class="fas fa-volume-up text-red-500"></i>
                                    <span id="audioTitle">إعدادات الصوت</span>
                                </h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-2" id="reciterLabel">القارئ</label>
                                        <select id="reciterSelect" class="w-full p-2 border border-gray-200 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800">
                                            <option value="ar.alafasy">مشاري العفاسي</option>
                                            <option value="ar.husary">محمود خليل الحصري</option>
                                            <option value="ar.minshawi">محمد صديق المنشاوي</option>
                                            <option value="ar.sudais">عبد الرحمن السديس</option>
                                            <option value="ar.shuraim">سعود الشريم</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2" id="playbackSpeedLabel">سرعة التشغيل</label>
                                        <select id="playbackSpeedSelect" class="w-full p-2 border border-gray-200 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800">
                                            <option value="0.5" id="speed1">بطيء (0.5x)</option>
                                            <option value="0.75" id="speed2">أبطأ (0.75x)</option>
                                            <option value="1" selected id="speed3">عادي (1x)</option>
                                            <option value="1.25" id="speed4">أسرع (1.25x)</option>
                                            <option value="1.5" id="speed5">سريع (1.5x)</option>
                                        </select>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="quranContent" class="space-y-6">
                    <div class="text-center text-2xl leading-loose quran-uthmani-font" id="arabicText">
                        <div class="text-gray-500 dark:text-gray-400 py-8" id="quranPlaceholder">
                            <i class="fas fa-book-quran text-4xl mb-4"></i>
                            <p class="text-xl">اختر سورة للبدء</p>
                            <p class="text-lg mt-2">Select a Surah to begin</p>
                        </div>
                    </div>
                    <div class="text-center text-lg text-gray-600 dark:text-gray-400" id="translationText"></div>
                </div>
                <div class="flex flex-col md:flex-row justify-between mt-6 gap-4">
                    <button onclick="prevAyah()" id="btnPrevAyah"
                        class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-full shadow transition-all duration-200 font-semibold disabled:bg-gray-300 disabled:text-gray-400 focus:ring-2 focus:ring-blue-400"
                        title="Previous Verse - الآية السابقة" disabled>
                        <i class="fas fa-arrow-left rotate-180"></i>
                        <span>السابق</span>
                    </button>
                    <button onclick="nextAyah()" id="btnNextAyah"
                        class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-full shadow transition-all duration-200 font-semibold disabled:bg-gray-300 disabled:text-gray-400 focus:ring-2 focus:ring-blue-400"
                        title="Next Verse - الآية التالية" disabled>
                        <span>التالي</span>
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Adhkar Tab Content -->
        <div id="qiblaContent" class="tab-content w-full p-4 hidden">
            <!-- AR Viewport -->
            <div class="relative w-full h-[70vh] bg-black rounded-xl overflow-hidden">
                <video id="arCamera" autoplay playsinline class="w-full h-full object-cover"></video>
                <canvas id="arCanvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4">
                    <button id="flipCameraBtn" class="bg-white/20 text-white p-3 rounded-full" title="Flip Camera - تبديل الكاميرا">
                        <i class="fas fa-camera-rotate"></i>
                    </button>
                    <div id="qiblaDegree" class="bg-white/20 text-white px-4 py-2 rounded-full">
                        <i class="fas fa-compass mr-2"></i>
                        <span id="degreeValue">0°</span>
                    </div>
                </div>
                <div id="kaabaIndicator" class="absolute w-12 h-12">
                    <img src="https://cdn-icons-png.flaticon.com/512/7222/7222554.png" alt="Kaaba" class="w-full h-full">
                </div>
            </div>
            <div id="arUnsupported" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg text-center mt-4">
                <i class="fas fa-triangle-exclamation text-yellow-500 text-3xl mb-3"></i>
                <h3 class="font-bold" id="arErrorTitle"></h3>
                <p class="mb-4" id="arErrorMessage"></p>
                <button onclick="initCompassFallback()" class="bg-blue-500 text-white px-6 py-2 rounded-lg">
                    <i class="fas fa-compass mr-2"></i>
                    <span id="fallbackBtnText"></span>
                </button>
            </div>
        </div>
        <div id="adhkarContent" class="tab-content active w-full">
            <!-- Main Buttons for Morning/Evening Adhkar -->
            <div id="home" class="w-full flex flex-col items-center justify-center mt-8">
              <div class="flex flex-row gap-4 justify-center mb-8">
                <button onclick="loadAdhkar('sabah')" id="btnMorning" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-full shadow flex items-center justify-center gap-2" title="Morning Adhkar - أذكار الصباح">
                  <i class="fas fa-sun"></i> <span id="labelMorning"></span>
                </button>
                <button onclick="loadAdhkar('masaa')" id="btnEvening" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-full shadow flex items-center justify-center gap-2" title="Evening Adhkar - أذكار المساء">
                  <i class="fas fa-moon"></i> <span id="labelEvening"></span>
                </button>
                <button id="adhkarMenuBtn" class="bg-gradient-to-br from-teal-400 to-blue-500 text-white rounded-full shadow-xl p-4 hover:from-teal-500 hover:to-blue-600 hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900 focus:ring-blue-400 transition-all duration-200 ease-in-out text-2xl flex items-center justify-center" title="عرض أقسام الأذكار اليومية">
                  <i class="fas fa-bars"></i>
                </button>
              </div>
              <!-- Modal for Adhkar Sections -->
              <div id="adhkarMenuModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 max-w-lg w-full relative animate-general-fade-in border border-gray-200 dark:border-gray-700" style="max-height:90vh; overflow-y:auto;">
                  <button id="closeAdhkarMenu" class="absolute top-3 left-3 text-gray-400 hover:text-red-500 text-2xl focus:outline-none" title="إغلاق القائمة">
                    <i class="fas fa-times"></i>
                  </button>
                  <!-- Daily Routine -->
                  <div>
                    <h3 class="text-lg font-bold mb-4 flex items-center justify-center gap-2">
                      <i class="fas fa-calendar-day text-blue-400"></i>
                      الأذكار اليومية
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 justify-center">
                      <button onclick="closeAdhkarMenuAndLoad('waking_sleeping')" id="btnWakingSleeping" class="bg-blue-100 hover:bg-blue-200 text-blue-900 py-2 px-4 rounded-full shadow-sm border border-blue-200 flex items-center justify-center gap-2 transition-all" title="Waking up & Sleeping Duas">
                        <i class="fas fa-bed"></i> <span id="labelWakingSleeping"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('home')" id="btnHome" class="bg-purple-100 hover:bg-purple-200 text-purple-900 py-2 px-4 rounded-full shadow-sm border border-purple-200 flex items-center justify-center gap-2 transition-all" title="Entering & Leaving Home Duas">
                        <i class="fas fa-home"></i> <span id="labelHome"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('bathroom')" id="btnBathroom" class="bg-pink-100 hover:bg-pink-200 text-pink-900 py-2 px-4 rounded-full shadow-sm border border-pink-200 flex items-center justify-center gap-2 transition-all" title="Entering & Exiting the Bathroom Duas">
                        <i class="fas fa-toilet"></i> <span id="labelBathroom"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('eating')" id="btnEating" class="bg-green-100 hover:bg-green-200 text-green-900 py-2 px-4 rounded-full shadow-sm border border-green-200 flex items-center justify-center gap-2 transition-all" title="Before & After Eating Duas">
                        <i class="fas fa-utensils"></i> <span id="labelEating"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('masjid')" id="btnMasjid" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-900 py-2 px-4 rounded-full shadow-sm border border-indigo-200 flex items-center justify-center gap-2 transition-all" title="Entering & Exiting the Masjid Duas">
                        <i class="fas fa-mosque"></i> <span id="labelMasjid"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('traveling')" id="btnTraveling" class="bg-teal-100 hover:bg-teal-200 text-teal-900 py-2 px-4 rounded-full shadow-sm border border-teal-200 flex items-center justify-center gap-2 transition-all" title="Traveling Duas">
                        <i class="fas fa-car"></i> <span id="labelTraveling"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('clothes')" id="btnClothes" class="bg-gray-100 hover:bg-gray-200 text-gray-900 py-2 px-4 rounded-full shadow-sm border border-gray-200 flex items-center justify-center gap-2 transition-all" title="Wearing Clothes Duas">
                        <i class="fas fa-tshirt"></i> <span id="labelClothes"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('anxiety')" id="btnAnxiety" class="bg-blue-50 hover:bg-blue-100 text-blue-800 py-2 px-4 rounded-full shadow-sm border border-blue-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs for Anxiety, Depression & Sadness">
                        <i class="fas fa-heart-crack"></i> <span id="labelAnxiety"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('hardship')" id="btnHardship" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-800 py-2 px-4 rounded-full shadow-sm border border-indigo-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs in Times of Hardship">
                        <i class="fas fa-mountain"></i> <span id="labelHardship"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('istighfar')" id="btnIstighfar" class="bg-green-50 hover:bg-green-100 text-green-800 py-2 px-4 rounded-full shadow-sm border border-green-100 flex items-center justify-center gap-2 transition-all" title="Seeking Forgiveness (Istighfar)">
                        <i class="fas fa-leaf"></i> <span id="labelIstighfar"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('patience_gratitude')" id="btnPatienceGratitude" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-800 py-2 px-4 rounded-full shadow-sm border border-yellow-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs for Patience & Gratitude">
                        <i class="fas fa-hands-praying"></i> <span id="labelPatienceGratitude"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('rabbana')" id="btnRabbana" class="bg-purple-50 hover:bg-purple-100 text-purple-800 py-2 px-4 rounded-full shadow-sm border border-purple-100 flex items-center justify-center gap-2 transition-all" title="Rabbana Duʿāʾs (from the Qur'an)">
                        <i class="fas fa-book-quran"></i> <span id="labelRabbana"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('prophetic')" id="btnProphetic" class="bg-pink-50 hover:bg-pink-100 text-pink-800 py-2 px-4 rounded-full shadow-sm border border-pink-100 flex items-center justify-center gap-2 transition-all" title="Prophetic Duʿāʾs from Hadith">
                        <i class="fas fa-feather-alt"></i> <span id="labelProphetic"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('prophets')" id="btnProphets" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-800 py-2 px-4 rounded-full shadow-sm border border-indigo-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs of the Prophets">
                        <i class="fas fa-user-friends"></i> <span id="labelProphets"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('rain')" id="btnRain" class="bg-blue-50 hover:bg-blue-100 text-blue-800 py-2 px-4 rounded-full shadow-sm border border-blue-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs for Rain / Drought">
                        <i class="fas fa-cloud-rain"></i> <span id="labelRain"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('patient')" id="btnSick" class="bg-red-50 hover:bg-red-100 text-red-800 py-2 px-4 rounded-full shadow-sm border border-red-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs for the Sick">
                        <i class="fas fa-notes-medical"></i> <span id="labelPatient"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('deceased')" id="btnDeceased" class="bg-gray-50 hover:bg-gray-100 text-gray-800 py-2 px-4 rounded-full shadow-sm border border-gray-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs for the Deceased">
                        <i class="fas fa-dove"></i> <span id="labelDeceased"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('marriage_children_rizq')" id="btnMarriageChildrenRizq" class="bg-green-50 hover:bg-green-100 text-green-800 py-2 px-4 rounded-full shadow-sm border border-green-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs for Marriage, Children, Rizq">
                        <i class="fas fa-baby"></i> <span id="labelMarriageChildrenRizq"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('protection')" id="btnProtection" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-800 py-2 px-4 rounded-full shadow-sm border border-yellow-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs for Protection (Evil Eye, Jinn, Calamity)">
                        <i class="fas fa-shield-alt"></i> <span id="labelProtection"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('salah')" id="btnSalah" class="bg-blue-50 hover:bg-blue-100 text-blue-800 py-2 px-4 rounded-full shadow-sm border border-blue-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾ before and after Salah">
                        <i class="fas fa-pray"></i> <span id="labelSalah"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('sujood_tashahhud')" id="btnSujoodTashahhud" class="bg-orange-50 hover:bg-orange-100 text-orange-800 py-2 px-4 rounded-full shadow-sm border border-orange-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs during Sujood & Tashahhud">
                        <i class="fas fa-hands"></i> <span id="labelSujoodTashahhud"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('qunoot')" id="btnQunoot" class="bg-teal-50 hover:bg-teal-100 text-teal-800 py-2 px-4 rounded-full shadow-sm border border-teal-100 flex items-center justify-center gap-2 transition-all" title="Duʿās for Qunoot (Witr prayer)">
                        <i class="fas fa-moon-stars"></i> <span id="labelQunoot"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('tahajjud')" id="btnTahajjud" class="bg-purple-50 hover:bg-purple-100 text-purple-800 py-2 px-4 rounded-full shadow-sm border border-purple-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs for Tahajjud">
                        <i class="fas fa-star-and-crescent"></i> <span id="labelTahajjud"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('istikhara')" id="btnIstikhara" class="bg-pink-50 hover:bg-pink-100 text-pink-800 py-2 px-4 rounded-full shadow-sm border border-pink-100 flex items-center justify-center gap-2 transition-all" title="Duʿāʾs for Istikhārah (Seeking Guidance)">
                        <i class="fas fa-compass"></i> <span id="labelIstikhara"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('ramadan')" id="btnRamadan" class="bg-green-50 hover:bg-green-100 text-green-800 py-2 px-4 rounded-full shadow-sm border border-green-100 flex items-center justify-center gap-2 transition-all" title="Ramadan Duʿāʾs">
                        <i class="fas fa-calendar-alt"></i> <span id="labelRamadan"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('hajj')" id="btnHajj" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-800 py-2 px-4 rounded-full shadow-sm border border-yellow-100 flex items-center justify-center gap-2 transition-all" title="Dhul Hijjah & Hajj-related Duʿāʾs">
                        <i class="fas fa-kaaba"></i> <span id="labelHajj"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('laylat_al_qadr')" id="btnLaylatAlQadr" class="bg-blue-50 hover:bg-blue-100 text-blue-800 py-2 px-4 rounded-full shadow-sm border border-blue-100 flex items-center justify-center gap-2 transition-all" title="Laylat al-Qadr Duʿāʾs">
                        <i class="fas fa-lightbulb"></i> <span id="labelLaylatAlQadr"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('eid')" id="btnEid" class="bg-pink-50 hover:bg-pink-100 text-pink-800 py-2 px-4 rounded-full shadow-sm border border-pink-100 flex items-center justify-center gap-2 transition-all" title="Eid Duʿāʾs">
                        <i class="fas fa-gift"></i> <span id="labelEid"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('natural_events')" id="btnNaturalEvents" class="bg-gray-50 hover:bg-gray-100 text-gray-800 py-2 px-4 rounded-full shadow-sm border border-gray-100 flex items-center justify-center gap-2 transition-all" title="Rain, Eclipse, Earthquake, etc.">
                        <i class="fas fa-bolt"></i> <span id="labelNaturalEvents"></span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Adhkar View Section -->
            <div id="adhkarView" class="hidden max-w-xl p-4 bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 space-y-4 text-center no-select mx-auto">
                <div id="swipeHint" class="text-sm text-gray-400 mb-2">
                    <i class="fas fa-arrows-alt-h mr-1"></i> <span id="swipeHintText">اسحب لليسار أو اليمين للتنقل</span>
                </div>
                <div id="clickHint" class="text-sm text-gray-400 mb-2">
                    <i class="fas fa-hand-pointer mr-1 cursor-pointer"></i> <span id="clickHintText">اضغظ للعد</span>
                </div>
                
                <h2 class="text-xl font-semibold" id="dhikrCounter"></h2>
                <p class="text-2xl leading-loose" id="adhkarArabicText"></p>
                <span id="repeatCount" class="text-sm text-gray-500 dark:text-gray-400">
                    <span id="repeatLabel">تكرار</span>: <span id="repeatValue"></span>
                </span>
                <p class="italic" id="transliterationText"></p>
                <p class="text-sm" id="translationTextDikr"></p>

                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-4">
                    <button onclick="prevDhikr()" id="btnPrev" class="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-300 px-6 py-3 rounded shadow hover:scale-105 transform transition-all duration-200 font-semibold" title="Previous - السابق">السابق</button>
                    <button onclick="nextDhikr()" id="btnNext" class="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-300 px-6 py-3 rounded shadow hover:scale-105 transform transition-all duration-200 font-semibold" title="Next - التالي">التالي</button>            
                </div>

                <!-- Back to Home Button -->
                <button onclick="goHome()" id="btnBack" class="mt-4 text-blue-500 dark:text-blue-300 hover:underline" title="Back to Home - الرجوع للرئيسية">الرجوع للرئيسية</button>
            </div>
        </div>

        <!-- Prayer Times Tab Content -->
        <div id="prayerContent" class="tab-content w-full max-w-md p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-center mb-4" id="prayerTitle">أوقات الصلاة</h2>
                <p id="azan-location" class="text-center mb-6">جاري تحديد الموقع...</p>
                
                <!-- Add Notification Toggle -->
                <div class="flex items-center justify-between mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <span class="text-sm" id="notificationLabel">إشعارات أوقات الصلاة</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="notificationToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <ul class="space-y-3">
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-fajr">
                        <span>الفجر:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-sunrise">
                        <span>الشروق:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-dhuhr">
                        <span>الظهر:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-asr">
                        <span>العصر:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-maghrib">
                        <span>المغرب:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                    <li class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex justify-between" id="azan-isha">
                        <span>العشاء:</span>
                        <span class="font-medium">--:--</span>
                    </li>
                </ul>
            </div>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="p-4 text-center space-x-2 border-t border-gray-200 dark:border-gray-700 mt-auto">
        <button onclick="switchLanguage()" id="langToggle" 
        class="text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 no-underline hover:no-underline transition-colors dark:bg-transparent" 
        title="Switch Language - تبديل اللغة">English</button>

    </footer>

    <script>
      function toArabicNumerals(num) {
        const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
        return String(num).split('').map(digit => arabicNumerals[digit]).join('');
      }

      const adhkar = [];
      let current = 0;
      let filteredAdhkar = [];
let currentLang = 'ar';
let currentCity = "Amman";

// AR Qibla Finder
      let arActive = false;
      let cameraStream = null;
let facingMode = "environment";
let currentHeading = 0;
      let qiblaAngle = 0;
      let animationFrameId = null;
let smoothedHeading = null;

// Variables for swipe detection
let touchStartX = 0;
let touchEndX = 0;
const swipeThreshold = 50;

      // Add these new variables at the top with other variables
      let notificationEnabled = false;
      let prayerNotifications = {};
      let nextPrayerTimeout = null;

// Add Quran-related variables
let currentSurah = null;
let currentAyah = 0;
let quranData = null;
let translationData = null;
let currentTranslationKey = 'en.sahih'; // Default translation

// English Surah names mapping
const surahNamesEnglish = [
  "Al-Fatihah", "Al-Baqarah", "Aal-E-Imran", "An-Nisa", "Al-Maidah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
  "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Taha",
  "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum",
  "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
  "Fussilat", "Ash-Shuraa", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
  "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah",
  "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij",
  "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "Abasa",
  "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad",
  "Ash-Shams", "Al-Layl", "Ad-Duhaa", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat",
  "Al-Qari'ah", "At-Takathur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr",
  "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
];

// Add these new variables at the top with other variables
let isReadingMode = false;
let isTranslationVisible = true;
let currentBookmark = null;
let readingModeAyahs = [];

// Add these variables at the top with other variables
let isTafsirVisible = false;
let tafsirData = null;

// Add these variables at the top with other variables
let currentAudioSurah = null;
let currentAudioAyah = null;

      const languages = {
          ar: {
              title: "أذكار وأوقات الصلاة",
              morning: "أذكار الصباح",
              evening: "أذكار المساء",
              previous: "السابق",
              next: "التالي",
              back: "الرجوع للرئيسية",
              langSwitch: "English",
              counter: (i, total) => `الذكر ${i} من ${total}`,
              repeatLabel: "تكرار",
              swipeHint: "اسحب لليسار أو اليمين للتنقل",
              clickHint: "اضغط للعد",
              prayerTitle: "أوقات الصلاة",
              fajr: "الفجر",
              dhuhr: "الظهر",
              asr: "العصر",
              maghrib: "المغرب",
              isha: "العشاء",
              refresh: "تحديث",
              adhkarTab: "الأذكار",
              prayerTab: "أوقات الصلاة",
              qiblaTab: "القبلة",
              quranTab: "القرآن",
              quranTitle: "القرآن الكريم",
              selectSurah: "اختر السورة",
              arabic: "العربية",
              english: "English",
              locationText: (city, timezone) => `المدينة: ${city} | المنطقة الزمنية: ${timezone}`,
              arErrorTitle: "الواقع المعزز غير مدعوم",
              arErrorMessage: "هذه الميزة تتطلب هاتفاً مزوداً بمستشعرات الحركة",
              fallbackBtnText: "استخدام البوصلة الأساسية",
              calibrationMessage: "حرك الجهاز على شكل رقم 8 لمعايرة البوصلة",
              calibrationDone: "تم",
              alignedMessage: "موجه نحو القبلة",
              tiltMessage: "أمل جهازك بشكل مسطح",
              notificationPermissionDenied: "يرجى السماح بالإشعارات لتلقي تنبيهات أوقات الصلاة",
              prayerTimeNotification: "حان وقت الصلاة",
              prayerTimeNotificationBody: "حان وقت الصلاة",
              prayerTimeApproaching: "حان وقت الصلاة",
              prayerTimeApproachingBody: "حان وقت صلاة",
              tutorialTitle: "تفعيل الإشعارات",
              tutorialIOS: {
                  title: "تفعيل الإشعارات على iOS",
                  steps: [
                      "اضغط على زر المشاركة (Share) في أسفل المتصفح",
                      "اختر \"إضافة إلى الشاشة الرئيسية\" (Add to Home Screen)",
                      "اضغط \"إضافة\" (Add) في الأعلى",
                      "افتح التطبيق من الشاشة الرئيسية",
                      "قم بتفعيل الإشعارات عندما يطلب منك"
                  ],
                  note: "ملاحظة: يجب أن يكون التطبيق مفتوحاً من الشاشة الرئيسية لتعمل الإشعارات بشكل صحيح"
              },
              tutorialAndroid: {
                  title: "تفعيل الإشعارات على Android",
                  steps: [
                      "اضغط على زر القائمة (ثلاث نقاط) في الأعلى",
                      "اختر \"إضافة إلى الشاشة الرئيسية\" (Add to Home Screen)",
                      "اضغط \"إضافة\" (Add)",
                      "افتح التطبيق من الشاشة الرئيسية",
                      "قم بتفعيل الإشعارات عندما يطلب منك"
                  ]
              },
              gotIt: "فهمت",
              notificationLabel: "إشعارات أوقات الصلاة",
              bookmarkVerse: "اضغط لتعيين علامة مرجعية",
              translationNames: {
                  // English
                  "en.sahih": "الإنجليزية (صحاح)",
                  "en.pickthall": "الإنجليزية (بيكثال)",
                  "en.yusufali": "الإنجليزية (يوسف علي)",
                  "en.hilali": "الإنجليزية (هلالي-خان)",
                  "en.arberry": "الإنجليزية (آربري)",
                  "en.asad": "الإنجليزية (محمد أسد)",
                  "en.daryabadi": "الإنجليزية (داريابادي)",
                  "en.shakir": "الإنجليزية (شاكر)",
                  // French
                  "fr.hamidullah": "الفرنسية (حميد الله)",
                  "fr.leclerc": "الفرنسية (لوكليرك)",
                  // German
                  "de.bubenheim": "الألمانية (بوبنهايم)",
                  "de.khoury": "الألمانية (خوري)",
                  // Spanish
                  "es.cortes": "الإسبانية (كورتيس)",
                  "es.garcia": "الإسبانية (غارسيا)",
                  // Italian
                  "it.piccardo": "الإيطالية (بيكاردو)",
                  // Portuguese
                  "pt.elhayek": "البرتغالية (الحايك)",
                  // Russian
                  "ru.kuliev": "الروسية (كولييف)",
                  "ru.osmanov": "الروسية (عثمانوف)",
                  // Turkish
                  "tr.diyanet": "التركية (ديانت)",
                  "tr.bulac": "التركية (بولاش)",
                  // Urdu
                  "ur.junagarhi": "الأردية (جونا غاري)",
                  "ur.kanzuliman": "الأردية (كنز الإيمان)",
                  // Indonesian
                  "id.indonesian": "الإندونيسية (وزارة الدين)",
                  // Malay
                  "ms.basmeih": "الماليزية (بسميح)",
                  // Dutch
                  "nl.keyzer": "الهولندية (كيزر)",
                  // Bengali
                  "bn.bengali": "البنغالية (محيالدين خان)",
                  // Chinese
                  "zh.jian": "الصينية المبسطة (جيان)",
                  // Japanese
                  "ja.japanese": "اليابانية (ريوتشي موري)",
                  // Korean
                  "ko.korean": "الكورية (حامد تشوي)",
                  // Hindi
                  "hi.hindi": "الهندية (فاروق خان)",
                  // Tamil
                  "ta.tamil": "التاميلية (جان تراست)",
                  // Persian/Farsi
                  "fa.ansarian": "الفارسية (أنصاريان)",
                  "fa.makarem": "الفارسية (مكارم شيرازي)",
                  // Azerbaijani
                  "az.mammadaliyev": "الأذربيجانية (ممد علييف)",
                  // Albanian
                  "sq.ahmeti": "الألبانية (أحمتي)",
                  // Bosnian
                  "bs.korkut": "البوسنية (كوركوت)",
                  // Czech
                  "cs.hrbek": "التشيكية (هربك)",
                  // Norwegian
                  "no.berg": "النرويجية (برغ)",
                  // Swedish
                  "sv.bernstrom": "السويدية (برنستروم)",
                  // Thai
                  "th.thai": "التايلاندية (الملك فهد)",
                  // Kurdish
                  "ku.asan": "الكردية (آسان)",
                  // Hausa
                  "ha.gumi": "الهوسا (أبو بكر غومي)",
                  // Swahili
                  "sw.barwani": "السواحيلية (بارواني)",
                  // Somali
                  "so.abduh": "الصومالية (عبده)",
                  // Amharic
                  "am.sadiq": "الأمهرية (صادق)",
                  // Yoruba
                  "yo.mikail": "اليوروبا (ميكائيل)"
              },
              azkarTypes: {
                sabah: "أذكار الصباح",
                masaa: "أذكار المساء",
                waking_sleeping: "أدعية الاستيقاظ والنوم",
                home: "أدعية دخول وخروج المنزل",
                bathroom: "أدعية دخول وخروج الحمام",
                eating: "أدعية قبل وبعد الأكل",
                masjid: "أدعية دخول وخروج المسجد",
                traveling: "أدعية السفر",
                clothes: "أدعية لبس الثياب",
                anxiety: "أدعية القلق والحزن",
                hardship: "أدعية الشدة",
                istighfar: "أدعية الاستغفار",
                patience_gratitude: "أدعية الصبر والشكر",
                rabbana: "أدعية ربنا",
                prophetic: "أدعية نبوية",
                prophets: "أدعية الأنبياء",
                rain: "أدعية المطر",
                patient: "أدعية المريض",
                deceased: "أدعية المتوفى",
                marriage_children_rizq: "أدعية الزواج والرزق",
                protection: "أدعية الحماية",
                salah: "أدعية الصلاة",
                sujood_tashahhud: "أدعية السجود والتشهد",
                qunoot: "أدعية القنوت",
                tahajjud: "أدعية التهجد",
                istikhara: "دعاء الاستخارة",
                ramadan: "أدعية رمضان",
                hajj: "أدعية الحج",
                laylat_al_qadr: "أدعية ليلة القدر",
                eid: "أدعية العيد",
                natural_events: "أدعية الظواهر الطبيعية"
              },
              sunrise: "الشروق"
          },
          en: {
              title: "Azkar & Prayer Times",
              morning: "Morning Azkar",
              evening: "Evening Azkar",
              previous: "Previous",
              next: "Next",
              back: "Back to Home",
              langSwitch: "العربية",
              counter: (i, total) => `Zikr ${i} of ${total}`,
              repeatLabel: "Repeat",
              swipeHint: "Swipe left or right to navigate",
              clickHint: "Click to Count",
              prayerTitle: "Prayer Times",
              fajr: "Fajr",
              dhuhr: "Dhuhr",
              asr: "Asr",
              maghrib: "Maghrib",
              isha: "Isha",
              refresh: "Refresh",
              adhkarTab: "Azkar",
              prayerTab: "Prayer Times",
              qiblaTab: "Qibla",
              quranTab: "Quran",
              quranTitle: "The Holy Quran",
              selectSurah: "Select Surah",
              arabic: "Arabic",
              english: "English",
              locationText: (city, timezone) => `City: ${city} | Timezone: ${timezone}`,
              arErrorTitle: "AR Unsupported",
              arErrorMessage: "This feature requires a mobile device with motion sensors",
              fallbackBtnText: "Use Basic Compass",
              calibrationMessage: "Move your device in a figure-8 pattern to calibrate the compass",
              calibrationDone: "Done",
              alignedMessage: "Aligned with Qibla",
              tiltMessage: "Hold device flat",
              notificationPermissionDenied: "Please allow notifications to receive prayer time alerts",
              prayerTimeNotification: "Prayer Time",
              prayerTimeNotificationBody: "It's time for prayer",
              prayerTimeApproaching: "Prayer Time",
              prayerTimeApproachingBody: "It's time for",
              tutorialTitle: "Enable Notifications",
              tutorialIOS: {
                  title: "Enable Notifications on iOS",
                  steps: [
                      "Tap the Share button at the bottom of the browser",
                      "Select \"Add to Home Screen\"",
                      "Tap \"Add\" at the top",
                      "Open the app from your home screen",
                      "Enable notifications when prompted"
                  ],
                  note: "Note: The app must be opened from the home screen for notifications to work properly"
              },
              tutorialAndroid: {
                  title: "Enable Notifications on Android",
                  steps: [
                      "Tap the menu button (three dots) at the top",
                      "Select \"Add to Home Screen\"",
                      "Tap \"Add\"",
                      "Open the app from your home screen",
                      "Enable notifications when prompted"
                  ]
              },
              gotIt: "Got it",
              notificationLabel: "Prayer Time Notifications",
              bookmarkVerse: "Click to bookmark this verse",
              translationNames: {
                  // English
                  "en.sahih": "English (Sahih International)",
                  "en.pickthall": "English (Pickthall)",
                  "en.yusufali": "English (Yusuf Ali)",
                  "en.hilali": "English (Hilali-Khan)",
                  "en.arberry": "English (Arberry)",
                  "en.asad": "English (Muhammad Asad)",
                  "en.daryabadi": "English (Daryabadi)",
                  "en.shakir": "English (Shakir)",
                  // French
                  "fr.hamidullah": "Français (Hamidullah)",
                  "fr.leclerc": "Français (Leclerc)",
                  // German
                  "de.bubenheim": "Deutsch (Bubenheim)",
                  "de.khoury": "Deutsch (Khoury)",
                  // Spanish
                  "es.cortes": "Español (Cortés)",
                  "es.garcia": "Español (García)",
                  // Italian
                  "it.piccardo": "Italiano (Piccardo)",
                  // Portuguese
                  "pt.elhayek": "Português (El Hayek)",
                  // Russian
                  "ru.kuliev": "Русский (Кулиев)",
                  "ru.osmanov": "Русский (Османов)",
                  // Turkish
                  "tr.diyanet": "Türkçe (Diyanet)",
                  "tr.bulac": "Türkçe (Bulaç)",
                  // Urdu
                  "ur.junagarhi": "اردو (جونا گاری)",
                  "ur.kanzuliman": "اردو (کنز الایمان)",
                  // Indonesian
                  "id.indonesian": "Bahasa Indonesia (Kementerian Agama)",
                  // Malay
                  "ms.basmeih": "Bahasa Melayu (Basmeih)",
                  // Dutch
                  "nl.keyzer": "Nederlands (Keyzer)",
                  // Bengali
                  "bn.bengali": "বাংলা (মুহিউদ্দীন খান)",
                  // Chinese
                  "zh.jian": "中文简体 (马坚译)",
                  // Japanese
                  "ja.japanese": "日本語 (森亮一)",
                  // Korean
                  "ko.korean": "한국어 (최하메드)",
                  // Hindi
                  "hi.hindi": "हिन्दी (फारूक खान)",
                  // Tamil
                  "ta.tamil": "தமிழ் (ஜான் டிரஸ்ட்)",
                  // Persian/Farsi
                  "fa.ansarian": "فارسی (انصاریان)",
                  "fa.makarem": "فارسی (مکارم شیرازی)",
                  // Azerbaijani
                  "az.mammadaliyev": "Azərbaycan (Məmmədəliyev)",
                  // Albanian
                  "sq.ahmeti": "Shqip (Ahmeti)",
                  // Bosnian
                  "bs.korkut": "Bosanski (Korkut)",
                  // Czech
                  "cs.hrbek": "Čeština (Hrbek)",
                  // Norwegian
                  "no.berg": "Norsk (Berg)",
                  // Swedish
                  "sv.bernstrom": "Svenska (Bernström)",
                  // Thai
                  "th.thai": "ไทย (สำนักงานพระราชวัง)",
                  // Kurdish
                  "ku.asan": "کوردی (ئاسان)",
                  // Hausa
                  "ha.gumi": "Hausa (Abubakar Gumi)",
                  // Swahili
                  "sw.barwani": "Kiswahili (Barwani)",
                  // Somali
                  "so.abduh": "Soomaali (Abduh)",
                  // Amharic
                  "am.sadiq": "አማርኛ (ሳዲቅ)",
                  // Yoruba
                  "yo.mikail": "Yorùbá (Mikail)"
              },
              azkarTypes: {
                sabah: "Morning Azkar",
                masaa: "Evening Azkar",
                waking_sleeping: "Waking & Sleeping Duas",
                home: "Entering & Leaving Home Duas",
                bathroom: "Entering & Exiting Bathroom Duas",
                eating: "Before & After Eating Duas",
                masjid: "Entering & Exiting Masjid Duas",
                traveling: "Traveling Duas",
                clothes: "Wearing Clothes Duas",
                anxiety: "Duas for Anxiety & Sadness",
                hardship: "Duas in Times of Hardship",
                istighfar: "Seeking Forgiveness (Istighfar)",
                patience_gratitude: "Duas for Patience & Gratitude",
                rabbana: "Rabbana Duas (from the Qur'an)",
                prophetic: "Prophetic Duas from Hadith",
                prophets: "Duas of the Prophets",
                rain: "Duas for Rain / Drought",
                patient: "Duas for the Sick",
                deceased: "Duas for the Deceased",
                marriage_children_rizq: "Duas for Marriage, Children, Rizq",
                protection: "Duas for Protection (Evil Eye, Jinn, Calamity)",
                salah: "Duas before and after Salah",
                sujood_tashahhud: "Duas during Sujood & Tashahhud",
                qunoot: "Duas for Qunoot (Witr prayer)",
                tahajjud: "Duas for Tahajjud",
                istikhara: "Dua for Istikhara (Seeking Guidance)",
                ramadan: "Ramadan Duas",
                hajj: "Dhul Hijjah & Hajj-related Duas",
                laylat_al_qadr: "Laylat al-Qadr Duas",
                eid: "Eid Duas",
                natural_events: "Duas for Natural Events (Rain, Eclipse, Earthquake, etc.)"
              },
              sunrise: "Sunrise"
          }
      };


      // Add debug logging to API calls
      async function fetchPrayerTimes(city = "Amman") {
          const today = new Date().toISOString().split('T')[0];
          const formattedDate = today.split('-').reverse().join('-');
          const cacheKey = `prayer-${city}-${formattedDate}`;
          
          const strategies = [
              async () => {
                  const url = `https://api.aladhan.com/v1/timingsByAddress/${formattedDate}?address=${encodeURIComponent(city)}`;
                  const response = await fetch(url);
                  if (!response.ok) throw new Error(`Direct API failed: ${response.status}`);
                  return response.json();
              },
              
              async () => {
                  const cache = await caches.open('api-cache-v1');
                  const cached = await cache.match(`https://api.aladhan.com/v1/timingsByAddress/${formattedDate}?address=${encodeURIComponent(city)}`);
                  if (!cached) throw new Error('No cache available');
                  return cached.json();
              },
              
              async () => {
                  const stored = localStorage.getItem(cacheKey);
                  if (!stored) throw new Error('No localStorage data');
                  return JSON.parse(stored);
              }
          ];

          for (const strategy of strategies) {
              try {
                  const data = await strategy();
                  localStorage.setItem(cacheKey, JSON.stringify(data));
                  
                  if (data.code === 200) {
                      const timings = data.data.timings;
                      const location = data.data.meta.timezone;
                      
                      prayerNotifications = timings;
                      savePrayerTimes(timings, location, city);

                      document.getElementById("azan-location").innerText = languages[currentLang].locationText(city, location);
                      document.querySelector("#azan-fajr span:last-child").innerText = timings.Fajr;
                      document.querySelector("#azan-sunrise span:last-child").innerText = timings.Sunrise;
                      document.querySelector("#azan-dhuhr span:last-child").innerText = timings.Dhuhr;
                      document.querySelector("#azan-asr span:last-child").innerText = timings.Asr;
                      document.querySelector("#azan-maghrib span:last-child").innerText = timings.Maghrib;
                      document.querySelector("#azan-isha span:last-child").innerText = timings.Isha;

                      if (notificationEnabled) {
                          setupPrayerNotifications();
                      }
                      return;
                  }
              } catch (error) {
                  continue;
              }
          }

          document.getElementById("azan-location").innerText = languages[currentLang].arErrorMessage;
          throw new Error('All prayer time fetch strategies failed');
      }

      // Update initARCamera to include debug logging
      async function initARCamera() {
    console.log("Initializing AR Camera...");
          
    // Check if we're on a mobile device
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isLaptop = !isMobile && window.innerWidth > 768;
    console.log("Device type:", isMobile ? "Mobile" : isLaptop ? "Laptop" : "Desktop", "iOS:", isIOS);

    try {
        // Check for device orientation support
        if (!('DeviceOrientationEvent' in window)) {
            console.error("Device orientation not supported");
            if (isLaptop) {
                throw new Error("laptop_mode");
            } else {
                throw new Error("orientation_not_supported");
            }
          }

        // For iOS, request motion permission first
              if (isIOS && typeof DeviceOrientationEvent.requestPermission === 'function') {
            try {
                  const permission = await DeviceOrientationEvent.requestPermission();
                console.log("Motion permission status:", permission);
                  if (permission !== 'granted') {
                    throw new Error("motion_permission_denied");
                }
            } catch (error) {
                console.error("Motion permission error:", error);
                throw new Error("motion_permission_denied");
            }
        }

        // Request camera permission
        console.log("Requesting camera permission...");
        const cameraStream = await navigator.mediaDevices.getUserMedia({
                  video: {
                      facingMode: facingMode,
                width: { ideal: isMobile ? 1280 : 1920 },
                height: { ideal: isMobile ? 720 : 1080 }
            }
        });
        console.log("Camera permission granted");

        // Request location permission
        console.log("Requesting location permission...");
              const position = await new Promise((resolve, reject) => {
                  navigator.geolocation.getCurrentPosition(resolve, reject, {
                      enableHighAccuracy: true,
                      timeout: 10000,
                      maximumAge: 0
                  });
              });
        console.log("Location permission granted");

        // All permissions granted, proceed with initialization
        const video = document.getElementById('arCamera');
        if (!video) {
            throw new Error("video_element_not_found");
        }

        // Set video properties for mobile
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.srcObject = cameraStream;

        // Wait for video to be ready
        await new Promise((resolve) => {
            video.onloadedmetadata = () => {
                video.play().then(resolve).catch(error => {
                    console.error("Error playing video:", error);
                    resolve(); // Continue anyway
                });
            };
        });

        console.log("Location received:", position.coords);
        // Calculate Qibla direction
              qiblaAngle = calculateQiblaAngle(position.coords.latitude, position.coords.longitude);
        console.log("Qibla angle calculated:", qiblaAngle);

        // Start AR rendering
              arActive = true;
              window.addEventListener('deviceorientation', handleOrientation);
              startARRenderLoop();
        console.log("AR initialization complete");

          } catch (error) {
        console.error("AR initialization failed:", error);
        
        // Handle specific error cases
        switch(error.message) {
            case "laptop_mode":
                showARUnsupported("laptop_mode");
                break;
            case "orientation_not_supported":
                showARUnsupported("orientation_not_supported");
                break;
            case "camera_not_supported":
                showARUnsupported("camera_not_supported");
                break;
            case "motion_permission_denied":
                showARUnsupported("motion_permission_denied");
                break;
            case "video_element_not_found":
                showARUnsupported("video_element_not_found");
                break;
            default:
                if (error.name === 'NotAllowedError') {
                    showARUnsupported("permission_denied");
                } else if (error.name === 'NotFoundError') {
                    showARUnsupported("camera_not_found");
                } else if (error.name === 'NotReadableError') {
                    showARUnsupported("camera_not_readable");
                } else if (error.name === 'TimeoutError') {
                    showARUnsupported("location_timeout");
                } else {
                    showARUnsupported("unknown_error");
                }
              }
          }
      }

      function calculateQiblaAngle(lat, lng) {
          const kaabaLat = 21.422487;
          const kaabaLng = 39.826206;

          const φ1 = lat * Math.PI / 180;
          const φ2 = kaabaLat * Math.PI / 180;
          const Δλ = (kaabaLng - lng) * Math.PI / 180;

          const y = Math.sin(Δλ) * Math.cos(φ2);
          const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
          let bearing = Math.atan2(y, x) * 180 / Math.PI;
          return (bearing + 360) % 360;
      }

      function handleOrientation(event) {
          let heading;

          if (typeof event.webkitCompassHeading !== "undefined") {
              // iOS: use the accurate magnetic heading
              heading = event.webkitCompassHeading;
          } else if (typeof event.alpha === "number") {
              // Android: calculate heading from alpha
              heading = 360 - event.alpha;

              // Adjust for screen orientation
              const orientation = window.screen.orientation || window.orientation;
              let screenAngle = 0;

              if (orientation && typeof orientation.angle === "number") {
                  screenAngle = orientation.angle;
              } else if (typeof orientation === "number") {
                  screenAngle = orientation;
              }

              // Adjust heading based on screen orientation
              heading = (heading + screenAngle) % 360;
          } else {
              console.warn("Orientation not supported");
              return;
          }

          // Apply smoothing to reduce jitter
          if (typeof currentHeading === 'undefined') {
              currentHeading = heading;
          } else {
              // Calculate the shortest path to the new heading
              let diff = heading - currentHeading;
              if (diff > 180) diff -= 360;
              if (diff < -180) diff += 360;
              
              // Apply smoothing factor (0.1 = 10% of the difference per update)
              currentHeading = (currentHeading + diff * 0.1 + 360) % 360;
          }

          updateDegreeDisplay();
      }

      function smoothHeading(newHeading) {
          const smoothingFactor = 0.1;
          if (smoothedHeading === null) {
              smoothedHeading = newHeading;
          } else {
              smoothedHeading += smoothingFactor * (newHeading - smoothedHeading);
          }
          return smoothedHeading;
      }

      function updateDegreeDisplay() {
          const relativeAngle = (qiblaAngle - currentHeading + 360) % 360;
          const degreeDisplay = document.getElementById('degreeValue');
          
          // Show alignment message when close to Qibla
          if (Math.abs(relativeAngle) < 5 || Math.abs(relativeAngle - 360) < 5) {
              degreeDisplay.textContent = languages[currentLang].alignedMessage;
              degreeDisplay.parentElement.style.backgroundColor = 'rgba(34, 197, 94, 0.8)'; // Green background
          } else {
              // Round to nearest degree for stability
              const roundedAngle = Math.round(relativeAngle);
              degreeDisplay.textContent = `${roundedAngle}°`;
              degreeDisplay.parentElement.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
          }
      }

      function startARRenderLoop() {
          const video = document.getElementById('arCamera');
          const canvas = document.getElementById('arCanvas');
          const ctx = canvas.getContext('2d');
          const kaabaIndicator = document.getElementById('kaabaIndicator');

          function render() {
              if (!arActive) return;

              if (video.readyState !== 4) {
                  animationFrameId = requestAnimationFrame(render);
                  return;
              }

              const displayWidth = video.clientWidth;
              const displayHeight = video.clientHeight;
              canvas.width = displayWidth;
              canvas.height = displayHeight;

              const relativeAngle = (qiblaAngle - currentHeading + 360) % 360;
              const rad = relativeAngle * Math.PI / 180;

              const centerX = displayWidth / 2;
              const centerY = displayHeight / 2;

              // Clear canvas
              ctx.clearRect(0, 0, displayWidth, displayHeight);

              // Draw center dot (alignment target)
              ctx.beginPath();
              ctx.arc(centerX, centerY, 10, 0, 2 * Math.PI);
              ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
              ctx.fill();

              // Position Kaaba indicator
              const radius = Math.min(centerX, centerY) * 0.5;
              let kaabaX = centerX + Math.sin(rad) * radius;
              let kaabaY = centerY - Math.cos(rad) * radius;

              kaabaX = Math.max(30, Math.min(displayWidth - 30, kaabaX));
              kaabaY = Math.max(30, Math.min(displayHeight - 30, kaabaY));

              // Adjust Kaaba indicator opacity based on alignment
              kaabaIndicator.style.transform = `translate(${kaabaX - 24}px, ${kaabaY - 24}px)`;
              kaabaIndicator.style.opacity = Math.abs(relativeAngle) < 5 || Math.abs(relativeAngle - 360) < 5 ? '0.2' : '1';

              // Draw alignment indicator when close to Qibla
              if (Math.abs(relativeAngle) < 5 || Math.abs(relativeAngle - 360) < 5) {
                  ctx.beginPath();
                  ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
                  ctx.fillStyle = 'rgba(34, 197, 94, 0.8)';
                  ctx.fill();
              }

              animationFrameId = requestAnimationFrame(render);
          }

          kaabaIndicator.style.opacity = '0';
          kaabaIndicator.style.transition = 'opacity 0.5s, transform 0.2s';
          render();
      }

function showARUnsupported(errorType) {
    const qiblaContent = document.getElementById('qiblaContent');
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isLaptop = !isMobile && window.innerWidth > 768;
    const isInStandaloneMode = ('standalone' in navigator) && (navigator.standalone);
    
    let title, message, showFallback = true;
    
    switch(errorType) {
        case "ios_not_standalone":
            title = currentLang === 'ar' ? 'يرجى إضافة التطبيق إلى الشاشة الرئيسية' : 'Please Add to Home Screen';
            message = currentLang === 'ar' 
                ? 'لتفعيل ميزة القبلة، يرجى:\n\n1. اضغط على زر المشاركة (Share) في أسفل المتصفح\n2. اختر "إضافة إلى الشاشة الرئيسية"\n3. افتح التطبيق من الشاشة الرئيسية\n\nملاحظة: يجب إضافة التطبيق إلى الشاشة الرئيسية لتفعيل ميزة القبلة على iOS'
                : 'To enable the Qibla feature, please:\n\n1. Tap the Share button at the bottom of the browser\n2. Select "Add to Home Screen"\n3. Open the app from your home screen\n\nNote: The app must be added to home screen to enable Qibla feature on iOS';
            showFallback = false;
            break;
        case "motion_permission_denied":
            title = currentLang === 'ar' ? 'تم رفض إذن المستشعرات' : 'Motion Sensors Denied';
            message = currentLang === 'ar'
                ? 'يرجى السماح بالوصول إلى مستشعرات الحركة في إعدادات المتصفح:\n\n1. افتح إعدادات جهازك\n2. انتقل إلى Safari > الإعدادات\n3. قم بتفعيل "السماح بالوصول إلى المستشعرات"\n4. أعد تشغيل التطبيق'
                : 'Please allow access to motion sensors in browser settings:\n\n1. Open your device settings\n2. Go to Safari > Settings\n3. Enable "Allow Motion Sensors"\n4. Restart the app';
            break;
        // ... rest of the cases remain the same ...
    }
    
    qiblaContent.innerHTML = `
        <div class="relative w-full h-[70vh] bg-black rounded-xl overflow-hidden">
            <div id="arUnsupported" class="absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-800 p-6 text-center">
                <i class="fas fa-triangle-exclamation text-yellow-500 text-3xl mb-3"></i>
                <h3 class="font-bold text-xl mb-4">${title}</h3>
                <p class="mb-6 whitespace-pre-line">${message}</p>
                ${showFallback ? `
                    <button onclick="initCompassFallback()" class="bg-blue-500 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-compass mr-2"></i>
                        <span>${currentLang === 'ar' ? 'استخدام البوصلة الأساسية' : 'Use Basic Compass'}</span>
                </button>
                ` : ''}
            </div>
        </div>
    `;
      }

      function showCalibrationPrompt() {
          const unsupportedDiv = document.getElementById('arUnsupported');
          unsupportedDiv.classList.remove('hidden');
          unsupportedDiv.innerHTML = `
              <i class="fas fa-exclamation-circle text-yellow-500 text-3xl mb-3"></i>
              <h3 class="font-bold">${languages[currentLang].arErrorTitle}</h3>
              <p class="mb-4">${languages[currentLang].calibrationMessage}</p>
              <button onclick="dismissCalibrationPrompt()" class="bg-blue-500 text-white px-6 py-2 rounded-lg">
                  <i class="fas fa-check mr-2"></i>
                  ${languages[currentLang].calibrationDone}
              </button>
          `;
      }

      function dismissCalibrationPrompt() {
          document.getElementById('arUnsupported').classList.add('hidden');
      }

      function initCompassFallback() {
          stopARCamera();

          const qiblaContent = document.getElementById('qiblaContent');
          qiblaContent.innerHTML = `
              <div class="relative w-full h-[70vh] bg-gray-800 rounded-xl flex items-center justify-center">
                  <div id="compass" class="w-64 h-64 relative">
                      <div class="absolute inset-0 bg-white rounded-full flex items-center justify-center">
                          <i class="fas fa-compass text-6xl text-blue-500"></i>
                      </div>
                      <div id="qiblaNeedle" class="absolute w-4 h-32 bg-green-500 left-1/2 transform -translate-x-1/2 origin-bottom rounded-t-full"></div>
                  </div>
                  <div class="absolute bottom-4 text-white text-lg">
                      <i class="fas fa-compass mr-2"></i>
                      <span id="degreeValue">0°</span>
                  </div>
              </div>
          `;

          arActive = true;
          window.addEventListener('deviceorientation', updateFallbackCompass);

          navigator.geolocation.getCurrentPosition(
              (position) => {
                  qiblaAngle = calculateQiblaAngle(position.coords.latitude, position.coords.longitude);
              },
              () => {
                  qiblaAngle = 0;
                  updateDegreeDisplay();
              },
              { enableHighAccuracy: true, timeout: 10000 }
          );
      }

      function updateFallbackCompass(event) {
          if (!event.alpha && !event.webkitCompassHeading || !arActive) return;

          let heading = event.webkitCompassHeading || event.alpha;

          if (!event.webkitCompassHeading) {
              const orientation = window.screen.orientation?.angle || 0;
              switch (orientation) {
                  case 90:
                      heading = (heading + 270) % 360;
                      break;
                  case 270:
                      heading = (heading + 90) % 360;
                      break;
                  case 180:
                      heading = (360 - heading) % 360;
                      break;
              }
          }

          currentHeading = smoothHeading(heading);
          const relativeAngle = (qiblaAngle - currentHeading + 360) % 360;
          const degreeDisplay = document.getElementById('degreeValue');

          if (Math.abs(relativeAngle) < 5 || Math.abs(relativeAngle - 360) < 5) {
              degreeDisplay.textContent = languages[currentLang].alignedMessage;
              degreeDisplay.parentElement.style.backgroundColor = 'rgba(34, 197, 94, 0.8)';
          } else {
              degreeDisplay.textContent = `${Math.round(relativeAngle)}°`;
              degreeDisplay.parentElement.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
          }

          const needle = document.getElementById('qiblaNeedle');
          needle.style.transform = `translateX(-50%) rotate(${relativeAngle}deg)`;
      }

      function stopARCamera() {
          arActive = false;
          if (animationFrameId) {
              cancelAnimationFrame(animationFrameId);
    }
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
          }
          window.removeEventListener('deviceorientation', handleOrientation);
    window.removeEventListener('deviceorientation', updateFallbackCompass);
      }

      // Event Listeners
      document.getElementById('flipCameraBtn').addEventListener('click', () => {
          facingMode = facingMode === "user" ? "environment" : "user";
          stopARCamera();
          initARCamera();
      });

      function handleDhikrClick() {
    
          const arabicText = document.getElementById('adhkarArabicText');
          arabicText.classList.add('clicked');
          setTimeout(() => arabicText.classList.remove('clicked'), 300);

          if (filteredAdhkar[current].remainingRepeats > 0) {
              filteredAdhkar[current].remainingRepeats--;
              updateRepeatCounter();
          }
      }

      function updateRepeatCounter() {
          document.getElementById('repeatValue').innerText = filteredAdhkar[current].remainingRepeats;
      }

      function switchLanguage() {
          currentLang = currentLang === 'ar' ? 'en' : 'ar';
          tafsirLang = currentLang;
          document.documentElement.lang = currentLang;
          document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
          updateUI();
          updateSettingsLanguage();
          displayDhikr();
          updatePrayerTimesUI();
          
          // Update Surah dropdown with appropriate language names
          updateSurahDropdown();
          
          // Update Quran display if we're in the Quran tab
          if (document.getElementById('quranContent').classList.contains('active')) {
              // Force a refresh of the current display
              if (currentSurah !== null) {
                  if (isReadingMode) {
                      loadReadingModeAyahs();
                  } else {
                      displayAyah();
                  }
              } else {
                  // If no surah is selected, reset the content to update the continue reading section
                  resetQuranContent();
              }
          }
          
          // Update tutorial if it's visible
          const modal = document.getElementById('tutorialModal');
          if (!modal.classList.contains('hidden')) {
              showTutorial();
          }
      }

      function updateUI() {
          const lang = languages[currentLang];
          const elements = {
              'pageTitle': lang.title,
              'btnPrev': lang.previous,
              'btnNext': lang.next,
              'btnBack': lang.back,
              'langToggle': lang.langSwitch,
              'repeatLabel': lang.repeatLabel,
              'swipeHintText': lang.swipeHint,
              'clickHintText': lang.clickHint,
              'adhkarTab': lang.adhkarTab,
              'prayerTab': lang.prayerTab,
              'qiblaTab': lang.qiblaTab,
              'quranTab': lang.quranTab,
              'notificationLabel': lang.notificationLabel,
              'quranTitle': lang.quranTitle,
              'btnPrevAyah': lang.previous,
              'btnNextAyah': lang.next
          };

          // Update each element if it exists
          for (const [id, text] of Object.entries(elements)) {
              const element = document.getElementById(id);
              if (element) {
                  element.innerText = text;
              }
          }

          // Special case for btnRefresh which has an icon
          const btnRefresh = document.getElementById('btnRefresh');
          if (btnRefresh) {
              btnRefresh.innerHTML = `<i class="fas fa-sync-alt mr-2"></i> ${lang.refresh}`;
          }

          // Update surah menu button text
          updateSurahDropdown();
          
          // Update translation select options
          const translationSelect = document.getElementById('translationSelect');
          if (translationSelect) {
          const currentTranslation = translationSelect.value;
          translationSelect.innerHTML = '';
          
              // Add options based on current language - organized by language groups
              const translationOptions = [
                  // English Translations
                  { value: "en.sahih", group: currentLang === 'ar' ? "الإنجليزية" : "English" },
                  { value: "en.pickthall", group: currentLang === 'ar' ? "الإنجليزية" : "English" },
                  { value: "en.yusufali", group: currentLang === 'ar' ? "الإنجليزية" : "English" },
                  { value: "en.hilali", group: currentLang === 'ar' ? "الإنجليزية" : "English" },
                  { value: "en.arberry", group: currentLang === 'ar' ? "الإنجليزية" : "English" },
                  { value: "en.asad", group: currentLang === 'ar' ? "الإنجليزية" : "English" },
                  { value: "en.daryabadi", group: currentLang === 'ar' ? "الإنجليزية" : "English" },
                  { value: "en.shakir", group: currentLang === 'ar' ? "الإنجليزية" : "English" },
                  
                  // European Languages
                  { value: "fr.hamidullah", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "fr.leclerc", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "de.bubenheim", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "de.khoury", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "es.cortes", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "es.garcia", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "it.piccardo", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "pt.elhayek", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "ru.kuliev", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "ru.osmanov", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "nl.keyzer", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "bs.korkut", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "cs.hrbek", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "no.berg", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "sv.bernstrom", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  { value: "sq.ahmeti", group: currentLang === 'ar' ? "الأوروبية" : "European" },
                  
                  // Middle Eastern & Central Asian
                  { value: "tr.diyanet", group: currentLang === 'ar' ? "الشرق الأوسط وآسيا الوسطى" : "Middle East & Central Asia" },
                  { value: "tr.bulac", group: currentLang === 'ar' ? "الشرق الأوسط وآسيا الوسطى" : "Middle East & Central Asia" },
                  { value: "ur.junagarhi", group: currentLang === 'ar' ? "الشرق الأوسط وآسيا الوسطى" : "Middle East & Central Asia" },
                  { value: "ur.kanzuliman", group: currentLang === 'ar' ? "الشرق الأوسط وآسيا الوسطى" : "Middle East & Central Asia" },
                  { value: "fa.ansarian", group: currentLang === 'ar' ? "الشرق الأوسط وآسيا الوسطى" : "Middle East & Central Asia" },
                  { value: "fa.makarem", group: currentLang === 'ar' ? "الشرق الأوسط وآسيا الوسطى" : "Middle East & Central Asia" },
                  { value: "az.mammadaliyev", group: currentLang === 'ar' ? "الشرق الأوسط وآسيا الوسطى" : "Middle East & Central Asia" },
                  { value: "ku.asan", group: currentLang === 'ar' ? "الشرق الأوسط وآسيا الوسطى" : "Middle East & Central Asia" },
                  
                  // South & Southeast Asian
                  { value: "id.indonesian", group: currentLang === 'ar' ? "جنوب وجنوب شرق آسيا" : "South & Southeast Asia" },
                  { value: "ms.basmeih", group: currentLang === 'ar' ? "جنوب وجنوب شرق آسيا" : "South & Southeast Asia" },
                  { value: "bn.bengali", group: currentLang === 'ar' ? "جنوب وجنوب شرق آسيا" : "South & Southeast Asia" },
                  { value: "hi.hindi", group: currentLang === 'ar' ? "جنوب وجنوب شرق آسيا" : "South & Southeast Asia" },
                  { value: "ta.tamil", group: currentLang === 'ar' ? "جنوب وجنوب شرق آسيا" : "South & Southeast Asia" },
                  { value: "th.thai", group: currentLang === 'ar' ? "جنوب وجنوب شرق آسيا" : "South & Southeast Asia" },
                  
                  // East Asian
                  { value: "zh.jian", group: currentLang === 'ar' ? "شرق آسيا" : "East Asia" },
                  { value: "ja.japanese", group: currentLang === 'ar' ? "شرق آسيا" : "East Asia" },
                  { value: "ko.korean", group: currentLang === 'ar' ? "شرق آسيا" : "East Asia" },
                  
                  // African
                  { value: "ha.gumi", group: currentLang === 'ar' ? "الأفريقية" : "African" },
                  { value: "sw.barwani", group: currentLang === 'ar' ? "الأفريقية" : "African" },
                  { value: "so.abduh", group: currentLang === 'ar' ? "الأفريقية" : "African" },
                  { value: "am.sadiq", group: currentLang === 'ar' ? "الأفريقية" : "African" },
                  { value: "yo.mikail", group: currentLang === 'ar' ? "الأفريقية" : "African" }
              ];
              
              // Group translations by region
              const groupedTranslations = {};
              translationOptions.forEach(option => {
                  if (!groupedTranslations[option.group]) {
                      groupedTranslations[option.group] = [];
                  }
                  groupedTranslations[option.group].push(option.value);
              });
              
              // Build the dropdown HTML with optgroups
              let optionsHTML = '';
              Object.keys(groupedTranslations).forEach(groupName => {
                  optionsHTML += `<optgroup label="${groupName}">`;
                  groupedTranslations[groupName].forEach(translationKey => {
                      if (lang.translationNames[translationKey]) {
                          optionsHTML += `<option value="${translationKey}">${lang.translationNames[translationKey]}</option>`;
                      }
                  });
                  optionsHTML += `</optgroup>`;
              });
              
              translationSelect.innerHTML = optionsHTML;

              // Restore the previously selected translation if it exists
              if (currentTranslation) {
                  translationSelect.value = currentTranslation;
              }
          }
      }

      // Add this new function to handle translation changes
      async function handleTranslationChange(selectedTranslation) {
          try {
              console.log("Loading translation:", selectedTranslation);
              const response = await fetch(`https://api.alquran.cloud/v1/quran/${selectedTranslation}`);
              if (!response.ok) throw new Error('Failed to fetch translation');
              const data = await response.json();
              translationData = data.data.surahs;
              
              // Update the display if we're in the Quran tab and have a surah selected
              if (currentSurah !== null) {
                  if (isReadingMode) {
                      loadReadingModeAyahs();
                  } else {
                      displayAyah();
                  }
              }
              
              console.log("Translation loaded successfully");
          } catch (error) {
              console.error('Error loading translation:', error);
              showToast(currentLang === 'ar' ? 'حدث خطأ في تحميل الترجمة' : 'Error loading translation', 'error');
          }
      }

      function updateSurahDropdown() {
          // Update surah menu button text
          const selectedSurahText = document.getElementById('selectedSurahText');
          if (selectedSurahText) {
              if (currentSurah !== null && quranData && quranData[currentSurah]) {
                  const surah = quranData[currentSurah];
                  const surahName = currentLang === 'ar' ? surah.name : surahNamesEnglish[currentSurah];
                  selectedSurahText.textContent = `${surah.number}. ${surahName}`;
              } else {
                  selectedSurahText.textContent = languages[currentLang].selectSurah;
              }
          }
          
          // Update surah menu data and repopulate if menu is open
          if (quranData) {
              surahsData = quranData.map((surah, index) => ({
                  index: index,
                  number: surah.number,
                  name: surah.name,
                  englishName: surahNamesEnglish[index] || surah.englishName,
                  revelationType: surah.revelationType,
                  numberOfAyahs: surah.numberOfAyahs
              }));
              
              // If menu is open, repopulate it
              const surahList = document.getElementById('surahList');
              if (surahList && surahList.children.length > 0) {
                  populateSurahList(surahsData);
              }
          }
      }

      function updatePrayerTimesUI() {
          const lang = languages[currentLang];
    console.log("lang", lang)
          document.getElementById('prayerTitle').innerText = lang.prayerTitle;
          document.querySelector('#azan-fajr span:first-child').innerText = lang.fajr + ":";
          document.querySelector('#azan-sunrise span:first-child').innerText = lang.sunrise + ":";
          document.querySelector('#azan-dhuhr span:first-child').innerText = lang.dhuhr + ":";
          document.querySelector('#azan-asr span:first-child').innerText = lang.asr + ":";
          document.querySelector('#azan-maghrib span:first-child').innerText = lang.maghrib + ":";
          document.querySelector('#azan-isha span:first-child').innerText = lang.isha + ":";
      }

      fetch('adhkar.json')
          .then(res => res.json())
          .then(data => {
              adhkar.push(...data);
              document.getElementById('loadingSpinner').classList.add('hidden');
          })
          .catch(err => console.error("Error loading adhkar.json:", err));

      function loadAdhkar(time) {
          filteredAdhkar = adhkar.filter(d => d.time === time).map(d => ({
              ...d,
              remainingRepeats: d.repeat
          }));
          current = 0;
          document.getElementById('home').classList.add('fade-leave');
          setTimeout(() => {
              document.getElementById('home').classList.add('hidden');
              document.getElementById('adhkarView').classList.remove('hidden', 'fade-leave');
              document.getElementById('adhkarView').classList.add('fade-enter');
              requestAnimationFrame(() => document.getElementById('adhkarView').classList.add('fade-enter-active'));
          }, 300);
          displayDhikr();
          
          // Reset Quran content when loading adhkar
          resetQuranContent();
      }

      function displayDhikr() {
          if (!filteredAdhkar.length) return;
          const dhikr = filteredAdhkar[current];
          console.log("dhikr", dhikr)
          document.getElementById('adhkarArabicText').innerText = dhikr.arabic;
          document.getElementById('transliterationText').innerText = dhikr.transliteration;
          document.getElementById('translationTextDikr').innerText = dhikr.translation;
          document.getElementById('dhikrCounter').innerText = languages[currentLang].counter(current + 1, filteredAdhkar.length);
          document.getElementById('repeatValue').innerText = dhikr.remainingRepeats;
      }

      function nextDhikr() {
          if (current < filteredAdhkar.length - 1) {
              current++;
              displayDhikr();
          }
      }

      function prevDhikr() {
          if (current > 0) {
              current--;
              displayDhikr();
          }
      }

      function goHome() {
          document.getElementById('adhkarView').classList.add('fade-leave');
          setTimeout(() => {
              document.getElementById('adhkarView').classList.add('hidden');
              document.getElementById('home').classList.remove('hidden');
              document.getElementById('home').classList.add('fade-enter');
              requestAnimationFrame(() => document.getElementById('home').classList.add('fade-enter-active'));
          }, 300);
      }

      function handleTouchStart(e) {
          touchStartX = e.changedTouches[0].screenX;
      }

      function handleTouchEnd(e) {
          touchEndX = e.changedTouches[0].screenX;
          handleSwipe();
      }

      function handleSwipe() {
          const diff = touchEndX - touchStartX;
          if (Math.abs(diff) < swipeThreshold) return;
          if (diff > 0) {
              nextDhikr();
          } else {
              prevDhikr();
          }
      }

      // Add these storage helper functions at the top with other variables
      function savePrayerTimes(timings, location, city) {
          const dataToSave = {
              timings: timings,
              location: location,
              city: city,
              lastUpdated: new Date().toISOString() // Store as ISO string for easier parsing
          };
          try {
              localStorage.setItem('prayerTimes', JSON.stringify(dataToSave));
          } catch (error) {
              // Fallback to sessionStorage for iOS private browsing or if localStorage is full
              try {
                  sessionStorage.setItem('prayerTimes', JSON.stringify(dataToSave));
              } catch (sessionError) {
                  console.error('Error saving prayer times to localStorage and sessionStorage:', error, sessionError);
              }
          }
          // Call highlighting function after saving times
          setupPrayerHighlighting();
      }

      function loadPrayerTimes() {
          let savedData = null;
          // ... (existing code to load from localStorage or sessionStorage)
          try {
              const localStorageData = localStorage.getItem('prayerTimes');
              if (localStorageData) {
                  savedData = JSON.parse(localStorageData);
              }
          } catch (error) {
              console.error('Error reading from localStorage:', error);
          }

          if (!savedData && /iPad|iPhone|iPod/.test(navigator.userAgent)) {
              try {
                  const sessionStorageData = sessionStorage.getItem('prayerTimes');
                  if (sessionStorageData) {
                      savedData = JSON.parse(sessionStorageData);
                  }
              } catch (error) {
                  console.error('Error reading from sessionStorage:', error);
              }
          }

          if (savedData) {
              const lastUpdated = new Date(savedData.lastUpdated);
              const now = new Date();
              if (lastUpdated.toDateString() === now.toDateString()) {
                  prayerNotifications = savedData.timings;
                  currentCity = savedData.city;
                  // ... (existing UI updates for prayer times)
                  document.getElementById("azan-location").innerText = languages[currentLang].locationText(savedData.city, savedData.location);
                  document.querySelector("#azan-fajr span:last-child").innerText = savedData.timings.Fajr;
                  document.querySelector("#azan-sunrise span:last-child").innerText = savedData.timings.Sunrise;
                  document.querySelector("#azan-dhuhr span:last-child").innerText = savedData.timings.Dhuhr;
                  document.querySelector("#azan-asr span:last-child").innerText = savedData.timings.Asr;
                  document.querySelector("#azan-maghrib span:last-child").innerText = savedData.timings.Maghrib;
                  document.querySelector("#azan-isha span:last-child").innerText = savedData.timings.Isha;

                  if (notificationEnabled) {
                      setupPrayerNotifications();
                  }
                  // Call highlighting function if times are loaded from storage
                  setupPrayerHighlighting();
                  return true;
              }
          }
          return false;
      }

      // Update the fetchPrayerTimes function
      async function fetchPrayerTimes(city = "Amman") {
          const today = new Date().toISOString().split('T')[0];
          const formattedDate = today.split('-').reverse().join('-');
          const cacheKey = `prayer-${city}-${formattedDate}`;
          
          // Try multiple approaches
          const strategies = [
              // 1. Direct API call
              async () => {
                  const url = `https://api.aladhan.com/v1/timingsByAddress/${formattedDate}?address=${encodeURIComponent(city)}`;
                  const response = await fetch(url);
                  if (!response.ok) throw new Error('Direct API failed');
                  return response.json();
              },
              
              // 2. Service Worker cached version
              async () => {
                  const cache = await caches.open('api-cache-v1');
                  const cached = await cache.match(`https://api.aladhan.com/v1/timingsByAddress/${formattedDate}?address=${encodeURIComponent(city)}`);
                  if (!cached) throw new Error('No cache available');
                  return cached.json();
              },
              
              // 3. localStorage fallback
              async () => {
                  const stored = localStorage.getItem(cacheKey);
                  if (!stored) throw new Error('No localStorage data');
                  return JSON.parse(stored);
              }
          ];

          for (const strategy of strategies) {
              try {
                  const data = await strategy();
                  // Store successful response in localStorage as backup
                  localStorage.setItem(cacheKey, JSON.stringify(data));
                  
                  if (data.code === 200) {
                      const timings = data.data.timings;
                      const location = data.data.meta.timezone;

                      // Store timings for notifications
                      prayerNotifications = timings;
                      
                      // Save to storage
                      savePrayerTimes(timings, location, city);
                      console.log('Prayer times updated and saved:', timings);

                      document.getElementById("azan-location").innerText = languages[currentLang].locationText(city, location);
                      document.querySelector("#azan-fajr span:last-child").innerText = timings.Fajr;
                      document.querySelector("#azan-sunrise span:last-child").innerText = timings.Sunrise;
                      document.querySelector("#azan-dhuhr span:last-child").innerText = timings.Dhuhr;
                      document.querySelector("#azan-asr span:last-child").innerText = timings.Asr;
                      document.querySelector("#azan-maghrib span:last-child").innerText = timings.Maghrib;
                      document.querySelector("#azan-isha span:last-child").innerText = timings.Isha;

                      // Setup notifications if enabled
                      if (notificationEnabled) {
                          console.log('Setting up notifications after prayer times update');
                          setupPrayerNotifications();
                      }
                      // Call highlighting function if times are loaded from storage
                      setupPrayerHighlighting();
                      return;
                  }
              } catch (error) {
                  console.warn(`Strategy failed: ${error.message}`);
                  continue;
              }
          }

          // If all strategies fail, show error message
          document.getElementById("azan-location").innerText = languages[currentLang].arErrorMessage;
          throw new Error('All prayer time fetch strategies failed');
      }

      async function detectCityAndFetchTimes() {
          try {
              const locationRes = await fetch("https://ipapi.co/json/");
              const locationData = await locationRes.json();
              currentCity = locationData.city || "Amman";
              await fetchPrayerTimes(currentCity);
          } catch (error) {
              console.error("Could not detect city, falling back to Amman.", error);
              await fetchPrayerTimes("Amman");
          }
      }

      function setupTabs() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

          const tabs = document.querySelectorAll('.tab');
          tabs.forEach(tab => {
              tab.addEventListener('click', async () => {
                  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                  tab.classList.add('active');
                  const tabId = tab.getAttribute('data-tab');
                  document.getElementById(`${tabId}Content`).classList.add('active');

                  if (tabId === 'qibla') {
                     await initARCamera();
                  } else {
                      await stopARCamera();
                  }

            
            if (tabId === 'prayer' && isIOS) {
                
            } 

                  if (tabId === 'quran') {
                      try {
                          if (!quranData || !translationData) {
                              await loadQuranData();
                          } else {
                              resetQuranContent();
                          }
                      } catch (error) {
                          const arabicText = document.getElementById('arabicText');
                          if (arabicText) {
                              arabicText.innerHTML = `
                                  <div class="text-red-500 dark:text-red-400 py-8">
                                      <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                                      <p class="text-xl">${currentLang === 'ar' ? 'حدث خطأ في تحميل البيانات' : 'Error loading data'}</p>
                                      <p class="text-sm mt-4">${error.message}</p>
                                  </div>
                              `;
                          }
                      }
                  }
              });
          });
      }

      // Update loadQuranData function to include more detailed logging
      async function loadQuranData() {
          try {
              // Try to get cached data first
              let quranJson = null;
              let translationJson = null;
              
              try {
                  const cachedQuran = localStorage.getItem('quranData');
                  const cachedTranslation = localStorage.getItem('translationData');
                  
                  if (cachedQuran) {
                      quranJson = JSON.parse(cachedQuran);
                      console.log('Using cached Quran data');
                  }
                  
                  if (cachedTranslation) {
                      translationJson = JSON.parse(cachedTranslation);
                      console.log('Using cached translation data');
                  }
              } catch (error) {
                  console.error('Error reading from cache:', error);
              }

              // If no cached data, fetch from API
              if (!quranJson) {
                  const quranResponse = await fetch('https://api.alquran.cloud/v1/quran/quran-simple');
                  if (!quranResponse.ok) {
                      throw new Error(`Failed to load Quran data: ${quranResponse.status}`);
                  }
                  quranJson = await quranResponse.json();
                  
                  // Cache the data
                  try {
                      localStorage.setItem('quranData', JSON.stringify(quranJson));
                  } catch (error) {
                      console.error('Error caching Quran data:', error);
                  }
              }

              if (!translationJson) {
                  const translationResponse = await fetch('https://api.alquran.cloud/v1/quran/en.sahih');
                  if (!translationResponse.ok) {
                      throw new Error(`Failed to load translation: ${translationResponse.status}`);
                  }
                  translationJson = await translationResponse.json();
                  
                  // Cache the data
                  try {
                      localStorage.setItem('translationData', JSON.stringify(translationJson));
                  } catch (error) {
                      console.error('Error caching translation data:', error);
                  }
              }

              if (!quranJson.data || !quranJson.data.surahs) {
                  throw new Error('Invalid Quran data format');
              }

              quranData = quranJson.data.surahs;

              // Initialize surah menu data
              initializeSurahMenu();

              if (!translationJson.data || !translationJson.data.surahs) {
                  throw new Error('Invalid translation data format');
              }

              translationData = translationJson.data.surahs;

              currentSurah = null;
              currentAyah = 0;

            //   document.getElementById('btnBookmark').disabled = false;

              let savedBookmark = null;
              console.log("savedBookmark", savedBookmark);
              try {
                  const localStorageBookmark = localStorage.getItem('quranBookmark');
                  if (localStorageBookmark) {
                      savedBookmark = JSON.parse(localStorageBookmark);
                     
                    
                  }
              } catch (error) {
                  console.error('Error reading from localStorage:', error);
              }

              if (!savedBookmark) {
                  try {
                      const sessionStorageBookmark = sessionStorage.getItem('quranBookmark');
                      if (sessionStorageBookmark) {
                          savedBookmark = JSON.parse(sessionStorageBookmark);
                      }
                  } catch (error) {
                      console.error('Error reading from sessionStorage:', error);
                  }
              }

              if (savedBookmark) {
                  currentBookmark = savedBookmark;
                
              } else {
                 
              }

              resetQuranContent();

              // Set initial tafsir state and icon
              isTafsirVisible = false;
         

          } catch (error) {
              console.error('Error loading Quran data:', error);
              showToast(currentLang === 'ar' ? 'حدث خطأ في تحميل البيانات' : 'Error loading data', 'error');
          }
      }

      function resetQuranContent() {
          currentSurah = null;
          currentAyah = 0;
          
          // Update surah menu button text
          const selectedSurahText = document.getElementById('selectedSurahText');
          if (selectedSurahText) {
              selectedSurahText.textContent = languages[currentLang].selectSurah;
          }
          
          let savedBookmark = null;
          
          try {
              const localStorageBookmark = localStorage.getItem('quranBookmark');
              if (localStorageBookmark) {
                  savedBookmark = JSON.parse(localStorageBookmark);
              }
          } catch (error) {
              console.error('Error reading from localStorage:', error);
          }
          
          if (!savedBookmark) {
              try {
                  const sessionStorageBookmark = sessionStorage.getItem('quranBookmark');
                  if (sessionStorageBookmark) {
                      savedBookmark = JSON.parse(sessionStorageBookmark);
                  }
              } catch (error) {
                  console.error('Error reading from sessionStorage:', error);
              }
          }
          
          if (savedBookmark) {
              try {
                  currentBookmark = savedBookmark;
                  
              } catch (error) {
                  try {
                      localStorage.removeItem('quranBookmark');
                      sessionStorage.removeItem('quranBookmark');
                  } catch (storageError) {
                      console.error('Error removing invalid bookmark:', storageError);
                  }
                  currentBookmark = null;
              }
          }
          
          document.getElementById('arabicText').innerHTML = `
              <div class="text-gray-500 dark:text-gray-400 py-8">
                  <i class="fas fa-book-quran text-4xl mb-4"></i>
                  <p class="text-xl">${currentLang === 'ar' ? 'اختر سورة للبدء' : 'Select a Surah to begin'}</p>
                  ${savedBookmark && quranData ? `
                      <div class="mt-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 p-6 max-w-sm mx-auto">
                          <div class="text-center mb-6">
                              <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-50 dark:bg-blue-900/30 rounded-full mb-4">
                                  <i class="fas fa-bookmark text-blue-500 text-2xl"></i>
                              </div>
                              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                                  ${currentLang === 'ar' ? 'متابعة القراءة' : 'Continue Reading'}
                              </h3>
                              <div class="space-y-1">
                                  <p class="text-base font-medium text-gray-800 dark:text-gray-200">
                                      ${quranData[savedBookmark.surah].name}
                                  </p>
                                  <p class="text-sm text-gray-500 dark:text-gray-400">
                                      ${quranData[savedBookmark.surah].englishName}
                                  </p>
                                  <p class="text-sm text-blue-600 dark:text-blue-400 font-medium">
                                      ${currentLang === 'ar' ? 'الآية' : 'Verse'} ${savedBookmark.ayah + 1}
                                  </p>
                              </div>
                          </div>
                          <button onclick="goToBookmark()" class="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white py-3 px-6 rounded-xl font-medium transition-all duration-200 flex items-center justify-center gap-3 shadow-sm hover:shadow-md">
                              <i class="fas fa-play text-lg"></i>
                              <span class="text-lg">${currentLang === 'ar' ? 'متابعة' : 'Continue'}</span>
                          </button>
                          <div class="text-center mt-4">
                              <p class="text-xs text-gray-400 dark:text-gray-500">
                                  ${currentLang === 'ar' ? 'آخر قراءة' : 'Last read'} ${new Date(savedBookmark.timestamp).toLocaleDateString()}
                              </p>
                          </div>
                      </div>
                  ` : ''}
              </div>
          `;
          
          document.getElementById('translationText').innerHTML = '';
          
          document.getElementById('btnPrevAyah').disabled = true;
          document.getElementById('btnNextAyah').disabled = true;
          document.getElementById('btnReadingMode').disabled = true;
      }

      // Add these new functions for notification handling
      async function registerServiceWorker() {
          if ('serviceWorker' in navigator) {
              try {
                  const registration = await navigator.serviceWorker.register('sw.js', {
                      scope: './'
                  });
                  console.log('Service Worker registered with scope:', registration.scope);

                  // For iOS, request background fetch permission
                  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                      try {
                          await registration.periodicSync.register('prayer-times', {
                              minInterval: 15 * 60 * 1000 // 15 minutes
                          });
                          console.log('Periodic sync registered for prayer times');
                      } catch (error) {
                          console.error('Periodic sync registration failed:', error);
                      }
                  }

                  return registration;
              } catch (error) {
                  console.error('Service Worker registration failed:', error);
                  return null;
              }
          }
          return null;
      }

      async function requestNotificationPermission() {
          try {
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              
              // Check if the app is running in standalone mode (added to home screen)
              const isInStandaloneMode = ('standalone' in navigator) && (navigator.standalone);
              
              if (isIOS && !isInStandaloneMode) {
                  // Show instructions for adding to home screen first
                  showTutorial();
                  return false;
              }

              // Check if notifications are supported
              if (!('Notification' in window)) {
                  const notSupportedMessage = currentLang === 'ar'
                      ? 'المتصفح لا يدعم الإشعارات'
                      : 'Notifications are not supported in this browser';
                  alert(notSupportedMessage);
                  return false;
              }
              
              // Request permission
              const permission = await Notification.requestPermission();
              
              if (permission === 'granted') {
                  try {
                      notificationEnabled = true;
                      document.getElementById('notificationToggle').checked = true;
                
                      if (isIOS) {
                          // For iOS, use basic notifications
                          setupBasicNotifications();
                          // Show success message
                          const successMessage = currentLang === 'ar'
                              ? 'تم تفعيل الإشعارات بنجاح'
                              : 'Notifications enabled successfully';
                          alert(successMessage);
                      } else {
                          // For Android, use push notifications
                          const registration = await registerServiceWorker();
                          if (registration) {
                              try {
                                  const subscription = await registration.pushManager.subscribe({
                                      userVisibleOnly: true,
                                      applicationServerKey: 'BOPaG1Jwr89JCSdQ1ejhuPmyKXGVQLQjI2SJfeaYT-LiUjf44KtxCS_JSq-cVxE9O0q7sExLbs2mO4aO0KWPJcc'
                                  });
                                  localStorage.setItem('pushSubscription', JSON.stringify(subscription));
                                  setupPrayerNotifications();
                                  // Show success message
                                  const successMessage = currentLang === 'ar'
                                      ? 'تم تفعيل الإشعارات بنجاح'
                                      : 'Notifications enabled successfully';
                                  alert(successMessage);
                              } catch (error) {
                                  console.error('Push subscription failed:', error);
                                  setupBasicNotifications();
                              }
                          } else {
                              setupBasicNotifications();
                          }
                      }
                      return true;
                  } catch (error) {
                      console.error('Error setting up notifications:', error);
                      notificationEnabled = false;
                      document.getElementById('notificationToggle').checked = false;
                      
                      if (isIOS) {
                          const iosErrorMessage = currentLang === 'ar'
                              ? 'حدث خطأ في تفعيل الإشعارات. يرجى:\n\n1. التأكد من أن التطبيق مفتوح من الشاشة الرئيسية\n2. التأكد من تفعيل الإشعارات في إعدادات Safari\n3. إعادة تشغيل التطبيق'
                              : 'Error enabling notifications. Please:\n\n1. Make sure the app is opened from home screen\n2. Check Safari settings for notifications\n3. Restart the app';
                          alert(iosErrorMessage);
                      } else {
                          const errorMessage = currentLang === 'ar'
                              ? 'حدث خطأ في تفعيل الإشعارات'
                              : 'Error enabling notifications';
                          alert(errorMessage);
                      }
                      return false;
                  }
              } else {
                  notificationEnabled = false;
                  document.getElementById('notificationToggle').checked = false;
                  
                  // Show more detailed message for iOS
                  if (isIOS) {
                      const iosPermissionMessage = currentLang === 'ar'
                          ? 'لتفعيل الإشعارات في iOS:\n\n1. افتح إعدادات جهازك\n2. انتقل إلى Safari > الإعدادات\n3. قم بتفعيل "السماح بالإشعارات"\n4. أعد تشغيل التطبيق'
                          : 'To enable notifications on iOS:\n\n1. Open your device settings\n2. Go to Safari > Settings\n3. Enable "Allow Notifications"\n4. Restart the app';
                      alert(iosPermissionMessage);
                  } else {
                      const permissionDeniedMessage = currentLang === 'ar'
                          ? 'يرجى السماح بالإشعارات في إعدادات المتصفح'
                          : 'Please allow notifications in your browser settings';
                      alert(permissionDeniedMessage);
                  }
                  return false;
              }
          } catch (error) {
              console.error('Error requesting notification permission:', error);
              notificationEnabled = false;
              document.getElementById('notificationToggle').checked = false;
              const errorMessage = currentLang === 'ar'
                  ? 'حدث خطأ أثناء تفعيل الإشعارات'
                  : 'An error occurred while enabling notifications';
              alert(errorMessage);
              return false;
          }
      }

      function setupBasicNotifications() {
          if (!notificationEnabled) {
        alert('Notifications not enabled');
              return;
          }

          // Clear any existing notifications
          if (nextPrayerTimeout) {
              clearTimeout(nextPrayerTimeout);
          }

          const now = new Date();
          const timings = prayerNotifications;
          let nextPrayer = null;
          let nextPrayerTime = null;

          console.log('Current time:', now.toLocaleTimeString());
          console.log('Prayer times:', timings);

          // Find the next prayer time
          for (const [prayer, time] of Object.entries(timings)) {
              const prayerTime = new Date(`${now.toDateString()} ${time}`);
              console.log(`Checking ${prayer}: ${prayerTime.toLocaleTimeString()}`);
              
              if (prayerTime > now) {
                  if (!nextPrayerTime || prayerTime < nextPrayerTime) {
                      nextPrayer = prayer;
                      nextPrayerTime = prayerTime;
                  }
              }
          }

          if (nextPrayer && nextPrayerTime) {
              const timeUntilNext = nextPrayerTime - now;
              console.log('Next prayer:', nextPrayer, 'at', nextPrayerTime.toLocaleTimeString());
              
        // Schedule notification at prayer time
        console.log('Time until notification:', Math.floor(timeUntilNext / 60000), 'minutes');
              
        if (timeUntilNext > 0) {
            console.log('Setting up notification for:', nextPrayerTime.toLocaleTimeString());
                  
                  // For iOS in standalone mode, use background fetch
                  if (/iPad|iPhone|iPod/.test(navigator.userAgent) && ('standalone' in navigator) && (navigator.standalone)) {
                      // Schedule a background fetch
                      if ('serviceWorker' in navigator) {
                          navigator.serviceWorker.ready.then(registration => {
                              registration.backgroundFetch.fetch('prayer-notification', ['adhan.mp3'], {
                                  title: languages[currentLang].prayerTimeNotification,
                                  icons: [{
                                      sizes: '192x192',
                                      src: 'icon1.png',
                                      type: 'image/png',
                                  }],
                                  downloadTotal: 1,
                              });
                          });
                      }
                  } else {
                      // For Android or iOS not in standalone mode, use setTimeout
                      nextPrayerTimeout = setTimeout(() => {
                          console.log('Notification timeout triggered');
                          showBasicNotification(nextPrayer);
                }, timeUntilNext);
                  }
              } else {
                  console.log('Notification time has already passed');
              }
          } else {
              console.log('No upcoming prayer times found');
          }
      }

      function showBasicNotification(prayer) {
          if (!notificationEnabled) return;

          const prayerNames = {
              'Fajr': currentLang === 'ar' ? 'الفجر' : 'Fajr',
              'Dhuhr': currentLang === 'ar' ? 'الظهر' : 'Dhuhr',
              'Asr': currentLang === 'ar' ? 'العصر' : 'Asr',
              'Maghrib': currentLang === 'ar' ? 'المغرب' : 'Maghrib',
              'Isha': currentLang === 'ar' ? 'العشاء' : 'Isha'
          };

          try {
              const notification = new Notification(languages[currentLang].prayerTimeNotification, {
                  body: `${prayerNames[prayer]} ${languages[currentLang].prayerTimeApproachingBody}`,
                  icon: 'icon1.png',
                  badge: 'icon1.png',
                  requireInteraction: true,
                  silent: false
              });

              // Play adhan sound
              const audio = new Audio('adhan.mp3');
              audio.play().catch(error => console.error('Error playing adhan:', error));

              // Setup next notification
              setupBasicNotifications();
          } catch (error) {
              console.error('Error showing notification:', error);
              // Fallback to alert for iOS
              if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                  alert(`${prayerNames[prayer]} ${languages[currentLang].prayerTimeApproachingBody}`);
                  const audio = new Audio('adhan.mp3');
                  audio.play().catch(error => console.error('Error playing adhan:', error));
              }
          }
      }

      async function setupPrayerNotifications() {
          if (!notificationEnabled) return;

          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isInStandaloneMode = ('standalone' in navigator) && (navigator.standalone);

          // For iOS in standalone mode, use background fetch
          if (isIOS && isInStandaloneMode) {
              try {
                  const registration = await navigator.serviceWorker.ready;
                  await registration.periodicSync.register('prayer-times', {
                      minInterval: 15 * 60 * 1000 // 15 minutes
                  });
                  console.log('Periodic sync registered for prayer times');
              } catch (error) {
                  console.error('Periodic sync registration failed:', error);
                  // Fallback to basic notifications
                  setupBasicNotifications();
              }
          } else {
              // For Android or iOS not in standalone mode, use basic notifications
              setupBasicNotifications();
          }
      }

      // Add periodic check for prayer times
      function setupPeriodicChecks() {
          // Check prayer times every hour
          setInterval(() => {
              console.log('Running periodic prayer times check');
              fetchPrayerTimes(currentCity);
          }, 60 * 60 * 1000); // Every hour
      }

      // Add these functions to handle the tutorial
      function showTutorial() {
          // Basic iOS detection
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isInStandaloneMode = window.navigator.standalone === true;
          
          console.log('Showing tutorial for:', {
              isIOS,
              isInStandaloneMode,
              userAgent: navigator.userAgent
          });

          
          const modal = document.getElementById('tutorialModal');
          const iosTutorial = document.getElementById('iosTutorial');
          const androidTutorial = document.getElementById('androidTutorial');
          const title = document.getElementById('tutorialTitle');
          const gotItButton = document.getElementById('gotItButton');
          const iosSteps = document.getElementById('iosSteps');
          const androidSteps = document.getElementById('androidSteps');
          const iosNote = document.getElementById('iosNote');

          // Set language-specific content
          const lang = languages[currentLang];
          title.textContent = lang.tutorialTitle;
          gotItButton.textContent = lang.gotIt;

          // Set text alignment based on language
          const textAlignment = currentLang === 'ar' ? 'text-right' : 'text-left';
          iosSteps.className = `list-decimal list-inside space-y-3 ${textAlignment}`;
          androidSteps.className = `list-decimal list-inside space-y-3 ${textAlignment}`;
          iosNote.className = `mt-4 text-sm text-gray-500 ${textAlignment}`;

          // Set iOS tutorial content
          if (isIOS) {
              iosTutorial.classList.remove('hidden');
              androidTutorial.classList.add('hidden');
              
              // Clear previous steps
              iosSteps.innerHTML = '';
              
              // Add new steps
              lang.tutorialIOS.steps.forEach(step => {
                  const li = document.createElement('li');
                  li.textContent = step;
                  iosSteps.appendChild(li);
              });
              
              // Add note
              iosNote.textContent = lang.tutorialIOS.note;
          } else {
              // Set Android tutorial content
              iosTutorial.classList.add('hidden');
              androidTutorial.classList.remove('hidden');
              
              // Clear previous steps
              androidSteps.innerHTML = '';
              
              // Add new steps
              lang.tutorialAndroid.steps.forEach(step => {
                  const li = document.createElement('li');
                  li.textContent = step;
                  androidSteps.appendChild(li);
              });
          }

          // Show modal with iOS-specific handling
          modal.style.display = 'flex';
          modal.classList.remove('hidden');
          
          // Force a reflow to ensure the modal is visible
          modal.offsetHeight;
          
          // Add a small delay for iOS
          if (isIOS) {
              setTimeout(() => {
                  modal.style.opacity = '1';
              }, 50);
          } else {
              modal.style.opacity = '1';
          }
      }

      function closeTutorial() {
          const modal = document.getElementById('tutorialModal');
          modal.style.opacity = '0';
          
          // Wait for fade out animation
          setTimeout(() => {
              modal.style.display = 'none';
              modal.classList.add('hidden');
          }, 300);
      }

      // Add tafsir cache object at the top
      let tafsirCache = {};
      let currentTafsirSource = '2'; // Default tafsir source (Jalalayn ID)

      // Tafsir source mapping - mixing both APIs for comprehensive coverage
      const tafsirSources = {
        // Arabic tafsir from quran-tafseer.com API
        '1': { id: 1, name: 'التفسير الميسر', language: 'ar', api: 'quran-tafseer' },
        '2': { id: 2, name: 'تفسير الجلالين', language: 'ar', api: 'quran-tafseer' },
        '3': { id: 3, name: 'تفسير السعدي', language: 'ar', api: 'quran-tafseer' },
        '4': { id: 4, name: 'تفسير البغوي', language: 'ar', api: 'quran-tafseer' },
        '5': { id: 5, name: 'تفسير القرطبي', language: 'ar', api: 'quran-tafseer' },
        '6': { id: 6, name: 'تفسير ابن كثير', language: 'ar', api: 'quran-tafseer' },
        '7': { id: 7, name: 'تفسير الطبري', language: 'ar', api: 'quran-tafseer' },
        
        // English tafsir from spa5k tafsir_api
        'en-jalalayn': { slug: 'en-al-jalalayn', name: 'Tafsir al-Jalalayn (English)', language: 'en', api: 'spa5k' },
        'en-kathir': { slug: 'en-tafisr-ibn-kathir', name: 'Tafsir Ibn Kathir (English)', language: 'en', api: 'spa5k' },
        'en-maarif': { slug: 'en-tafsir-maarif-ul-quran', name: 'Ma\'ariful Quran (English)', language: 'en', api: 'spa5k' },
        'en-tazkirul': { slug: 'en-tazkirul-quran', name: 'Tazkirul Quran (English)', language: 'en', api: 'spa5k' }
      };

             // Update getTafsirForAyah to fetch per-ayah tafsir using multiple APIs
       async function getTafsirForAyah(surah, ayah, tafsirSource = null) {
         const source = tafsirSource || currentTafsirSource;
         const tafsirConfig = tafsirSources[source] || tafsirSources['2']; // Default to Jalalayn
         const cacheKey = `tafsir-${source}-${surah + 1}-${ayah + 1}`;
         
        if (tafsirCache[cacheKey]) {
          return tafsirCache[cacheKey];
        }
         
         try {
           let url, response, data;
           
           if (tafsirConfig.api === 'quran-tafseer') {
             // Use quran-tafseer.com API for Arabic tafsir
             url = `http://api.quran-tafseer.com/tafseer/${tafsirConfig.id}/${surah + 1}/${ayah + 1}`;
             response = await fetch(url);
             if (response.ok) {
               data = await response.json();
          tafsirCache[cacheKey] = data;
          return data;
             } else {
               throw new Error(`HTTP ${response.status}`);
             }
           } else if (tafsirConfig.api === 'spa5k') {
             // Use spa5k tafsir_api for English tafsir with multiple CDN fallbacks
             const cdnUrls = [
               `https://raw.githubusercontent.com/spa5k/tafsir_api/main/tafsir/${tafsirConfig.slug}/${surah + 1}/${ayah + 1}.json`,
               `https://cdn.statically.io/gh/spa5k/tafsir_api/main/tafsir/${tafsirConfig.slug}/${surah + 1}/${ayah + 1}.json`,
               `https://rawcdn.githack.com/spa5k/tafsir_api/main/tafsir/${tafsirConfig.slug}/${surah + 1}/${ayah + 1}.json`
             ];
             
             for (const cdnUrl of cdnUrls) {
               try {
                 response = await fetch(cdnUrl);
                 if (response.ok) {
                   data = await response.json();
                   tafsirCache[cacheKey] = data;
                   return data;
                 }
               } catch (cdnError) {
                 console.log(`Failed to fetch from ${cdnUrl}:`, cdnError);
                 continue;
               }
             }
             throw new Error('All CDN sources failed');
           }
        } catch (error) {
           console.log(`Failed to fetch tafsir from API:`, error);
           
           // Fallback to default tafsir if not already using it
           if (source !== '2') {
             return getTafsirForAyah(surah, ayah, '2');
           }
           
          tafsirCache[cacheKey] = { text: currentLang === 'ar' ? 'لا يوجد تفسير متاح' : 'Tafsir not available' };
          return tafsirCache[cacheKey];
        }
      }

      // Update displayAyah to fetch tafsir per ayah
      async function displayAyah() {
        const arabicTextElement = document.getElementById('arabicText');
        const translationTextElement = document.getElementById('translationText');
        const surah = quranData && currentSurah !== null ? quranData[currentSurah] : null;
        if (surah && surah.ayahs && surah.ayahs[0]) {
          console.log('First ayah from quranData:', surah.ayahs[0].text);
        }
        if (currentSurah === null || !quranData || !translationData) {
          arabicTextElement.innerHTML = `
            <div class="text-gray-500 dark:text-gray-400 py-8">
              <i class="fas fa-book-quran text-4xl mb-4"></i>
              <p class="text-xl">اختر سورة للبدء</p>
              <p class="text-lg mt-2">Select a Surah to begin</p>
            </div>
          `;
          translationTextElement.innerHTML = '';
          document.getElementById('btnPrevAyah').disabled = true;
          document.getElementById('btnNextAyah').disabled = true;
          document.getElementById('btnReadingMode').disabled = true;
          return;
        }
        try {
          const translation = translationData[currentSurah];
          if (!surah || !translation) throw new Error('Invalid surah data');
          if (!surah.ayahs || !translation.ayahs) throw new Error('Invalid ayahs data');
          if (
  currentAyah === null ||
  currentAyah === undefined ||
  isNaN(currentAyah) ||
  !surah.ayahs[currentAyah] ||
  !translation.ayahs[currentAyah]
) {
  showToast('Invalid ayah index. Showing the first ayah.', 'error');
  currentAyah = 0;
  // Try again with first ayah
  displayAyah();
  return;
}
          const bismillahText = 'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ';
          let bismillahHtml = '';
          let ayahText = surah.ayahs[currentAyah].text;
          let translationAyah = translation.ayahs[currentAyah];
          let ayahNumber = surah.ayahs[currentAyah].numberInSurah;
          let displayedAyahIndex = currentAyah;
          // For all surahs except At-Tawbah, show Bismillah at the top and remove from ayah text if present
          if (currentAyah === 0 && currentSurah !== 8) {
            ayahText = ayahText.replace('بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ', '');

            
            bismillahHtml = `<div class="text-center my-6 text-xl md:text-3xl quran-uthmani-font text-gray-700 dark:text-gray-200 select-none max-w-full md:max-w-2xl mx-auto" dir="rtl" style="font-family: 'Quran.com Font', Arial, sans-serif; letter-spacing: 0.05em; margin-bottom: 2rem;">${bismillahText}</div>`;
            // If ayahText is empty after removing Bismillah (e.g., Al-Fatiha where first ayah is only Bismillah), 
            // skip to the actual first content ayah and increment currentAyah accordingly
            if (!ayahText.trim() && surah.ayahs.length > 1) {
              currentAyah = 1; // Actually move to the next ayah
              ayahText = surah.ayahs[1].text;
              ayahText = ayahText.replace('بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ', '');

              translationAyah = translation.ayahs[1];
              ayahNumber = surah.ayahs[1].numberInSurah;
              displayedAyahIndex = 1;
            }
          }
          // Log the ayah text as it will be displayed (after Bismillah removal)
          if (currentAyah === 0 && currentSurah !== 8) {
            console.log('First ayah as displayed (after Bismillah removal):', ayahText);
          }
          const bookmarkText = languages[currentLang].bookmarkVerse;
          let tafsirHtml = '';
          if (isTafsirVisible) {
            tafsirHtml = `<div class="text-base text-gray-500 dark:text-gray-400 mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg" style="font-size: ${1 * currentTextSize}rem;">
              <div class="font-semibold mb-2">${currentLang === 'ar' ? 'التفسير' : 'Tafsir'}:</div>
              <span id="tafsir-loading">${currentLang === 'ar' ? 'جاري التحميل...' : 'Loading...'}</span>
            </div>`;
          }
          const html = `
            <div class="mb-6">
              ${bismillahHtml}
              <div class="text-2xl leading-loose mb-2 text-justify md:text-center w-full md:max-w-2xl mx-auto px-4 md:px-8 text-right" dir="rtl" style="font-size: ${1.5 * currentTextSize}rem; line-height: 2.2; word-spacing: 0.1em; letter-spacing: 0.02em;">
                <span class="ayah" data-surah="${currentSurah}" data-ayah="${displayedAyahIndex}">
                  ${ayahText}
                </span>
                <span class="verse-marker" 
                  onclick="bookmarkAyah(${currentSurah}, ${displayedAyahIndex})"
                  title="${bookmarkText}">
                  <span class="verse-icon"></span><span class="verse-number">${toArabicNumerals(ayahNumber)}</span>
                </span>
              </div>
              ${isTranslationVisible && translationAyah ? `
                <div class="text-lg text-gray-600 dark:text-gray-400 mb-2 text-left" dir="ltr" style="font-size: ${1.125 * currentTextSize}rem;">
                  ${translationAyah.text}
                </div>
              ` : ''}
              ${isTafsirVisible ? tafsirHtml : ''}
              
            </div>
          `;
          arabicTextElement.innerHTML = html;
          translationTextElement.innerHTML = '';
          document.getElementById('btnPrevAyah').disabled = currentAyah === 0;
          document.getElementById('btnNextAyah').disabled = currentAyah >= surah.ayahs.length - 1;
          document.getElementById('btnReadingMode').disabled = false;
          
          // Add event listeners for the ayah elements
          
          updateAyahHighlights();
          // Fetch tafsir if needed
          if (isTafsirVisible) {
            const tafsir = await getTafsirForAyah(currentSurah, displayedAyahIndex);
            const tafsirElem = document.getElementById('tafsir-loading');
            if (tafsirElem) tafsirElem.innerText = tafsir.text || (currentLang === 'ar' ? 'لا يوجد تفسير متاح' : 'Tafsir not available');
          }
        } catch (error) {
          console.error('Error displaying ayah:', error);
          arabicTextElement.innerHTML = `
            <div class="text-red-500 dark:text-red-400 py-8">
              <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
              <p class="text-xl">حدث خطأ في عرض الآية</p>
              <p class="text-lg mt-2">Error displaying verse</p>
            </div>
          `;
          translationTextElement.innerHTML = '';
        }
      }

      function nextAyah() {
          if (currentSurah === null || !quranData) {
              console.log('Cannot navigate: No surah selected or data not loaded');
              return;
          }

          const surah = quranData[currentSurah];
          
          // Debug log for navigation attempt
          console.log('Attempting next ayah navigation:', {
              currentSurah,
              currentAyah,
              totalAyahs: surah.ayahs.length,
              nextAyahIndex: currentAyah + 1,
              isReadingMode,
              surahName: surah.name,
              currentAyahData: surah.ayahs[currentAyah],
              nextAyahData: surah.ayahs[currentAyah + 1]
          });

          if (isReadingMode) {
              // In reading mode, move to next surah
              if (currentSurah < quranData.length - 1) {
                  currentSurah++;
                  currentAyah = 0;
                  // Update surah menu button text
                  updateSurahDropdown();
                  console.log('Moving to next surah:', {
                      from: currentSurah - 1,
                      to: currentSurah,
                      firstAyah: quranData[currentSurah].ayahs[0]
                  });
                  loadReadingModeAyahs();
                  // Scroll to the top of the page when moving to a new surah in reading mode
                  setTimeout(() => {
                      window.scrollTo({ top: 0, behavior: 'smooth' });
                  }, 100);
              }
          } else {
              // Single verse navigation
              if (currentAyah < surah.ayahs.length - 1) {
                  currentAyah++;
                  console.log('Moving to next ayah:', {
                      from: currentAyah - 1,
                      to: currentAyah,
                      ayahData: surah.ayahs[currentAyah]
                  });
                  displayAyah();
              } else if (currentSurah < quranData.length - 1) {
                  // Move to next surah
                  currentSurah++;
                  currentAyah = 0;
                  // Update surah menu button text
                  updateSurahDropdown();
                  console.log('Moving to next surah:', {
                      from: currentSurah - 1,
                      to: currentSurah,
                      firstAyah: quranData[currentSurah].ayahs[0]
                  });
                  displayAyah();
              }
          }
      }

      function prevAyah() {
          if (currentSurah === null || !quranData) {
              console.log('Cannot navigate: No surah selected or data not loaded');
              return;
          }

          const surah = quranData[currentSurah];
          
          // Debug log for navigation attempt
          console.log('Attempting previous ayah navigation:', {
              currentSurah,
              currentAyah,
              totalAyahs: surah.ayahs.length,
              prevAyahIndex: currentAyah - 1,
              isReadingMode,
              surahName: surah.name,
              currentAyahData: surah.ayahs[currentAyah],
              prevAyahData: surah.ayahs[currentAyah - 1]
          });

          if (isReadingMode) {
              // In reading mode, move to previous surah
              if (currentSurah > 0) {
                  currentSurah--;
                  currentAyah = 0;
                  // Update surah menu button text
                  updateSurahDropdown();
                  console.log('Moving to previous surah:', {
                      from: currentSurah + 1,
                      to: currentSurah,
                      lastAyah: quranData[currentSurah].ayahs[currentAyah]
                  });
                  loadReadingModeAyahs();
                  // Scroll to the top of the page when moving to a previous surah in reading mode
                  setTimeout(() => {
                      window.scrollTo({ top: 0, behavior: 'smooth' });
                  }, 100);
              }
          } else {
              // Single verse navigation
              if (currentAyah > 0) {
                  currentAyah--;
                  console.log('Moving to previous ayah:', {
                      from: currentAyah + 1,
                      to: currentAyah,
                      ayahData: surah.ayahs[currentAyah]
                  });
                  displayAyah();
              } else if (currentSurah > 0) {
                  // Move to previous surah
                  currentSurah--;
                  currentAyah = quranData[currentSurah].ayahs.length - 1;
                  // Update surah menu button text
                  updateSurahDropdown();
                  console.log('Moving to previous surah:', {
                      from: currentSurah + 1,
                      to: currentSurah,
                      lastAyah: quranData[currentSurah].ayahs[currentAyah]
                  });
                  displayAyah();
              }
          }
      }

      function loadReadingModeAyahs() {
          if (currentSurah === null || !quranData || !translationData) {
              console.log('Cannot load reading mode: No surah selected or data not loaded');
              return;
          }
          
          const surah = quranData[currentSurah];
          const translation = translationData[currentSurah];
          
          // Debug log for reading mode
          console.log('Loading reading mode:', {
              currentSurah,
              currentAyah,
              surahName: surah.name,
              totalAyahs: surah.ayahs.length,
              isReadingMode,
              firstAyah: surah.ayahs[0],
              secondAyah: surah.ayahs[1]
          });
          
          // Load all verses in the surah
          readingModeAyahs = [];
          for (let i = 0; i < surah.ayahs.length; i++) {
              if (surah.ayahs[i] && translation.ayahs[i]) {
                  readingModeAyahs.push({
                      arabic: surah.ayahs[i].text,
                      translation: translation.ayahs[i].text,
                      number: i + 1,
                      page: surah.ayahs[i].page // Include page number from original data
                  });
              }
          }
          
          // Set currentAyah to 0 since we're showing the whole surah
          currentAyah = 0;
          
          // Debug log for batch loading
          console.log('Reading mode batch:', {
              totalAyahs: surah.ayahs.length,
              loadedAyahs: readingModeAyahs.map(ayah => ayah.number)
          });
          
          displayReadingModeAyahs();
      }

      // Update displayReadingModeAyahs to fetch tafsir per ayah and group by pages
      async function displayReadingModeAyahsByPages(shouldScrollToBookmark = false, scrollToVerseId = null) {
        const arabicText = document.getElementById('arabicText');
        const translationText = document.getElementById('translationText');
        const bookmarkText = languages[currentLang].bookmarkVerse;
        let html = '';
        
        // Group verses by page number
        const pageGroups = {};
        let startIdx = 0;
        const bismillahText = 'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ';
        
        // Skip Bismillah-only verses
        if (readingModeAyahs.length > 0 && readingModeAyahs[0].arabic.replace(/\s/g, '') === bismillahText.replace(/\s/g, '')) {
          startIdx = 1;
        }
        
        // Group verses by their page numbers
        for (let index = startIdx; index < readingModeAyahs.length; index++) {
          const ayah = readingModeAyahs[index];
          const pageNum = ayah.page || 1; // fallback to page 1 if no page info
          
          if (!pageGroups[pageNum]) {
            pageGroups[pageNum] = [];
          }
          pageGroups[pageNum].push({
            ayah: ayah,
            originalIndex: index,
            ayahIndex: currentAyah + index
          });
        }
        
        // Insert Bismillah at the top for all surahs except At-Tawbah (9)
        let bismillahHtml = '';
        if (currentSurah !== 8) {
          bismillahHtml = `<div class="text-center my-6 text-xl md:text-3xl quran-uthmani-font text-gray-700 dark:text-gray-200 select-none max-w-full md:max-w-2xl mx-auto" dir="rtl" style="font-family: 'Quran.com Font', Arial, sans-serif; letter-spacing: 0.05em; margin-bottom: 2rem;">${bismillahText}</div>`;
        }
        
        html += bismillahHtml;
        
        // Sort pages numerically and render each page group
        const sortedPages = Object.keys(pageGroups).sort((a, b) => parseInt(a) - parseInt(b));
        
        for (let i = 0; i < sortedPages.length; i++) {
          const pageNum = sortedPages[i];
          const pageVersesData = pageGroups[pageNum];
          
          // Page header with number
          html += `<div class="page-section mb-8">
            <div class="page-header text-center mb-6">
              <div class="inline-flex items-center justify-center">
                <span class="text-xs font-normal text-gray-500 dark:text-gray-400 px-3 py-1 rounded-md bg-gray-50 dark:bg-gray-800/50">${currentLang === 'ar' ? 'صفحة' : 'Page'} ${currentLang === 'ar' ? toArabicNumerals(pageNum) : pageNum}</span>
              </div>
            </div>`;
          
          // Verses for this page
          let pageAyahLine = `<div class="text-2xl leading-loose text-justify md:text-center w-full md:max-w-2xl mx-auto px-4 md:px-8 mb-6 text-right" dir="rtl" style="font-size: ${1.5 * currentTextSize}rem; line-height: 2.2; word-spacing: 0.1em; letter-spacing: 0.02em;">`;
          
          for (let j = 0; j < pageVersesData.length; j++) {
            const verseData = pageVersesData[j];
            let ayahText = verseData.ayah.arabic;
            
            // Remove Bismillah from first verse if needed
            if (verseData.originalIndex === startIdx && currentSurah !== 8) {
              ayahText = ayahText.replace('بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ', '');
          }
            
            const verseNumber = currentAyah + verseData.originalIndex + 1 - startIdx;
            pageAyahLine += ` <span class="ayah" data-surah="${currentSurah}" data-ayah="${verseData.ayahIndex}">${ayahText}</span> <span class="verse-marker" id="verse-${currentSurah}-${verseData.ayahIndex}" onclick="bookmarkAyah(${currentSurah}, ${verseData.ayahIndex})" title="${bookmarkText}"><span class="verse-icon"></span><span class="verse-number">${toArabicNumerals(verseNumber)}</span></span>`;
        }
          
          pageAyahLine += '</div>';
          html += pageAyahLine;

          // Close page section
          html += '</div>';
          
          // Add separator between pages (except for the last page)
          if (i < sortedPages.length - 1) {
            html += `<div class="page-separator my-8">
              <div class="flex items-center justify-center">
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent w-full max-w-md"></div>
                <div class="mx-4">
                  <div class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full"></div>
                </div>
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent w-full max-w-md"></div>
              </div>
            </div>`;
          }
        }

        if (isTafsirVisible) {
          html += '<div class="mt-6 space-y-4">';
          for (let index = 0; index < readingModeAyahs.length; index++) {
            html += `<div class="text-base text-gray-500 dark:text-gray-400 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg" style="font-size: ${1 * currentTextSize}rem;">
              <div class="font-semibold mb-2">${currentLang === 'ar' ? 'التفسير' : 'Tafsir'} - ${languages[currentLang].verse} ${index + 1}</div>
              <span id="tafsir-loading-${index}">${currentLang === 'ar' ? 'جاري التحميل...' : 'Loading...'}</span>
            </div>`;
          }
          html += '</div>';
        }
        arabicText.innerHTML = html;
        translationText.innerHTML = '';
        const surah = quranData[currentSurah];
        document.getElementById('btnPrevAyah').disabled = currentSurah === 0;
        document.getElementById('btnNextAyah').disabled = currentSurah >= quranData.length - 1;
        const btn = document.getElementById('btnReadingMode');
        btn.title = `Displaying entire Surah ${surah.name} (${surah.englishName})`;
        // Event listeners for ayah elements are handled by the popover script
        updateAyahHighlights();
        // Fetch tafsir for all ayahs if needed
        if (isTafsirVisible) {
          for (let index = 0; index < readingModeAyahs.length; index++) {
            getTafsirForAyah(currentSurah, currentAyah + index).then(tafsir => {
              const tafsirElem = document.getElementById(`tafsir-loading-${index}`);
              if (tafsirElem) tafsirElem.innerText = tafsir.text || (currentLang === 'ar' ? 'لا يوجد تفسير متاح' : 'Tafsir not available');
            });
          }
        }
        // Scroll logic
        if (shouldScrollToBookmark && currentBookmark && currentBookmark.surah === currentSurah) {
          const verseElem = document.getElementById(`verse-${currentSurah}-${currentBookmark.ayah}`);
          if (verseElem) {
            verseElem.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        } else if (scrollToVerseId) {
          const verseElem = document.getElementById(scrollToVerseId);
          if (verseElem) {
            verseElem.scrollIntoView({ behavior: 'auto', block: 'center' });
          }
        }
      }

      // In toggleReadingMode, call displayReadingModeAyahs(true) when entering reading mode, otherwise false
      function toggleReadingMode() {
          isReadingMode = !isReadingMode;
          const btn = document.getElementById('btnReadingMode');
          

          
          if (isReadingMode) {
              btn.innerHTML = '<i class="fas fa-times"></i>';
              // Don't reset currentAyah to 0, keep the current position
              loadReadingModeAyahs();
              displayReadingModeAyahsByPages(true); // Only scroll to bookmark when entering reading mode
          } else {
              btn.innerHTML = '<i class="fas fa-book-open"></i>';
              displayAyah();
          }
      }

      function bookmarkAyah(surah, ayah) {
        if ((surah === null || surah === undefined) || !quranData) return;      
          // Convert surah and ayah to numbers to ensure proper comparison
          surah = Number(surah);
          ayah = Number(ayah);
          
          // Ensure ayah is within valid range
          const surahData = quranData[surah];
          console.log("surahData", surahData);
          if (!surahData || ayah < 0 || ayah >= surahData.ayahs.length) {
              console.error('Invalid ayah number:', ayah);
              return;
          }
          
          const bookmark = {
              surah: surah,
              ayah: ayah,
              timestamp: new Date().toISOString()
          };
          
          // Check if this is the same bookmark as current
          if (currentBookmark && Number(currentBookmark.surah) === surah && Number(currentBookmark.ayah) === ayah) {
              // Remove bookmark
              currentBookmark = null;
              try {
                  localStorage.removeItem('quranBookmark');
                  sessionStorage.removeItem('quranBookmark');
              } catch (error) {
                  console.error('Error removing bookmark:', error);
              }
             
              showToast(currentLang === 'ar' ? 'تم إزالة العلامة المرجعية' : 'Bookmark removed', 'info');
          } else {
              // Set bookmark
              currentBookmark = bookmark;
              try {
                  localStorage.setItem('quranBookmark', JSON.stringify(bookmark));
                  // For iOS, also save to sessionStorage as backup
                  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                      sessionStorage.setItem('quranBookmark', JSON.stringify(bookmark));
                  }
              } catch (error) {
                  console.error('Error saving bookmark:', error);
                  // If localStorage fails, try sessionStorage
                  try {
                      sessionStorage.setItem('quranBookmark', JSON.stringify(bookmark));
                  } catch (sessionError) {
                      console.error('Error saving bookmark to sessionStorage:', sessionError);
                  }
              }
             
              showToast(currentLang === 'ar' ? 'تم إضافة العلامة المرجعية' : 'Bookmark added', 'success');
          }
          
          // Update display
          if (isReadingMode) {
              loadReadingModeAyahs();
              displayReadingModeAyahsByPages(); // Update to use page-based function
          } else {
              displayAyah();
          }
      }

      function toggleBookmark() {
          if (currentSurah === null) return;
          
          bookmarkAyah(currentSurah, currentAyah);
      }

      function goToBookmark() {
          let savedBookmark = null;
          
          // Try localStorage first
          try {
              const localStorageBookmark = localStorage.getItem('quranBookmark');
              if (localStorageBookmark) {
                  savedBookmark = JSON.parse(localStorageBookmark);
              }
          } catch (error) {
              console.error('Error reading from localStorage:', error);
          }
          
          // If no bookmark in localStorage, try sessionStorage
          if (!savedBookmark) {
              try {
                  const sessionStorageBookmark = sessionStorage.getItem('quranBookmark');
                  if (sessionStorageBookmark) {
                      savedBookmark = JSON.parse(sessionStorageBookmark);
                  }
              } catch (error) {
                  console.error('Error reading from sessionStorage:', error);
              }
          }
          
          if (savedBookmark) {
              try {
                  // Store the bookmark position before loading data
                  const bookmarkSurah = savedBookmark.surah;
                  const bookmarkAyah = savedBookmark.ayah;

                  // Set the current surah and ayah
                  currentSurah = bookmarkSurah;
                  currentAyah = bookmarkAyah;
                  
                  // Update surah menu button text
                  updateSurahDropdown();
                  
                  // Ensure the surah data is loaded
                  if (!quranData || !translationData) {
                      loadQuranData().then(() => {
                          // Restore the bookmark position after data is loaded
                          currentSurah = bookmarkSurah;
                          currentAyah = bookmarkAyah;
                          
                          // After data is loaded, update the display
                          if (isReadingMode) {
                              loadReadingModeAyahs();
                              displayReadingModeAyahsByPages(true); // Scroll to bookmark
                          } else {
                              displayAyah();
                          }
                      });
                  } else {
                      // Data is already loaded, just update the display
                      if (isReadingMode) {
                          loadReadingModeAyahs();
                          displayReadingModeAyahsByPages(true); // Scroll to bookmark
                      } else {
                          displayAyah();
                      }
                  }
              } catch (error) {
                  console.error('Error going to bookmark:', error);
              }
          } else {
              showToast(currentLang === 'ar' ? 'لا توجد علامة مرجعية محفوظة' : 'No bookmark saved', 'info');
          }
      }

      function handleNotificationToggleClick(e) {
        const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
        const isInStandaloneMode = window.navigator.standalone === true;

        if (!e.target.checked) {
          notificationEnabled = false;
          return;
        }

        if (isIOS && !isInStandaloneMode) {
          showTutorial();

         


          e.preventDefault();
          e.target.checked = false;
          return;
        }

        showTutorial();

        requestNotificationPermission().then((success) => {
          if (!success) {
            e.target.checked = false;
          }
        });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            tafsirLang = currentLang;
            console.log("tafsirLang", tafsirLang)

            const adhkarView = document.getElementById('adhkarView');
            const adhkarArabicText = document.getElementById('adhkarArabicText');
            if (adhkarView) {
                adhkarView.addEventListener('touchstart', handleTouchStart, false);
                adhkarView.addEventListener('touchend', handleTouchEnd, false);
            }
            if (adhkarArabicText) {
                adhkarArabicText.addEventListener('click', handleDhikrClick);
            }

            setupTabs();

            // Try to load saved prayer times first
            if (!loadPrayerTimes()) {
                // If no saved times or they're from a different day, fetch new times
                await detectCityAndFetchTimes();
            }

            // Add notification toggle handler
            const notificationToggle = document.getElementById('notificationToggle');
            
                  
          console.log(notificationToggle.checked)
          if (notificationToggle) {
          notificationToggle.addEventListener('click', handleNotificationToggleClick);
                        }


            // Add periodic checks
            setupPeriodicChecks();

            // Load Quran data
            await loadQuranData();
            
            // Initialize font settings
            initializeFontSettings();
            
            // Update settings language
            updateSettingsLanguage();
            
            // Add translation toggle handler
            
            // Add bookmark toggle handler
            
            // Load saved bookmark
            const savedBookmark = localStorage.getItem('quranBookmark');
            if (savedBookmark) {
                try {
                    currentBookmark = JSON.parse(savedBookmark);
                   
                } catch (error) {
                    console.error('Error loading bookmark:', error);
                    localStorage.removeItem('quranBookmark');
                    currentBookmark = null;
                }
            }

         

          
        });

        // Add this function to show toast notifications
        function showToast(message, type = 'info') {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Set icon based on type
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide and remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // iOS-specific detection and handling
        function isIOSStandalone() {
            return window.navigator.standalone === true;
        }

        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }

        function showIOSInstallPrompt() {
            if (isIOS() && !isIOSStandalone()) {
                const modal = document.getElementById('iosInstallModal') || createIOSInstallModal();
                // Force a reflow to ensure the modal is visible
                modal.offsetHeight;
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
                
                // Add a small delay for Safari
                setTimeout(() => {
                    modal.style.opacity = '1';
                }, 50);
            }
        }

        function createIOSInstallModal() {
            const modal = document.createElement('div');
            modal.id = 'iosInstallModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s ease';
            modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-[90%] max-w-md relative">
                <div class="text-center mb-4">
                    <i class="fas fa-home text-3xl text-blue-500 mb-2"></i>
                    <h3 class="text-xl font-bold">${languages[currentLang].tutorialTitle}</h3>
                </div>
                <ol class="list-decimal list-inside space-y-3 text-left">
                    <li>${languages[currentLang].tutorialIOS.steps[0]}</li>
                    <li>${languages[currentLang].tutorialIOS.steps[1]}</li>
                    <li>${languages[currentLang].tutorialIOS.steps[2]}</li>
                </ol>
                <div class="mt-6 flex justify-center">
                    <button onclick="closeIOSInstallModal()" 
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg">
                        ${languages[currentLang].gotIt}
                    </button>
                </div>
            </div>
        `;
            document.body.appendChild(modal);
            return modal;
        }

        function closeIOSInstallModal() {
            const modal = document.getElementById('iosInstallModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        // Add this to your document.addEventListener('DOMContentLoaded', ...) section
        document.addEventListener('DOMContentLoaded', async () => {
            // ... existing code ...

            // Add translation select handler
            // Translation selector will be handled in modal initialization

            // ... rest of your existing code ...
        });

        // Add these variables at the top with other variables
        let currentTextSize = 1; // Base size multiplier
        const TEXT_SIZE_STEP = 0.2; // Size change step
        const MIN_TEXT_SIZE = 0.8; // Minimum size multiplier
        const MAX_TEXT_SIZE = 2.0; // Maximum size multiplier

        // Add these functions for text size control
        function increaseTextSize() {
            if (currentTextSize < MAX_TEXT_SIZE) {
                currentTextSize += TEXT_SIZE_STEP;
                updateTextSize();
                saveTextSizePreference();
                updateFontSizeDisplay();
                updateSliderValue();
                // Refresh current display
                if (currentSurah !== null) {
                    if (isReadingMode) {
                        displayReadingModeAyahs();
                    } else {
                        displayAyah();
                    }
                }
            }
        }

        function decreaseTextSize() {
            if (currentTextSize > MIN_TEXT_SIZE) {
                currentTextSize -= TEXT_SIZE_STEP;
                updateTextSize();
                saveTextSizePreference();
                updateFontSizeDisplay();
                updateSliderValue();
                // Refresh current display
                if (currentSurah !== null) {
                    if (isReadingMode) {
                        displayReadingModeAyahs();
                    } else {
                        displayAyah();
                    }
                }
            }
        }

        function updateSliderValue() {
            const slider = document.getElementById('fontSizeSlider');
            if (slider) {
                slider.value = currentTextSize;
            }
        }

        function resetTextSize() {
            currentTextSize = 1;
            updateTextSize();
            saveTextSizePreference();
            updateFontSizeDisplay();
            updateSliderValue();
            // Refresh current display
            if (currentSurah !== null) {
                if (isReadingMode) {
                    displayReadingModeAyahs();
                } else {
                    displayAyah();
                }
            }
        }

        // Quran Settings Menu Functions
        function toggleQuranSettings() {
            const menu = document.getElementById('quranSettingsMenu');
            const isHidden = menu.classList.contains('hidden');
            
            if (isHidden) {
                // Show menu
                menu.classList.remove('hidden');
                setTimeout(() => {
                    menu.classList.remove('translate-x-full');
                }, 10);
                
                // Add overlay
                const overlay = document.createElement('div');
                overlay.className = 'settings-overlay';
                overlay.onclick = toggleQuranSettings;
                document.body.appendChild(overlay);
                
                // Update displays
                updateFontSizeDisplay();
                updateFontSizeSlider();
                updateSettingsLanguage();
            } else {
                // Hide menu
                menu.classList.add('translate-x-full');
                setTimeout(() => {
                    menu.classList.add('hidden');
                }, 300);
                
                // Remove overlay
                const overlay = document.querySelector('.settings-overlay');
                if (overlay) overlay.remove();
            }
        }

        function updateFontSizeDisplay() {
            const display = document.getElementById('currentFontSize');
            if (display) {
                display.textContent = (1.5 * currentTextSize).toFixed(1) + 'rem';
            }
        }

        function updateFontSizeSlider() {
            const slider = document.getElementById('fontSizeSlider');
            if (slider) {
                slider.value = currentTextSize;
                slider.oninput = function() {
                    currentTextSize = parseFloat(this.value);
                    updateTextSize();
                    updateFontSizeDisplay();
                    saveTextSizePreference();
                    // Refresh current display
                    if (currentSurah !== null) {
                        if (isReadingMode) {
                            displayReadingModeAyahs();
                        } else {
                            displayAyah();
                        }
                    }
                };
            }
        }

        function changeFontFamily(fontClass) {
            const arabicText = document.getElementById('arabicText');
            if (arabicText) {
                // Remove all font classes
                arabicText.classList.remove('font-quran-original', 'font-utman-taha', 'font-al-mushaf', 'font-system-arabic');
                // Add selected font class
                arabicText.classList.add(fontClass);
                
                // Save preference
                localStorage.setItem('quranFontFamily', fontClass);
            }
        }

        // Initialize font family radio buttons
        function initializeFontSettings() {
            const fontRadios = document.querySelectorAll('input[name="fontFamily"]');
            const savedFont = localStorage.getItem('quranFontFamily') || 'font-quran-original';
            
            fontRadios.forEach(radio => {
                let expectedValue;
                switch(savedFont) {
                    case 'font-utman-taha':
                        expectedValue = 'utman-taha';
                        break;
                    case 'font-al-mushaf':
                        expectedValue = 'al-mushaf';
                        break;
                    case 'font-system-arabic':
                        expectedValue = 'system-arabic';
                        break;
                    default:
                        expectedValue = 'quran-font';
                }
                
                if (radio.value === expectedValue) {
                    radio.checked = true;
                }
                
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        let fontClass;
                        switch(this.value) {
                            case 'quran-font':
                                fontClass = 'font-quran-original';
                                break;
                            case 'utman-taha':
                                fontClass = 'font-utman-taha';
                                break;
                            case 'al-mushaf':
                                fontClass = 'font-al-mushaf';
                                break;
                            case 'system-arabic':
                                fontClass = 'font-system-arabic';
                                break;
                            default:
                                fontClass = 'font-quran-original';
                        }
                        changeFontFamily(fontClass);
                    }
                });
            });
            
            // Apply saved font
            changeFontFamily(savedFont);
            
            // Initialize other settings
            initializeAudioSettings();
        }



        // Audio Settings Functions
        let currentReciter = 'ar.alafasy';
        let currentPlaybackSpeed = 1;


        function initializeAudioSettings() {
            // Initialize reciter
            const savedReciter = localStorage.getItem('quranReciter') || 'ar.alafasy';
            currentReciter = savedReciter;
            const reciterSelect = document.getElementById('reciterSelect');
            if (reciterSelect) {
                reciterSelect.value = savedReciter;
                reciterSelect.addEventListener('change', function() {
                    currentReciter = this.value;
                    localStorage.setItem('quranReciter', this.value);
                    
                    // Show feedback about reciter change
                    const reciterNames = {
                        'ar.alafasy': currentLang === 'ar' ? 'مشاري العفاسي' : 'Mishary Al-Afasy',
                        'ar.husary': currentLang === 'ar' ? 'محمود خليل الحصري' : 'Mahmoud Khalil Al-Husary',
                        'ar.minshawi': currentLang === 'ar' ? 'محمد صديق المنشاوي' : 'Mohamed Siddiq Al-Minshawi',
                        'ar.sudais': currentLang === 'ar' ? 'عبد الرحمن السديس' : 'Abdul Rahman As-Sudais',
                        'ar.shuraim': currentLang === 'ar' ? 'سعود الشريم' : 'Saud Ash-Shuraim'
                    };
                    
                    const message = currentLang === 'ar' ? 
                        `تم اختيار القارئ: ${reciterNames[this.value]}` : 
                        `Reciter selected: ${reciterNames[this.value]}`;
                    
                    showToast(message, 'success');
                });
            }

            // Initialize playback speed
            const savedSpeed = localStorage.getItem('quranPlaybackSpeed') || '1';
            currentPlaybackSpeed = parseFloat(savedSpeed);
            const speedSelect = document.getElementById('playbackSpeedSelect');
            if (speedSelect) {
                speedSelect.value = savedSpeed;
                speedSelect.addEventListener('change', function() {
                    currentPlaybackSpeed = parseFloat(this.value);
                    localStorage.setItem('quranPlaybackSpeed', this.value);
                    
                    // Show feedback about speed change
                    const message = currentLang === 'ar' ? 
                        `تم تغيير سرعة التشغيل إلى: ${this.value}x` : 
                        `Playback speed changed to: ${this.value}x`;
                    
                    showToast(message, 'success');
                });
            }


        }

        // Update settings menu language
        function updateSettingsLanguage() {
            const settingsTexts = {
                ar: {
                    title: 'إعدادات القرآن',
                    fontSizeTitle: 'حجم الخط',
                    currentSizeLabel: 'حجم الخط الحالي',
                    resetSizeText: 'إعادة تعيين الحجم',
                    fontFamilyTitle: 'نوع الخط',
                    font1Name: 'خط القرآن الأصلي',
                    font2Name: 'خط عثمان طه',
                    font3Name: 'خط المصحف',
                    font4Name: 'خط النظام العربي',
                    font4Desc: 'Arial, Tahoma',
                    audioTitle: 'إعدادات الصوت',
                    reciterLabel: 'القارئ',
                    playbackSpeedLabel: 'سرعة التشغيل',

                    speed1: 'بطيء (0.5x)',
                    speed2: 'أبطأ (0.75x)',
                    speed3: 'عادي (1x)',
                    speed4: 'أسرع (1.25x)',
                    speed5: 'سريع (1.5x)',
                    settingsBtn: 'إعدادات القرآن',
                    decreaseBtn: 'تصغير الخط',
                    increaseBtn: 'تكبير الخط'
                },
                en: {
                    title: 'Quran Settings',
                    fontSizeTitle: 'Font Size',
                    currentSizeLabel: 'Current Font Size',
                    resetSizeText: 'Reset Size',
                    fontFamilyTitle: 'Font Family',
                    font1Name: 'Original Quran Font',
                    font2Name: 'Utman Taha Font',
                    font3Name: 'Al Mushaf Font',
                    font4Name: 'System Arabic Font',
                    font4Desc: 'Arial, Tahoma',
                    audioTitle: 'Audio Settings',
                    reciterLabel: 'Reciter',
                    playbackSpeedLabel: 'Playback Speed',

                    speed1: 'Slow (0.5x)',
                    speed2: 'Slower (0.75x)',
                    speed3: 'Normal (1x)',
                    speed4: 'Faster (1.25x)',
                    speed5: 'Fast (1.5x)',
                    settingsBtn: 'Quran Settings',
                    decreaseBtn: 'Decrease Font Size',
                    increaseBtn: 'Increase Font Size'
                }
            };

            const texts = settingsTexts[currentLang] || settingsTexts.ar;

            // Update all text elements
            const elements = [
                { id: 'settingsTitle', text: texts.title },
                { id: 'fontSizeTitle', text: texts.fontSizeTitle },
                { id: 'currentSizeLabel', text: texts.currentSizeLabel },
                { id: 'resetSizeText', text: texts.resetSizeText },
                { id: 'fontFamilyTitle', text: texts.fontFamilyTitle },
                { id: 'font1Name', text: texts.font1Name },
                { id: 'font2Name', text: texts.font2Name },
                { id: 'font3Name', text: texts.font3Name },
                { id: 'font4Name', text: texts.font4Name },
                { id: 'font4Desc', text: texts.font4Desc },
                { id: 'audioTitle', text: texts.audioTitle },
                { id: 'reciterLabel', text: texts.reciterLabel },
                { id: 'playbackSpeedLabel', text: texts.playbackSpeedLabel },

                { id: 'speed1', text: texts.speed1 },
                { id: 'speed2', text: texts.speed2 },
                { id: 'speed3', text: texts.speed3 },
                { id: 'speed4', text: texts.speed4 },
                { id: 'speed5', text: texts.speed5 }
            ];

            elements.forEach(({ id, text }) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                }
            });

            // Update button titles
            const settingsBtn = document.getElementById('settingsBtn');
            const decreaseBtn = document.getElementById('decreaseBtn');
            const increaseBtn = document.getElementById('increaseBtn');

            if (settingsBtn) settingsBtn.title = texts.settingsBtn;
            if (decreaseBtn) decreaseBtn.title = texts.decreaseBtn;
            if (increaseBtn) increaseBtn.title = texts.increaseBtn;
        }

        function updateTextSize() {
            const arabicText = document.getElementById('arabicText');
            const translationText = document.getElementById('translationText');
            
            if (arabicText) {
                arabicText.style.fontSize = `${1.5 * currentTextSize}rem`; // Base size is 1.5rem
            }
            if (translationText) {
                translationText.style.fontSize = `${1.125 * currentTextSize}rem`; // Base size is 1.125rem
            }
        }

        function saveTextSizePreference() {
            try {
                localStorage.setItem('quranTextSize', currentTextSize.toString());
            } catch (error) {
                console.error('Error saving text size preference:', error);
            }
        }

        function loadTextSizePreference() {
            try {
                const savedSize = localStorage.getItem('quranTextSize');
                if (savedSize) {
                    currentTextSize = parseFloat(savedSize);
                    updateTextSize();
                }
            } catch (error) {
                console.error('Error loading text size preference:', error);
            }
        }

        // Add this to your document.addEventListener('DOMContentLoaded', ...) section
        document.addEventListener('DOMContentLoaded', async () => {
            // ... existing code ...
            
            // Load saved text size preference
            loadTextSizePreference();
            
            // ... rest of your existing code ...
        });

        // Add this function to load Tafsir data
        async function loadTafsirData() {
            try {
                // Initialize tafsirData as an object to store surah data
                tafsirData = {};
                console.log('Tafsir data initialized');
            } catch (error) {
                console.error('Error initializing Tafsir data:', error);
                showToast(currentLang === 'ar' ? 'حدث خطأ في تحميل التفسير' : 'Error loading Tafsir', 'error');
            }
        }

        // Add toggle Tafsir function
        function toggleTafsir() {
            isTafsirVisible = !isTafsirVisible;
            
            if (isTafsirVisible) {
                if (currentSurah !== null) {
                    loadTafsirForSurah(currentSurah + 1).then(() => {
                        // Preserve scroll position in reading mode
                        if (isReadingMode) {
                            const centeredId = getCenteredVerseId();
                            displayReadingModeAyahs(false, centeredId);
                        } else {
                            displayAyah();
                        }
                    });
                }
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-book"></i>';
                // Preserve scroll position in reading mode
                if (isReadingMode) {
                    const centeredId = getCenteredVerseId();
                    displayReadingModeAyahs(false, centeredId);
                } else {
                    displayAyah();
                }
            }
        }

        // Update the document.addEventListener('DOMContentLoaded', ...) section
        document.addEventListener('DOMContentLoaded', async () => {
            // ... existing code ...
            
            // Add Tafsir toggle handler
            
            // Load Tafsir data
            await loadTafsirData();
            
            // ... rest of your existing code ...
        });

        // Add a function to load Tafsir for a specific surah
        async function loadTafsirForSurah(surahNumber) {
            try {
                const langCode = tafsirLang === 'ar' ? 'ar-tafsir-muyassar' : 'en-al-jalalayn';
                const response = await fetch(`https://cdn.jsdelivr.net/gh/spa5k/tafsir_api@main/tafsir/${langCode}/${surahNumber}.json`);
                console.log(response);
                if (!response.ok) throw new Error('Failed to fetch Tafsir data');
                const data = await response.json();
                tafsirData[surahNumber - 1] = data; // Store with 0-based index
                console.log(`Tafsir data loaded successfully for Surah ${surahNumber} (${tafsirLang})`);
                console.log('Tafsir data:', tafsirData[surahNumber - 1]);
                console.log('Tafsir ayah keys:', Object.keys(tafsirData[surahNumber - 1].ayahs));
            } catch (error) {
                console.error('Error loading Tafsir data:', error);
                showToast(currentLang === 'ar' ? 'حدث خطأ في تحميل التفسير' : 'Error loading Tafsir', 'error');
            }
        }

        // Surah Side Menu Functionality
        let surahsData = []; // Store surah data for search
        
        function initializeSurahMenu() {
            if (!quranData) return;
            
            surahsData = quranData.map((surah, index) => ({
                index: index,
                number: surah.number,
                name: surah.name,
                englishName: surahNamesEnglish[index] || surah.englishName,
                revelationType: surah.revelationType,
                numberOfAyahs: surah.numberOfAyahs
            }));
            
            populateSurahList(surahsData);
        }
        
        function populateSurahList(surahs) {
            const surahList = document.getElementById('surahList');
            surahList.innerHTML = '';
            
            surahs.forEach(surah => {
                const surahItem = document.createElement('div');
                surahItem.className = 'surah-item p-3 mb-2 bg-white dark:bg-black rounded-lg hover:bg-gray-100 dark:hover:bg-gray-900 cursor-pointer transition-all duration-200 border border-gray-200 dark:border-gray-800';
                surahItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-black dark:bg-white text-white dark:text-black rounded-full flex items-center justify-center text-sm font-bold">
                                    ${currentLang === 'ar' ? toArabicNumerals(surah.number) : surah.number}
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-black dark:text-white text-lg">
                                        ${currentLang === 'ar' ? surah.name : surah.englishName}
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">
                                        ${currentLang === 'ar' ? surah.englishName : surah.name} • ${currentLang === 'ar' ? toArabicNumerals(surah.numberOfAyahs) : surah.numberOfAyahs} ${currentLang === 'ar' ? 'آية' : 'verses'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs px-2 py-1 rounded-full border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300">
                            ${currentLang === 'ar' ? (surah.revelationType === 'Meccan' ? 'مكية' : 'مدنية') : surah.revelationType}
                        </div>
                    </div>
                `;
                
                surahItem.addEventListener('click', () => selectSurah(surah.index));
                surahList.appendChild(surahItem);
            });
        }
        
        function selectSurah(surahIndex) {
            currentSurah = surahIndex;
                currentAyah = 0;
                isReadingMode = false;
                document.getElementById('btnReadingMode').innerHTML = '<i class="fas fa-book-open"></i>';
            
            // Update button text
            const surah = quranData[surahIndex];
            const surahName = currentLang === 'ar' ? surah.name : surahNamesEnglish[surahIndex];
            document.getElementById('selectedSurahText').textContent = `${surah.number}. ${surahName}`;
            
            // Close side menu
            closeSurahMenu();
                
                // Load Tafsir for the selected surah
                if (isTafsirVisible) {
                loadTafsirForSurah(currentSurah + 1); // +1 because surah numbers start from 1
                }
                
                displayAyah();
        }
        
        function openSurahMenu() {
            const sideMenu = document.getElementById('surahSideMenu');
            const overlay = document.getElementById('surahMenuOverlay');
            
            sideMenu.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
            
            // Initialize menu if not done yet
            if (surahsData.length === 0) {
                initializeSurahMenu();
            }
            
            // Focus search input
            setTimeout(() => {
                document.getElementById('surahSearchInput').focus();
            }, 300);
        }
        
        function closeSurahMenu() {
            const sideMenu = document.getElementById('surahSideMenu');
            const overlay = document.getElementById('surahMenuOverlay');
            
            sideMenu.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
            
            // Clear search
            document.getElementById('surahSearchInput').value = '';
            if (surahsData.length > 0) {
                populateSurahList(surahsData);
            }
        }
        
        // Function to remove Arabic diacritics and normalize Alef variants for better search
        function normalizeArabicText(text) {
            return text
                // Remove diacritics
                .replace(/[\u064B-\u0652\u0670\u0640]/g, '')
                // Normalize Alef variants: أ إ آ ا -> ا
                .replace(/[أإآ]/g, 'ا');
        }
        
        function searchSurahs(query) {
            if (!query.trim()) {
                populateSurahList(surahsData);
                return;
            }
            
            const searchTerm = query.toLowerCase();
            const searchTermNormalized = normalizeArabicText(searchTerm);
            
            const filteredSurahs = surahsData.filter(surah => {
                // Normalize surah names for comparison
                const arabicNameNormalized = normalizeArabicText(surah.name.toLowerCase());
                const englishNameLower = surah.englishName.toLowerCase();
                
                return (
                    // Search in Arabic name (original and normalized)
                    surah.name.toLowerCase().includes(searchTerm) ||
                    arabicNameNormalized.includes(searchTerm) ||
                    arabicNameNormalized.includes(searchTermNormalized) ||
                    // Search in English name
                    englishNameLower.includes(searchTerm) ||
                    // Search by number
                    surah.number.toString().includes(searchTerm)
                );
            });
            
            populateSurahList(filteredSurahs);
        }
        
        // Event Listeners for Surah Menu
        document.addEventListener('DOMContentLoaded', function() {
            // Surah menu button
            document.getElementById('surahMenuBtn').addEventListener('click', openSurahMenu);
            
            // Close menu button
            document.getElementById('closeSurahMenu').addEventListener('click', closeSurahMenu);
            
            // Overlay click to close
            document.getElementById('surahMenuOverlay').addEventListener('click', closeSurahMenu);
            
            // Search functionality
            document.getElementById('surahSearchInput').addEventListener('input', function(e) {
                searchSurahs(e.target.value);
            });
            
            // Escape key to close menu
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSurahMenu();
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Disable tafsir and translation buttons initially
            
            // Initialize language
            currentLang = localStorage.getItem('language') || 'ar';
        });

        // Utility to get the verse closest to the center of the viewport
        function getCenteredVerseId() {
            const verses = document.querySelectorAll('[id^="verse-"]');
            const viewportCenter = window.scrollY + window.innerHeight / 2;
            let closestId = null;
            let minDist = Infinity;
            verses.forEach(verse => {
                const rect = verse.getBoundingClientRect();
                const verseCenter = rect.top + window.scrollY + rect.height / 2;
                const dist = Math.abs(verseCenter - viewportCenter);
                if (dist < minDist) {
                    minDist = dist;
                    closestId = verse.id;
                }
            });
            return closestId;
        }

        // Update playAyahAudio to toggle play/pause and handle interruptions with debounce
        function playAyahAudio(surah, ayah) {
            // Prevent multiple rapid clicks with a debounce flag
            if (window.isPlayingAudio) {
                return;
            }
            window.isPlayingAudio = true;

            // If the same ayah is playing, pause it (do not restart)
            if (window.currentAyahAudio && currentAudioSurah === surah && currentAudioAyah === ayah && !window.currentAyahAudio.paused) {
                window.currentAyahAudio.pause();
                console.log('Ayah audio stopped:', { surah, ayah });
                updateAyahHighlights();
                window.isPlayingAudio = false;
                return;
            }
            // Pause and reset any currently playing audio
            if (window.currentAyahAudio) {
                window.currentAyahAudio.pause();
                window.currentAyahAudio = null;
            }
            // Pad numbers to 3 digits
            const surahStr = (Number(surah) + 1).toString().padStart(3, '0');
            const ayahStr = (Number(ayah) + 1).toString().padStart(3, '0');
            
            // Get selected reciter from settings
            const reciterMapping = {
                'ar.alafasy': 'Alafasy_64kbps',
                'ar.husary': 'Husary_64kbps',
                'ar.minshawi': 'Minshawy_Murattal_128kbps',
                'ar.sudais': 'Abdurrahmaan_As-Sudais_64kbps',
                'ar.shuraim': 'Saood_ash-Shuraym_64kbps'
            };
            
            const selectedReciter = currentReciter || 'ar.alafasy';
            const reciter = reciterMapping[selectedReciter] || 'Alafasy_64kbps';
            const url = `https://everyayah.com/data/${reciter}/${surahStr}${ayahStr}.mp3`;
            const audio = new Audio(url);
            
            // Apply playback speed from settings
            audio.playbackRate = currentPlaybackSpeed || 1;
            
            window.currentAyahAudio = audio;
            currentAudioSurah = surah;
            currentAudioAyah = ayah;
            // Use a promise to handle play to avoid AbortError
            audio.play().then(() => {
                console.log('Ayah audio playing:', { surah, ayah, reciter: selectedReciter, speed: currentPlaybackSpeed });
                updateAyahHighlights();
                

                
                window.isPlayingAudio = false;
            }).catch(error => {
                console.error("Audio play error:", error);
                showToast(currentLang === 'ar' ? 'حدث خطأ أثناء تشغيل الصوت' : 'Error playing audio', 'error');
                currentAudioSurah = null;
                currentAudioAyah = null;
                window.currentAyahAudio = null;
                updateAyahHighlights();
                window.isPlayingAudio = false;
            });
            updateAyahHighlights();
            audio.onended = () => {
                currentAudioSurah = null;
                currentAudioAyah = null;
                window.currentAyahAudio = null;
                updateAyahHighlights();
                window.isPlayingAudio = false;
                console.log('Ayah audio stopped (ended):', { surah, ayah });
            };
        }

        // Function to attach event listeners to ayah elements
        window.attachAyahListeners = function() {
            document.querySelectorAll('.ayah').forEach(ayahElem => {
                ayahElem.addEventListener('click', function() {
                    const surah = this.getAttribute('data-surah');
                    const ayah = this.getAttribute('data-ayah');
                    playAyahAudio(parseInt(surah), parseInt(ayah));
                });
            });
        };

        // Update ayah highlighting based on current playing state
        function updateAyahHighlights() {
            document.querySelectorAll('.ayah').forEach(span => {
                const surah = span.getAttribute('data-surah');
                const ayah = span.getAttribute('data-ayah');
                if (Number(surah) === Number(currentAudioSurah) && Number(ayah) === Number(currentAudioAyah) && window.currentAyahAudio && !window.currentAyahAudio.paused) {
                    span.classList.add('ayah-playing');
                } else {
                    span.classList.remove('ayah-playing');
                }
            });
        }

        let prayerHighlightInterval = null;

        function updateNextPrayerHighlight() {
            console.log("--- updateNextPrayerHighlight --- Triggered at", new Date().toLocaleTimeString());
            if (!prayerNotifications || Object.keys(prayerNotifications).length === 0) {
                console.log("Prayer times not available for highlighting or empty.");
                return;
            }
            // console.log("Current prayerNotifications:", JSON.parse(JSON.stringify(prayerNotifications)));

            const now = new Date();
            // console.log("Device current time for highlight check:", now.toLocaleTimeString());
            const prayerOrder = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            let nextPrayerName = null;

            // Remove existing highlights and restore default backgrounds
            prayerOrder.forEach(prayer => {
                const prayerEl = document.getElementById(`azan-${prayer.toLowerCase()}`);
                if (prayerEl) {
                    prayerEl.classList.remove('next-prayer-highlight');
                    // Ensure default Tailwind backgrounds are present when not highlighted
                    prayerEl.classList.add('bg-gray-100', 'dark:bg-gray-700');
                }
            });

            for (const prayerName of prayerOrder) {
                const prayerTimeStr = prayerNotifications[prayerName];
                if (!prayerTimeStr) continue;

                const [hours, minutes] = prayerTimeStr.split(':').map(Number);
                const prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);

                if (prayerDate > now) {
                    nextPrayerName = prayerName;
                    break;
                }
            }

            if (!nextPrayerName) {
                nextPrayerName = 'Fajr';
            }

            if (nextPrayerName) {
                const nextPrayerEl = document.getElementById(`azan-${nextPrayerName.toLowerCase()}`);
                if (nextPrayerEl) {
                    // Remove default Tailwind backgrounds before applying highlight
                    nextPrayerEl.classList.remove('bg-gray-100', 'dark:bg-gray-700');
                    nextPrayerEl.classList.add('next-prayer-highlight');
                }
            }
        }

        function setupPrayerHighlighting() {
            if (prayerHighlightInterval) {
                clearInterval(prayerHighlightInterval);
            }
            updateNextPrayerHighlight(); // Initial call
            prayerHighlightInterval = setInterval(updateNextPrayerHighlight, 60000); // Update every minute
        }

        // Add modal open/close logic and helper for button click
        function closeAdhkarMenuAndLoad(section) {
          document.getElementById('adhkarMenuModal').classList.add('hidden');
          loadAdhkar(section);
        }
        document.addEventListener('DOMContentLoaded', function() {
          const menuBtn = document.getElementById('adhkarMenuBtn');
          const modal = document.getElementById('adhkarMenuModal');
          const closeBtn = document.getElementById('closeAdhkarMenu');
          // Open modal
          menuBtn.addEventListener('click', function() {
            modal.classList.remove('hidden');
          });
          // Close modal by X
          closeBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
          });
          // Close modal by clicking outside
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.classList.add('hidden');
            }
          });
        });

 
      </script>
      <script>
(function() {
  const quranControls = document.querySelector('.quran-controls-sticky');
  const quranHook = document.getElementById('quranHook');
  let lastScrollY = window.scrollY;
  let controlsHidden = false;
  let ticking = false;
  function onScroll() {
    if (!quranControls || !quranHook) return;
    if (window.scrollY > 120 && !controlsHidden) {
      quranControls.classList.add('quran-controls-hidden');
      quranHook.classList.add('quran-hook-visible');
      controlsHidden = true;
    } else if (window.scrollY <= 120 && controlsHidden) {
      quranControls.classList.remove('quran-controls-hidden');
      quranHook.classList.remove('quran-hook-visible');
      controlsHidden = false;
    }
    ticking = false;
  }
  window.addEventListener('scroll', function() {
    if (!ticking) {
      window.requestAnimationFrame(onScroll);
      ticking = true;
    }
  });
  if (quranHook) {
    quranHook.addEventListener('click', function() {
      if (quranControls) {
        quranControls.classList.remove('quran-controls-hidden');
        quranHook.classList.remove('quran-hook-visible');
        controlsHidden = false;
        // Removed: window.scrollTo({top: 0, behavior: 'smooth'});
      }
    });
  }
})();
      </script>
      <script>
document.addEventListener('DOMContentLoaded', function() {
  var quranHook = document.getElementById('quranHook');
  if (quranHook) {
    // Force layout calculation to prevent jump
    void quranHook.offsetWidth;
  }
});
      </script>

<script>
function updateAzkarTypeLabels() {
  const types = [
    ['Morning', 'sabah'],
    ['Evening', 'masaa'],
    ['WakingSleeping', 'waking_sleeping'],
    ['Home', 'home'],
    ['Bathroom', 'bathroom'],
    ['Eating', 'eating'],
    ['Masjid', 'masjid'],
    ['Traveling', 'traveling'],
    ['Clothes', 'clothes'],
    ['Anxiety', 'anxiety'],
    ['Hardship', 'hardship'],
    ['Istighfar', 'istighfar'],
    ['PatienceGratitude', 'patience_gratitude'],
    ['Rabbana', 'rabbana'],
    ['Prophetic', 'prophetic'],
    ['Prophets', 'prophets'],
    ['Rain', 'rain'],
    ['Patient', 'patient'],
    ['Deceased', 'deceased'],
    ['MarriageChildrenRizq', 'marriage_children_rizq'],
    ['Protection', 'protection'],
    ['Salah', 'salah'],
    ['SujoodTashahhud', 'sujood_tashahhud'],
    ['Qunoot', 'qunoot'],
    ['Tahajjud', 'tahajjud'],
    ['Istikhara', 'istikhara'],
    ['Ramadan', 'ramadan'],
    ['Hajj', 'hajj'],
    ['LaylatAlQadr', 'laylat_al_qadr'],
    ['Eid', 'eid'],
    ['NaturalEvents', 'natural_events']
  ];
  types.forEach(([labelIdPrefix, typeKey]) => {
    const el = document.getElementById('label' + labelIdPrefix);
    if (el) {
      // Set text content first
      if (languages[currentLang].azkarTypes[typeKey]) {
        el.textContent = languages[currentLang].azkarTypes[typeKey];
      }
      
      // Clear any previous dynamic font size classes
      el.classList.remove('text-xs', 'text-sm'); 

      if (currentLang === 'en') {
        el.classList.add('text-xs'); // Smaller font for English labels
      } else { // Arabic
        el.classList.add('text-sm'); // Slightly larger font for Arabic labels
      }
    }
  });
}
document.addEventListener('DOMContentLoaded', updateAzkarTypeLabels);
// Patch switchLanguage to also update azkar labels
const origSwitchLanguage = window.switchLanguage;
window.switchLanguage = function() {
  origSwitchLanguage();
  updateAzkarTypeLabels();
};
      </script>
      <script>
(function() {
    // Initialize tafsir selector when modal is shown
  document.addEventListener('DOMContentLoaded', function() {
    const tafsirModal = document.getElementById('tafsirModal');
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
          const tafsirSelect = document.getElementById('tafsirSelect');
          if (tafsirModal.style.display === 'flex' && tafsirSelect) {
            tafsirSelect.value = currentTafsirSource;
            // Remove existing listeners to avoid duplicates
            tafsirSelect.onchange = function() {
              currentTafsirSource = this.value;
              // Reload tafsir content in modal
              document.getElementById('tafsirModalContent').textContent = currentLang === 'ar' ? 'جاري التحميل...' : 'Loading...';
              loadTafsirContent();
            };
          }
        }
      });
    });
    observer.observe(tafsirModal, { attributes: true });
  });
})();
      </script>

<script>
(function() {
  let popover = document.getElementById('ayahMenuPopover');
  let lastAyahElem = null;
  let popoverAyah = null;
  let popoverSurah = null;

  // Helper to close the popover
  function closePopover() {
    popover.style.display = 'none';
    lastAyahElem = null;
    popoverAyah = null;
    popoverSurah = null;
  }

  // Attach popover to ayah click
  document.addEventListener('click', function(e) {
    // If click is on an ayah
    if (e.target.classList.contains('ayah')) {
      e.preventDefault();
      e.stopPropagation();
      lastAyahElem = e.target;
      popoverAyah = parseInt(e.target.getAttribute('data-ayah'));
      popoverSurah = parseInt(e.target.getAttribute('data-surah'));
      // Position popover above the ayah
      const rect = e.target.getBoundingClientRect();
      const scrollY = window.scrollY || window.pageYOffset;
      const scrollX = window.scrollX || window.pageXOffset;
      popover.style.top = (rect.top + scrollY - popover.offsetHeight - 8) + 'px';
      popover.style.left = (rect.left + scrollX + rect.width/2 - popover.offsetWidth/2) + 'px';
      popover.style.display = 'block';
      // Set direction and alignment based on language
      if (currentLang === 'en') {
        popover.style.direction = 'ltr';
        popover.style.textAlign = 'left';
        } else {
        popover.style.direction = 'rtl';
        popover.style.textAlign = 'right';
      }
      // Update menu text/icons based on current state
      const langIsAr = currentLang === 'ar';
      // Update tooltips based on current state and language
      document.getElementById('ayahMenuTranslation').title = isTranslationVisible ? (langIsAr ? 'إخفاء الترجمة' : 'Hide Translation') : (langIsAr ? 'إظهار الترجمة' : 'Show Translation');
      document.getElementById('ayahMenuTafsir').title = isTafsirVisible ? (langIsAr ? 'إخفاء التفسير' : 'Hide Tafsir') : (langIsAr ? 'إظهار التفسير' : 'Show Tafsir');
      // Bookmark icon and tooltip
      const isBookmarked = currentBookmark && currentBookmark.surah === popoverSurah && currentBookmark.ayah === popoverAyah;
      document.getElementById('ayahMenuBookmark').querySelector('i').className = isBookmarked ? 'fas fa-bookmark text-yellow-500' : 'far fa-bookmark';
      document.getElementById('ayahMenuBookmark').title = isBookmarked ? (langIsAr ? 'إزالة العلامة' : 'Remove Bookmark') : (langIsAr ? 'إشارة مرجعية' : 'Bookmark');
      // Play/Stop icon and tooltip
      const isPlaying = window.currentAyahAudio && currentAudioSurah === popoverSurah && currentAudioAyah === popoverAyah && !window.currentAyahAudio.paused;
      const playBtn = document.getElementById('ayahMenuPlay');
      playBtn.querySelector('i').className = isPlaying ? 'fas fa-stop' : 'fas fa-play';
      playBtn.title = isPlaying ? (langIsAr ? 'ايقاف الاية' : 'Stop Ayah') : (langIsAr ? 'تشغيل الآية' : 'Play Ayah');
    } else if (!popover.contains(e.target)) {
      closePopover();
      }
    });
  // Hide popover on scroll
  window.addEventListener('scroll', closePopover);
  // Menu actions
  document.getElementById('ayahMenuPlay').onclick = function() {
    if (popoverSurah !== null && popoverAyah !== null) playAyahAudio(popoverSurah, popoverAyah);
    closePopover();
  };
  document.getElementById('ayahMenuTranslation').onclick = function() {
    if (popoverSurah !== null && popoverAyah !== null) {
      showTranslationModal(popoverSurah, popoverAyah);
    }
    closePopover();
  };
  document.getElementById('ayahMenuTafsir').onclick = function() {
    if (popoverSurah !== null && popoverAyah !== null) {
      showTafsirModal(popoverSurah, popoverAyah);
    }
    closePopover();
  };
  document.getElementById('ayahMenuBookmark').onclick = function() {
    if (popoverSurah !== null && popoverAyah !== null) bookmarkAyah(popoverSurah, popoverAyah);
    closePopover();
  };
})();

// Add tafsir modal functions
let currentTafsirSurah = null;
let currentTafsirAyah = null;

function showTafsirModal(surah, ayah) {
  const modal = document.getElementById('tafsirModal');
  const surahData = quranData[surah];
  const translationAyahs = translationData[surah];
  const ayahData = surahData.ayahs[ayah];
  const translationAyah = translationAyahs.ayahs[ayah];
  
  // Store current ayah for language change
  currentTafsirSurah = surah;
  currentTafsirAyah = ayah;
  
  // Set modal content
  document.getElementById('tafsirModalTitle').textContent = currentLang === 'ar' ? 'التفسير' : 'Tafsir';
  document.getElementById('tafsirModalAyah').textContent = ayahData.text;
  document.getElementById('tafsirModalTranslation').textContent = translationAyah ? translationAyah.text : '';
  document.getElementById('tafsirModalContent').textContent = currentLang === 'ar' ? 'جاري التحميل...' : 'Loading...';
  
  // Show modal
  modal.style.display = 'flex';
  
  // Load tafsir
  loadTafsirContent();
}

function loadTafsirContent() {
  if (currentTafsirSurah !== null && currentTafsirAyah !== null) {
    getTafsirForAyah(currentTafsirSurah, currentTafsirAyah).then(tafsir => {
      document.getElementById('tafsirModalContent').textContent = tafsir.text || (currentLang === 'ar' ? 'لا يوجد تفسير متاح' : 'Tafsir not available');
    });
  }
}

function closeTafsirModal() {
  document.getElementById('tafsirModal').style.display = 'none';
  currentTafsirSurah = null;
  currentTafsirAyah = null;
}

// Close modal handlers
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('closeTafsirModal').onclick = closeTafsirModal;
  document.getElementById('tafsirModal').onclick = function(e) {
    if (e.target === this) closeTafsirModal();
  };
});

// Add translation modal functions
let currentTranslationSurah = null;
let currentTranslationAyah = null;

function showTranslationModal(surah, ayah) {
  const modal = document.getElementById('translationModal');
  const surahData = quranData[surah];
  const ayahData = surahData.ayahs[ayah];
  
  // Store current ayah for translation change
  currentTranslationSurah = surah;
  currentTranslationAyah = ayah;
  
  // Set modal content
  document.getElementById('translationModalTitle').textContent = currentLang === 'ar' ? 'الترجمة' : 'Translation';
  document.getElementById('translationModalAyah').textContent = ayahData.text;
  document.getElementById('translationModalContent').textContent = currentLang === 'ar' ? 'جاري التحميل...' : 'Loading...';
  
  // Show modal
  modal.style.display = 'flex';
  
  // Load translation
  loadTranslationContent();
}

function loadTranslationContent() {
  if (currentTranslationSurah !== null && currentTranslationAyah !== null) {
    const translationAyahs = translationData[currentTranslationSurah];
    const translationAyah = translationAyahs.ayahs[currentTranslationAyah];
    document.getElementById('translationModalContent').textContent = translationAyah ? translationAyah.text : (currentLang === 'ar' ? 'لا توجد ترجمة متاحة' : 'No translation available');
  }
}

function closeTranslationModal() {
  document.getElementById('translationModal').style.display = 'none';
  currentTranslationSurah = null;
  currentTranslationAyah = null;
}

// Close modal handlers for translation modal
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('closeTranslationModal').onclick = closeTranslationModal;
  document.getElementById('translationModal').onclick = function(e) {
    if (e.target === this) closeTranslationModal();
  };
});

// Initialize translation modal dropdown
(function() {
  // Initialize translation language selector when modal is shown
  document.addEventListener('DOMContentLoaded', function() {
    const translationModal = document.getElementById('translationModal');
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
          const translationSelect = document.getElementById('translationSelect');
          if (translationModal.style.display === 'flex' && translationSelect) {
            translationSelect.value = currentTranslationKey;
            // Remove existing listeners to avoid duplicates
            translationSelect.onchange = function() {
              currentTranslationKey = this.value;
              // Reload translation data and content in modal
              handleTranslationChange(this.value).then(() => {
                document.getElementById('translationModalContent').textContent = currentLang === 'ar' ? 'جاري التحميل...' : 'Loading...';
                loadTranslationContent();
              });
            };
          }
        }
      });
    });
    observer.observe(translationModal, { attributes: true });
  });
})();

// Create an alias for backward compatibility
async function displayReadingModeAyahs(shouldScrollToBookmark = false, scrollToVerseId = null) {
  return displayReadingModeAyahsByPages(shouldScrollToBookmark, scrollToVerseId);
}
      </script>

<!-- Tafsir Popup Modal -->
<div id="tafsirModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20000;" class="flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
    <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-3">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="tafsirModalTitle">التفسير</h3>
        <select id="tafsirSelect" class="bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm" title="Select Tafsir - اختر التفسير">
          <optgroup label="Arabic Tafsir - التفسير العربي">
            <option value="1">التفسير الميسر</option>
            <option value="2">تفسير الجلالين</option>
            <option value="3">تفسير السعدي</option>
            <option value="4">تفسير البغوي</option>
            <option value="5">تفسير القرطبي</option>
            <option value="6">تفسير ابن كثير</option>
            <option value="7">تفسير الطبري</option>
          </optgroup>
          <optgroup label="English Tafsir">
            <option value="en-jalalayn">Tafsir al-Jalalayn (English)</option>
            <option value="en-kathir">Tafsir Ibn Kathir (English)</option>
            <option value="en-maarif">Ma'ariful Quran (English)</option>
            <option value="en-tazkirul">Tazkirul Quran (English)</option>
          </optgroup>
        </select>
      </div>
      <button id="closeTafsirModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl">&times;</button>
    </div>
    <div class="p-4">
      <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
        <div class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2" id="tafsirModalAyah">الآية</div>
        <div class="text-lg text-gray-600 dark:text-gray-400" id="tafsirModalTranslation">Translation</div>
      </div>
      <div class="text-base text-gray-700 dark:text-gray-300 leading-relaxed" id="tafsirModalContent">جاري التحميل...</div>
    </div>
  </div>
</div>

<!-- Translation Popup Modal -->
<div id="translationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20000;" class="flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
    <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-3">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="translationModalTitle">الترجمة</h3>
        <select id="translationSelect" class="bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm" title="Select Translation - اختر الترجمة">
          <optgroup label="English">
            <option value="en.sahih">English (Sahih International)</option>
            <option value="en.pickthall">English (Pickthall)</option>
            <option value="en.yusufali">English (Yusuf Ali)</option>
            <option value="en.hilali">English (Hilali-Khan)</option>
            <option value="en.arberry">English (Arberry)</option>
            <option value="en.asad">English (Muhammad Asad)</option>
            <option value="en.daryabadi">English (Daryabadi)</option>
            <option value="en.shakir">English (Shakir)</option>
          </optgroup>
          <optgroup label="European">
            <option value="fr.hamidullah">Français (Hamidullah)</option>
            <option value="fr.leclerc">Français (Leclerc)</option>
            <option value="de.bubenheim">Deutsch (Bubenheim)</option>
            <option value="de.khoury">Deutsch (Khoury)</option>
            <option value="es.cortes">Español (Cortés)</option>
            <option value="es.garcia">Español (García)</option>
            <option value="it.piccardo">Italiano (Piccardo)</option>
            <option value="pt.elhayek">Português (El Hayek)</option>
            <option value="ru.kuliev">Русский (Кулиев)</option>
            <option value="ru.osmanov">Русский (Османов)</option>
            <option value="nl.keyzer">Nederlands (Keyzer)</option>
            <option value="bs.korkut">Bosanski (Korkut)</option>
            <option value="cs.hrbek">Čeština (Hrbek)</option>
            <option value="no.berg">Norsk (Berg)</option>
            <option value="sv.bernstrom">Svenska (Bernström)</option>
            <option value="sq.ahmeti">Shqip (Ahmeti)</option>
          </optgroup>
          <optgroup label="Middle East & Central Asia">
            <option value="tr.diyanet">Türkçe (Diyanet)</option>
            <option value="tr.bulac">Türkçe (Bulaç)</option>
            <option value="ur.junagarhi">اردو (جونا گاری)</option>
            <option value="ur.kanzuliman">اردو (کنز الایمان)</option>
            <option value="fa.ansarian">فارسی (انصاریان)</option>
            <option value="fa.makarem">فارسی (مکارم شیرازی)</option>
            <option value="az.mammadaliyev">Azərbaycan (Məmmədəliyev)</option>
            <option value="ku.asan">کوردی (ئاسان)</option>
          </optgroup>
          <optgroup label="South & Southeast Asia">
            <option value="id.indonesian">Bahasa Indonesia (Kementerian Agama)</option>
            <option value="ms.basmeih">Bahasa Melayu (Basmeih)</option>
            <option value="bn.bengali">বাংলা (মুহিউদ্দীন খান)</option>
            <option value="hi.hindi">हिन्दी (फारूक खान)</option>
            <option value="ta.tamil">தமிழ் (ஜான் டிரஸ்ட்)</option>
            <option value="th.thai">ไทย (สำนักงานพระราชวัง)</option>
          </optgroup>
          <optgroup label="East Asia">
            <option value="zh.jian">中文简体 (马坚译)</option>
            <option value="ja.japanese">日本語 (森亮一)</option>
            <option value="ko.korean">한국어 (최하메드)</option>
          </optgroup>
          <optgroup label="African">
            <option value="ha.gumi">Hausa (Abubakar Gumi)</option>
            <option value="sw.barwani">Kiswahili (Barwani)</option>
            <option value="so.abduh">Soomaali (Abduh)</option>
            <option value="am.sadiq">አማርኛ (ሳዲቅ)</option>
            <option value="yo.mikail">Yorùbá (Mikail)</option>
          </optgroup>
        </select>
      </div>
      <button id="closeTranslationModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl">&times;</button>
    </div>
    <div class="p-4">
      <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
        <div class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2" id="translationModalAyah">الآية</div>
      </div>
      <div class="text-base text-gray-700 dark:text-gray-300 leading-relaxed" id="translationModalContent">Translation</div>
    </div>
  </div>
</div>

<!-- Surah Selection Side Menu -->
<div id="surahSideMenu" class="fixed inset-y-0 left-0 w-80 bg-white dark:bg-black shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out z-30 overflow-hidden border-r border-gray-200 dark:border-gray-800">
  <div class="flex flex-col h-full">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-black">
      <h3 class="text-lg font-semibold text-black dark:text-white">اختر السورة</h3>
      <button id="closeSurahMenu" class="text-black dark:text-white hover:text-gray-600 dark:hover:text-gray-400 text-xl p-1">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Search Box -->
    <div class="p-4 border-b border-gray-200 dark:border-gray-800">
      <div class="relative">
        <input 
          type="text" 
          id="surahSearchInput" 
          placeholder="ابحث عن السورة... Search surah..."
          class="w-full px-4 py-2 pl-10 pr-4 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-1 focus:ring-black dark:focus:ring-white focus:border-black dark:focus:border-white text-sm text-black dark:text-white"
        >
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-400"></i>
      </div>
    </div>
    
    <!-- Surah List -->
    <div class="flex-1 overflow-y-auto">
      <div id="surahList" class="p-2">
        <!-- Surah items will be populated here -->
      </div>
    </div>
  </div>
</div>

<!-- Overlay for side menu -->
<div id="surahMenuOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>

</body>
</html>
