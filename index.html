    <!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Add iOS-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Sakinah">
    <link rel="apple-touch-icon" href="icon1.png">
    <link rel="manifest" href="manifest.json">
    <!-- Add favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Reliable Quran fonts from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400&display=swap" rel="stylesheet">
    <title>Sakinah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1a1a',
                            text: '#ffffff',
                            primary: '#3B82F6',
                            secondary: '#4B5563'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .buttonActive {
            color: #f39c12; /* Example color (golden/yellow) */
            transform: scale(1.2); /* Slightly enlarge the element */
            transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        /* Dark mode transitions - optimized */
        * {
            transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
        }

        /* --- CONSOLIDATED ANIMATIONS START --- */
        @keyframes fadeInSimple {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes quranHookFadeInFromTop {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px); /* Include translateX for centering */
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0); /* Include translateX for centering */
    }
}

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeInFromBottom { /* For toast notifications */
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes fadeOutToBottom { /* For toast notifications */
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }

        @keyframes fadeInFromTop { /* For general UI elements */
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Animation Utility Classes - optimized */
        .animate-toast-in {
            animation: fadeInFromBottom 0.15s ease-out forwards;
        }

        .animate-toast-out {
            animation: fadeOutToBottom 0.15s ease-out forwards;
        }

        .animate-general-fade-in {
            animation: fadeInFromTop 0.2s ease-out forwards;
        }
        /* --- CONSOLIDATED ANIMATIONS END --- */

        /* Dark mode specific styles */
        .dark .toast {
            background: rgba(0, 0, 0, 0.9);
        }

        .dark .toast.success {
            background: rgba(34, 197, 94, 0.9);
        }

        .dark .toast.info {
            background: rgba(59, 130, 246, 0.9);
        }

        /* Dark mode for select elements */
        .dark select {
            background-color: #1f2937;
            color: #f3f4f6;
            border-color: #374151;
        }

        .dark select option {
            background-color: #1f2937;
            color: #f3f4f6;
        }

       /* Dark mode for buttons */
               .dark button:not(.bg-blue-500):not(.bg-green-500):not(#langToggle):not(#btnBack):not(.ayah-play-btn):not(#closeTafsirModal):not(#darkModeToggle):not(#closeTranslationModal):not(#closeSurahMenu):not(#surahMenuBtn):not(#settingsBtn):not(#closeSettingsBtn):not(#currentFontSize):not(#decreaseBtn):not(#increaseBtn) { /* Added :not(#langToggle) */
            background-color: #374151;
            color: #f3f4f6;
        }

        .dark button:hover:not(.bg-blue-500):not(.bg-green-500):not(#langToggle):not(#btnBack):not(.ayah-play-btn):not(#ayahMenuPlay):not(#ayahMenuTranslation):not(#ayahMenuTafsir):not(#ayahMenuBookmark):not(#closeTafsirModal):not(#darkModeToggle):not(#closeTranslationModal):not(#closeSurahMenu):not(#surahMenuBtn):not(#closeSettingsBtn):not(#currentFontSize){
            background-color: #4b5563;
        }

        /* Dark mode for cards */
        .dark .bg-white {
            background-color: #1f2937;
        }

        /* Dark mode for text */
        .dark .text-gray-600 {
            color: #d1d5db;
        }

        .dark .text-gray-500 {
            color: #9ca3af;
        }

        /* Dark mode for borders */
        .dark .border-gray-200 {
            border-color: #374151;
        }

        /* Dark mode for hover states */
        .dark .hover\\:bg-gray-100:hover {
            background-color: #374151;
        }

        /* Dark mode for shadows */
        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        /* Reading Progress Bar Styles */
        .reading-progress-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .reading-progress-container.visible {
            opacity: 1;
        }

        .reading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6, #10B981);
            transition: width 0.15s ease;
            width: 0%;
            border-radius: 0 2px 2px 0;
        }

        .dark .reading-progress-container {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .dark .reading-progress-bar {
            background: linear-gradient(90deg, #60A5FA, #34D399);
        }

        /* Mobile Navigation Buttons */
        .mobile-nav-buttons {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 16px 0 8px 0;
        }

        .mobile-nav-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3B82F6;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            transition: transform 0.1s ease;
            min-width: 70px;
            touch-action: manipulation;
        }

        .mobile-nav-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.5);
            transform: scale(1.05);
        }

        .mobile-nav-btn:disabled {
            background: rgba(156, 163, 175, 0.1);
            border-color: rgba(156, 163, 175, 0.3);
            color: #9CA3AF;
            transform: none;
        }

        .dark .mobile-nav-btn {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.3);
            color: #60A5FA;
        }

        .dark .mobile-nav-btn:hover {
            background: rgba(96, 165, 250, 0.15);
            border-color: rgba(96, 165, 250, 0.5);
        }

        .dark .mobile-nav-btn:disabled {
            background: rgba(156, 163, 175, 0.1);
            border-color: rgba(156, 163, 175, 0.3);
            color: #6B7280;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .reading-progress-container {
                height: 3px;
            }

            .mobile-nav-buttons {
                display: flex;
            }
        }

        /* --- COMPONENT STYLES --- */
        
        /* Qibla / AR Styles */
        #compass {
            position: relative;
            width: 16rem;
            height: 16rem;
            animation: fadeInSimple 0.2s ease-in; /* USE CONSOLIDATED */
        }

        #qiblaNeedle {
            transition: transform 0.1s ease-out;
            transform-origin: bottom center;
        }

        #kaabaIndicator {
            position: absolute;
            width: 48px;
            height: 48px;
            top: 0;
            left: 0;
            will-change: transform, opacity;
            z-index: 100;
            pointer-events: none;
            filter: drop-shadow(0 0 12px rgba(255, 200, 50, 0.7));
            transition: transform 0.2s ease-out, opacity 0.3s ease; /* Used 0.3s from a later definition */
        }

        #arUnsupported {
            animation: slideIn 0.3s ease-out; /* USE CONSOLIDATED */
        }

        #arCamera {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Removed transform: scaleX(-1) to fix inverted camera */
        }

        #arCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        #qiblaDegree {
            backdrop-filter: blur(10px);
            font-family: monospace;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        #flipCameraBtn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
            transition: all 0.2s ease;
        }

        @supports (-webkit-touch-callout: none) { /* iOS Specific AR fix */
            #kaabaIndicator {
                transform: translateZ(0);
            }
        }
        
        /* Enhanced Qibla AR Styles */
        #directionArrow {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        #compassRose {
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }
        
        #kaabaIndicator {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }
        
        #alignmentRings .animate-pulse {
            animation: pulse-ring 2s infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translateY(0);
            }
            40%, 43% {
                transform: translateY(-10px);
            }
            70% {
                transform: translateY(-5px);
            }
        }
        
        @keyframes qibla-success {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(34, 197, 94, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(34, 197, 94, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(34, 197, 94, 0.5); }
        }
        
        /* Enhanced Qibla Alignment Animations */
        @keyframes qibla-perfect-alignment {
            0% { 
                transform: scale(1) rotate(0deg); 
                box-shadow: 0 0 0 rgba(34, 197, 94, 0.8);
                filter: brightness(1);
            }
            25% { 
                transform: scale(1.15) rotate(2deg); 
                box-shadow: 0 0 30px rgba(34, 197, 94, 1);
                filter: brightness(1.2);
            }
            50% { 
                transform: scale(1.2) rotate(-1deg); 
                box-shadow: 0 0 40px rgba(34, 197, 94, 0.9);
                filter: brightness(1.3);
            }
            75% { 
                transform: scale(1.15) rotate(1deg); 
                box-shadow: 0 0 35px rgba(34, 197, 94, 1);
                filter: brightness(1.2);
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                box-shadow: 0 0 0 rgba(34, 197, 94, 0.8);
                filter: brightness(1);
            }
        }
        
        @keyframes qibla-glow-pulse {
            0% { 
                box-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
                background: linear-gradient(45deg, #22c55e, #16a34a);
            }
            50% { 
                box-shadow: 0 0 25px rgba(34, 197, 94, 0.9);
                background: linear-gradient(45deg, #16a34a, #22c55e);
            }
            100% { 
                box-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
                background: linear-gradient(45deg, #22c55e, #16a34a);
            }
        }
        
        @keyframes qibla-text-glow {
            0% { 
                text-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
                color: #16a34a;
            }
            50% { 
                text-shadow: 0 0 15px rgba(34, 197, 94, 0.8);
                color: #22c55e;
            }
            100% { 
                text-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
                color: #16a34a;
            }
        }
        
        @keyframes qibla-ring-expand {
            0% { 
                transform: scale(1);
                opacity: 0.8;
                border-width: 2px;
            }
            50% { 
                transform: scale(1.3);
                opacity: 0.4;
                border-width: 3px;
            }
            100% { 
                transform: scale(1.6);
                opacity: 0;
                border-width: 1px;
            }
        }
        
        .qibla-perfect-aligned {
            animation: qibla-perfect-alignment 1.5s ease-in-out infinite;
        }
        
        .qibla-glow {
            animation: qibla-glow-pulse 2s ease-in-out infinite;
        }
        
        .qibla-text-glow {
            animation: qibla-text-glow 1.5s ease-in-out infinite;
        }
        
        .qibla-ring-expand {
            animation: qibla-ring-expand 2s ease-in-out infinite;
        }

        /* General UI Element Styles */
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .clicked {
            transform: scale(1.03);
            opacity: 0.95;
            transition: transform 0.15s ease-out, opacity 0.15s ease-out;
        }

        /* Islamic Pattern Background */
        .islamic-pattern {
            position: relative;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(139, 69, 19, 0.03) 0%, transparent 50%);
        }
        
        .islamic-pattern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 8px, rgba(59, 130, 246, 0.015) 8px, rgba(59, 130, 246, 0.015) 16px),
                repeating-linear-gradient(-45deg, transparent, transparent 8px, rgba(139, 69, 19, 0.015) 8px, rgba(139, 69, 19, 0.015) 16px);
            pointer-events: none;
            z-index: -1;
        }

        /* Tasbih Button - Prevent zoom and improve touch */
        #tasbihContent button[onclick="incrementTasbih()"] {
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Prevent double-tap zoom on mobile */
        @media (max-width: 768px) {
            #tasbihContent {
                touch-action: manipulation;
            }
            
            #tasbihContent button[onclick="incrementTasbih()"] {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
                -webkit-tap-highlight-color: rgba(0,0,0,0);
            }
        }

        /* LTR Text Styling */
        .ltr-text {
            direction: ltr !important;
            text-align: left !important;
            unicode-bidi: embed;
        }
        
        /* When main language is English, Arabic text should be RTL */
        [dir="ltr"] .arabic-text {
            direction: rtl !important;
            text-align: right !important;
            unicode-bidi: embed;
        }

        /* Dhikr Counter Animations */
        .dhikr-counter {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dhikr-counter.animate-count {
            transform: scale(1.2);
            color: #10b981;
        }
        
        .dhikr-counter.animate-count.dark {
            color: #34d399;
        }
        
        .dhikr-complete {
            animation: celebration 0.8s ease-out;
        }
        
        @keyframes celebration {
            0% { transform: scale(1); }
            25% { transform: scale(1.1) rotate(2deg); }
            50% { transform: scale(1.05) rotate(-1deg); }
            75% { transform: scale(1.08) rotate(1deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        .counter-pulse {
            animation: pulse-glow 0.6s ease-out;
        }
        
        @keyframes pulse-glow {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% { 
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(59, 130, 246, 0);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
        
        .number-flip {
            animation: flip-number 0.4s ease-in-out;
        }
        
        @keyframes flip-number {
            0% { transform: rotateX(0deg); }
            50% { transform: rotateX(90deg); }
            100% { transform: rotateX(0deg); }
        }
        
        /* Progress ring animation */
        .progress-ring {
            transition: stroke-dashoffset 0.3s ease-in-out;
        }
        
        .progress-ring-complete {
            animation: ring-pulse-complete 1.5s ease-out;
        }
        
        @keyframes ring-pulse-complete {
            0% { 
                stroke-width: 8;
                filter: drop-shadow(0 0 0 rgba(16, 185, 129, 0.8));
            }
            25% { 
                stroke-width: 12;
                filter: drop-shadow(0 0 15px rgba(16, 185, 129, 0.9));
            }
            50% { 
                stroke-width: 10;
                filter: drop-shadow(0 0 20px rgba(16, 185, 129, 0.7));
            }
            75% { 
                stroke-width: 12;
                filter: drop-shadow(0 0 15px rgba(16, 185, 129, 0.8));
            }
            100% { 
                stroke-width: 8;
                filter: drop-shadow(0 0 0 rgba(16, 185, 129, 0.5));
            }
        }
        
        /* Confetti animation */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Tab Navigation */
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #6B7280;
            font-weight: 500;
            font-size: 0.9rem;
            position: relative;
            background: transparent;
            border: 1px solid transparent;
            margin: 0 1px;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: #3B82F6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border-color: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }
        
        .tab.active {
            color: white;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            border-color: #2563EB;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        /* Dark mode tab styles */
        .dark .tab {
            color: #9CA3AF;
        }
        
        .dark .tab:hover {
            color: #60A5FA;
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(96, 165, 250, 0.08));
            border-color: rgba(96, 165, 250, 0.3);
            box-shadow: 0 2px 8px rgba(96, 165, 250, 0.2);
        }
        
        /* Quran Search Styles */
        .quran-search-container {
            position: relative;
        }
        
        .search-result-item {
            transition: all 0.2s ease-in-out;
        }
        
        .search-result-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .search-result-item:active {
            transform: translateY(0);
        }
        
        /* Custom scrollbar for search results */
        #quranSearchResults::-webkit-scrollbar {
            width: 6px;
        }
        
        #quranSearchResults::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }
        
        #quranSearchResults::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        #quranSearchResults::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .dark #quranSearchResults::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .dark #quranSearchResults::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .dark #quranSearchResults::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .dark .tab.active {
            color: white;
            background: linear-gradient(135deg, #60A5FA, #3B82F6);
            border-color: #3B82F6;
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* Modern Modal Button Styles */
        #adhkarMenuModal button:not(#closeAdhkarMenu) {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.8), rgba(249, 250, 251, 0.8));
            border: 1px solid rgba(229, 231, 235, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(1);
        }
        
        #adhkarMenuModal button:not(#closeAdhkarMenu):hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15);
            background: linear-gradient(145deg, rgba(249, 250, 251, 0.9), rgba(243, 244, 246, 0.9));
        }
        
        .dark #adhkarMenuModal button:not(#closeAdhkarMenu) {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.8));
            border-color: rgba(75, 85, 99, 0.8);
        }
        
        .dark #adhkarMenuModal button:not(#closeAdhkarMenu):hover {
            background: linear-gradient(145deg, rgba(55, 65, 81, 0.9), rgba(31, 41, 55, 0.9));
        }
        
        #adhkarMenuModal button:not(#closeAdhkarMenu) i {
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        
        .dark #adhkarMenuModal button:not(#closeAdhkarMenu) i {
            background-color: rgba(17, 24, 39, 0.8);
        }
        
        #adhkarMenuModal button:not(#closeAdhkarMenu) span {
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease; /* This handles the show/hide opacity */
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .toast.show {
            opacity: 1;
        }

        .toast i {
            font-size: 1.2em;
        }

        /* Mobile Layout Fixes */
        @media (max-width: 768px) {
            /* Fix header and navigation */
            header {
                padding: 0.001rem 0.05rem;
                font-size: 0.5rem;
            }

            /* Fix tab navigation */
            .tab { /* This was duplicated, keeping one */
                padding: 8px 12px;
                font-size: 0.8rem;  
                white-space: nowrap;
                margin: 0 1px;
            }
            
            .tab:hover, .tab.active {
                transform: none; /* Disable transform on mobile for better performance */
            }

            /* Fix Quran content layout - but NOT the sticky controls */
            /* Selectors like #quranContent .flex.justify-between might need review if #quranContent is used multiple times in HTML */
            /* Assuming #quranContent refers to the main Quran tab content area */
            div#quranContent.tab-content .flex.justify-between:not(.quran-controls-sticky) { /* Made selector more specific and exclude sticky controls */
                flex-direction: column;
                gap: 1rem;
            }

            div#quranContent.tab-content .flex.gap-2:not(.quran-controls-sticky *) { /* Made selector more specific and exclude sticky controls children */
                flex-wrap: wrap;
                justify-content: center;
            }

            /* Fix select dropdowns - completely reset and rebuild */
            select { 
                /* Remove ALL native styling */
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                
                /* Add our custom styling */
                background-color: #fff !important;
                border: 1px solid #e5e7eb !important;
                border-radius: 0.5rem;
                padding: 0.5rem 0.5rem 0.5rem 2.5rem;
                font-size: 1rem;
                width: 100%;
                text-align: right;
                direction: rtl;
                color: #000 !important;
                
                /* Add our custom arrow */
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
                background-repeat: no-repeat !important;
                background-position: left 0.5rem center !important;
                background-size: 1.5em 1.5em !important;
            }
            
            /* Remove native dropdown arrows completely */
            select {
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
            }
            
            select::-ms-expand {
                display: none !important;
            }
            
            /* Additional browser-specific arrow removal */
            select::-webkit-inner-spin-button,
            select::-webkit-outer-spin-button {
                -webkit-appearance: none !important;
                margin: 0 !important;
            }
            
            /* English dropdowns should use LTR */
            select[data-lang="en"], select.ltr {
                background-position: right 0.5rem center;
                padding-left: 0.5rem;
                padding-right: 2.5rem;
                text-align: left;
                direction: ltr;
            }

            /* Fix buttons layout */
            /* This selector seems quite generic, ensure it targets the correct element */
            /* For instance, if it's for Quran nav buttons: */
            div#quranContent.tab-content .flex.justify-between.mt-6 { 
                flex-direction: column;
                gap: 1rem;
            }

            div#quranContent.tab-content .flex.justify-between.mt-6 > * {
                width: 100%;
            }



            /* Fix reading mode buttons - but preserve our horizontal layout */
            /* This selector is also generic, assumed to be within Quran controls */
            .quran-controls-sticky .flex.gap-2:not(.flex.items-center.gap-1) {
                justify-content: center;
                width: 100%;
            }

            /* Fix translation toggle */
            #toggleTranslation, #toggleBookmark { /* This might be #toggleTafsir as well? */
                padding: 0.5rem;
            }

            /* Fix surah select container */
            #surahSelect, #translationSelect {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            /* Mobile responsive for horizontal header */
            .quran-controls-sticky {
                margin: -1rem -1rem 1rem -1rem;
                padding: 0.5rem 0.75rem;
                gap: 0.25rem;
                flex-wrap: nowrap !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: center !important;
            }
            
            .quran-controls-sticky > div {
                flex-shrink: 0;
                min-width: 0;
            }
            
            /* Force horizontal layout on mobile */
            .quran-controls-sticky.flex.items-center.justify-between {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
            }
            
            /* Left section - controls */
            .quran-controls-sticky > div:first-child {
                flex: 0 0 auto;
                max-width: 25%;
            }
            
            /* Center section - page/juz indicator */
            .quran-controls-sticky > div:nth-child(2) {
                flex: 0 1 auto;
                text-align: center;
            }
            
            /* Right section - surah selector */
            .quran-controls-sticky > div:last-child {
                flex: 1 1 auto;
                min-width: 120px;
                max-width: 60%;
            }
            
            .quran-controls-sticky #selectedSurahText {
                max-width: 140px;
                min-width: 80px;
                font-size: 0.7rem;
            }
            
            .quran-controls-sticky #surahMenuBtn {
                min-width: 100px;
                padding: 0.3rem 0.5rem !important;
            }
            
            .quran-controls-sticky button {
                padding: 0.3rem !important;
                font-size: 0.7rem;
            }

            .quran-controls-sticky .flex.items-center.gap-1 {
                gap: 0.125rem;
            }

            .quran-controls-sticky .flex.items-center.gap-1 button {
                padding: 0.3rem 0.4rem !important;
            }
            
            /* Fix Quran settings sidebar on mobile */
            #quranSettingsMenu {
                width: 100vw !important;
                right: 0 !important;
                left: auto !important;
            }
            
            #quranSettingsMenu .flex.items-center.justify-between {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                align-items: center !important;
                padding: 1rem !important;
                gap: 1rem !important;
            }
            
            #quranSettingsMenu h3 {
                font-size: 0.9rem !important;
                flex: 1 1 auto !important;
                min-width: 0 !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
                margin: 0 !important;
            }
            
            #quranSettingsMenu .flex.items-center.justify-between button {
                flex: 0 0 auto !important;
                min-width: 44px !important;
                min-height: 44px !important;
                padding: 0.5rem !important;
                margin: 0 !important;
            }
        }

        /* iOS-specific fixes */
        @supports (-webkit-touch-callout: none) {
            select { /* This will override the general select styling on iOS */
                -webkit-appearance: none !important;
                appearance: none !important;
                background-color: #fff !important;
                border: 1px solid #e5e7eb !important;
                border-radius: 0.5rem;
                padding: 0.5rem 0.5rem 0.5rem 2.5rem; /* RTL: left padding for arrow */
                font-size: 1rem;
                width: 100%;
                text-align: right;
                direction: rtl;
                color: #000 !important;
                /* Background image is inherited from general rule */
            }
            
            /* English dropdowns on iOS */
            select[data-lang="en"], select.ltr {
                padding: 0.5rem 2.5rem 0.5rem 0.5rem !important; /* LTR: right padding for arrow */
                background-position: right 0.5rem center !important; /* LTR: arrow on right */
                text-align: left;
                direction: ltr;
            }

            select:focus {
                outline: none;
                border-color: #3B82F6;
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
            }

            select option { /* iOS option styling */
                padding: 0.5rem;
                font-size: 1rem;
                background-color: #fff; /* Specific for iOS light mode */
            }

            /* Fix for iOS select dropdown - remove all native arrows */
            select::-ms-expand {
                display: none;
            }
            
            /* Force remove all native select styling */
            select {
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
            }
            
            select::-webkit-inner-spin-button,
            select::-webkit-outer-spin-button {
                -webkit-appearance: none !important;
                margin: 0 !important;
            }

            /* Ensure the select is clickable */
            select:active,
            select:focus {
                -webkit-tap-highlight-color: transparent;
            }

            /* Fix for iOS select text alignment */
            select option { /* This is duplicated, ensure it's intended */
                text-align: right;
                direction: rtl;
            }
        }

        /* Android-specific fixes */
        /* Styles for 'select' on Android if needed, currently basic */
        @supports not (-webkit-touch-callout: none) { /* This targets non-iOS, effectively Android for this context */
            select {
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                background-color: #fff !important;
                border: 1px solid #e5e7eb !important;
                border-radius: 0.5rem;
                padding: 0.5rem 0.5rem 0.5rem 2.5rem; /* RTL: left padding for arrow */
                font-size: 1rem;
                text-align: right;
                direction: rtl;
                color: #000 !important;
                /* Background image is inherited from general rule */
            }
            
            /* English dropdowns on Android */
            select[data-lang="en"], select.ltr {
                padding: 0.5rem 2.5rem 0.5rem 0.5rem !important; /* LTR: right padding for arrow */
                background-position: right 0.5rem center !important; /* LTR: arrow on right */
                text-align: left;
                direction: ltr;
            }
        }
        
        /* Quran Sticky Controls */
        .quran-controls-sticky {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #fff; /* Default light mode */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            transition: transform 0.3s cubic-bezier(.4,2,.6,1), opacity 0.3s;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .quran-controls-sticky {
            background: #1f2937; /* Dark mode */
            border-bottom-color: #374151;
        }
        .quran-controls-hidden {
          transform: translateY(-120%);
          opacity: 0;
          pointer-events: none;
        }
   


        /* Prayer Time Highlighting */
        .next-prayer-highlight { /* Base for light mode */
            background-color: #e0f2fe !important; 
            border-left: 4px solid #0ea5e9 !important; /* Added !important for consistency */
            font-weight: 600 !important; /* Added !important for consistency */
            color: #0ea5e9 !important; /* Ensuring text color contrasts, added !important */
        }

        .dark .next-prayer-highlight { /* For dark mode */
            background-color: #80c8f7  !important; 
            border-left-color: #0ea5e9 !important; /* Added !important */
            color: #f0f9ff !important; 
        }

        

        /* Modern Prayer Times Highlight Styles */
        #prayerContent .next-prayer-highlight {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(16, 185, 129, 0.9)) !important;
            border: 2px solid rgba(34, 197, 94, 0.5) !important;
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1) !important;
            transform: scale(1.02) !important;
            animation: prayerPulse 2s ease-in-out infinite !important;
        }
        
        .dark #prayerContent .next-prayer-highlight {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.8), rgba(16, 185, 129, 0.8)) !important;
            border: 2px solid rgba(34, 197, 94, 0.6) !important;
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1) !important;
        }

        /* Text styling for highlighted prayer */
        #prayerContent .next-prayer-highlight span {
            color: white !important;
            font-weight: 700 !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        }

        /* Icon styling for highlighted prayer */
        #prayerContent .next-prayer-highlight .w-10 {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7)) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        #prayerContent .next-prayer-highlight .w-10 i {
            color: #059669 !important;
        }

        /* Pulse animation for next prayer */
        @keyframes prayerPulse {
            0%, 100% {
                box-shadow: 0 8px 32px rgba(34, 197, 94, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
            }
            50% {
                box-shadow: 0 8px 32px rgba(34, 197, 94, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.2);
            }
        }

        /* General Fade transitions (often used with JS toggles) */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px); /* This is different from fadeInFromTop */
            transition: all 0.4s ease;
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-leave {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s ease;
        }
        .fade-leave-active {
            opacity: 0;
            transform: translateY(10px);
        }

        /* Enhanced verse styling for better desktop reading */
        .ayah {
            transition: background-color 0.2s ease;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        
        .ayah:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .dark .ayah:hover {
            background-color: rgba(59, 130, 246, 0.2);
        }

        /* Better spacing for desktop reading */
        @media (min-width: 768px) {
            .text-2xl.leading-loose {
                line-height: 2.4 !important;
            }
        }

        /* Improved container for better reading flow */
        .quran-reading-container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        @media (min-width: 768px) {
            .quran-reading-container {
                padding: 3rem 2rem;
            }
        }
        @font-face {
            font-family: 'KFGQPC Uthmanic Script HAFS';
            src: url('https://cdn.jsdelivr.net/gh/quran/quran.com-frontend@master/static/fonts/KFGQPC-Uthmanic-Script-HAFS.woff2') format('woff2'),
                 url('https://cdn.jsdelivr.net/gh/quran/quran.com-frontend@master/static/fonts/KFGQPC-Uthmanic-Script-HAFS.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
    font-family: 'KFGQPC Uthman Taha Naskh';
    src: url('fonts/UtmanTahaNaskh.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

        @font-face {
    font-family: 'AlMushafQuran';
    src: url('fonts/AlMushafQuran.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}


        .quran-uthmani-font {
    font-family: 'Quran.com Font', Arial, sans-serif;
    font-size: 2rem;
    line-height: 2.5rem;
    letter-spacing: 0.01em;
    font-weight: bold;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
        }

        /* Font Family Options */
        .font-quran-original {
            font-family: 'UthmanicHafs1Ver18', 'Quran.com Font', Arial, sans-serif;
        }
        
        .font-utman-taha {
            font-family: 'KFGQPC Uthman Taha Naskh', 'UtmanTahaNaskh', Arial, sans-serif;
        }
        
        .font-al-mushaf {
            font-family: 'AlMushafQuran', Arial, sans-serif;
        }
        
        .font-system-arabic {
            font-family: Arial, Tahoma, 'Segoe UI', sans-serif;
        }

        /* Settings Menu Overlay */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }


        .ayah {
            display: inline;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .ayah:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .dark .ayah:hover {
            background-color: rgba(96, 165, 250, 0.2);
        }
        .ayah-playing {
            background-color: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        .dark .ayah-playing {
            background-color: rgba(96, 165, 250, 0.3);
            color: #60a5fa;
        }
            .verse-marker {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            cursor: pointer;
            margin: 0 0.25rem;
            vertical-align: middle;
            transition: box-shadow 0.25s, filter 0.25s;
        }
        .verse-marker:hover, .verse-marker:focus {
            z-index: 2;
        }
        .verse-marker:hover .verse-icon, .verse-marker:focus .verse-icon {
            filter: drop-shadow(0 0 8px #3b82f6aa) brightness(1.2);
            transition: filter 0.2s;
        }
        .dark .verse-marker:hover .verse-icon, .dark .verse-marker:focus .verse-icon {
            filter: drop-shadow(0 0 10px #60a5fa) brightness(1.3);
        }
        .verse-icon {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('icons/seperator.svg');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .verse-number {
            position: relative;
            z-index: 1;
            font-size: 0.8rem;
            font-weight: bold;
            color: #2d3748; /* gray-800 */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }
        
        /* Ensure page numbers and UI elements don't inherit Quran font */
        .page-header, .page-header *, .text-blue-700, .text-blue-300 {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }
        
        /* Quran.com exact font - UthmanicHafs1 Ver18 */
        @font-face {
            font-family: 'Quran.com Font';
            src: url('fonts/UthmanicHafs1Ver18.ttf?v=3') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'Quran.com Font';
            src: url('fonts/UthmanicHafs1Ver18.ttf?v=3') format('truetype');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        
        /* Local font fallback */
        @font-face {
            font-family: 'Uthmani Local';
            src: url('fonts/UtmanTahaNaskh.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        .dark .verse-number {
            color: #f7fafc; /* gray-100 */
        }

        /* Ayah Context Menu Popover */
        #ayahMenuPopover {
            display: none;
            position: absolute;
            z-index: 10000;
            min-width: 180px;
            max-width: 260px;
            background-color: #fff;
            border: 0.1px solid #ccc;
            border-radius: 0.375rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 10px;
            transition: opacity 0.3s ease;
            word-break: break-word;
            white-space: normal;
        }

        #ayahMenuPopover button {
            display: block;
            width: 100%;
            padding: 5px 0;
            color: #333;
            border: none;
            background: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-align: inherit;
            white-space: normal;
        }

        #ayahMenuPopover button:hover {
            background-color: #f0f0f0;
        }

        #ayahMenuPopover i {
            margin-right: 10px;
        }

        /* Ayah Context Menu Popover */
        #ayahMenuPopover {
            display: none;
            position: absolute;
            z-index: 10000;
            background-color: #fff;
            border: 0.1px solid #ccc;
            border-radius: 0.375rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 8px;
            transition: opacity 0.3s ease;
        }

        #ayahMenuPopover button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            color: #333;
            border: none;
            background: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border-radius: 4px;
        }

        #ayahMenuPopover button:hover {
            background-color: #f0f0f0;
        }

        .dark #ayahMenuPopover {
            background-color: #374151;
            border-color: #4b5563;
        }

        .dark #ayahMenuPopover button {
            color: #f3f4f6;
        }

        .dark #ayahMenuPopover button:hover {
            background-color: #4b5563;
        }
        
        /* Auto-appearing tooltip for reading mode button */
        #btnReadingMode.show-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            pointer-events: none;
            animation: tooltipFadeIn 0.3s ease-out;
        }
        
        #btnReadingMode.show-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            margin-bottom: -5px;
            pointer-events: none;
            animation: tooltipFadeIn 0.3s ease-out;
        }
        
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        #btnReadingMode {
            position: relative;
        }
</style>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">
</head>

<body class="bg-gradient-to-b from-gray-100 to-white dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-150">
    <!-- Remove debug panel -->
    
    <!-- Header Section -->
    <header class="bg-gradient-to-r from-white via-gray-50 to-white dark:from-gray-800 dark:via-gray-850 dark:to-gray-800 shadow-lg border-b border-gray-100 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between py-3 sm:py-4">
                <!-- Brand Section -->
                <div class="flex items-center gap-3">
                    <button onclick="goToHomeScreen()" class="group focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-lg transition-transform duration-150" title="  - Go to Home">
                        <img src="icon1.png" alt="Sakinah" class="h-8 w-8 sm:h-10 sm:w-10 rounded-lg shadow-md group-hover:shadow-lg transition-transform duration-150 group-hover:scale-105 border-2 border-transparent group-hover:border-blue-200 dark:group-hover:border-blue-400">
                    </button>
                    
                    <!-- Date Display -->
                    <div class="flex flex-col text-xs text-gray-500 dark:text-gray-400">
                        <div class="flex items-center gap-1">
                            <i class="fas fa-calendar-alt text-blue-500 text-[10px] sm:text-xs flex-shrink-0"></i>
                            <span id="gregorianDate" class="text-[10px] sm:text-xs">Loading...</span>
                        </div>
                        <div class="text-[8px] sm:text-[10px] text-gray-400 dark:text-gray-500" id="hijriDate"></div>
                    </div>
                </div>

                <!-- Actions Section -->
                <div class="flex items-center space-x-2 rtl:space-x-reverse">
                    <!-- Language Toggle -->
                    <button onclick="switchLanguage()" id="langToggle" 
                        class="group relative p-2 sm:p-2.5 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 bg-white/70 dark:bg-gray-700/70 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-xl border border-gray-200 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-500 transition-transform duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-sm hover:shadow-md transform hover:scale-105" 
                        title="Switch Language -  ">
                        <i class="fas fa-globe text-sm sm:mr-1.5 rtl:sm:mr-0 rtl:sm:ml-1.5 group-hover:rotate-12 transition-transform duration-150"></i>
                        <span class="hidden sm:inline">English</span>
                        <span class="sm:hidden">EN</span>
                    </button>

                    <!-- Dark Mode Toggle -->
                    <button id="darkModeToggle" 
                        class="group relative p-2 sm:p-2.5 text-gray-600 dark:text-gray-300 hover:text-amber-600 dark:hover:text-amber-400 bg-white/70 dark:bg-gray-700/70 hover:bg-amber-50 dark:hover:bg-amber-900/30 rounded-xl border border-gray-200 dark:border-gray-600 hover:border-amber-300 dark:hover:border-amber-500 transition-transform duration-150 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 shadow-sm hover:shadow-md transform hover:scale-105" 
                        title="Toggle Dark Mode -   ">
                        <i class="fas fa-moon dark:hidden text-sm group-hover:rotate-12 transition-transform duration-150"></i>
                        <i class="fas fa-sun hidden dark:block text-sm group-hover:rotate-180 transition-transform duration-150"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Reading Progress Bar -->
    <div id="readingProgressContainer" class="reading-progress-container">
        <div id="readingProgressBar" class="reading-progress-bar"></div>
    </div>



    <!-- Ayah Context Menu Popover -->
    <div id="ayahMenuPopover" style="display:none; position:absolute; z-index:10000;" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-2 animate-general-fade-in">
      <div class="flex gap-1">
        <button id="ayahMenuPlay" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Play Ayah"><i class="fas fa-play"></i></button>
        <button id="ayahMenuTranslation" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Show Translation"><i class="fas fa-language"></i></button>
        <button id="ayahMenuTafsir" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Show Tafsir"><i class="fas fa-book-open"></i></button>
        <button id="ayahMenuBookmark" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Bookmark"><i class="far fa-bookmark"></i></button>
      </div>
    </div>

        <!-- Add this script right after the header -->
        <script>
        // Dark mode functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const html = document.documentElement;
            
            // Check for saved theme preference or use system preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Set initial theme
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            
            // Toggle dark mode
            darkModeToggle.addEventListener('click', () => {
                html.classList.toggle('dark');
                const isDark = html.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                // Update toggle button icon
                const moonIcon = darkModeToggle.querySelector('.fa-moon');
                const sunIcon = darkModeToggle.querySelector('.fa-sun');
                if (isDark) {
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                } else {
                    moonIcon.classList.remove('hidden');
                    sunIcon.classList.add('hidden');
                }
                
                // Remove focus from button to clear yellow effect
                darkModeToggle.blur();
            });
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        html.classList.add('dark');
                    } else {
                        html.classList.remove('dark');
                    }
                }
            });
        }

        // Call initDarkMode when the document is loaded
        document.addEventListener('DOMContentLoaded', initDarkMode);
        
        // Date Functions
        function updateHijriDate() {
            const today = new Date();
            
            // Force Gregorian calendar for both languages
            let gregorianDate;
            if (currentLang === 'ar') {
                // For Arabic, use Gregorian calendar explicitly
                const options = {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    calendar: 'gregory'
                };
                try {
                    gregorianDate = today.toLocaleDateString('ar-SA-u-ca-gregory', options);
                } catch (e) {
                    // Fallback: use English format if Arabic Gregorian fails
                    gregorianDate = today.toLocaleDateString('en-US', options);
                }
            } else {
                gregorianDate = today.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            // Set Gregorian date as main date immediately
            document.getElementById('gregorianDate').textContent = gregorianDate;
            
            // Simple Hijri conversion (approximate)
            const hijriMonths = [
                { ar: '', en: 'Muharram' },
                { ar: '', en: 'Safar' },
                { ar: ' ', en: 'Rabi\' al-awwal' },
                { ar: ' ', en: 'Rabi\' al-thani' },
                { ar: ' ', en: 'Jumada al-awwal' },
                { ar: ' ', en: 'Jumada al-thani' },
                { ar: '', en: 'Rajab' },
                { ar: '', en: 'Sha\'ban' },
                { ar: '', en: 'Ramadan' },
                { ar: '', en: 'Shawwal' },
                { ar: ' ', en: 'Dhu al-Qi\'dah' },
                { ar: ' ', en: 'Dhu al-Hijjah' }
            ];
            
            // Fetch from Islamic calendar API for Hijri date (as secondary)
            fetch(`https://api.aladhan.com/v1/gToH/${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const hijri = data.data.hijri;
                        const monthName = hijriMonths[hijri.month.number - 1];
                        const hijriText = currentLang === 'ar' 
                            ? `${hijri.day} ${monthName.ar} ${hijri.year} `
                            : `${hijri.day} ${monthName.en} ${hijri.year} AH`;
                        
                        document.getElementById('hijriDate').textContent = hijriText;
                    }
                })
                .catch(() => {
                    // Fallback if API fails
                    document.getElementById('hijriDate').textContent = currentLang === 'ar' ? ' ' : 'Islamic Date';
                });
        }
    </script>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="fixed inset-0 bg-black/60 z-50 hidden">
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-lg bg-white/95 dark:bg-gray-800/95 rounded-2xl p-8 shadow-2xl border border-white/20 dark:border-gray-700/50 text-right">
  
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-bell text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent" id="tutorialTitle"></h2>
            </div>
  
            <div id="iosTutorial" class="hidden">
                <ol class="list-decimal list-inside space-y-4 text-gray-700 dark:text-gray-300" id="iosSteps"></ol>
                <div class="mt-6 p-4 bg-blue-50/70 dark:bg-blue-900/30 rounded-xl text-sm text-blue-700 dark:text-blue-300 border border-blue-200/50 dark:border-blue-700/50" id="iosNote"></div>
            </div>
  
            <div id="androidTutorial" class="hidden">
                <ol class="list-decimal list-inside space-y-4 text-gray-700 dark:text-gray-300" id="androidSteps"></ol>
            </div>
  
            <div class="mt-8 flex justify-center">
                <button onclick="closeTutorial()" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-8 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200" id="gotItButton"></button>
            </div>
        </div>
    </div>
  
  

    <!-- Tab Navigation -->
    <div class="flex justify-center bg-gradient-to-r from-gray-50 via-white to-gray-50 dark:from-gray-800 dark:via-gray-750 dark:to-gray-800 border-b-2 border-gray-100 dark:border-gray-700 px-4 py-2 shadow-sm">
        <div class="flex bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm rounded-xl p-1 border border-gray-200/50 dark:border-gray-600/50 shadow-inner">
        <div class="tab" data-tab="qibla" id="qiblaTab" title=" - Qibla Direction"></div>
        <div class="tab active" data-tab="adhkar" id="adhkarTab" title=" - Daily Remembrance"></div>
        <div class="tab" data-tab="prayer" id="prayerTab" title="  - Prayer Times"> </div>
            <div class="tab" data-tab="tasbih" id="tasbihTab" title=" - Digital Tasbih"></div>
        <div class="tab" data-tab="quran" id="quranTab" title=" - Holy Quran"></div>
        </div>
    </div>

    <main class="flex-grow flex items-center justify-center islamic-pattern">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 flex justify-center items-center bg-white dark:bg-black z-50">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>

        <!-- Quran Tab Content -->
        <div id="quranContent" class="tab-content w-full max-w-4xl p-4 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">

                <div class="quran-controls-sticky flex items-center justify-between px-4 py-2 mb-6 gap-2 flex-nowrap min-w-0">
                    <!-- Left Section: Controls -->
                    <div class="flex items-center gap-1 flex-shrink-0">
                        <!-- Settings Button -->
                        <button onclick="toggleQuranSettings()" class="rounded-md p-2 transition-colors text-sm flex-shrink-0" id="settingsBtn" title="Quran Settings -  ">
                            <i class="fas fa-cog w-3 h-3"></i>
                        </button>
                        
                        <!-- Reading Mode Button -->
                        <button onclick="toggleReadingMode()" id="btnReadingMode" class="bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm flex-shrink-0" title="Toggle Reading Mode -   " disabled>
                            <i class="fas fa-book-open w-3 h-3"></i>
                        </button>
                        </div>

                    <!-- Center Section: Page & Juz Indicator -->
                    <div id="pageJuzIndicator" class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 hidden">
                        <span id="currentPageIndicator" class="px-2 py-1"> </span>
                        <span id="currentJuzIndicator" class="px-2 py-1"> </span>
                        </div>

                    <!-- Right Section: Surah Selector -->
                    <div class="flex items-center flex-shrink-0 min-w-0">
                        <button id="surahMenuBtn" class="rounded-md px-3 py-2 flex items-center gap-2 text-sm transition-colors overflow-hidden" title="Select Surah -  ">
                            <span id="selectedSurahText" class="truncate"> </span>
                            <i class="fas fa-chevron-down text-xs flex-shrink-0"></i>
                        </button>
                        </div>
                        </div>
                        
                <!-- Quran Search Bar -->
                <div class="quran-search-container mb-4">
                    <div class="relative">
                                        <div class="flex items-center bg-white/90 dark:bg-gray-700/90 backdrop-blur-sm border border-gray-200 dark:border-gray-600 rounded-xl shadow-lg overflow-hidden" dir="ltr">
                    <div class="flex-shrink-0 pl-4">
                        <i class="fas fa-search text-gray-400 dark:text-gray-500"></i>
                    </div>
                    <input 
                        type="text" 
                        id="quranSearchInput" 
                        class="flex-1 px-3 py-3 bg-transparent border-none outline-none text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400"
                        placeholder="   - Search Quran..."
                        autocomplete="off"
                        dir="auto"
                    >
                    <div class="flex-shrink-0 pr-2">
                        <button 
                            id="quranSearchClearBtn" 
                            class="hidden p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                            onclick="clearQuranSearch()"
                            title="Clear Search -  "
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                        
                        <!-- Search Results Dropdown -->
                        <div id="quranSearchResults" class="absolute top-full left-0 right-0 mt-2 bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm border border-gray-200 dark:border-gray-600 rounded-xl shadow-2xl max-h-96 overflow-y-auto z-[60] hidden">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
                        
                <!-- Quran Settings Side Menu -->
                <div id="quranSettingsMenu" class="fixed inset-y-0 right-0 w-80 bg-white/95 dark:bg-gray-900/95 shadow-2xl border-l border-white/30 dark:border-gray-600/50 transform translate-x-full transition-transform duration-200 ease-in-out z-50 hidden" style="background-image: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%), radial-gradient(circle at 40% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%);">
                    <div class="flex flex-col h-full">
                        <!-- Header -->
                        <div class="flex items-center justify-between p-4 border-b border-white/20 dark:border-gray-600/30 bg-gradient-to-r from-transparent via-white/10 to-transparent" style="min-height: 60px;">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-lg">
                                    <i class="fas fa-cog text-white text-lg"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 dark:text-white flex-1 min-w-0 pr-4" id="settingsTitle" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"> </h3>
                            </div>
                            <button id="closeSettingsBtn" onclick="toggleQuranSettings()" class="w-10 h-10 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110 shadow-lg flex-shrink-0" style="min-width: 44px; min-height: 44px;">
                                <i class="fas fa-times text-sm"></i>
                        </button>
                        </div>

                        <!-- Settings Content -->
                        <div class="flex-1 p-4 space-y-6 overflow-y-auto">
                            <!-- Font Size Settings -->
                            <div class="bg-white/70 dark:bg-gray-700/70 backdrop-blur-sm rounded-xl p-4 border border-white/30 dark:border-gray-600/50 shadow-md">
                                <h4 class="text-md font-medium mb-3 flex items-center gap-2">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-text-height text-white text-sm"></i>
                                    </div>
                                    <span id="fontSizeTitle" class="font-bold text-gray-800 dark:text-gray-200"> </span>
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-gray-700 dark:text-gray-300" id="currentSizeLabel">  </span>
                                        <span id="currentFontSize" class="text-sm font-mono bg-gradient-to-r from-blue-100 to-indigo-100 dark:from-blue-900/50 dark:to-indigo-900/50 text-blue-700 dark:text-blue-300 px-3 py-1.5 rounded-lg border border-blue-200 dark:border-blue-700">2rem</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="decreaseBtn" onclick="decreaseTextSize()" class="bg-gradient-to-r from-red-100 to-pink-100 dark:from-red-900/30 dark:to-pink-900/30 hover:from-red-200 hover:to-pink-200 dark:hover:from-red-800/40 dark:hover:to-pink-800/40 text-red-600 dark:text-red-400 p-2 rounded-lg transition-all duration-200 hover:scale-105 shadow-sm" title=" ">
                                            <i class="fas fa-minus text-sm"></i>
                            </button>
                                        <div class="flex-1 mx-2">
                                            <input type="range" id="fontSizeSlider" min="1" max="4" step="0.1" value="2" class="w-full h-2 bg-gradient-to-r from-blue-200 to-indigo-200 dark:from-blue-800 to-indigo-800 rounded-lg appearance-none cursor-pointer">
                                        </div>
                                        <button id="increaseBtn" onclick="increaseTextSize()" class="bg-gradient-to-r from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 hover:from-green-200 hover:to-emerald-200 dark:hover:from-green-800/40 dark:hover:to-emerald-800/40 text-green-600 dark:text-green-400 p-2 rounded-lg transition-all duration-200 hover:scale-105 shadow-sm" title=" ">
                                            <i class="fas fa-plus text-sm"></i>
                            </button>
                                    </div>
                                    <button onclick="resetTextSize()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white py-2 px-4 rounded-lg transition-all duration-200 hover:scale-105 text-sm font-medium shadow-lg" id="resetSizeBtn">
                                        <i class="fas fa-undo mr-2"></i>
                                        <span id="resetSizeText">  </span>
                            </button>
                            </div>
                        </div>

                            <!-- Font Family Settings -->
                            <div class="bg-white/70 dark:bg-gray-700/70 backdrop-blur-sm rounded-xl p-4 border border-white/30 dark:border-gray-600/50 shadow-md">
                                <h4 class="text-md font-medium mb-3 flex items-center gap-2">
                                    <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-font text-white text-sm"></i>
                                    </div>
                                    <span id="fontFamilyTitle" class="font-bold text-gray-800 dark:text-gray-200"> </span>
                                </h4>
                                <div class="space-y-2">
                                    <label class="flex items-center p-3 bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-600/60 dark:to-gray-700/60 backdrop-blur-sm border border-white/40 dark:border-gray-600/40 rounded-lg hover:from-white/80 hover:to-gray-50/80 dark:hover:from-gray-600/80 dark:hover:to-gray-700/80 cursor-pointer transition-all duration-200 hover:scale-[1.02] shadow-sm">
                                        <input type="radio" name="fontFamily" value="quran-font" class="mr-3 text-green-500 focus:ring-green-500" checked>
                                        <div class="flex-1">
                                            <div class="font-medium text-gray-800 dark:text-gray-200" id="font1Name">  </div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Uthmanic Hafs</div>
                    </div>
                                    </label>
                                    <label class="flex items-center p-3 bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-600/60 dark:to-gray-700/60 backdrop-blur-sm border border-white/40 dark:border-gray-600/40 rounded-lg hover:from-white/80 hover:to-gray-50/80 dark:hover:from-gray-600/80 dark:hover:to-gray-700/80 cursor-pointer transition-all duration-200 hover:scale-[1.02] shadow-sm">
                                        <input type="radio" name="fontFamily" value="utman-taha" class="mr-3 text-green-500 focus:ring-green-500">
                                        <div class="flex-1">
                                            <div class="font-medium text-gray-800 dark:text-gray-200" id="font2Name">  </div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Utman Taha Naskh</div>
                </div>
                                    </label>
                                    <label class="flex items-center p-3 bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-600/60 dark:to-gray-700/60 backdrop-blur-sm border border-white/40 dark:border-gray-600/40 rounded-lg hover:from-white/80 hover:to-gray-50/80 dark:hover:from-gray-600/80 dark:hover:to-gray-700/80 cursor-pointer transition-all duration-200 hover:scale-[1.02] shadow-sm">
                                        <input type="radio" name="fontFamily" value="al-mushaf" class="mr-3 text-green-500 focus:ring-green-500">
                                        <div class="flex-1">
                                            <div class="font-medium text-gray-800 dark:text-gray-200" id="font3Name"> </div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Al Qalam</div>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-3 bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-600/60 dark:to-gray-700/60 backdrop-blur-sm border border-white/40 dark:border-gray-600/40 rounded-lg hover:from-white/80 hover:to-gray-50/80 dark:hover:from-gray-600/80 dark:hover:to-gray-700/80 cursor-pointer transition-all duration-200 hover:scale-[1.02] shadow-sm">
                                        <input type="radio" name="fontFamily" value="system-arabic" class="mr-3 text-green-500 focus:ring-green-500">
                                        <div class="flex-1">
                                            <div class="font-medium text-gray-800 dark:text-gray-200" id="font4Name">  </div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400" id="font4Desc">Arial</div>
                                        </div>
                                    </label>
                                </div>
                            </div>



                            <!-- Audio Settings -->
                            <div class="bg-white/70 dark:bg-gray-700/70 backdrop-blur-sm rounded-xl p-4 border border-white/30 dark:border-gray-600/50 shadow-md">
                                <h4 class="text-md font-medium mb-3 flex items-center gap-2">
                                    <div class="w-8 h-8 bg-gradient-to-r from-red-500 to-pink-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-volume-up text-white text-sm"></i>
                                    </div>
                                    <span id="audioTitle" class="font-bold text-gray-800 dark:text-gray-200"> </span>
                                </h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300" id="reciterLabel"></label>
                                        <select id="reciterSelect" class="w-full p-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all duration-200 shadow-sm" style="background-image: none;">
                                            <option value="ar.alafasy" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800"> </option>
                                            <option value="ar.husary" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800">  </option>
                                            <option value="ar.minshawi" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800">  </option>
                                            <option value="ar.sudais" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800">  </option>
                                            <option value="ar.shuraim" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800"> </option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300" id="playbackSpeedLabel"> </label>
                                        <select id="playbackSpeedSelect" class="w-full p-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all duration-200 shadow-sm" style="background-image: none;">
                                            <option value="0.5" id="speed1" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800"> (0.5x)</option>
                                            <option value="0.75" id="speed2" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800"> (0.75x)</option>
                                            <option value="1" selected id="speed3" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800"> (1x)</option>
                                            <option value="1.25" id="speed4" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800"> (1.25x)</option>
                                            <option value="1.5" id="speed5" class="text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-800"> (1.5x)</option>
                                        </select>
                                    </div>
                                    <div class="bg-gradient-to-r from-blue-50/60 to-indigo-50/60 dark:from-blue-900/20 dark:to-indigo-900/20 backdrop-blur-sm border border-blue-200/50 dark:border-blue-700/50 rounded-lg p-3">
                                        <label class="flex items-center gap-3 cursor-pointer">
                                            <input type="checkbox" id="continuousPlayToggle" class="w-4 h-4 text-blue-600 bg-white/80 border-blue-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-blue-600">
                                            <div>
                                                <div class="text-sm font-medium text-gray-800 dark:text-gray-200" id="continuousPlayLabel">    </div>
                                                <div class="text-xs text-gray-600 dark:text-gray-400" id="continuousPlayDesc">       </div>
                                            </div>
                                        </label>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="quranContent" class="space-y-3">
                    <div class="text-center text-2xl leading-loose quran-uthmani-font" id="arabicText">
                        <div class="text-gray-500 dark:text-gray-400 py-2" id="quranPlaceholder">
                            <i class="fas fa-book-quran text-2xl mb-2"></i>
                            <p class="text-lg">  </p>
                            <p class="text-sm mt-1">Select a Surah to begin</p>
                        </div>
                    </div>
                    
                    <!-- Quick Surahs Section (shown when no surah is selected) -->
                    <div id="quickSurahsSection" class="max-w-2xl mx-auto">
                        <div class="text-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2" id="quickSurahsTitle">  </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400" id="quickSurahsDesc">Quick access to commonly read surahs</p>
                        </div>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                            <!-- Al-Fatiha -->
                            <button onclick="loadQuickSurah(1)" class="bg-gradient-to-r from-green-50/80 to-emerald-50/80 dark:from-green-900/40 dark:to-emerald-900/40 hover:from-green-100/80 hover:to-emerald-100/80 dark:hover:from-green-900/60 dark:hover:to-emerald-900/60 text-green-700 dark:text-green-300 p-3 rounded-lg text-sm font-medium transition-all duration-200 border border-green-200/50 dark:border-green-700/50 shadow-sm hover:shadow-md transform hover:scale-[1.02]">
                                <div class="flex flex-col items-center gap-1">
                                    <div class="w-6 h-6 bg-green-500/20 rounded-full flex items-center justify-center mb-1">
                                        <span class="text-xs font-bold"></span>
                                    </div>
                                    <span class="text-xs font-bold"></span>
                                    <span class="text-xs opacity-75">Al-Fatiha</span>
                                </div>
                            </button>
                            
                            <!-- Al-Baqarah -->
                            <button onclick="loadQuickSurah(2)" class="bg-gradient-to-r from-blue-50/80 to-cyan-50/80 dark:from-blue-900/40 dark:to-cyan-900/40 hover:from-blue-100/80 hover:to-cyan-100/80 dark:hover:from-blue-900/60 dark:hover:to-cyan-900/60 text-blue-700 dark:text-blue-300 p-3 rounded-lg text-sm font-medium transition-all duration-200 border border-blue-200/50 dark:border-blue-700/50 shadow-sm hover:shadow-md transform hover:scale-[1.02]">
                                <div class="flex flex-col items-center gap-1">
                                    <div class="w-6 h-6 bg-blue-500/20 rounded-full flex items-center justify-center mb-1">
                                        <span class="text-xs font-bold"></span>
                                    </div>
                                    <span class="text-xs font-bold"></span>
                                    <span class="text-xs opacity-75">Al-Baqarah</span>
                                </div>
                            </button>
                            
                            <!-- Yasin -->
                            <button onclick="loadQuickSurah(36)" class="bg-gradient-to-r from-purple-50/80 to-indigo-50/80 dark:from-purple-900/40 dark:to-indigo-900/40 hover:from-purple-100/80 hover:to-indigo-100/80 dark:hover:from-purple-900/60 dark:hover:to-indigo-900/60 text-purple-700 dark:text-purple-300 p-3 rounded-lg text-sm font-medium transition-all duration-200 border border-purple-200/50 dark:border-purple-700/50 shadow-sm hover:shadow-md transform hover:scale-[1.02]">
                                <div class="flex flex-col items-center gap-1">
                                    <div class="w-6 h-6 bg-purple-500/20 rounded-full flex items-center justify-center mb-1">
                                        <span class="text-xs font-bold"></span>
                                    </div>
                                    <span class="text-xs font-bold"></span>
                                    <span class="text-xs opacity-75">Ya-Sin</span>
                                </div>
                            </button>
                            
                            <!-- Al-Kahf -->
                            <button onclick="loadQuickSurah(18)" class="bg-gradient-to-r from-orange-50/80 to-red-50/80 dark:from-orange-900/40 dark:to-red-900/40 hover:from-orange-100/80 hover:to-red-100/80 dark:hover:from-orange-900/60 dark:hover:to-red-900/60 text-orange-700 dark:text-orange-300 p-3 rounded-lg text-sm font-medium transition-all duration-200 border border-orange-200/50 dark:border-orange-700/50 shadow-sm hover:shadow-md transform hover:scale-[1.02]">
                                <div class="flex flex-col items-center gap-1">
                                    <div class="w-6 h-6 bg-orange-500/20 rounded-full flex items-center justify-center mb-1">
                                        <span class="text-xs font-bold"></span>
                                    </div>
                                    <span class="text-xs font-bold"></span>
                                    <span class="text-xs opacity-75">Al-Kahf</span>
                                </div>
                            </button>
                            
                            <!-- Al-Mulk -->
                            <button onclick="loadQuickSurah(67)" class="bg-gradient-to-r from-teal-50/80 to-cyan-50/80 dark:from-teal-900/40 dark:to-cyan-900/40 hover:from-teal-100/80 hover:to-cyan-100/80 dark:hover:from-teal-900/60 dark:hover:to-cyan-900/60 text-teal-700 dark:text-teal-300 p-3 rounded-lg text-sm font-medium transition-all duration-200 border border-teal-200/50 dark:border-teal-700/50 shadow-sm hover:shadow-md transform hover:scale-[1.02]">
                                <div class="flex flex-col items-center gap-1">
                                    <div class="w-6 h-6 bg-teal-500/20 rounded-full flex items-center justify-center mb-1">
                                        <span class="text-xs font-bold"></span>
                                    </div>
                                    <span class="text-xs font-bold"></span>
                                    <span class="text-xs opacity-75">Al-Mulk</span>
                                </div>
                            </button>
                            
                            <!-- Al-Ikhlas -->
                            <button onclick="loadQuickSurah(112)" class="bg-gradient-to-r from-pink-50/80 to-rose-50/80 dark:from-pink-900/40 dark:to-rose-900/40 hover:from-pink-100/80 hover:to-rose-100/80 dark:hover:from-pink-900/60 dark:hover:to-rose-900/60 text-pink-700 dark:text-pink-300 p-3 rounded-lg text-sm font-medium transition-all duration-200 border border-pink-200/50 dark:border-pink-700/50 shadow-sm hover:shadow-md transform hover:scale-[1.02]">
                                <div class="flex flex-col items-center gap-1">
                                    <div class="w-6 h-6 bg-pink-500/20 rounded-full flex items-center justify-center mb-1">
                                        <span class="text-xs font-bold"></span>
                                    </div>
                                    <span class="text-xs font-bold"></span>
                                    <span class="text-xs opacity-75">Al-Ikhlas</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center text-lg text-gray-600 dark:text-gray-400" id="translationText"></div>
                </div>

            </div>
        </div>

        <!-- Qibla Tab Content -->
        <div id="qiblaContent" class="tab-content w-full p-4 hidden">
            <!-- Simple Compass Interface -->
            <div class="max-w-md mx-auto">
                <!-- Location Display -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-4 shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white" id="locationTitle"> </h3>
                        <button id="refreshLocationBtn" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-location-arrow text-sm"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-300">
                        <div class="flex items-center gap-2 mb-1">
                            <i class="fas fa-location-dot text-blue-500"></i>
                            <span id="locationInfo">  ...</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-route text-green-500"></i>
                            <span id="qiblaDistance"> ...</span>
                        </div>
                    </div>
                </div>

                <!-- Compass Container -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                    <div class="relative w-80 h-80 mx-auto">
                        <!-- Compass Background Circle -->
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-gray-700 dark:to-gray-600 rounded-full border-4 border-gray-200 dark:border-gray-500 shadow-inner overflow-hidden">
                            <!-- Rotating Compass Rose -->
                            <div class="absolute inset-4 rounded-full transition-transform duration-500 ease-out" id="compassRose" style="transform: rotate(0deg);">
                                <!-- Degree Markings -->
                                <div class="absolute inset-0 rounded-full">
                                    <!-- Major degree markings (every 30) -->
                                    <div class="absolute inset-0">
                                        <!-- North (0) -->
                                        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-1 h-8 bg-red-500"></div>
                                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-white dark:text-white font-bold text-sm bg-red-500 dark:bg-red-600 px-1 rounded">N</div>
                                        
                                        <!-- East (90) -->
                                        <div class="absolute right-0 top-1/2 transform -translate-y-1/2 w-8 h-1 bg-gray-600 dark:bg-gray-400"></div>
                                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white dark:text-black font-bold text-sm bg-gray-600 dark:bg-gray-400 px-1 rounded">E</div>
                                        
                                        <!-- South (180) -->
                                        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1 h-8 bg-gray-600 dark:bg-gray-400"></div>
                                        <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-white dark:text-black font-bold text-sm bg-gray-600 dark:bg-gray-400 px-1 rounded">S</div>
                                        
                                        <!-- West (270) -->
                                        <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-8 h-1 bg-gray-600 dark:bg-gray-400"></div>
                                        <div class="absolute left-2 top-1/2 transform -translate-y-1/2 text-white dark:text-black font-bold text-sm bg-gray-600 dark:bg-gray-400 px-1 rounded">W</div>
                                    </div>
                                    
                                    <!-- Minor degree markings -->
                                    <div class="absolute inset-2 rounded-full">
                                        <div class="absolute inset-0" id="degreeMarkings">
                                            <!-- Generated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fixed Qibla Direction Indicator -->
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="relative">
                                <!-- Qibla Arrow pointing up -->
                                <div class="absolute -top-20 left-1/2 transform -translate-x-1/2 flex flex-col items-center z-10">
                                    <div class="bg-green-500 text-white p-3 rounded-full shadow-lg mb-2 animate-pulse">
                                        <i class="fas fa-kaaba text-xl"></i>
                                    </div>
                                    <div class="w-0 h-0 border-l-4 border-r-4 border-t-8 border-transparent border-t-green-500 shadow-lg"></div>
                                    <div class="w-1 h-12 bg-green-500 shadow-lg"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Fixed Device Direction Indicator -->
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="relative">
                                <!-- Device direction arrow pointing up -->
                                <div class="absolute -top-16 left-1/2 transform -translate-x-1/2 flex flex-col items-center z-20">
                                    <div class="w-0 h-0 border-l-3 border-r-3 border-b-6 border-transparent border-b-red-500 shadow-lg"></div>
                                    <div class="w-1 h-8 bg-red-500 shadow-lg"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Center Button -->
                        <div class="absolute inset-0 flex items-center justify-center z-30">
                            <button id="startCompassBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-full shadow-lg transition-colors">
                                <i class="fas fa-compass mr-2"></i>
                                <span id="startCompassText"> </span>
                            </button>
                        </div>
                    </div>

                    <!-- Status Display -->
                    <div class="mt-6 space-y-3">
                        <!-- Direction Display -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-gray-800 dark:text-white mb-1" id="degreeDisplay">--</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300" id="directionStatus"> " " </div>
                        </div>

                        <!-- Accuracy Indicator -->
                        <div class="flex items-center justify-center gap-2 text-sm">
                            <div class="flex items-center gap-1">
                                <div class="w-2 h-2 rounded-full" id="accuracyIndicator"></div>
                                <span id="accuracyText"> </span>
                            </div>
                        </div>

                        <!-- Help Text -->
                        <div class="text-center space-y-2">
                            <button onclick="showCompassHelp()" class="text-blue-500 hover:text-blue-600 text-sm underline">
                                <i class="fas fa-question-circle mr-1"></i>
                                <span id="helpText">  </span>
                            </button>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Modal -->
            <div id="compassHelpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white" id="helpModalTitle">  </h3>
                        <button onclick="closeCompassHelp()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-3 text-sm text-gray-600 dark:text-gray-300" id="helpModalContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                    <button onclick="closeCompassHelp()" class="w-full mt-4 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <span id="closeHelpText"></span>
                    </button>
                </div>
            </div>
        </div>
        <div id="adhkarContent" class="tab-content active w-full">
            <!-- Main Buttons for Morning/Evening Adhkar -->
            <div id="home" class="w-full flex flex-col items-center justify-center mt-4">
              <!-- Quick Access Cards -->
              <div class="max-w-4xl w-full px-4 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Morning Adhkar Card -->
                  <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl border border-amber-200 dark:border-amber-800 p-6 hover:shadow-lg transition-all duration-300 cursor-pointer" onclick="loadAdhkar('sabah')">
                    <div class="flex items-center gap-4">
                      <div class="bg-amber-100 dark:bg-amber-900/40 rounded-lg p-3">
                        <i class="fas fa-sun text-2xl text-amber-600 dark:text-amber-400"></i>
                      </div>
                      <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1" id="morningCardTitle"> </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300" id="morningCardDesc">   </p>
                      </div>
                      <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500 arrow-icon"></i>
                    </div>
                  </div>

                  <!-- Evening Adhkar Card -->
                  <div class="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-xl border border-indigo-200 dark:border-indigo-800 p-6 hover:shadow-lg transition-all duration-300 cursor-pointer" onclick="loadAdhkar('masaa')">
                    <div class="flex items-center gap-4">
                      <div class="bg-indigo-100 dark:bg-indigo-900/40 rounded-lg p-3">
                        <i class="fas fa-moon text-2xl text-indigo-600 dark:text-indigo-400"></i>
                      </div>
                      <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1" id="eveningCardTitle"> </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300" id="eveningCardDesc">   </p>
                      </div>
                      <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500 arrow-icon"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- More Adhkar Button -->
              <div class="max-w-md mx-auto px-4 mb-8">
                <button id="adhkarMenuBtn" class="w-full bg-gradient-to-r from-purple-50 via-pink-50 to-purple-50 dark:from-purple-900/20 dark:via-pink-900/20 dark:to-purple-900/20 border border-purple-200 dark:border-purple-800 hover:from-purple-100 hover:via-pink-100 hover:to-purple-100 dark:hover:from-purple-900/30 dark:hover:via-pink-900/30 dark:hover:to-purple-900/30 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transform hover:scale-105" title="   ">
                  <div class="flex items-center justify-center gap-3">
                    <div class="bg-purple-100 dark:bg-purple-900/40 rounded-lg p-2">
                      <i class="fas fa-th-large text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <div class="flex flex-col items-start">
                      <span class="text-lg font-semibold" id="moreAdhkarTitle">  </span>
                      <span class="text-xs text-gray-500 dark:text-gray-400" id="moreAdhkarDesc">   </span>
                    </div>
                    <i class="fas fa-chevron-left text-gray-400 dark:text-gray-500 mr-auto arrow-icon"></i>
                  </div>
                </button>
              </div>

              <!-- Popular Adhkar Categories -->
              <div class="max-w-4xl w-full px-4 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 text-center" id="popularCategoriesTitle">  </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <button onclick="closeAdhkarMenuAndLoad('protection')" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-4 px-3 rounded-lg shadow-sm flex flex-col items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Protection">
                    <i class="fas fa-shield-alt text-yellow-500 text-lg"></i>
                    <span class="text-xs text-center" id="protectionLabel"> </span>
                </button>
                  <button onclick="closeAdhkarMenuAndLoad('istighfar')" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-4 px-3 rounded-lg shadow-sm flex flex-col items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Seeking Forgiveness">
                    <i class="fas fa-leaf text-green-500 text-lg"></i>
                    <span class="text-xs text-center" id="istighfarLabel"></span>
                  </button>
                  <button onclick="closeAdhkarMenuAndLoad('anxiety')" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-4 px-3 rounded-lg shadow-sm flex flex-col items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Anxiety">
                    <i class="fas fa-heart-crack text-blue-500 text-lg"></i>
                    <span class="text-xs text-center" id="anxietyLabel"> </span>
                  </button>
                  <button onclick="closeAdhkarMenuAndLoad('salah')" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-4 px-3 rounded-lg shadow-sm flex flex-col items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Prayer Dus">
                    <i class="fas fa-pray text-blue-500 text-lg"></i>
                    <span class="text-xs text-center" id="prayerLabel"> </span>
                </button>
                </div>
              </div>

              <!-- Daily Reminders -->
              <div class="max-w-4xl w-full px-4 mb-6">
                <div class="bg-gradient-to-r from-green-50 via-emerald-50 to-green-50 dark:from-green-900/20 dark:via-emerald-900/20 dark:to-green-900/20 rounded-xl border border-green-200 dark:border-green-800 p-6">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div class="bg-green-100 dark:bg-green-900/40 rounded-lg p-2">
                        <i class="fas fa-lightbulb text-green-600 dark:text-green-400"></i>
                      </div>
                      <h3 class="text-lg font-semibold text-gray-800 dark:text-white" id="reminderTitle"> </h3>
                    </div>
                    <button onclick="generateRandomHadith()" class="bg-green-100 hover:bg-green-200 dark:bg-green-900/30 dark:hover:bg-green-900/50 text-green-700 dark:text-green-300 hover:text-green-800 dark:hover:text-green-200 px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 flex items-center gap-2 shadow-sm hover:shadow-md transform hover:scale-105">
                      <i class="fas fa-shuffle text-xs"></i>
                      <span id="randomHadithBtn"> </span>
                    </button>
                  </div>
                  <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed" id="reminderText">
                       : "               "
                  </p>
                  <div class="mt-3 text-xs text-gray-500 dark:text-gray-400" id="reminderSource">  </div>
                </div>
              </div>
              <!-- Modal for Adhkar Sections -->
              <div id="adhkarMenuModal" class="fixed inset-0 bg-black/60 flex items-start sm:items-center justify-center z-50 hidden pt-4 sm:pt-0">
                <div class="bg-gradient-to-br from-white via-gray-50 to-white dark:from-gray-800 dark:via-gray-850 dark:to-gray-800 rounded-3xl shadow-2xl p-8 max-w-2xl w-full relative animate-general-fade-in border border-gray-200/50 dark:border-gray-600/50 my-4 sm:my-0" style="max-height:90vh; overflow-y:auto;">
                  <button id="closeAdhkarMenu" class="absolute top-4 left-4 w-10 h-10 bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300 rounded-full flex items-center justify-center transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" title=" ">
                    <i class="fas fa-times text-sm"></i>
                  </button>
                  <!-- Daily Routine -->
                  <div class="pt-4">
                    <div class="text-center mb-8">
                      <div class="bg-blue-100 dark:bg-blue-900/30 rounded-2xl p-4 inline-block mb-4">
                        <i class="fas fa-calendar-day text-3xl text-blue-600 dark:text-blue-400"></i>
                      </div>
                      <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2" id="dailyAdhkarTitle"> </h3>
                      <p class="text-gray-600 dark:text-gray-300 text-sm" id="dailyAdhkarDesc">      </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 justify-center">
                      <button onclick="closeAdhkarMenuAndLoad('waking_sleeping')" id="btnWakingSleeping" class="group bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 hover:from-blue-100 hover:to-blue-200 dark:hover:from-blue-900/30 dark:hover:to-blue-800/30 border border-blue-200 dark:border-blue-700 text-gray-700 dark:text-gray-300 hover:text-blue-800 dark:hover:text-blue-200 py-4 px-4 rounded-xl shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" title="Waking up & Sleeping Duas">
                        <div class="flex flex-col items-center gap-2">
                          <div class="bg-blue-100 dark:bg-blue-900/40 rounded-lg p-2 group-hover:bg-blue-200 dark:group-hover:bg-blue-800/50 transition-colors duration-300">
                            <i class="fas fa-bed text-blue-600 dark:text-blue-400 text-lg"></i>
                          </div>
                          <span id="labelWakingSleeping" class="text-xs font-medium text-center"></span>
                        </div>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('home')" id="btnHome" class="group bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 hover:from-purple-100 hover:to-purple-200 dark:hover:from-purple-900/30 dark:hover:to-purple-800/30 border border-purple-200 dark:border-purple-700 text-gray-700 dark:text-gray-300 hover:text-purple-800 dark:hover:text-purple-200 py-4 px-4 rounded-xl shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2" title="Entering & Leaving Home Duas">
                        <div class="flex flex-col items-center gap-2">
                          <div class="bg-purple-100 dark:bg-purple-900/40 rounded-lg p-2 group-hover:bg-purple-200 dark:group-hover:bg-purple-800/50 transition-colors duration-300">
                            <i class="fas fa-home text-purple-600 dark:text-purple-400 text-lg"></i>
                          </div>
                          <span id="labelHome" class="text-xs font-medium text-center"></span>
                        </div>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('bathroom')" id="btnBathroom" class="group bg-gradient-to-r from-pink-50 to-pink-100 dark:from-pink-900/20 dark:to-pink-800/20 hover:from-pink-100 hover:to-pink-200 dark:hover:from-pink-900/30 dark:hover:to-pink-800/30 border border-pink-200 dark:border-pink-700 text-gray-700 dark:text-gray-300 hover:text-pink-800 dark:hover:text-pink-200 py-4 px-4 rounded-xl shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2" title="Entering & Exiting the Bathroom Duas">
                        <div class="flex flex-col items-center gap-2">
                          <div class="bg-pink-100 dark:bg-pink-900/40 rounded-lg p-2 group-hover:bg-pink-200 dark:group-hover:bg-pink-800/50 transition-colors duration-300">
                            <i class="fas fa-toilet text-pink-600 dark:text-pink-400 text-lg"></i>
                          </div>
                          <span id="labelBathroom" class="text-xs font-medium text-center"></span>
                        </div>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('eating')" id="btnEating" class="group bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 hover:from-green-100 hover:to-green-200 dark:hover:from-green-900/30 dark:hover:to-green-800/30 border border-green-200 dark:border-green-700 text-gray-700 dark:text-gray-300 hover:text-green-800 dark:hover:text-green-200 py-4 px-4 rounded-xl shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" title="Before & After Eating Duas">
                        <div class="flex flex-col items-center gap-2">
                          <div class="bg-green-100 dark:bg-green-900/40 rounded-lg p-2 group-hover:bg-green-200 dark:group-hover:bg-green-800/50 transition-colors duration-300">
                            <i class="fas fa-utensils text-green-600 dark:text-green-400 text-lg"></i>
                          </div>
                          <span id="labelEating" class="text-xs font-medium text-center"></span>
                        </div>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('masjid')" id="btnMasjid" class="group bg-gradient-to-r from-indigo-50 to-indigo-100 dark:from-indigo-900/20 dark:to-indigo-800/20 hover:from-indigo-100 hover:to-indigo-200 dark:hover:from-indigo-900/30 dark:hover:to-indigo-800/30 border border-indigo-200 dark:border-indigo-700 text-gray-700 dark:text-gray-300 hover:text-indigo-800 dark:hover:text-indigo-200 py-4 px-4 rounded-xl shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" title="Entering & Exiting the Masjid Duas">
                        <div class="flex flex-col items-center gap-2">
                          <div class="bg-indigo-100 dark:bg-indigo-900/40 rounded-lg p-2 group-hover:bg-indigo-200 dark:group-hover:bg-indigo-800/50 transition-colors duration-300">
                            <i class="fas fa-mosque text-indigo-600 dark:text-indigo-400 text-lg"></i>
                          </div>
                          <span id="labelMasjid" class="text-xs font-medium text-center"></span>
                        </div>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('traveling')" id="btnTraveling" class="group bg-gradient-to-r from-teal-50 to-teal-100 dark:from-teal-900/20 dark:to-teal-800/20 hover:from-teal-100 hover:to-teal-200 dark:hover:from-teal-900/30 dark:hover:to-teal-800/30 border border-teal-200 dark:border-teal-700 text-gray-700 dark:text-gray-300 hover:text-teal-800 dark:hover:text-teal-200 py-4 px-4 rounded-xl shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2" title="Traveling Duas">
                        <div class="flex flex-col items-center gap-2">
                          <div class="bg-teal-100 dark:bg-teal-900/40 rounded-lg p-2 group-hover:bg-teal-200 dark:group-hover:bg-teal-800/50 transition-colors duration-300">
                            <i class="fas fa-car text-teal-600 dark:text-teal-400 text-lg"></i>
                          </div>
                          <span id="labelTraveling" class="text-xs font-medium text-center"></span>
                        </div>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('clothes')" id="btnClothes" class="group bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-900/20 dark:to-gray-800/20 hover:from-gray-100 hover:to-gray-200 dark:hover:from-gray-900/30 dark:hover:to-gray-800/30 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-200 py-4 px-4 rounded-xl shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" title="Wearing Clothes Duas">
                        <div class="flex flex-col items-center gap-2">
                          <div class="bg-gray-100 dark:bg-gray-900/40 rounded-lg p-2 group-hover:bg-gray-200 dark:group-hover:bg-gray-800/50 transition-colors duration-300">
                            <i class="fas fa-tshirt text-gray-600 dark:text-gray-400 text-lg"></i>
                          </div>
                          <span id="labelClothes" class="text-xs font-medium text-center"></span>
                        </div>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('anxiety')" id="btnAnxiety" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Anxiety, Depression & Sadness">
                        <i class="fas fa-heart-crack text-blue-500"></i> <span id="labelAnxiety"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('hardship')" id="btnHardship" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus in Times of Hardship">
                        <i class="fas fa-mountain text-indigo-500"></i> <span id="labelHardship"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('istighfar')" id="btnIstighfar" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Seeking Forgiveness (Istighfar)">
                        <i class="fas fa-leaf text-green-500"></i> <span id="labelIstighfar"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('patience_gratitude')" id="btnPatienceGratitude" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Patience & Gratitude">
                        <i class="fas fa-hands-praying text-yellow-500"></i> <span id="labelPatienceGratitude"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('rabbana')" id="btnRabbana" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Rabbana Dus (from the Qur'an)">
                        <i class="fas fa-book-quran text-purple-500"></i> <span id="labelRabbana"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('prophetic')" id="btnProphetic" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Prophetic Dus from Hadith">
                        <i class="fas fa-feather-alt text-pink-500"></i> <span id="labelProphetic"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('prophets')" id="btnProphets" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus of the Prophets">
                        <i class="fas fa-user-friends text-indigo-500"></i> <span id="labelProphets"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('rain')" id="btnRain" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Rain / Drought">
                        <i class="fas fa-cloud-rain text-blue-500"></i> <span id="labelRain"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('patient')" id="btnSick" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for the Sick">
                        <i class="fas fa-notes-medical text-red-500"></i> <span id="labelPatient"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('deceased')" id="btnDeceased" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for the Deceased">
                        <i class="fas fa-dove text-gray-500"></i> <span id="labelDeceased"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('marriage_children_rizq')" id="btnMarriageChildrenRizq" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Marriage, Children, Rizq">
                        <i class="fas fa-baby text-green-500"></i> <span id="labelMarriageChildrenRizq"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('protection')" id="btnProtection" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Protection (Evil Eye, Jinn, Calamity)">
                        <i class="fas fa-shield-alt text-yellow-500"></i> <span id="labelProtection"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('salah')" id="btnSalah" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Du before and after Salah">
                        <i class="fas fa-pray text-blue-500"></i> <span id="labelSalah"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('sujood_tashahhud')" id="btnSujoodTashahhud" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus during Sujood & Tashahhud">
                        <i class="fas fa-hands text-orange-500"></i> <span id="labelSujoodTashahhud"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('qunoot')" id="btnQunoot" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Qunoot (Witr prayer)">
                        <i class="fas fa-moon-stars text-teal-500"></i> <span id="labelQunoot"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('tahajjud')" id="btnTahajjud" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Tahajjud">
                        <i class="fas fa-star-and-crescent text-purple-500"></i> <span id="labelTahajjud"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('istikhara')" id="btnIstikhara" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dus for Istikhrah (Seeking Guidance)">
                        <i class="fas fa-compass text-pink-500"></i> <span id="labelIstikhara"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('ramadan')" id="btnRamadan" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Ramadan Dus">
                        <i class="fas fa-calendar-alt text-green-500"></i> <span id="labelRamadan"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('hajj')" id="btnHajj" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Dhul Hijjah & Hajj-related Dus">
                        <i class="fas fa-kaaba text-yellow-500"></i> <span id="labelHajj"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('laylat_al_qadr')" id="btnLaylatAlQadr" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Laylat al-Qadr Dus">
                        <i class="fas fa-lightbulb text-blue-500"></i> <span id="labelLaylatAlQadr"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('eid')" id="btnEid" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Eid Dus">
                        <i class="fas fa-gift text-pink-500"></i> <span id="labelEid"></span>
                      </button>
                      <button onclick="closeAdhkarMenuAndLoad('natural_events')" id="btnNaturalEvents" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white py-2 px-4 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Rain, Eclipse, Earthquake, etc.">
                        <i class="fas fa-bolt text-yellow-500"></i> <span id="labelNaturalEvents"></span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Adhkar View Section -->
            <div id="adhkarView" class="hidden max-w-xl mt-6 p-6 bg-white/90 dark:bg-gray-800/90 rounded-3xl shadow-2xl border border-white/20 dark:border-gray-700/50 space-y-6 text-center no-select mx-auto islamic-pattern">
                <!-- Header with Back Button and Counter -->
                <div class="flex justify-between items-center mb-4">
                    <button onclick="goHome()" class="flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-lg p-2 hover:bg-gray-100 dark:hover:bg-gray-700" title="Back - ">
                        <i class="fas fa-arrow-left text-lg back-arrow"></i>
                        <span class="text-sm font-medium" id="backText"></span>
                    </button>
                    
                    <!-- Compact Counter Display -->
                    <div class="flex items-center gap-3">
                        <!-- Progress Ring -->
                        <div class="relative w-16 h-16">
                            <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 100 100">
                                <!-- Background circle -->
                                <circle cx="50" cy="50" r="40" stroke="currentColor" stroke-width="8" fill="none" class="text-gray-200 dark:text-gray-700"/>
                                <!-- Progress circle -->
                                <circle cx="50" cy="50" r="40" stroke="currentColor" stroke-width="8" fill="none" 
                                        class="text-blue-500 dark:text-blue-400 progress-ring" 
                                        id="dhikrProgressRing"
                                        stroke-dasharray="251.2" 
                                        stroke-dashoffset="251.2"
                                        stroke-linecap="round"/>
                            </svg>
                            <!-- Counter Number -->
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-lg font-bold text-blue-600 dark:text-blue-400 dhikr-counter" id="dhikrCountNumber">0</span>
                </div>
                        </div>
                        <!-- Counter Title -->
                        <div class="text-right">
                            <h2 class="text-sm font-semibold text-gray-800 dark:text-gray-200" id="dhikrCounter"></h2>
                        </div>
                    </div>
                </div>
                
                <!-- Dhikr Content Card -->
                <div class="bg-gradient-to-br from-blue-50/50 to-purple-50/50 dark:from-blue-900/20 dark:to-purple-900/20 backdrop-blur-sm rounded-2xl p-6 border border-blue-200/30 dark:border-blue-700/30 mb-4">
                    <!-- Compact Hints inside content -->
                    <div class="flex flex-wrap gap-2 justify-center mb-4">
                        <div id="swipeHint" class="flex items-center bg-blue-100/60 dark:bg-blue-800/40 text-blue-600 dark:text-blue-400 px-2 py-1 rounded-full text-xs">
                            <i class="fas fa-arrows-alt-h mr-1 text-xs"></i> <span id="swipeHintText"> </span>
                        </div>
                        <div id="clickHint" class="flex items-center bg-green-100/60 dark:bg-green-800/40 text-green-600 dark:text-green-400 px-2 py-1 rounded-full text-xs">
                            <i class="fas fa-hand-pointer mr-1 cursor-pointer text-xs"></i> <span id="clickHintText"> </span>
                        </div>
                    </div>
                    
                    <p class="text-2xl leading-loose text-gray-800 dark:text-gray-200 mb-3 font-quran-original arabic-text" id="adhkarArabicText" dir="rtl"></p>
                    <span id="repeatCount" class="inline-block px-3 py-1 bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 rounded-full text-sm font-medium mb-3">
                    <span id="repeatLabel"></span>: <span id="repeatValue"></span>
                </span>
                    
                    <!-- Toggle Buttons -->
                    <div class="flex gap-2 mb-3">
                        <button onclick="toggleTransliteration()" id="transliterationBtn" class="bg-gradient-to-r from-green-100 to-emerald-100 dark:from-green-900/40 dark:to-emerald-900/40 hover:from-green-200 hover:to-emerald-200 dark:hover:from-green-900/60 dark:hover:to-emerald-900/60 text-green-700 dark:text-green-300 px-3 py-2 rounded-lg text-xs font-medium transition-all duration-200 border border-green-200/50 dark:border-green-700/50 shadow-sm hover:shadow-md transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500/50">
                            <i class="fas fa-volume-up mr-1"></i> <span>Pronunciation</span>
                        </button>
                        <button onclick="toggleTranslation()" id="translationBtn" class="bg-gradient-to-r from-blue-100 to-indigo-100 dark:from-blue-900/40 dark:to-indigo-900/40 hover:from-blue-200 hover:to-indigo-200 dark:hover:from-blue-900/60 dark:hover:to-indigo-900/60 text-blue-700 dark:text-blue-300 px-3 py-2 rounded-lg text-xs font-medium transition-all duration-200 border border-blue-200/50 dark:border-blue-700/50 shadow-sm hover:shadow-md transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                            <i class="fas fa-language mr-1"></i> <span>Translation</span>
                        </button>
                    </div>
                    
                    <!-- Transliteration (Hidden by default) -->
                    <div id="transliterationSection" class="hidden">
                        <p class="italic text-gray-600 dark:text-gray-400 mb-2 ltr-text" id="transliterationText" dir="ltr"></p>
                    </div>
                    
                    <!-- Translation (Hidden by default) -->
                    <div id="translationSection" class="hidden">
                        <p class="text-sm text-gray-700 dark:text-gray-300 ltr-text" id="translationTextDikr" dir="ltr"></p>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-6 gap-4">
                    <button onclick="prevDhikr()" id="btnPrev" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium" title="Previous - "></button>
                    <button onclick="nextDhikr()" id="btnNext" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-purple-300 font-medium" title="Next - "></button>            
                </div>


            </div>
        </div>

        <!-- Tasbih Tab Content -->
        <div id="tasbihContent" class="tab-content w-full max-w-lg p-3">
            <div class="bg-white/90 dark:bg-gray-800/90 rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-4 text-center islamic-pattern">
                <!-- Compact Header Section -->
                <div class="text-center mb-3">
                    <div class="w-10 h-10 mx-auto mb-2 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-hand-holding-heart text-sm text-white"></i>
                    </div>
                    <div class="flex items-center justify-center gap-2 mb-1">
                        <i class="fas fa-prayer-beads text-purple-600 dark:text-purple-400 text-lg"></i>
                        <h2 class="text-lg font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent" id="tasbihTitle"> </h2>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 text-xs">Digital Tasbih Counter</p>
                </div>
                
                <!-- Compact Counter and Dhikr Row -->
                <div class="flex gap-3 mb-4">
                    <!-- Counter Display Card -->
                    <div class="flex-1 bg-gradient-to-br from-white/80 to-gray-50/80 dark:from-gray-700/80 dark:to-gray-800/80 rounded-xl p-3 border border-purple-200/50 dark:border-purple-700/50 shadow-lg">
                        <div class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent mb-1" id="tasbihCount">0</div>
                        <div class="text-xs font-medium text-gray-600 dark:text-gray-400" id="tasbihTarget">Target: 33</div>
                    </div>
                    
                    <!-- Current Dhikr Card -->
                    <div class="flex-1 bg-gradient-to-r from-indigo-50/80 to-purple-50/80 dark:from-indigo-900/40 dark:to-purple-900/40 rounded-xl p-3 border border-indigo-200/50 dark:border-indigo-700/50">
                        <p class="text-base font-bold text-gray-800 dark:text-gray-200 mb-1" id="currentDhikr"> </p>
                        <p class="text-xs text-gray-600 dark:text-gray-400" id="currentDhikrTranslation">Glory be to Allah</p>
                    </div>
                </div>
                
                <!-- Count Button -->
                <button onclick="incrementTasbih()" class="w-24 h-24 bg-gradient-to-br from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white rounded-full text-xl font-bold shadow-2xl hover:shadow-purple-500/25 transform hover:scale-105 active:scale-95 transition-transform duration-100 focus:outline-none focus:ring-4 focus:ring-purple-300/50 mb-4 select-none touch-manipulation relative overflow-hidden" style="touch-action: manipulation;">
                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent rounded-full"></div>
                    <i class="fas fa-plus relative z-10"></i>
                </button>
                
                <!-- Compact Controls -->
                <div class="flex justify-center gap-2 mb-4">
                    <button onclick="resetTasbih()" class="bg-gradient-to-r from-gray-100/80 to-gray-200/80 dark:from-gray-700/80 dark:to-gray-600/80 backdrop-blur-sm hover:from-gray-200/80 hover:to-gray-300/80 dark:hover:from-gray-600/80 dark:hover:to-gray-500/80 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg transition-all duration-200 border border-gray-300/50 dark:border-gray-600/50 shadow-lg hover:shadow-xl text-sm">
                        <i class="fas fa-undo mr-1"></i> <span id="resetBtn"> </span>
                    </button>
                    <button onclick="changeTasbihTarget()" class="bg-gradient-to-r from-blue-100/80 to-indigo-100/80 dark:from-blue-900/40 dark:to-indigo-900/40 backdrop-blur-sm hover:from-blue-200/80 hover:to-indigo-200/80 dark:hover:from-blue-900/60 dark:hover:to-indigo-900/60 text-blue-700 dark:text-blue-300 px-4 py-2 rounded-lg transition-all duration-200 border border-blue-300/50 dark:border-blue-700/50 shadow-lg hover:shadow-xl text-sm">
                        <i class="fas fa-target mr-1"></i> <span id="targetBtn"> </span>
                    </button>
                </div>
                
                <!-- Compact Preset Dhikr Options -->
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="setDhikr(' ', 'Glory be to Allah', 33)" class="bg-gradient-to-r from-blue-50/80 to-cyan-50/80 dark:from-blue-900/40 dark:to-cyan-900/40 backdrop-blur-sm hover:from-blue-100/80 hover:to-cyan-100/80 dark:hover:from-blue-900/60 dark:hover:to-cyan-900/60 text-blue-700 dark:text-blue-300 p-3 rounded-lg text-sm font-medium transition-all duration-200 border border-blue-200/50 dark:border-blue-700/50 shadow-md hover:shadow-lg transform hover:scale-[1.02]">
                        <div class="flex items-center justify-between">
                            <span class="text-sm"> </span>
                            <span class="bg-blue-500/20 px-2 py-1 rounded-full text-xs">33</span>
                        </div>
                    </button>
                    <button onclick="setDhikr(' ', 'Praise be to Allah', 33)" class="bg-gradient-to-r from-green-50/80 to-emerald-50/80 dark:from-green-900/40 dark:to-emerald-900/40 backdrop-blur-sm hover:from-green-100/80 hover:to-emerald-100/80 dark:hover:from-green-900/60 dark:hover:to-emerald-900/60 text-green-700 dark:text-green-300 p-3 rounded-lg text-sm font-medium transition-all duration-200 border border-green-200/50 dark:border-green-700/50 shadow-md hover:shadow-lg transform hover:scale-[1.02]">
                        <div class="flex items-center justify-between">
                            <span class="text-sm"> </span>
                            <span class="bg-green-500/20 px-2 py-1 rounded-full text-xs">33</span>
                        </div>
                    </button>
                    <button onclick="setDhikr(' ', 'Allah is Greatest', 34)" class="bg-gradient-to-r from-red-50/80 to-pink-50/80 dark:from-red-900/40 dark:to-pink-900/40 backdrop-blur-sm hover:from-red-100/80 hover:to-pink-100/80 dark:hover:from-red-900/60 dark:hover:to-pink-900/60 text-red-700 dark:text-red-300 p-3 rounded-lg text-sm font-medium transition-all duration-200 border border-red-200/50 dark:border-red-700/50 shadow-md hover:shadow-lg transform hover:scale-[1.02]">
                        <div class="flex items-center justify-between">
                            <span class="text-sm"> </span>
                            <span class="bg-red-500/20 px-2 py-1 rounded-full text-xs">34</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Prayer Times Tab Content -->
        <div id="prayerContent" class="tab-content w-full max-w-lg p-3">
            <div class="bg-white/90 dark:bg-gray-800/90 rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-4 islamic-pattern">
                <!-- Compact Header Section -->
                <div class="text-center mb-4">
                    <div class="w-12 h-12 mx-auto mb-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-mosque text-lg text-white"></i>
                    </div>
                    <h2 class="text-xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent mb-1" id="prayerTitle"> </h2>
                    <p id="azan-location" class="text-gray-600 dark:text-gray-400 text-xs">  ...</p>
                </div>
                
                <!-- Compact Notification Toggle Card -->
                <div class="mb-4 p-3 bg-gradient-to-r from-blue-50/70 to-indigo-50/70 dark:from-blue-900/30 dark:to-indigo-900/30 backdrop-blur-sm rounded-lg border border-blue-200/50 dark:border-blue-700/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-bell text-white text-xs"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="notificationLabel">  </span>
                        </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="notificationToggle" class="sr-only peer">
                            <div class="w-10 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300/50 dark:peer-focus:ring-blue-800/50 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-gradient-to-r peer-checked:from-blue-500 peer-checked:to-indigo-600 shadow-inner"></div>
                    </label>
                    </div>
                </div>

                <!-- Compact Prayer Times List -->
                <div class="space-y-2">
                    <div class="bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-700/60 dark:to-gray-800/60 backdrop-blur-sm p-3 rounded-lg border border-gray-200/50 dark:border-gray-600/50 shadow-sm hover:shadow-md transition-all duration-200" id="azan-fajr">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-moon text-white text-xs"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300"></span>
                            </div>
                            <span class="font-bold text-base text-gray-800 dark:text-gray-200">--:--</span>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-700/60 dark:to-gray-800/60 backdrop-blur-sm p-3 rounded-lg border border-gray-200/50 dark:border-gray-600/50 shadow-sm hover:shadow-md transition-all duration-200" id="azan-sunrise">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-sun text-white text-xs"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300"></span>
                            </div>
                            <span class="font-bold text-base text-gray-800 dark:text-gray-200">--:--</span>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-700/60 dark:to-gray-800/60 backdrop-blur-sm p-3 rounded-lg border border-gray-200/50 dark:border-gray-600/50 shadow-sm hover:shadow-md transition-all duration-200" id="azan-dhuhr">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-cyan-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-sun text-white text-xs"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300"></span>
                            </div>
                            <span class="font-bold text-base text-gray-800 dark:text-gray-200">--:--</span>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-700/60 dark:to-gray-800/60 backdrop-blur-sm p-3 rounded-lg border border-gray-200/50 dark:border-gray-600/50 shadow-sm hover:shadow-md transition-all duration-200" id="azan-asr">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gradient-to-r from-orange-400 to-red-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-cloud-sun text-white text-xs"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300"></span>
                            </div>
                            <span class="font-bold text-base text-gray-800 dark:text-gray-200">--:--</span>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-700/60 dark:to-gray-800/60 backdrop-blur-sm p-3 rounded-lg border border-gray-200/50 dark:border-gray-600/50 shadow-sm hover:shadow-md transition-all duration-200" id="azan-maghrib">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gradient-to-r from-red-500 to-pink-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-moon text-white text-xs"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300"></span>
                            </div>
                            <span class="font-bold text-base text-gray-800 dark:text-gray-200">--:--</span>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-700/60 dark:to-gray-800/60 backdrop-blur-sm p-3 rounded-lg border border-gray-200/50 dark:border-gray-600/50 shadow-sm hover:shadow-md transition-all duration-200" id="azan-isha">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-star text-white text-xs"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300"></span>
                            </div>
                            <span class="font-bold text-base text-gray-800 dark:text-gray-200">--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="p-4 text-center space-x-2 border-t border-gray-200 dark:border-gray-700 mt-auto">
        <!-- Footer content removed - language toggle moved to header -->
    </footer>

    <script>
      function toArabicNumerals(num) {
        const arabicNumerals = ['', '', '', '', '', '', '', '', '', ''];
        return String(num).split('').map(digit => arabicNumerals[digit]).join('');
      }

      const adhkar = [];
      let current = 0;
      let filteredAdhkar = [];
let currentLang = 'ar';
let currentCity = "Amman";

// Simple Qibla Compass
      let compassActive = false;
      let currentHeading = 0;
      let qiblaAngle = 0;
      let userLocation = null;
      let smoothedHeading = null;

// Variables for swipe detection
let touchStartX = 0;
let touchEndX = 0;
const swipeThreshold = 50;

      // Add these new variables at the top with other variables
      let notificationEnabled = false;
      let prayerNotifications = {};
      let notificationTimeouts = [];
      let nextPrayerTimeout = null;

// Add Quran-related variables
let currentSurah = null;
let currentAyah = 0;
let quranData = null;
let translationData = null;
let currentTranslationKey = 'en.sahih'; // Default translation

// English Surah names mapping
const surahNamesEnglish = [
  "Al-Fatihah", "Al-Baqarah", "Aal-E-Imran", "An-Nisa", "Al-Maidah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
  "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Taha",
  "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum",
  "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
  "Fussilat", "Ash-Shuraa", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
  "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah",
  "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij",
  "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "Abasa",
  "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad",
  "Ash-Shams", "Al-Layl", "Ad-Duhaa", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat",
  "Al-Qari'ah", "At-Takathur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr",
  "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
];

// Add these new variables at the top with other variables
let isReadingMode = false;
let isTranslationVisible = true;
let currentBookmark = null;
let readingModeAyahs = [];

// Add these variables at the top with other variables
let isTafsirVisible = false;
let tafsirData = null;

// Add these variables at the top with other variables
let currentAudioSurah = null;
let currentAudioAyah = null;

// Reading progress variables
let progressBarVisible = false;
let scrollTimeout = null;

      // Tasbih Counter Variables
      let tasbihCount = 0;
      let tasbihTarget = 33;
      let currentTasbihText = ' ';
      let currentTasbihTranslation = 'Glory be to Allah';

      // Tasbih Functions
      function incrementTasbih() {
          tasbihCount++;
          document.getElementById('tasbihCount').textContent = tasbihCount;
          
          // Haptic feedback if available
          if (navigator.vibrate) {
              navigator.vibrate(50);
          }
          
          // Check if target reached
          if (tasbihCount === tasbihTarget) {
              // Celebration animation
              const button = event.target.closest('button');
              button.style.transform = 'scale(1.2)';
              setTimeout(() => {
                  button.style.transform = '';
              }, 200);
              
              // Show completion message
              const message = currentLang === 'ar' 
                  ? `  ${tasbihTarget}  ${currentTasbihText}` 
                  : `Completed ${tasbihTarget} of ${currentTasbihText}`;
              showToast(message, 'success');
              
              // Auto-reset after 2 seconds
              setTimeout(() => {
                  resetTasbih();
              }, 2000);
          }
          
          // Save to localStorage
          localStorage.setItem('tasbihCount', tasbihCount);
      }
      
      function resetTasbih() {
          tasbihCount = 0;
          document.getElementById('tasbihCount').textContent = tasbihCount;
          localStorage.removeItem('tasbihCount');
      }
      
      function changeTasbihTarget() {
          const newTarget = prompt(
              currentLang === 'ar' ? '  :' : 'Enter new target:',
              tasbihTarget
          );
          if (newTarget && !isNaN(newTarget) && newTarget > 0) {
              tasbihTarget = parseInt(newTarget);
              updateTasbihTarget();
              localStorage.setItem('tasbihTarget', tasbihTarget);
          }
      }
      
      function setDhikr(arabic, english, target) {
          currentTasbihText = arabic;
          currentTasbihTranslation = english;
          tasbihTarget = target;
          resetTasbih();
          updateTasbihDisplay();
          localStorage.setItem('currentTasbih', JSON.stringify({
              arabic: arabic,
              english: english,
              target: target
          }));
      }
      
      function updateTasbihDisplay() {
          document.getElementById('currentDhikr').textContent = currentTasbihText;
          document.getElementById('currentDhikrTranslation').textContent = currentTasbihTranslation;
          updateTasbihTarget();
      }
      
      function updateTasbihTarget() {
          const targetText = currentLang === 'ar' ? `: ${tasbihTarget}` : `Target: ${tasbihTarget}`;
          document.getElementById('tasbihTarget').textContent = targetText;
      }
      
      function loadTasbihState() {
          // Load saved count
          const savedCount = localStorage.getItem('tasbihCount');
          if (savedCount) {
              tasbihCount = parseInt(savedCount);
              document.getElementById('tasbihCount').textContent = tasbihCount;
          }
          
          // Load saved target
          const savedTarget = localStorage.getItem('tasbihTarget');
          if (savedTarget) {
              tasbihTarget = parseInt(savedTarget);
          }
          
          // Load saved dhikr
          const savedTasbih = localStorage.getItem('currentTasbih');
          if (savedTasbih) {
              const tasbih = JSON.parse(savedTasbih);
              currentTasbihText = tasbih.arabic;
              currentTasbihTranslation = tasbih.english;
              tasbihTarget = tasbih.target;
          }
          
          updateTasbihDisplay();
      }

      // Daily rotating hadiths collection
      const dailyHadiths = [
          {
              ar: "               ",
              en: "Whoever says 'Glory be to Allah and praise Him' one hundred times a day, his sins will be forgiven even if they are like the foam of the sea",
              source_ar: "  ",
              source_en: "Narrated by Bukhari and Muslim"
          },
          {
              ar: "                           ",
              en: "Whoever says 'There is no god but Allah alone, with no partner; His is the dominion and His is the praise, and He is able to do all things' one hundred times a day, it will be equivalent to freeing ten slaves",
              source_ar: "  ",
              source_en: "Narrated by Bukhari and Muslim"
          },
          {
              ar: "   :                      ",
              en: "Whoever says in the morning: 'O Allah, we have reached the morning and the dominion belongs to Allah, and praise be to Allah. There is no god but Allah alone, with no partner' one hundred times, it will be equivalent to freeing a slave",
              source_ar: "  ",
              source_en: "Narrated by Abu Dawud"
          },
          {
              ar: "                         ",
              en: "Whoever says 'In the name of Allah with whose name nothing is harmed on earth nor in heaven, and He is the All-Hearing, All-Knowing' three times, will not be suddenly afflicted by calamity until morning",
              source_ar: "   ",
              source_en: "Narrated by Abu Dawud and Tirmidhi"
          },
          {
              ar: "         :                    ",
              en: "No Muslim says when he reaches morning and evening three times: 'I am pleased with Allah as my Lord, Islam as my religion, and Muhammad  as my Messenger' except that it becomes Allah's right to please him on the Day of Resurrection",
              source_ar: "   ",
              source_en: "Narrated by Ahmad and Abu Dawud"
          },
          {
              ar: "                   ",
              en: "Whoever says 'I seek forgiveness from Allah besides whom there is no god, the Ever-Living, the Sustainer, and I repent to Him' will be forgiven even if he fled from battle",
              source_ar: "   ",
              source_en: "Narrated by Abu Dawud and Tirmidhi"
          },
          {
              ar: "          ",
              en: "Whoever says 'Glory be to Allah the Magnificent and praise be to Him' a palm tree will be planted for him in Paradise",
              source_ar: " ",
              source_en: "Narrated by Tirmidhi"
          },
          {
              ar: "         :      ",
              en: "Two phrases that are light on the tongue, heavy on the scale, and beloved to the Most Merciful: 'Glory be to Allah and praise be to Him, Glory be to Allah the Magnificent'",
              source_ar: "  ",
              source_en: "Narrated by Bukhari and Muslim"
          },
          {
              ar: "                ",
              en: "Whoever says 'There is no power and no strength except in Allah' it will be a cure for ninety-nine ailments, the least of which is worry",
              source_ar: " ",
              source_en: "Narrated by Al-Hakim"
          },
          {
              ar: "               ",
              en: "Whoever recites Ayat al-Kursi after each obligatory prayer, nothing prevents him from entering Paradise except death",
              source_ar: " ",
              source_en: "Narrated by An-Nasa'i"
          },
          {
              ar: "     :                    ",
              en: "Whoever says when going to bed: 'I believe in Allah besides whom there is no god, Who created everything and He knows all things' his previous sins will be forgiven",
              source_ar: "  ",
              source_en: "Narrated by Ibn As-Sunni"
          },
          {
              ar: "   :                ",
              en: "Whoever says when sleeping: 'Praise be to Allah Who fed us, gave us drink, sufficed us, and gave us shelter, for how many have no one to suffice them or give them shelter' will enter Paradise",
              source_ar: " ",
              source_en: "Narrated by Muslim"
          },
          {
              ar: "                 ",
              en: "Purification is half of faith, 'Praise be to Allah' fills the scale, and 'Glory be to Allah and praise be to Allah' fill what is between the heavens and the earth",
              source_ar: " ",
              source_en: "Narrated by Muslim"
          },
          {
              ar: "   :                       ",
              en: "Whoever says in the morning: 'O Allah, whatever blessing I or any of Your creation have received is from You alone, You have no partner. To You belongs praise and thanks' has fulfilled the gratitude of his day",
              source_ar: "  ",
              source_en: "Narrated by Abu Dawud"
          },
          {
              ar: "       :                    ",
              en: "Whoever says three times in the morning and evening: 'Allah is sufficient for me, there is no god but He, in Him I trust and He is the Lord of the Great Throne' Allah will suffice him in all his worldly and otherworldly concerns",
              source_ar: "  ",
              source_en: "Narrated by Abu Dawud"
          },
          {
              ar: "    :                     ",
              en: "Whoever says when hearing the call to prayer: 'O Allah, Lord of this perfect call and established prayer, grant Muhammad the intercession and favor, and raise him to the praised position You have promised him' my intercession will be lawful for him on the Day of Resurrection",
              source_ar: " ",
              source_en: "Narrated by Bukhari"
          },
          {
              ar: "        ",
              en: "Allah loves, when one of you does a job, that he does it with excellence",
              source_ar: " ",
              source_en: "Narrated by Al-Bayhaqi"
          },
          {
              ar: "           ",
              en: "A strong believer is better and more beloved to Allah than a weak believer, though both are good",
              source_ar: " ",
              source_en: "Narrated by Muslim"
          },
          {
              ar: "               ",
              en: "Whoever relieves a believer of distress in this world, Allah will relieve him of distress on the Day of Resurrection",
              source_ar: " ",
              source_en: "Narrated by Muslim"
          },
          {
              ar: "  ",
              en: "A good word is charity",
              source_ar: "  ",
              source_en: "Narrated by Bukhari and Muslim"
          },
          {
              ar: "         ",
              en: "Whoever believes in Allah and the Last Day should speak good or remain silent",
              source_ar: "  ",
              source_en: "Narrated by Bukhari and Muslim"
          },
          {
              ar: "                      ",
              en: "No human fills a vessel worse than his stomach. It is sufficient for the son of Adam to eat what will support his back. If he must eat more, then one third for food, one third for drink, and one third for air",
              source_ar: " ",
              source_en: "Narrated by Tirmidhi"
          },
          {
              ar: "             ",
              en: "Whoever loves to meet Allah, Allah loves to meet him, and whoever dislikes meeting Allah, Allah dislikes meeting him",
              source_ar: "  ",
              source_en: "Narrated by Bukhari and Muslim"
          },
          {
              ar: "       ",
              en: "Be keen on what benefits you, seek Allah's help, and do not be incapable",
              source_ar: " ",
              source_en: "Narrated by Muslim"
          },
          {
              ar: "           ",
              en: "Allah does not look at your forms and wealth, but He looks at your hearts and deeds",
              source_ar: " ",
              source_en: "Narrated by Muslim"
          },
          {
              ar: "       ",
              en: "Whoever does a deed that is not in accordance with our matter will have it rejected",
              source_ar: " ",
              source_en: "Narrated by Muslim"
          },
          {
              ar: "    :      ",
              en: "Religion is sincere advice. We said: To whom? He said: To Allah, His Book, His Messenger, and to the leaders and common people of the Muslims",
              source_ar: " ",
              source_en: "Narrated by Muslim"
          },
          {
              ar: "    ",
              en: "Your smile in your brother's face is charity",
              source_ar: " ",
              source_en: "Narrated by Tirmidhi"
          },
          {
              ar: "           ",
              en: "Fear Allah wherever you are, follow a bad deed with a good one to erase it, and treat people with good character",
              source_ar: " ",
              source_en: "Narrated by Tirmidhi"
          }
      ];

      // Function to get today's hadith based on the day of the month
      function getTodaysHadith() {
          const today = new Date();
          const dayOfMonth = today.getDate(); // Gets 1-31
          const hadithIndex = (dayOfMonth - 1) % dailyHadiths.length; // Convert to 0-based index and cycle through array
          return dailyHadiths[hadithIndex];
      }

             // Function to update the daily reminder with today's hadith
       function updateDailyReminder() {
           const todaysHadith = getTodaysHadith();
           displayHadith(todaysHadith);
       }

       // Function to display a hadith in the reminder section
       function displayHadith(hadith) {
           const reminderText = document.getElementById('reminderText');
           const reminderSource = document.getElementById('reminderSource');
           
           if (reminderText && reminderSource) {
               if (currentLang === 'ar') {
                   reminderText.textContent = `   : "${hadith.ar}"`;
                   reminderSource.textContent = hadith.source_ar;
               } else {
                   reminderText.textContent = `The Prophet  said: "${hadith.en}"`;
                   reminderSource.textContent = hadith.source_en;
               }
           }
       }

       // Function to generate a random hadith
       function generateRandomHadith() {
           const randomIndex = Math.floor(Math.random() * dailyHadiths.length);
           const randomHadith = dailyHadiths[randomIndex];
           displayHadith(randomHadith);
           
           // Add a subtle animation to indicate change
           const reminderText = document.getElementById('reminderText');
           if (reminderText) {
               reminderText.style.opacity = '0.5';
               setTimeout(() => {
                   reminderText.style.opacity = '1';
               }, 150);
           }
       }

       // Function to load saved language preference
       function loadLanguagePreference() {
           const savedLang = localStorage.getItem('preferredLanguage');
           if (savedLang && (savedLang === 'ar' || savedLang === 'en')) {
               currentLang = savedLang;
               tafsirLang = currentLang;
               document.documentElement.lang = currentLang;
               document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
           }
       }

      const languages = {
          ar: {
              title: "Sakinah",
              morning: " ",
              evening: " ",
              previous: "",
              next: "",
              backText: "",
              langSwitch: "English",
              counter: (i, total) => ` ${i}  ${total}`,
              repeatLabel: "",
                      swipeHint: " ",
              clickHint: " ",
              prayerTitle: " ",
              fajr: "",
              dhuhr: "",
              asr: "",
              maghrib: "",
              isha: "",
              refresh: "",
              adhkarTab: "",
              prayerTab: " ",
              qiblaTab: "",
              tasbihTab: "",
              quranTab: "",
              quranTitle: " ",
              selectSurah: " ",
              arabic: "",
              english: "English",
              locationText: (city, timezone) => `: ${city} |  : ${timezone}`,
              arErrorTitle: "   ",
              arErrorMessage: "      ",
              fallbackBtnText: "  ",
              calibrationMessage: "     8  ",
              calibrationDone: "",
              alignedMessage: "  ",
        locationTitle: " ",
        startCompassText: " ",
        helpText: "  ",
        helpModalTitle: "  ",
        closeHelpText: "",
        accuracyHigh: " ",
        accuracyMedium: " ",
        facingQibla: "   ",
        closeToQibla: "  ",
        turnRight: " ",
        calculating: " ...",
        clickStartCompass: " \" \" ",
        notConnected: " ",
        compassInstructions: [
          "1.   \" \" ",
          "2.    ",
          "3.     ",
          "4.     ",
          "5.       "
        ],
        turnLeft: " ",
              tiltMessage: "   ",
              notificationPermissionDenied: "      ",
              prayerTimeNotification: "  ",
              prayerTimeNotificationBody: "  ",
              prayerTimeApproaching: "  ",
              prayerTimeApproachingBody: "  ",
              tutorialTitle: " ",
              tutorialIOS: {
                  title: "   iOS",
                  steps: [
                      "    (Share)   ",
                      " \"   \" (Add to Home Screen)",
                      " \"\" (Add)  ",
                      "    ",
                      "     "
                  ],
                  note: ":            "
              },
              tutorialAndroid: {
                  title: "   Android",
                  steps: [
                      "    ( )  ",
                      " \"   \" (Add to Home Screen)",
                      " \"\" (Add)",
                      "    ",
                      "     "
                  ]
              },
              gotIt: "",
              notificationLabel: "  ",
              bookmarkVerse: "   ",
              translationNames: {
                  // English
                  "en.sahih": " ()",
                  "en.pickthall": " ()",
                  "en.yusufali": " ( )",
                  "en.hilali": " (-)",
                  "en.arberry": " ()",
                  "en.asad": " ( )",
                  "en.daryabadi": " ()",
                  "en.shakir": " ()",
                  // French
                  "fr.hamidullah": " ( )",
                  "fr.leclerc": " ()",
                  // German
                  "de.bubenheim": " ()",
                  "de.khoury": " ()",
                  // Spanish
                  "es.cortes": " ()",
                  "es.garcia": " ()",
                  // Italian
                  "it.piccardo": " ()",
                  // Portuguese
                  "pt.elhayek": " ()",
                  // Russian
                  "ru.kuliev": " ()",
                  "ru.osmanov": " ()",
                  // Turkish
                  "tr.diyanet": " ()",
                  "tr.bulac": " ()",
                  // Urdu
                  "ur.junagarhi": " ( )",
                  "ur.kanzuliman": " ( )",
                  // Indonesian
                  "id.indonesian": " ( )",
                  // Malay
                  "ms.basmeih": " ()",
                  // Dutch
                  "nl.keyzer": " ()",
                  // Bengali
                  "bn.bengali": " ( )",
                  // Chinese
                  "zh.jian": "  ()",
                  // Japanese
                  "ja.japanese": " ( )",
                  // Korean
                  "ko.korean": " ( )",
                  // Hindi
                  "hi.hindi": " ( )",
                  // Tamil
                  "ta.tamil": " ( )",
                  // Persian/Farsi
                  "fa.ansarian": " ()",
                  "fa.makarem": " ( )",
                  // Azerbaijani
                  "az.mammadaliyev": " ( )",
                  // Albanian
                  "sq.ahmeti": " ()",
                  // Bosnian
                  "bs.korkut": " ()",
                  // Czech
                  "cs.hrbek": " ()",
                  // Norwegian
                  "no.berg": " ()",
                  // Swedish
                  "sv.bernstrom": " ()",
                  // Thai
                  "th.thai": " ( )",
                  // Kurdish
                  "ku.asan": " ()",
                  // Hausa
                  "ha.gumi": " (  )",
                  // Swahili
                  "sw.barwani": " ()",
                  // Somali
                  "so.abduh": " ()",
                  // Amharic
                  "am.sadiq": " ()",
                  // Yoruba
                  "yo.mikail": " ()"
              },
              azkarTypes: {
                sabah: " ",
                masaa: " ",
                waking_sleeping: "  ",
                home: "   ",
                bathroom: "   ",
                eating: "   ",
                masjid: "   ",
                traveling: " ",
                clothes: "  ",
                anxiety: "  ",
                hardship: " ",
                istighfar: " ",
                patience_gratitude: "  ",
                rabbana: " ",
                prophetic: " ",
                prophets: " ",
                rain: " ",
                patient: " ",
                deceased: " ",
                marriage_children_rizq: "  ",
                protection: " ",
                salah: " ",
                sujood_tashahhud: "  ",
                qunoot: " ",
                tahajjud: " ",
                istikhara: " ",
                ramadan: " ",
                hajj: " ",
                laylat_al_qadr: "  ",
                eid: " ",
                natural_events: "  "
              },
              sunrise: "",
              // Navigation button texts
              previousVerse: "",
              nextVerse: "",
              previousSurah: " ",
              nextSurah: " ",
              // Adhkar home page texts
              
              morningCardTitle: " ",
              morningCardDesc: "   ",
              eveningCardTitle: " ",
              eveningCardDesc: "   ",
              moreAdhkarTitle: "  ",
              moreAdhkarDesc: "   ",
              popularCategoriesTitle: "  ",
              protectionLabel: " ",
              istighfarLabel: "",
              anxietyLabel: " ",
              prayerLabel: " ",
              reminderTitle: " ",
              randomHadithBtn: " ",
              // Tasbih translations
              tasbihTitle: " ",
              resetBtn: " ",
              targetBtn: " ",
              dailyAdhkarTitle: " ",
              dailyAdhkarDesc: "      ",
              quickSurahsTitle: "  ",
              quickSurahsDesc: "    ",
              displayFullSurah: "  "
          },
          en: {
              title: "Sakinah",
              morning: "Morning Azkar",
              evening: "Evening Azkar",
              previous: "Previous",
              next: "Next",
              backText: "Back",
              langSwitch: "",
              counter: (i, total) => `Zikr ${i} of ${total}`,
              repeatLabel: "Repeat",
                      swipeHint: "Swipe to navigate",
              clickHint: "Click to Count",
              prayerTitle: "Prayer Times",
              fajr: "Fajr",
              dhuhr: "Dhuhr",
              asr: "Asr",
              maghrib: "Maghrib",
              isha: "Isha",
              refresh: "Refresh",
              adhkarTab: "Azkar",
              prayerTab: "Prayer Times",
              qiblaTab: "Qibla",
              tasbihTab: "Tasbih",
              quranTab: "Quran",
              quranTitle: "The Holy Quran",
              selectSurah: "Select Surah",
              arabic: "Arabic",
              english: "English",
              locationText: (city, timezone) => `City: ${city} | Timezone: ${timezone}`,
              arErrorTitle: "AR Unsupported",
              arErrorMessage: "This feature requires a mobile device with motion sensors",
              fallbackBtnText: "Use Basic Compass",
              calibrationMessage: "Move your device in a figure-8 pattern to calibrate the compass",
              calibrationDone: "Done",
              alignedMessage: "Aligned with Qibla",
        locationTitle: "Current Location",
        startCompassText: "Start Compass",
        helpText: "How to use compass?",
        helpModalTitle: "How to Use Compass",
        closeHelpText: "OK",
        accuracyHigh: "High Accuracy",
        accuracyMedium: "Medium Accuracy",
        facingQibla: "Facing Qibla ",
        closeToQibla: "Close to Qibla",
        turnRight: "Turn right",
        calculating: "Calculating...",
        clickStartCompass: "Click 'Start Compass' to begin",
        notConnected: "Not connected",
        compassInstructions: [
          "1. Click 'Start Compass' to begin",
          "2. Hold your device flat",
          "3. The red arrow points to North",
          "4. The Kaaba icon points to Qibla",
          "5. Turn until the Kaaba icon is at the top"
        ],
        turnLeft: "Turn left",
              tiltMessage: "Hold device flat",
              notificationPermissionDenied: "Please allow notifications to receive prayer time alerts",
              prayerTimeNotification: "Prayer Time",
              prayerTimeNotificationBody: "It's time for prayer",
              prayerTimeApproaching: "Prayer Time",
              prayerTimeApproachingBody: "It's time for",
              tutorialTitle: "Enable Notifications",
              tutorialIOS: {
                  title: "Enable Notifications on iOS",
                  steps: [
                      "Tap the Share button at the bottom of the browser",
                      "Select \"Add to Home Screen\"",
                      "Tap \"Add\" at the top",
                      "Open the app from your home screen",
                      "Enable notifications when prompted"
                  ],
                  note: "Note: The app must be opened from the home screen for notifications to work properly"
              },
              tutorialAndroid: {
                  title: "Enable Notifications on Android",
                  steps: [
                      "Tap the menu button (three dots) at the top",
                      "Select \"Add to Home Screen\"",
                      "Tap \"Add\"",
                      "Open the app from your home screen",
                      "Enable notifications when prompted"
                  ]
              },
              gotIt: "Got it",
              notificationLabel: "Prayer Time Notifications",
              bookmarkVerse: "Click to bookmark this verse",
              translationNames: {
                  // English
                  "en.sahih": "English (Sahih Intl)",
                  "en.pickthall": "English (Pickthall)",
                  "en.yusufali": "English (Yusuf Ali)",
                  "en.hilali": "English (Hilali-Khan)",
                  "en.arberry": "English (Arberry)",
                  "en.asad": "English (Muhammad Asad)",
                  "en.daryabadi": "English (Daryabadi)",
                  "en.shakir": "English (Shakir)",
                  // French
                  "fr.hamidullah": "Franais (Hamidullah)",
                  "fr.leclerc": "Franais (Leclerc)",
                  // German
                  "de.bubenheim": "Deutsch (Bubenheim)",
                  "de.khoury": "Deutsch (Khoury)",
                  // Spanish
                  "es.cortes": "Espaol (Corts)",
                  "es.garcia": "Espaol (Garca)",
                  // Italian
                  "it.piccardo": "Italiano (Piccardo)",
                  // Portuguese
                  "pt.elhayek": "Portugus (El Hayek)",
                  // Russian
                  "ru.kuliev": " ()",
                  "ru.osmanov": " ()",
                  // Turkish
                  "tr.diyanet": "Trke (Diyanet)",
                  "tr.bulac": "Trke (Bula)",
                  // Urdu
                  "ur.junagarhi": " ( )",
                  "ur.kanzuliman": " ( )",
                  // Indonesian
                  "id.indonesian": "Bahasa Indonesia (Kementerian Agama)",
                  // Malay
                  "ms.basmeih": "Bahasa Melayu (Basmeih)",
                  // Dutch
                  "nl.keyzer": "Nederlands (Keyzer)",
                  // Bengali
                  "bn.bengali": " ( )",
                  // Chinese
                  "zh.jian": " ()",
                  // Japanese
                  "ja.japanese": " ()",
                  // Korean
                  "ko.korean": " ()",
                  // Hindi
                  "hi.hindi": " ( )",
                  // Tamil
                  "ta.tamil": " ( )",
                  // Persian/Farsi
                  "fa.ansarian": " ()",
                  "fa.makarem": " ( )",
                  // Azerbaijani
                  "az.mammadaliyev": "Azrbaycan (Mmmdliyev)",
                  // Albanian
                  "sq.ahmeti": "Shqip (Ahmeti)",
                  // Bosnian
                  "bs.korkut": "Bosanski (Korkut)",
                  // Czech
                  "cs.hrbek": "etina (Hrbek)",
                  // Norwegian
                  "no.berg": "Norsk (Berg)",
                  // Swedish
                  "sv.bernstrom": "Svenska (Bernstrm)",
                  // Thai
                  "th.thai": " ()",
                  // Kurdish
                  "ku.asan": " ()",
                  // Hausa
                  "ha.gumi": "Hausa (Abubakar Gumi)",
                  // Swahili
                  "sw.barwani": "Kiswahili (Barwani)",
                  // Somali
                  "so.abduh": "Soomaali (Abduh)",
                  // Amharic
                  "am.sadiq": " ()",
                  // Yoruba
                  "yo.mikail": "Yorb (Mikail)"
              },
              azkarTypes: {
                sabah: "Morning Azkar",
                masaa: "Evening Azkar",
                waking_sleeping: "Waking & Sleeping Duas",
                home: "Entering & Leaving Home Duas",
                bathroom: "Entering & Exiting Bathroom Duas",
                eating: "Before & After Eating Duas",
                masjid: "Entering & Exiting Masjid Duas",
                traveling: "Traveling Duas",
                clothes: "Wearing Clothes Duas",
                anxiety: "Duas for Anxiety & Sadness",
                hardship: "Duas in Times of Hardship",
                istighfar: "Seeking Forgiveness (Istighfar)",
                patience_gratitude: "Duas for Patience & Gratitude",
                rabbana: "Rabbana Duas (from the Qur'an)",
                prophetic: "Prophetic Duas from Hadith",
                prophets: "Duas of the Prophets",
                rain: "Duas for Rain / Drought",
                patient: "Duas for the Sick",
                deceased: "Duas for the Deceased",
                marriage_children_rizq: "Duas for Marriage, Children, Rizq",
                protection: "Duas for Protection (Evil Eye, Jinn, Calamity)",
                salah: "Duas before and after Salah",
                sujood_tashahhud: "Duas during Sujood & Tashahhud",
                qunoot: "Duas for Qunoot (Witr prayer)",
                tahajjud: "Duas for Tahajjud",
                istikhara: "Dua for Istikhara (Seeking Guidance)",
                ramadan: "Ramadan Duas",
                hajj: "Dhul Hijjah & Hajj-related Duas",
                laylat_al_qadr: "Laylat al-Qadr Duas",
                eid: "Eid Duas",
                natural_events: "Duas for Natural Events (Rain, Eclipse, Earthquake, etc.)"
              },
              sunrise: "Sunrise",
              // Navigation button texts
              previousVerse: "Previous",
              nextVerse: "Next",
              previousSurah: "Previous Surah",
              nextSurah: "Next Surah",
              // Adhkar home page texts

              morningCardTitle: "Morning Azkar",
              morningCardDesc: "Begin your day with dhikr and dua",
              eveningCardTitle: "Evening Azkar",
              eveningCardDesc: "End your day with dhikr and istighfar",
              moreAdhkarTitle: "More Azkar",
              moreAdhkarDesc: "Discover all sections of azkar",
              popularCategoriesTitle: "Most Used Azkar",
              protectionLabel: "Protection",
              istighfarLabel: "Forgiveness",
              anxietyLabel: "Anxiety",
              prayerLabel: "Prayer",
              reminderTitle: "Daily Reminder",
              randomHadithBtn: "Another Hadith",
              // Tasbih translations
              tasbihTitle: "Digital Tasbih",
              resetBtn: "Reset",
              targetBtn: "Change Target",
              dailyAdhkarTitle: "Daily Azkar",
              dailyAdhkarDesc: "Choose from a variety of azkar and duas",
              quickSurahsTitle: "Most Read Surahs",
              quickSurahsDesc: "Quick access to commonly read surahs",
              displayFullSurah: "Display full surah"
          }
      };


      // Add debug logging to API calls
      async function fetchPrayerTimes(city = "Amman") {
          const today = new Date().toISOString().split('T')[0];
          const formattedDate = today.split('-').reverse().join('-');
          const cacheKey = `prayer-${city}-${formattedDate}`;
          
          const strategies = [
              async () => {
                  const url = `https://api.aladhan.com/v1/timingsByAddress/${formattedDate}?address=${encodeURIComponent(city)}`;
                  const response = await fetch(url);
                  if (!response.ok) throw new Error(`Direct API failed: ${response.status}`);
                  return response.json();
              },
              
              async () => {
                  const cache = await caches.open('api-cache-v1');
                  const cached = await cache.match(`https://api.aladhan.com/v1/timingsByAddress/${formattedDate}?address=${encodeURIComponent(city)}`);
                  if (!cached) throw new Error('No cache available');
                  return cached.json();
              },
              
              async () => {
                  const stored = localStorage.getItem(cacheKey);
                  if (!stored) throw new Error('No localStorage data');
                  return JSON.parse(stored);
              }
          ];

          for (const strategy of strategies) {
              try {
                  const data = await strategy();
                  localStorage.setItem(cacheKey, JSON.stringify(data));
                  
                  if (data.code === 200) {
                      const timings = data.data.timings;
                      const location = data.data.meta.timezone;
                      
                      prayerNotifications = timings;
                      savePrayerTimes(timings, location, city);

                      document.getElementById("azan-location").innerText = languages[currentLang].locationText(city, location);
                      // Debug prayer time selectors
                      console.log("=== DEBUGGING PRAYER TIME UPDATES ===");
                      console.log("Prayer times data:", timings);
                      
                      // Test different selectors for Fajr time
                      const fajrCard = document.getElementById('azan-fajr');
                      if (fajrCard) {
                          const allSpans = fajrCard.querySelectorAll('span');
                          console.log("Fajr card spans:", allSpans.length);
                          allSpans.forEach((span, index) => {
                              console.log(`Fajr span ${index}:`, span.textContent, span.className);
                          });
                          
                          // Try different selectors
                          const selector1 = fajrCard.querySelector('.flex span:last-child');
                          const selector2 = fajrCard.querySelector('.font-bold');
                          const selector3 = fajrCard.querySelector('span:nth-child(2)');
                          
                          console.log("Selector '.flex span:last-child':", selector1);
                          console.log("Selector '.font-bold':", selector2);
                          console.log("Selector 'span:nth-child(2)':", selector3);
                      }
                      
                      // Use the working selector for prayer times
                      const fajrTimeSpan = document.querySelector("#azan-fajr .font-bold");
                      if (fajrTimeSpan) {
                          console.log("Updating Fajr time from", fajrTimeSpan.innerText, "to", timings.Fajr);
                          fajrTimeSpan.innerText = timings.Fajr;
                      } else {
                          console.error("Fajr time span not found!");
                      }
                      
                      const sunriseTimeSpan = document.querySelector("#azan-sunrise .font-bold");
                      if (sunriseTimeSpan) sunriseTimeSpan.innerText = timings.Sunrise;
                      
                      const dhuhrTimeSpan = document.querySelector("#azan-dhuhr .font-bold");
                      if (dhuhrTimeSpan) dhuhrTimeSpan.innerText = timings.Dhuhr;
                      
                      const asrTimeSpan = document.querySelector("#azan-asr .font-bold");
                      if (asrTimeSpan) asrTimeSpan.innerText = timings.Asr;
                      
                      const maghribTimeSpan = document.querySelector("#azan-maghrib .font-bold");
                      if (maghribTimeSpan) maghribTimeSpan.innerText = timings.Maghrib;
                      
                      const ishaTimeSpan = document.querySelector("#azan-isha .font-bold");
                      if (ishaTimeSpan) ishaTimeSpan.innerText = timings.Isha;
                      
                      console.log("=== END PRAYER TIME DEBUGGING ===");
                      
                      // Update prayer names after setting times
                      updatePrayerTimesUI();

                      if (notificationEnabled) {
                          setupPrayerNotifications();
                      }
                      return;
                  }
              } catch (error) {
                  continue;
              }
          }

          document.getElementById("azan-location").innerText = languages[currentLang].arErrorMessage;
          throw new Error('All prayer time fetch strategies failed');
      }

            // Simple Compass Initialization
      async function initQiblaCompass() {
          const startBtn = document.getElementById('startCompassBtn');
          const startText = document.getElementById('startCompassText');
          
          try {
              // Update button to show loading
              startBtn.disabled = true;
              startText.textContent = currentLang === 'ar' ? ' ...' : 'Loading...';
              
              // Check for device orientation support
              if (!('DeviceOrientationEvent' in window)) {
                  throw new Error("orientation_not_supported");
              }

              // For iOS, request motion permission
              const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
              if (isIOS && typeof DeviceOrientationEvent.requestPermission === 'function') {
                  const permission = await DeviceOrientationEvent.requestPermission();
                  if (permission !== 'granted') {
                      throw new Error("motion_permission_denied");
                  }
              }

              // Get user location
              const position = await new Promise((resolve, reject) => {
                  navigator.geolocation.getCurrentPosition(resolve, reject, {
                      enableHighAccuracy: true,
                      timeout: 10000,
                      maximumAge: 60000
                  });
              });

              // Store location and calculate Qibla
              userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
              };
              
              qiblaAngle = calculateQiblaAngle(position.coords.latitude, position.coords.longitude);
              updateLocationDisplay(position.coords.latitude, position.coords.longitude);

              // Start compass
              compassActive = true;
              // Remove any previous listeners to avoid duplicates
              window.removeEventListener('deviceorientation', handleCompassOrientation);
              window.removeEventListener('deviceorientationabsolute', handleCompassOrientation);
              if ('ondeviceorientationabsolute' in window) {
                  window.addEventListener('deviceorientationabsolute', handleCompassOrientation, true);
              } else {
                  window.addEventListener('deviceorientation', handleCompassOrientation, true);
              }
              
              // Hide start button and show compass
              startBtn.style.display = 'none';
              updateCompassDisplay();

          } catch (error) {
              console.error("Compass initialization failed:", error);
              startBtn.disabled = false;
              startText.textContent = currentLang === 'ar' ? ' ' : 'Start Compass';
              
              // Show error
              if (error.message === "orientation_not_supported") {
                  showCompassError(currentLang === 'ar' ? '     ' : 'Compass not supported on this device');
              } else if (error.message === "motion_permission_denied") {
                  showCompassError(currentLang === 'ar' ? '     ' : 'Please allow motion sensor access');
              } else if (error.code === 1) {
                  showCompassError(currentLang === 'ar' ? '    ' : 'Please allow location access');
              } else {
                  showCompassError(currentLang === 'ar' ? '    ' : 'Error starting compass');
              }
          }
      }

      // Enhanced compass orientation handler with better smoothing
      function handleCompassOrientation(event) {
          if (!compassActive) return;

          let heading = 0;
          
          // Check if iOS with accurate webkitCompassHeading
          if (event.webkitCompassHeading !== undefined) {
              // iOS provides accurate magnetic heading
              heading = event.webkitCompassHeading;
          } else if (event.alpha !== null) {
              // For Android and other devices, use alpha
              heading = Math.abs(event.alpha - 360);
          } else {
              return; // No valid orientation data
          }

          // Enhanced smoothing with adaptive factor
          if (smoothedHeading === null) {
              smoothedHeading = heading;
          } else {
              let diff = heading - smoothedHeading;
              // Handle 360/0 degree boundary
              if (diff > 180) diff -= 360;
              if (diff < -180) diff += 360;
              
              // Adaptive smoothing - less smoothing when moving fast, more when stable
              const smoothingFactor = Math.abs(diff) > 10 ? 0.3 : 0.1;
              smoothedHeading = (smoothedHeading + diff * smoothingFactor + 360) % 360;
          }

          currentHeading = smoothedHeading;
          updateCompassDisplay();
      }

      // Update compass display with new rotating compass rose approach
      function updateCompassDisplay() {
          if (!compassActive || typeof qiblaAngle === 'undefined') return;

          const compassRose = document.getElementById('compassRose');
          const degreeDisplay = document.getElementById('degreeDisplay');
          const directionStatus = document.getElementById('directionStatus');
          const accuracyIndicator = document.getElementById('accuracyIndicator');
          const accuracyText = document.getElementById('accuracyText');

          // Rotate compass rose to show current heading (opposite direction)
          if (compassRose) {
              compassRose.style.transform = `rotate(${-currentHeading}deg)`;
          }

          // Calculate Qibla direction relative to current heading
          const qiblaRelative = (qiblaAngle - currentHeading + 360) % 360;
          
          // Show current heading in degrees
          if (degreeDisplay) {
              degreeDisplay.textContent = `${Math.round(currentHeading)}`;
          }

          // Calculate alignment difference for status
          const alignmentDiff = Math.min(qiblaRelative, 360 - qiblaRelative);

          // Update direction status with enhanced animations
          if (directionStatus) {
              if (alignmentDiff <= 5) {
                  directionStatus.textContent = languages[currentLang].facingQibla;
                  directionStatus.className = 'text-sm font-semibold qibla-text-glow';
                  
                  // Add haptic feedback when perfectly aligned
                  if (alignmentDiff <= 2 && 'vibrate' in navigator) {
                      navigator.vibrate([100, 50, 100]);
                  }
              } else if (alignmentDiff <= 15) {
                  directionStatus.textContent = languages[currentLang].closeToQibla;
                  directionStatus.className = 'text-sm text-yellow-600 dark:text-yellow-400 animate-pulse';
              } else {
                  // Calculate turn direction and angle
                  const turnAngle = Math.round(Math.min(qiblaRelative, 360 - qiblaRelative));
                  const direction = qiblaRelative < 180 ? 
                      `${languages[currentLang].turnRight} ${turnAngle}` : 
                      `${languages[currentLang].turnLeft} ${turnAngle}`;
                  directionStatus.textContent = direction;
                  directionStatus.className = 'text-sm text-gray-600 dark:text-gray-300';
              }
          }

          // Update accuracy indicator
          const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
          if (accuracyIndicator && accuracyText) {
              if (isIOS) {
                  accuracyIndicator.className = 'w-2 h-2 rounded-full bg-green-500';
                  accuracyText.textContent = languages[currentLang].accuracyHigh;
              } else {
                  accuracyIndicator.className = 'w-2 h-2 rounded-full bg-yellow-500';
                  accuracyText.textContent = languages[currentLang].accuracyMedium;
              }
          }

          // Add enhanced visual feedback when aligned
          const qiblaTab = document.getElementById('qiblaTab');
          const qiblaIndicator = document.querySelector('.bg-green-500.animate-pulse');
          const alignmentRings = document.querySelectorAll('#alignmentRings .ring');
          
          if (qiblaTab) {
              if (alignmentDiff <= 5) {
                  qiblaTab.classList.add('qibla-glow');
                  qiblaTab.style.backgroundColor = 'rgba(34, 197, 94, 0.15)';
                  qiblaTab.style.borderColor = 'rgb(34, 197, 94)';
                  qiblaTab.style.boxShadow = '0 0 30px rgba(34, 197, 94, 0.8)';
                  qiblaTab.style.transform = 'scale(1.02)';
              } else {
                  qiblaTab.classList.remove('qibla-glow');
                  qiblaTab.style.backgroundColor = '';
                  qiblaTab.style.borderColor = '';
                  qiblaTab.style.boxShadow = '';
                  qiblaTab.style.transform = '';
              }
          }
          
          // Enhance compass rose animation when aligned
          if (compassRose && alignmentDiff <= 5) {
              compassRose.classList.add('qibla-perfect-aligned');
          } else if (compassRose) {
              compassRose.classList.remove('qibla-perfect-aligned');
          }
          
          // Add expanding ring animation
          alignmentRings.forEach((ring, index) => {
              if (alignmentDiff <= 5) {
                  ring.classList.add('qibla-ring-expand');
                  ring.style.animationDelay = `${index * 0.3}s`;
              } else {
                  ring.classList.remove('qibla-ring-expand');
                  ring.style.animationDelay = '';
              }
          });
          
          // Enhance qibla indicator animation when aligned
          if (qiblaIndicator) {
              if (alignmentDiff <= 5) {
                  qiblaIndicator.classList.add('qibla-perfect-aligned');
                  qiblaIndicator.style.boxShadow = '0 0 40px rgba(34, 197, 94, 1)';
              } else {
                  qiblaIndicator.classList.remove('qibla-perfect-aligned');
                  qiblaIndicator.style.animation = 'pulse 2s ease-in-out infinite';
                  qiblaIndicator.style.transform = 'scale(1)';
                  qiblaIndicator.style.boxShadow = '';
              }
          }
      }

      function calculateQiblaAngle(lat, lng) {
          // Kaaba coordinates
          const kaabaLat = 21.4224779;
          const kaabaLng = 39.8262136;

          // Convert to radians
          const 1 = lat * Math.PI / 180;
          const 2 = kaabaLat * Math.PI / 180;
          const  = (kaabaLng - lng) * Math.PI / 180;

          // Calculate bearing
          const y = Math.sin() * Math.cos(2);
          const x = Math.cos(1) * Math.sin(2) - Math.sin(1) * Math.cos(2) * Math.cos();
          
          let bearing = Math.atan2(y, x) * 180 / Math.PI;
          bearing = (bearing + 360) % 360;
          
          return bearing;
      }
      
      // Update location display
      function updateLocationDisplay(lat, lng) {
          const locationInfo = document.getElementById('locationInfo');
          const qiblaDistance = document.getElementById('qiblaDistance');
          
          if (locationInfo) {
              // Simple location display
              locationInfo.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
          }
          
          if (qiblaDistance) {
              // Calculate distance to Mecca
              const distance = calculateDistanceToMecca(lat, lng);
              qiblaDistance.textContent = currentLang === 'ar' ? 
                  `${distance}   ` : 
                  `${distance} km to Mecca`;
          }
      }

      // Calculate distance to Mecca
      function calculateDistanceToMecca(lat, lng) {
          const kaabaLat = 21.4224779;
          const kaabaLng = 39.8262136;
          
          const R = 6371; // Earth's radius in km
          const dLat = (kaabaLat - lat) * Math.PI / 180;
          const dLng = (kaabaLng - lng) * Math.PI / 180;
          
          const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat * Math.PI / 180) * Math.cos(kaabaLat * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
          
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          const distance = R * c;
          
          return Math.round(distance).toLocaleString();
      }

      // Show compass error
      function showCompassError(message) {
          const directionStatus = document.getElementById('directionStatus');
          if (directionStatus) {
              directionStatus.textContent = message;
              directionStatus.className = 'text-sm text-red-600 dark:text-red-400';
          }
      }

      // Show compass help modal
      function showCompassHelp() {
          updateCompassHelpContent();
          document.getElementById('compassHelpModal').classList.remove('hidden');
      }
      
      // Update compass help modal content based on current language
      function updateCompassHelpContent() {
          const helpModalContent = document.getElementById('helpModalContent');
          if (helpModalContent) {
              const instructions = languages[currentLang].compassInstructions;
              helpModalContent.innerHTML = instructions.map(instruction => `<p>${instruction}</p>`).join('');
          }
      }

      // Close compass help modal
      function closeCompassHelp() {
          document.getElementById('compassHelpModal').classList.add('hidden');
      }
      
      // Update compass UI elements when language changes
      function updateCompassUI() {
          const directionStatus = document.getElementById('directionStatus');
          const accuracyText = document.getElementById('accuracyText');
          const qiblaDistance = document.getElementById('qiblaDistance');
          const locationInfo = document.getElementById('locationInfo');
          
          // Update default text if compass is not active
          if (!compassActive) {
              if (directionStatus) {
                  directionStatus.textContent = languages[currentLang].clickStartCompass;
              }
              if (accuracyText) {
                  accuracyText.textContent = languages[currentLang].notConnected;
              }
              if (qiblaDistance && (qiblaDistance.textContent.includes(' ') || qiblaDistance.textContent.includes('Calculating'))) {
                  qiblaDistance.textContent = languages[currentLang].calculating;
              }
          }
          
          // Update compass help modal content
          updateCompassHelpContent();
          
          // If compass is active, update display
          if (compassActive) {
              updateCompassDisplay();
          }
      }

      // Stop compass
      function stopCompass() {
          compassActive = false;
          window.removeEventListener('deviceorientation', handleCompassOrientation);
          window.removeEventListener('deviceorientationabsolute', handleCompassOrientation);
          
          const startBtn = document.getElementById('startCompassBtn');
          if (startBtn) {
              startBtn.style.display = 'block';
              startBtn.disabled = false;
          }
          
          // Reset tab visual feedback
          const qiblaTab = document.getElementById('qiblaTab');
          if (qiblaTab) {
              qiblaTab.style.backgroundColor = '';
              qiblaTab.style.borderColor = '';
          }
      }

      // Add event listener for refresh location button
      document.getElementById('refreshLocationBtn').addEventListener('click', async () => {
          const btn = document.getElementById('refreshLocationBtn');
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i>';
          
          try {
              const position = await new Promise((resolve, reject) => {
                  navigator.geolocation.getCurrentPosition(resolve, reject, {
                      enableHighAccuracy: true,
                      timeout: 10000,
                      maximumAge: 0
                  });
              });
              
              userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
              };
              
              qiblaAngle = calculateQiblaAngle(position.coords.latitude, position.coords.longitude);
              updateLocationDisplay(position.coords.latitude, position.coords.longitude);
              
              if (compassActive) {
                  updateCompassDisplay();
              }
              
          } catch (error) {
              showCompassError(currentLang === 'ar' ? '   ' : 'Failed to update location');
          } finally {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-location-arrow text-sm"></i>';
          }
      });

      function smoothHeading(newHeading) {
          const smoothingFactor = 0.1;
          if (smoothedHeading === null) {
              smoothedHeading = newHeading;
          } else {
              smoothedHeading += smoothingFactor * (newHeading - smoothedHeading);
          }
          return smoothedHeading;
      }

      function updateDegreeDisplay() {
          if (typeof qiblaAngle === 'undefined' || typeof currentHeading === 'undefined') {
              return;
          }
          
          const relativeAngle = (qiblaAngle - currentHeading + 360) % 360;
          const degreeDisplay = document.getElementById('degreeValue');
          const alignmentRings = document.getElementById('alignmentRings');
          const alignmentDot = document.getElementById('alignmentDot');
          const alignmentText = document.getElementById('alignmentText');
          const directionArrow = document.getElementById('directionArrow');
          const kaabaGlow = document.getElementById('kaabaGlow');
          
          if (!degreeDisplay) return;
          
          // More precise alignment detection (within 5 degrees)
          const isAligned = Math.abs(relativeAngle) <= 5 || Math.abs(relativeAngle - 360) <= 5;
          const isVeryClose = Math.abs(relativeAngle) <= 2 || Math.abs(relativeAngle - 360) <= 2;
          
          // Update direction arrow rotation
          if (directionArrow) {
              directionArrow.style.transform = `rotate(${relativeAngle}deg)`;
          }
          
          if (isAligned) {
              degreeDisplay.textContent = languages[currentLang].alignedMessage || 'Aligned with Qibla';
              degreeDisplay.parentElement.style.backgroundColor = 'rgba(34, 197, 94, 0.8)'; // Green background
              
              // Show alignment rings
              if (alignmentRings) alignmentRings.style.opacity = '1';
              if (kaabaGlow) kaabaGlow.style.opacity = isVeryClose ? '0.8' : '0.4';
              
              // Update alignment status
              if (alignmentDot) {
                  alignmentDot.className = 'w-2 h-2 bg-green-400 rounded-full animate-pulse';
              }
              if (alignmentText) {
                  alignmentText.textContent = isVeryClose ? 
                      (currentLang === 'ar' ? '  !' : 'Perfectly Aligned!') :
                      (currentLang === 'ar' ? '  ' : 'Close to Qibla');
              }
              
              // Haptic feedback when aligned
              if ('vibrate' in navigator && isVeryClose) {
                  navigator.vibrate([50, 100, 50]);
              }
          } else {
              // Round to nearest degree for stability
              const roundedAngle = Math.round(relativeAngle);
              degreeDisplay.textContent = `${roundedAngle}`;
              degreeDisplay.parentElement.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
              
              // Hide alignment rings and glow
              if (alignmentRings) alignmentRings.style.opacity = '0';
              if (kaabaGlow) kaabaGlow.style.opacity = '0';
              
              // Update alignment status
              if (alignmentDot) {
                  alignmentDot.className = 'w-2 h-2 bg-red-400 rounded-full';
              }
              if (alignmentText) {
                  const distance = Math.min(relativeAngle, 360 - relativeAngle);
                  if (distance > 45) {
                      alignmentText.textContent = currentLang === 'ar' ? '  ' : 'Finding Qibla';
                  } else {
                      alignmentText.textContent = currentLang === 'ar' ? '  ' : 'Getting closer';
                  }
              }
          }
          
          // Debug info (remove in production)
          console.log(`Qibla: ${qiblaAngle.toFixed(1)}, Heading: ${currentHeading.toFixed(1)}, Relative: ${relativeAngle.toFixed(1)}`);
      }
      
      function updateAccuracyIndicator(isHighAccuracy) {
          const accuracyIndicator = document.getElementById('accuracyIndicator');
          if (!accuracyIndicator) return;
          
          const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
          
          if (isHighAccuracy && isIOS) {
              accuracyIndicator.innerHTML = '<i class="fas fa-check-circle text-green-400 mr-1"></i>' + 
                  (currentLang === 'ar' ? ' ' : 'High Accuracy');
              accuracyIndicator.className = 'text-green-400';
          } else {
              accuracyIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-400 mr-1"></i>' + 
                  (currentLang === 'ar' ? '  -   ' : 'Medium Accuracy - Calibrate Compass');
              accuracyIndicator.className = 'text-yellow-400';
          }
      }

      function startARRenderLoop() {
          const video = document.getElementById('arCamera');
          const canvas = document.getElementById('arCanvas');
          const ctx = canvas.getContext('2d');
          const kaabaIndicator = document.getElementById('kaabaIndicator');
          const compassRose = document.getElementById('compassRose');

          function render() {
              if (!arActive) return;

              if (video.readyState !== 4) {
                  animationFrameId = requestAnimationFrame(render);
                  return;
              }

              const displayWidth = video.clientWidth;
              const displayHeight = video.clientHeight;
              canvas.width = displayWidth;
              canvas.height = displayHeight;

              if (typeof qiblaAngle === 'undefined' || typeof currentHeading === 'undefined') {
                  animationFrameId = requestAnimationFrame(render);
                  return;
              }

              const relativeAngle = (qiblaAngle - currentHeading + 360) % 360;
              const rad = relativeAngle * Math.PI / 180;

              const centerX = displayWidth / 2;
              const centerY = displayHeight / 2;

              // Clear canvas for additional drawing
              ctx.clearRect(0, 0, displayWidth, displayHeight);

              // Rotate compass rose based on device heading
              if (compassRose) {
                  compassRose.style.transform = `rotate(${-currentHeading}deg)`;
                  // Show compass rose when not aligned for better orientation
                  const isAligned = Math.abs(relativeAngle) <= 5 || Math.abs(relativeAngle - 360) <= 5;
                  compassRose.style.opacity = isAligned ? '0.1' : '0.3';
              }

              // Position Kaaba indicator
              const radius = Math.min(centerX, centerY) * 0.6; // Slightly larger radius
              let kaabaX = centerX + Math.sin(rad) * radius;
              let kaabaY = centerY - Math.cos(rad) * radius;

              // Keep Kaaba indicator within bounds with more margin
              const margin = 64; // Increased margin for larger indicator
              kaabaX = Math.max(margin, Math.min(displayWidth - margin, kaabaX));
              kaabaY = Math.max(margin, Math.min(displayHeight - margin, kaabaY));

              // Update Kaaba indicator position
              if (kaabaIndicator) {
                  kaabaIndicator.style.transform = `translate(${kaabaX - 32}px, ${kaabaY - 32}px)`;
                  
                  // Update distance indicator
                  const distanceSpan = document.getElementById('qiblaDistance');
                  if (distanceSpan && typeof userLocation !== 'undefined') {
                      const distance = calculateDistance(userLocation.lat, userLocation.lng, 21.4224779, 39.8262136);
                      distanceSpan.textContent = `${distance.toFixed(0)} km`;
                  }
              }

              // Draw directional line from center to Qibla when far from alignment
              const isAligned = Math.abs(relativeAngle) <= 10 || Math.abs(relativeAngle - 360) <= 10;
              if (!isAligned) {
                  ctx.beginPath();
                  ctx.setLineDash([10, 10]);
                  ctx.moveTo(centerX, centerY);
                  ctx.lineTo(kaabaX, kaabaY);
                  ctx.strokeStyle = 'rgba(34, 197, 94, 0.6)';
                  ctx.lineWidth = 2;
                  ctx.stroke();
                  ctx.setLineDash([]);
              }

              animationFrameId = requestAnimationFrame(render);
          }

          // Initialize with smooth transitions
          if (kaabaIndicator) {
              kaabaIndicator.style.opacity = '1';
              kaabaIndicator.style.transition = 'opacity 0.5s, transform 0.3s ease-out';
          }
          
          render();
      }
      
             // Helper function to calculate distance between two coordinates
       function calculateDistance(lat1, lng1, lat2, lng2) {
           const R = 6371; // Earth's radius in kilometers
           const dLat = (lat2 - lat1) * Math.PI / 180;
           const dLng = (lng2 - lng1) * Math.PI / 180;
           const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
           const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
           return R * c;
       }
       
       // Update location display with city/country info
       function updateLocationDisplay(lat, lng) {
           const locationInfo = document.getElementById('locationInfo');
           if (!locationInfo) return;
           
           // Show coordinates initially
           locationInfo.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
           
           // Try to get city name using reverse geocoding (optional)
           // This is a simple approximation - in production, use a proper geocoding service
           const cityName = getCityName(lat, lng);
           if (cityName) {
               locationInfo.textContent = cityName;
           }
       }
       
       // Simple city name approximation (replace with proper geocoding service)
       function getCityName(lat, lng) {
           // Major cities approximation - in production, use a proper geocoding API
           const cities = [
               { name: "Mecca, Saudi Arabia", lat: 21.4225, lng: 39.8262, radius: 50 },
               { name: "Medina, Saudi Arabia", lat: 24.4539, lng: 39.6031, radius: 50 },
               { name: "Riyadh, Saudi Arabia", lat: 24.7136, lng: 46.6753, radius: 100 },
               { name: "Dubai, UAE", lat: 25.2048, lng: 55.2708, radius: 100 },
               { name: "Cairo, Egypt", lat: 30.0444, lng: 31.2357, radius: 100 },
               { name: "Istanbul, Turkey", lat: 41.0082, lng: 28.9784, radius: 100 },
               { name: "London, UK", lat: 51.5074, lng: -0.1278, radius: 100 },
               { name: "New York, USA", lat: 40.7128, lng: -74.0060, radius: 100 },
               { name: "Los Angeles, USA", lat: 34.0522, lng: -118.2437, radius: 100 },
               { name: "Toronto, Canada", lat: 43.6532, lng: -79.3832, radius: 100 },
           ];
           
           for (const city of cities) {
               const distance = calculateDistance(lat, lng, city.lat, city.lng);
               if (distance < city.radius) {
                   return city.name;
               }
           }
           
           return null;
      }

// Legacy function for compatibility - simplified for basic compass
function showARUnsupported(errorType) {
    // For backward compatibility, just show a simple error
    showCompassError(currentLang === 'ar' ? '   ' : 'Compass error occurred');
}

      // Legacy functions for compatibility
      function showCalibrationPrompt() {
          // No longer needed with simple compass
      }

      function dismissCalibrationPrompt() {
          // No longer needed with simple compass
      }

      // Legacy function for compatibility
      function initCompassFallback() {
          initQiblaCompass();
      }

      // Test function to validate qibla accuracy for known locations
      function testQiblaAccuracy() {
          const testLocations = [
              { name: "Amman, Jordan", lat: 31.9454, lng: 35.9284, expectedBearing: 157 },
              { name: "London, UK", lat: 51.5074, lng: -0.1278, expectedBearing: 119 },
              { name: "New York, USA", lat: 40.7128, lng: -74.0060, expectedBearing: 58 },
              { name: "Jakarta, Indonesia", lat: -6.2088, lng: 106.8456, expectedBearing: 295 },
              { name: "Cairo, Egypt", lat: 30.0444, lng: 31.2357, expectedBearing: 135 }
          ];
          
          console.log("=== Qibla Accuracy Test ===");
          testLocations.forEach(location => {
              const calculated = calculateQiblaAngle(location.lat, location.lng);
              const difference = Math.abs(calculated - location.expectedBearing);
              const accuracy = difference <= 2 ? " ACCURATE" : difference <= 5 ? " CLOSE" : " INACCURATE";
              console.log(`${location.name}: Expected ${location.expectedBearing}, Got ${calculated.toFixed(1)}, Diff: ${difference.toFixed(1)} ${accuracy}`);
          });
      }
      
             // Call test function (remove in production)
       // testQiblaAccuracy();

       // Test notification function (for debugging)
       function testNotification() {
           if (!notificationEnabled) {
               console.log('Notifications not enabled. Enable them first.');
               return;
           }
           
           console.log('Testing notification...');
           showBasicNotification('Dhuhr');
       }
       
       // Add to global scope for console testing
       window.testNotification = testNotification;
       window.testQiblaAccuracy = testQiblaAccuracy;

      // Samsung-specific retry function
      async function retrySamsungInit() {
          console.log("Retrying Samsung initialization with different approach...");
          
          try {
              // Force request permissions again
              const stream = await navigator.mediaDevices.getUserMedia({ video: true });
              stream.getTracks().forEach(track => track.stop());
              
              // Try with different geolocation options
              const position = await new Promise((resolve, reject) => {
                  navigator.geolocation.getCurrentPosition(resolve, reject, {
                      enableHighAccuracy: false, // Try with lower accuracy first
                      timeout: 20000,
                      maximumAge: 60000 // Allow cached location
                  });
              });
              
              console.log("Samsung retry: Permissions obtained, reinitializing...");
              
              // Wait a bit then retry full initialization
              setTimeout(() => {
                  initQiblaCompass();
              }, 1000);
              
          } catch (error) {
              console.error("Samsung retry failed:", error);
              showCompassError(currentLang === 'ar' ? '   ' : 'Retry failed');
          }
      }

            // Initialize location on page load
      async function initializeQiblaLocation() {
          console.log(' Initializing Qibla location on page load...');
          try {
              const position = await new Promise((resolve, reject) => {
                  navigator.geolocation.getCurrentPosition(resolve, reject, {
                      enableHighAccuracy: true,
                      timeout: 10000,
                      maximumAge: 300000 // 5 minutes cache
                  });
              });
              
              console.log(' Location obtained:', {
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude,
                  accuracy: position.coords.accuracy
              });
              
              userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
              };
              
              qiblaAngle = calculateQiblaAngle(position.coords.latitude, position.coords.longitude);
              updateLocationDisplay(position.coords.latitude, position.coords.longitude);
              
              console.log(' Qibla location initialized successfully');
              
          } catch (error) {
              console.log(" Could not get location on page load:", error);
              // Show default message
              const locationInfo = document.getElementById('locationInfo');
              const qiblaDistance = document.getElementById('qiblaDistance');
              
              if (locationInfo) {
                  locationInfo.textContent = currentLang === 'ar' ? '    ' : 'Click button to detect location';
              }
              if (qiblaDistance) {
                  qiblaDistance.textContent = languages[currentLang].calculating;
              }
              
              // Update direction status and accuracy text
              const directionStatus = document.getElementById('directionStatus');
              const accuracyText = document.getElementById('accuracyText');
              
              if (directionStatus) {
                  directionStatus.textContent = languages[currentLang].clickStartCompass;
              }
              if (accuracyText) {
                  accuracyText.textContent = languages[currentLang].notConnected;
              }
          }
      }

      // Event Listeners
      document.getElementById('startCompassBtn').addEventListener('click', initQiblaCompass);
      
      // Initialize location when page loads
      document.addEventListener('DOMContentLoaded', () => {
          setTimeout(initializeQiblaLocation, 1000); // Delay to ensure DOM is ready
      });

      function handleDhikrClick() {
          const arabicText = document.getElementById('adhkarArabicText');
          const counterNumber = document.getElementById('dhikrCountNumber');
          const progressRing = document.getElementById('dhikrProgressRing');
          const dhikrCard = arabicText.closest('.bg-gradient-to-br');

          if (filteredAdhkar[current].remainingRepeats > 0) {
              filteredAdhkar[current].remainingRepeats--;
              
              // Calculate current count and total
              const totalRepeats = filteredAdhkar[current].repeat;
              const currentCount = totalRepeats - filteredAdhkar[current].remainingRepeats;
              const progress = (currentCount / totalRepeats) * 100;
              
              // Update counter number directly without animation
              counterNumber.textContent = currentCount;
              
              // Update progress ring
              updateProgressRing(progressRing, progress);
              
              // Check if completed
              if (filteredAdhkar[current].remainingRepeats === 0) {
                  setTimeout(() => {
                      celebrateCompletion();
                  }, 300);
              }
              
              updateRepeatCounter();
          }
      }



      function updateProgressRing(ringElement, progress) {
          const circumference = 2 * Math.PI * 40; // radius = 40
          const offset = circumference - (progress / 100) * circumference;
          ringElement.style.strokeDashoffset = offset;
          
          // Change color based on progress
          if (progress >= 100) {
              ringElement.classList.remove('text-blue-500', 'dark:text-blue-400');
              ringElement.classList.add('text-green-500', 'dark:text-green-400');
          } else if (progress >= 75) {
              ringElement.classList.remove('text-blue-500', 'dark:text-blue-400');
              ringElement.classList.add('text-yellow-500', 'dark:text-yellow-400');
          }
      }

      function celebrateCompletion() {
          const counterNumber = document.getElementById('dhikrCountNumber');
          const progressRing = document.getElementById('dhikrProgressRing');
          
          // Change counter color to green without animation
          counterNumber.style.color = '#10b981'; // Green color
          
          // Apply color pulse effect to the progress ring
          if (progressRing) {
              progressRing.classList.add('progress-ring-complete');
              
              // Remove the animation class after animation completes
              setTimeout(() => {
                  progressRing.classList.remove('progress-ring-complete');
              }, 1500);
          }
          
          // Play success sound if available
          if ('vibrate' in navigator) {
              navigator.vibrate([200, 100, 200]);
          }
      }



      function updateRepeatCounter() {
          document.getElementById('repeatValue').innerText = filteredAdhkar[current].remainingRepeats;
      }

      function switchLanguage() {
          currentLang = currentLang === 'ar' ? 'en' : 'ar';
          tafsirLang = currentLang;
          
          // Save language preference to localStorage
          localStorage.setItem('preferredLanguage', currentLang);
          
          document.documentElement.lang = currentLang;
          document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
          
          // Use setTimeout to ensure DOM updates are processed
          setTimeout(() => {
          updateUI();
          updateSettingsLanguage();
              updateReciterOptions();
          displayDhikr();
          updatePrayerTimesUI();
          updateCompassUI();
          }, 0);
          
          // Update Surah dropdown with appropriate language names
          updateSurahDropdown();
          
          // Update Quran display if we're in the Quran tab
          if (document.getElementById('quranContent').classList.contains('active')) {
              // Force a refresh of the current display
              if (currentSurah !== null) {
                  if (isReadingMode) {
                      loadReadingModeAyahs();
                  } else {
                      displayAyah();
                  }
              } else {
                  // If no surah is selected, reset the content to update the continue reading section
                  resetQuranContent();
              }
          }
          
          // Update tutorial if it's visible
          const modal = document.getElementById('tutorialModal');
          if (!modal.classList.contains('hidden')) {
              showTutorial();
          }

          // Update page/Juz indicator language if visible
          const pageJuzIndicator = document.getElementById('pageJuzIndicator');
          if (pageJuzIndicator && !pageJuzIndicator.classList.contains('hidden')) {
              // Use stored values to update language immediately, then re-detect
              if (currentPageNum && currentJuzNum) {
                  updatePageJuzIndicator(currentPageNum, currentJuzNum);
              }
              // Also re-detect to ensure accuracy
              setTimeout(() => {
                  if (isReadingMode && currentSurah !== null) {
                      detectCurrentPageAndJuz();
                  }
              }, 100);
          }
      }

      function updateUI() {
          const lang = languages[currentLang];
          const elements = {
              'pageTitle': lang.title,
              'btnPrev': lang.previous,
              'btnNext': lang.next,

              'langToggle': lang.langSwitch,
              'repeatLabel': lang.repeatLabel,
              'swipeHintText': lang.swipeHint,
              'clickHintText': lang.clickHint,
              'adhkarTab': lang.adhkarTab,
              'prayerTab': lang.prayerTab,
              'qiblaTab': lang.qiblaTab,
        'locationTitle': lang.locationTitle,
        'startCompassText': lang.startCompassText,
        'helpText': lang.helpText,
        'helpModalTitle': lang.helpModalTitle,
        'closeHelpText': lang.closeHelpText,
        'troubleshootText': lang.troubleshootText,
              'tasbihTab': lang.tasbihTab,
              'quranTab': lang.quranTab,
              'notificationLabel': lang.notificationLabel,
              'quranTitle': lang.quranTitle,
              'surahMenuTitle': lang.selectSurah,
              // Adhkar home page elements
              
              'morningCardTitle': lang.morningCardTitle,
              'morningCardDesc': lang.morningCardDesc,
              'eveningCardTitle': lang.eveningCardTitle,
              'eveningCardDesc': lang.eveningCardDesc,
              'moreAdhkarTitle': lang.moreAdhkarTitle,
              'moreAdhkarDesc': lang.moreAdhkarDesc,
              'popularCategoriesTitle': lang.popularCategoriesTitle,
              'protectionLabel': lang.protectionLabel,
              'istighfarLabel': lang.istighfarLabel,
              'anxietyLabel': lang.anxietyLabel,
              'prayerLabel': lang.prayerLabel,
              'reminderTitle': lang.reminderTitle,
              'randomHadithBtn': lang.randomHadithBtn,
              // Tasbih elements
              'tasbihTitle': lang.tasbihTitle,
              'resetBtn': lang.resetBtn,
              'targetBtn': lang.targetBtn,
              'dailyAdhkarTitle': lang.dailyAdhkarTitle,
              'dailyAdhkarDesc': lang.dailyAdhkarDesc,
              'quickSurahsTitle': lang.quickSurahsTitle,
              'quickSurahsDesc': lang.quickSurahsDesc

          };
          
          // Update reading mode button tooltip if in single verse mode
          const readingModeBtn = document.getElementById('btnReadingMode');
          if (readingModeBtn && !isReadingMode && currentSurah !== null && readingModeBtn.classList.contains('show-tooltip')) {
              readingModeBtn.setAttribute('data-tooltip', lang.displayFullSurah);
          }

          // Update each element if it exists
          for (const [id, text] of Object.entries(elements)) {
              const element = document.getElementById(id);
              if (element) {
                  element.innerText = text;
              }
          }

          // Update azkar type labels in modal
          const azkarTypeLabels = {
              'labelWakingSleeping': lang.azkarTypes.waking_sleeping,
              'labelHome': lang.azkarTypes.home,
              'labelBathroom': lang.azkarTypes.bathroom,
              'labelEating': lang.azkarTypes.eating,
              'labelMasjid': lang.azkarTypes.masjid,
              'labelTraveling': lang.azkarTypes.traveling,
              'labelClothes': lang.azkarTypes.clothes,
              'labelAnxiety': lang.azkarTypes.anxiety,
              'labelHardship': lang.azkarTypes.hardship,
              'labelIstighfar': lang.azkarTypes.istighfar,
              'labelPatienceGratitude': lang.azkarTypes.patience_gratitude,
              'labelRabbana': lang.azkarTypes.rabbana,
              'labelProphetic': lang.azkarTypes.prophetic,
              'labelProphets': lang.azkarTypes.prophets,
              'labelRain': lang.azkarTypes.rain,
              'labelPatient': lang.azkarTypes.patient,
              'labelDeceased': lang.azkarTypes.deceased,
              'labelMarriageChildrenRizq': lang.azkarTypes.marriage_children_rizq,
              'labelProtection': lang.azkarTypes.protection,
              'labelSalah': lang.azkarTypes.salah,
              'labelSujoodTashahhud': lang.azkarTypes.sujood_tashahhud,
              'labelQunoot': lang.azkarTypes.qunoot,
              'labelTahajjud': lang.azkarTypes.tahajjud,
              'labelIstikhara': lang.azkarTypes.istikhara,
              'labelRamadan': lang.azkarTypes.ramadan,
              'labelHajj': lang.azkarTypes.hajj,
              'labelLaylatAlQadr': lang.azkarTypes.laylat_al_qadr,
              'labelEid': lang.azkarTypes.eid,
              'labelNaturalEvents': lang.azkarTypes.natural_events
          };

          for (const [id, text] of Object.entries(azkarTypeLabels)) {
              const element = document.getElementById(id);
              if (element && text) {
                  element.innerText = text;
              }
          }

          // Update daily reminder with today's hadith
          updateDailyReminder();

          // Update arrow directions based on language
          const arrowIcons = document.querySelectorAll('.arrow-icon');
          arrowIcons.forEach(arrow => {
              arrow.className = arrow.className.replace(/fa-chevron-(left|right)/, '');
              if (currentLang === 'ar') {
                  arrow.classList.add('fa-chevron-left');
              } else {
                  arrow.classList.add('fa-chevron-right');
              }
          });
          
          // Update back arrow directions based on language
          const backArrows = document.querySelectorAll('.back-arrow');
          backArrows.forEach(arrow => {
              arrow.className = arrow.className.replace(/fa-arrow-(left|right)/, '');
              if (currentLang === 'ar') {
                  arrow.classList.add('fa-arrow-right');
              } else {
                  arrow.classList.add('fa-arrow-left');
              }
          });
          
          // Update back button text
          const backText = document.getElementById('backText');
          if (backText) {
              backText.textContent = lang.backText;
          }
          
          // Update Hijri date when language changes
          updateHijriDate();

          // Update language toggle button with both desktop and mobile text
          const langToggle = document.getElementById('langToggle');
          if (langToggle) {
              const langText = currentLang === 'ar' ? 'English' : '';
              const langShort = currentLang === 'ar' ? 'EN' : '';
              const desktopSpan = langToggle.querySelector('.hidden.sm\\:inline');
              const mobileSpan = langToggle.querySelector('.sm\\:hidden');
              if (desktopSpan) desktopSpan.textContent = langText;
              if (mobileSpan) mobileSpan.textContent = langShort;
          }

          // Special case for btnRefresh which has an icon
          const btnRefresh = document.getElementById('btnRefresh');
          if (btnRefresh) {
              btnRefresh.innerHTML = `<i class="fas fa-sync-alt mr-2"></i> ${lang.refresh}`;
          }

          // Update surah menu button text
          updateSurahDropdown();
          
          // Update translation select options
          const translationSelect = document.getElementById('translationSelect');
          if (translationSelect) {
          const currentTranslation = translationSelect.value;
          translationSelect.innerHTML = '';
          
              // Add options based on current language - organized by language groups
              const translationOptions = [
                  // English Translations
                  { value: "en.sahih", group: currentLang === 'ar' ? "" : "English" },
                  { value: "en.pickthall", group: currentLang === 'ar' ? "" : "English" },
                  { value: "en.yusufali", group: currentLang === 'ar' ? "" : "English" },
                  { value: "en.hilali", group: currentLang === 'ar' ? "" : "English" },
                  { value: "en.arberry", group: currentLang === 'ar' ? "" : "English" },
                  { value: "en.asad", group: currentLang === 'ar' ? "" : "English" },
                  { value: "en.daryabadi", group: currentLang === 'ar' ? "" : "English" },
                  { value: "en.shakir", group: currentLang === 'ar' ? "" : "English" },
                  
                  // European Languages
                  { value: "fr.hamidullah", group: currentLang === 'ar' ? "" : "European" },
                  { value: "fr.leclerc", group: currentLang === 'ar' ? "" : "European" },
                  { value: "de.bubenheim", group: currentLang === 'ar' ? "" : "European" },
                  { value: "de.khoury", group: currentLang === 'ar' ? "" : "European" },
                  { value: "es.cortes", group: currentLang === 'ar' ? "" : "European" },
                  { value: "es.garcia", group: currentLang === 'ar' ? "" : "European" },
                  { value: "it.piccardo", group: currentLang === 'ar' ? "" : "European" },
                  { value: "pt.elhayek", group: currentLang === 'ar' ? "" : "European" },
                  { value: "ru.kuliev", group: currentLang === 'ar' ? "" : "European" },
                  { value: "ru.osmanov", group: currentLang === 'ar' ? "" : "European" },
                  { value: "nl.keyzer", group: currentLang === 'ar' ? "" : "European" },
                  { value: "bs.korkut", group: currentLang === 'ar' ? "" : "European" },
                  { value: "cs.hrbek", group: currentLang === 'ar' ? "" : "European" },
                  { value: "no.berg", group: currentLang === 'ar' ? "" : "European" },
                  { value: "sv.bernstrom", group: currentLang === 'ar' ? "" : "European" },
                  { value: "sq.ahmeti", group: currentLang === 'ar' ? "" : "European" },
                  
                  // Middle Eastern & Central Asian
                  { value: "tr.diyanet", group: currentLang === 'ar' ? "   " : "Middle East & Central Asia" },
                  { value: "tr.bulac", group: currentLang === 'ar' ? "   " : "Middle East & Central Asia" },
                  { value: "ur.junagarhi", group: currentLang === 'ar' ? "   " : "Middle East & Central Asia" },
                  { value: "ur.kanzuliman", group: currentLang === 'ar' ? "   " : "Middle East & Central Asia" },
                  { value: "fa.ansarian", group: currentLang === 'ar' ? "   " : "Middle East & Central Asia" },
                  { value: "fa.makarem", group: currentLang === 'ar' ? "   " : "Middle East & Central Asia" },
                  { value: "az.mammadaliyev", group: currentLang === 'ar' ? "   " : "Middle East & Central Asia" },
                  { value: "ku.asan", group: currentLang === 'ar' ? "   " : "Middle East & Central Asia" },
                  
                  // South & Southeast Asian
                  { value: "id.indonesian", group: currentLang === 'ar' ? "   " : "South & Southeast Asia" },
                  { value: "ms.basmeih", group: currentLang === 'ar' ? "   " : "South & Southeast Asia" },
                  { value: "bn.bengali", group: currentLang === 'ar' ? "   " : "South & Southeast Asia" },
                  { value: "hi.hindi", group: currentLang === 'ar' ? "   " : "South & Southeast Asia" },
                  { value: "ta.tamil", group: currentLang === 'ar' ? "   " : "South & Southeast Asia" },
                  { value: "th.thai", group: currentLang === 'ar' ? "   " : "South & Southeast Asia" },
                  
                  // East Asian
                  { value: "zh.jian", group: currentLang === 'ar' ? " " : "East Asia" },
                  { value: "ja.japanese", group: currentLang === 'ar' ? " " : "East Asia" },
                  { value: "ko.korean", group: currentLang === 'ar' ? " " : "East Asia" },
                  
                  // African
                  { value: "ha.gumi", group: currentLang === 'ar' ? "" : "African" },
                  { value: "sw.barwani", group: currentLang === 'ar' ? "" : "African" },
                  { value: "so.abduh", group: currentLang === 'ar' ? "" : "African" },
                  { value: "am.sadiq", group: currentLang === 'ar' ? "" : "African" },
                  { value: "yo.mikail", group: currentLang === 'ar' ? "" : "African" }
              ];
              
              // Group translations by region
              const groupedTranslations = {};
              translationOptions.forEach(option => {
                  if (!groupedTranslations[option.group]) {
                      groupedTranslations[option.group] = [];
                  }
                  groupedTranslations[option.group].push(option.value);
              });
              
              // Build the dropdown HTML with optgroups
              let optionsHTML = '';
              Object.keys(groupedTranslations).forEach(groupName => {
                  optionsHTML += `<optgroup label="${groupName}">`;
                  groupedTranslations[groupName].forEach(translationKey => {
                      if (lang.translationNames[translationKey]) {
                          optionsHTML += `<option value="${translationKey}">${lang.translationNames[translationKey]}</option>`;
                      }
                  });
                  optionsHTML += `</optgroup>`;
              });
              
              translationSelect.innerHTML = optionsHTML;

              // Restore the previously selected translation if it exists
              if (currentTranslation) {
                  translationSelect.value = currentTranslation;
              }
          }
      }



      // Add this new function to handle translation changes
      async function handleTranslationChange(selectedTranslation) {
          try {
              console.log("Loading translation:", selectedTranslation);
              const response = await fetch(`https://api.alquran.cloud/v1/quran/${selectedTranslation}`);
              if (!response.ok) throw new Error('Failed to fetch translation');
              const data = await response.json();
              translationData = data.data.surahs;
              
              // Update the display if we're in the Quran tab and have a surah selected
              if (currentSurah !== null) {
                  if (isReadingMode) {
                      loadReadingModeAyahs();
                  } else {
                      displayAyah();
                  }
              }
              
              console.log("Translation loaded successfully");
          } catch (error) {
              console.error('Error loading translation:', error);
              showToast(currentLang === 'ar' ? '    ' : 'Error loading translation', 'error');
          }
      }

      function updateSurahDropdown() {
          // Update surah menu button text
          const selectedSurahText = document.getElementById('selectedSurahText');
          if (selectedSurahText) {
              if (currentSurah !== null && quranData && quranData[currentSurah]) {
                  const surah = quranData[currentSurah];
                  const surahName = currentLang === 'ar' ? surah.name : surahNamesEnglish[currentSurah];
                  selectedSurahText.textContent = `${surah.number}. ${surahName}`;
              } else {
                  selectedSurahText.textContent = languages[currentLang].selectSurah;
              }
          }
          
          // Update surah menu data and repopulate if menu is open
          if (quranData) {
              surahsData = quranData.map((surah, index) => ({
                  index: index,
                  number: surah.number,
                  name: surah.name,
                  englishName: surahNamesEnglish[index] || surah.englishName,
                  revelationType: surah.revelationType,
                  numberOfAyahs: surah.numberOfAyahs
              }));
              
              // If menu is open, repopulate it
              const surahList = document.getElementById('surahList');
              if (surahList && surahList.children.length > 0) {
                  populateSurahList(surahsData);
              }
          }
      }

      function updatePrayerTimesUI() {
          const lang = languages[currentLang];
          console.log("updatePrayerTimesUI called with lang:", lang);
          console.log("currentLang:", currentLang);
          
          document.getElementById('prayerTitle').innerText = lang.prayerTitle;
          
          // Debug: Test different selectors for Fajr
          console.log("=== DEBUGGING PRAYER NAME SELECTORS ===");
          
          const fajrCard = document.getElementById('azan-fajr');
          console.log("Fajr card found:", fajrCard);
          
          if (fajrCard) {
              const allSpans = fajrCard.querySelectorAll('span');
              console.log("All spans in fajr card:", allSpans.length);
              allSpans.forEach((span, index) => {
                  console.log(`Span ${index}:`, span.textContent, span.className);
              });
          }
          
          // Try different selectors
          const selector1 = document.querySelector('#azan-fajr .flex .flex span');
          const selector2 = document.querySelector('#azan-fajr span:first-of-type');
          const selector3 = document.querySelector('#azan-fajr .font-medium');
          
          console.log("Selector '.flex .flex span':", selector1);
          console.log("Selector 'span:first-of-type':", selector2);
          console.log("Selector '.font-medium':", selector3);
          
          // Update prayer names with the working selector
          const fajrNameSpan = document.querySelector('#azan-fajr .font-medium');
          if (fajrNameSpan) {
              console.log("Updating Fajr name from", fajrNameSpan.innerText, "to", lang.fajr);
              fajrNameSpan.innerText = lang.fajr;
          } else {
              console.error("Fajr name span not found!");
          }
          
          const sunriseNameSpan = document.querySelector('#azan-sunrise .font-medium');
          if (sunriseNameSpan) sunriseNameSpan.innerText = lang.sunrise;
          
          const dhuhrNameSpan = document.querySelector('#azan-dhuhr .font-medium');
          if (dhuhrNameSpan) dhuhrNameSpan.innerText = lang.dhuhr;
          
          const asrNameSpan = document.querySelector('#azan-asr .font-medium');
          if (asrNameSpan) asrNameSpan.innerText = lang.asr;
          
          const maghribNameSpan = document.querySelector('#azan-maghrib .font-medium');
          if (maghribNameSpan) maghribNameSpan.innerText = lang.maghrib;
          
          const ishaNameSpan = document.querySelector('#azan-isha .font-medium');
          if (ishaNameSpan) ishaNameSpan.innerText = lang.isha;
          
          console.log("=== END DEBUGGING ===");
      }

      fetch('adhkar.json')
          .then(res => res.json())
          .then(data => {
              adhkar.push(...data);
              document.getElementById('loadingSpinner').classList.add('hidden');
          })
          .catch(err => console.error("Error loading adhkar.json:", err));

      function loadAdhkar(time) {
          // Filter by time and remove duplicates based on Arabic text
          const timeFiltered = adhkar.filter(d => d.time === time);
          
          // Deduplicate based on Arabic text (keeping the first occurrence)
          const uniqueAdhkar = [];
          const seenArabic = new Set();
          
          for (const dhikr of timeFiltered) {
              // Normalize Arabic text by removing extra whitespace and diacritics for comparison
              const normalizedArabic = dhikr.arabic.replace(/\s+/g, ' ').trim();
              
              if (!seenArabic.has(normalizedArabic)) {
                  seenArabic.add(normalizedArabic);
                  uniqueAdhkar.push(dhikr);
              }
          }
          
          filteredAdhkar = uniqueAdhkar.map(d => ({
              ...d,
              remainingRepeats: d.repeat
          }));
          
          console.log(`Loaded ${timeFiltered.length} ${time} adhkar, deduplicated to ${filteredAdhkar.length} unique items`);
          current = 0;
          document.getElementById('home').classList.add('fade-leave');
          setTimeout(() => {
              document.getElementById('home').classList.add('hidden');
              document.getElementById('adhkarView').classList.remove('hidden', 'fade-leave');
              document.getElementById('adhkarView').classList.add('fade-enter');
              requestAnimationFrame(() => document.getElementById('adhkarView').classList.add('fade-enter-active'));
          }, 300);
          displayDhikr();
          
          // Reset Quran content when loading adhkar
          resetQuranContent();
      }

      function displayDhikr() {
          if (!filteredAdhkar.length) return;
          const dhikr = filteredAdhkar[current];
          console.log("dhikr", dhikr)
          
          // Update text content
          document.getElementById('adhkarArabicText').innerText = dhikr.arabic;
          document.getElementById('transliterationText').innerText = dhikr.transliteration;
          document.getElementById('translationTextDikr').innerText = dhikr.translation;
          document.getElementById('dhikrCounter').innerText = languages[currentLang].counter(current + 1, filteredAdhkar.length);
          document.getElementById('repeatValue').innerText = dhikr.remainingRepeats;
          
          // Initialize counter display
          const totalRepeats = dhikr.repeat;
          const currentCount = totalRepeats - dhikr.remainingRepeats;
          const progress = (currentCount / totalRepeats) * 100;
          
          // Update counter number
          const counterNumber = document.getElementById('dhikrCountNumber');
          if (counterNumber) {
              counterNumber.textContent = currentCount;
              counterNumber.style.color = ''; // Reset color
          }
          
          // Update progress ring
          const progressRing = document.getElementById('dhikrProgressRing');
          if (progressRing) {
              // Reset ring colors
              progressRing.classList.remove('text-green-500', 'dark:text-green-400', 'text-yellow-500', 'dark:text-yellow-400');
              progressRing.classList.add('text-blue-500', 'dark:text-blue-400');
              
              // Set progress
              const circumference = 2 * Math.PI * 40;
              const offset = circumference - (progress / 100) * circumference;
              progressRing.style.strokeDashoffset = offset;
              
              // Update color based on progress
              if (progress >= 100) {
                  progressRing.classList.remove('text-blue-500', 'dark:text-blue-400');
                  progressRing.classList.add('text-green-500', 'dark:text-green-400');
              } else if (progress >= 75) {
                  progressRing.classList.remove('text-blue-500', 'dark:text-blue-400');
                  progressRing.classList.add('text-yellow-500', 'dark:text-yellow-400');
              }
          }
          
          // Auto-scroll to ensure dhikr content is fully visible on mobile
          setTimeout(() => {
              scrollDhikrIntoView();
          }, 100);
      }
      
      function scrollDhikrIntoView() {
          // Only apply auto-scroll on mobile devices
          if (window.innerWidth <= 768) {
              const dhikrCard = document.querySelector('#adhkarView .bg-gradient-to-br');
              if (dhikrCard) {
                  // Calculate if the dhikr card extends beyond the viewport
                  const cardRect = dhikrCard.getBoundingClientRect();
                  const viewportHeight = window.innerHeight;
                  
                  // Check if the card is not fully visible
                  if (cardRect.bottom > viewportHeight || cardRect.top < 0) {
                      // Scroll to show the entire dhikr card with some padding
                      dhikrCard.scrollIntoView({
                          behavior: 'smooth',
                          block: 'center',
                          inline: 'nearest'
                      });
                  }
              }
          }
      }

      function nextDhikr() {
          if (current < filteredAdhkar.length - 1) {
              current++;
              displayDhikr();
          }
      }

      function prevDhikr() {
          if (current > 0) {
              current--;
              displayDhikr();
          }
      }

      function goHome() {
          document.getElementById('adhkarView').classList.add('fade-leave');
          setTimeout(() => {
              document.getElementById('adhkarView').classList.add('hidden');
              document.getElementById('home').classList.remove('hidden');
              document.getElementById('home').classList.add('fade-enter');
              requestAnimationFrame(() => document.getElementById('home').classList.add('fade-enter-active'));
          }, 300);
      }

      // Toggle functions for pronunciation and translation
      function toggleTransliteration() {
          const section = document.getElementById('transliterationSection');
          const btn = document.getElementById('transliterationBtn');
          
          if (section.classList.contains('hidden')) {
              section.classList.remove('hidden');
              btn.classList.add('bg-green-200', 'dark:bg-green-800/60');
              btn.classList.remove('bg-gradient-to-r', 'from-green-100', 'to-emerald-100', 'dark:from-green-900/40', 'dark:to-emerald-900/40');
          } else {
              section.classList.add('hidden');
              btn.classList.remove('bg-green-200', 'dark:bg-green-800/60');
              btn.classList.add('bg-gradient-to-r', 'from-green-100', 'to-emerald-100', 'dark:from-green-900/40', 'dark:to-emerald-900/40');
          }
      }

      function toggleTranslation() {
          const section = document.getElementById('translationSection');
          const btn = document.getElementById('translationBtn');
          
          if (section.classList.contains('hidden')) {
              section.classList.remove('hidden');
              btn.classList.add('bg-blue-200', 'dark:bg-blue-800/60');
              btn.classList.remove('bg-gradient-to-r', 'from-blue-100', 'to-indigo-100', 'dark:from-blue-900/40', 'dark:to-indigo-900/40');
          } else {
              section.classList.add('hidden');
              btn.classList.remove('bg-blue-200', 'dark:bg-blue-800/60');
              btn.classList.add('bg-gradient-to-r', 'from-blue-100', 'to-indigo-100', 'dark:from-blue-900/40', 'dark:to-indigo-900/40');
          }
      }

      function handleTouchStart(e) {
          touchStartX = e.changedTouches[0].screenX;
      }

      function handleTouchEnd(e) {
          touchEndX = e.changedTouches[0].screenX;
          handleSwipe();
      }

      function handleSwipe() {
          const diff = touchEndX - touchStartX;
          if (Math.abs(diff) < swipeThreshold) return;
          if (diff > 0) {
              nextDhikr();
          } else {
              prevDhikr();
          }
      }

      // Add these storage helper functions at the top with other variables
      function savePrayerTimes(timings, location, city) {
          const dataToSave = {
              timings: timings,
              location: location,
              city: city,
              lastUpdated: new Date().toISOString() // Store as ISO string for easier parsing
          };
          try {
              localStorage.setItem('prayerTimes', JSON.stringify(dataToSave));
          } catch (error) {
              // Fallback to sessionStorage for iOS private browsing or if localStorage is full
              try {
                  sessionStorage.setItem('prayerTimes', JSON.stringify(dataToSave));
              } catch (sessionError) {
                  console.error('Error saving prayer times to localStorage and sessionStorage:', error, sessionError);
              }
          }
          // Call highlighting function after saving times
          setupPrayerHighlighting();
      }

      function loadPrayerTimes() {
          let savedData = null;
          // ... (existing code to load from localStorage or sessionStorage)
          try {
              const localStorageData = localStorage.getItem('prayerTimes');
              if (localStorageData) {
                  savedData = JSON.parse(localStorageData);
              }
          } catch (error) {
              console.error('Error reading from localStorage:', error);
          }

          if (!savedData && /iPad|iPhone|iPod/.test(navigator.userAgent)) {
              try {
                  const sessionStorageData = sessionStorage.getItem('prayerTimes');
                  if (sessionStorageData) {
                      savedData = JSON.parse(sessionStorageData);
                  }
              } catch (error) {
                  console.error('Error reading from sessionStorage:', error);
              }
          }

          if (savedData) {
              const lastUpdated = new Date(savedData.lastUpdated);
              const now = new Date();
              if (lastUpdated.toDateString() === now.toDateString()) {
                  prayerNotifications = savedData.timings;
                  currentCity = savedData.city;
                  // ... (existing UI updates for prayer times)
                  document.getElementById("azan-location").innerText = languages[currentLang].locationText(savedData.city, savedData.location);
                  // Use font-bold selectors for cached prayer times
                  const fajrSpan = document.querySelector("#azan-fajr .font-bold");
                  if (fajrSpan) fajrSpan.innerText = savedData.timings.Fajr;
                  
                  const sunriseSpan = document.querySelector("#azan-sunrise .font-bold");
                  if (sunriseSpan) sunriseSpan.innerText = savedData.timings.Sunrise;
                  
                  const dhuhrSpan = document.querySelector("#azan-dhuhr .font-bold");
                  if (dhuhrSpan) dhuhrSpan.innerText = savedData.timings.Dhuhr;
                  
                  const asrSpan = document.querySelector("#azan-asr .font-bold");
                  if (asrSpan) asrSpan.innerText = savedData.timings.Asr;
                  
                  const maghribSpan = document.querySelector("#azan-maghrib .font-bold");
                  if (maghribSpan) maghribSpan.innerText = savedData.timings.Maghrib;
                  
                  const ishaSpan = document.querySelector("#azan-isha .font-bold");
                  if (ishaSpan) ishaSpan.innerText = savedData.timings.Isha;
                  
                  // Update prayer names after setting times
                  updatePrayerTimesUI();

                  if (notificationEnabled) {
                      setupPrayerNotifications();
                  }
                  // Call highlighting function if times are loaded from storage
                  setupPrayerHighlighting();
                  return true;
              }
          }
          return false;
      }

      // Update the fetchPrayerTimes function
      async function fetchPrayerTimes(city = "Amman") {
          const today = new Date().toISOString().split('T')[0];
          const formattedDate = today.split('-').reverse().join('-');
          const cacheKey = `prayer-${city}-${formattedDate}`;
          
          // Try multiple approaches
          const strategies = [
              // 1. Direct API call
              async () => {
                  const url = `https://api.aladhan.com/v1/timingsByAddress/${formattedDate}?address=${encodeURIComponent(city)}`;
                  const response = await fetch(url);
                  if (!response.ok) throw new Error('Direct API failed');
                  return response.json();
              },
              
              // 2. Service Worker cached version
              async () => {
                  const cache = await caches.open('api-cache-v1');
                  const cached = await cache.match(`https://api.aladhan.com/v1/timingsByAddress/${formattedDate}?address=${encodeURIComponent(city)}`);
                  if (!cached) throw new Error('No cache available');
                  return cached.json();
              },
              
              // 3. localStorage fallback
              async () => {
                  const stored = localStorage.getItem(cacheKey);
                  if (!stored) throw new Error('No localStorage data');
                  return JSON.parse(stored);
              }
          ];

          for (const strategy of strategies) {
              try {
                  const data = await strategy();
                  // Store successful response in localStorage as backup
                  localStorage.setItem(cacheKey, JSON.stringify(data));
                  
                  if (data.code === 200) {
                      const timings = data.data.timings;
                      const location = data.data.meta.timezone;

                      // Store timings for notifications
                      prayerNotifications = timings;
                      
                      // Save to storage
                      savePrayerTimes(timings, location, city);
                      console.log('Prayer times updated and saved:', timings);

                      document.getElementById("azan-location").innerText = languages[currentLang].locationText(city, location);
                      // Use font-bold selectors for API prayer times
                      const fajrEl = document.querySelector("#azan-fajr .font-bold");
                      if (fajrEl) fajrEl.innerText = timings.Fajr;
                      
                      const sunriseEl = document.querySelector("#azan-sunrise .font-bold");
                      if (sunriseEl) sunriseEl.innerText = timings.Sunrise;
                      
                      const dhuhrEl = document.querySelector("#azan-dhuhr .font-bold");
                      if (dhuhrEl) dhuhrEl.innerText = timings.Dhuhr;
                      
                      const asrEl = document.querySelector("#azan-asr .font-bold");
                      if (asrEl) asrEl.innerText = timings.Asr;
                      
                      const maghribEl = document.querySelector("#azan-maghrib .font-bold");
                      if (maghribEl) maghribEl.innerText = timings.Maghrib;
                      
                      const ishaEl = document.querySelector("#azan-isha .font-bold");
                      if (ishaEl) ishaEl.innerText = timings.Isha;
                      
                      // Update prayer names after setting times
                      updatePrayerTimesUI();

                      // Setup notifications if enabled
                      if (notificationEnabled) {
                          console.log('Setting up notifications after prayer times update');
                          setupPrayerNotifications();
                      }
                      // Call highlighting function if times are loaded from storage
                      setupPrayerHighlighting();
                      return;
                  }
              } catch (error) {
                  console.warn(`Strategy failed: ${error.message}`);
                  continue;
              }
          }

          // If all strategies fail, show error message
          document.getElementById("azan-location").innerText = languages[currentLang].arErrorMessage;
          throw new Error('All prayer time fetch strategies failed');
      }

      async function detectCityAndFetchTimes() {
          try {
              const locationRes = await fetch("https://ipapi.co/json/");
              const locationData = await locationRes.json();
              currentCity = locationData.city || "Amman";
              await fetchPrayerTimes(currentCity);
          } catch (error) {
              console.error("Could not detect city, falling back to Amman.", error);
              await fetchPrayerTimes("Amman");
          }
      }

      // Function to navigate to home screen (adhkar tab)
      function goToHomeScreen() {
          // Click the adhkar tab to go to home screen
          const adhkarTab = document.getElementById('adhkarTab');
          if (adhkarTab) {
              adhkarTab.click();
          }
      }

      function setupTabs() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

          const tabs = document.querySelectorAll('.tab');
          tabs.forEach(tab => {
              tab.addEventListener('click', async () => {
                  const previousActiveTab = document.querySelector('.tab.active');
                  const previousTabId = previousActiveTab ? previousActiveTab.getAttribute('data-tab') : null;
                  
                  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                  tab.classList.add('active');
                  const tabId = tab.getAttribute('data-tab');
                  document.getElementById(`${tabId}Content`).classList.add('active');

                  // Reset reading mode when switching away from Quran tab
                  if (previousTabId === 'quran' && tabId !== 'quran' && isReadingMode) {
                      isReadingMode = false;
                      const btnReadingMode = document.getElementById('btnReadingMode');
                      if (btnReadingMode) {
                          btnReadingMode.innerHTML = '<i class="fas fa-book-open w-3 h-3"></i>';
                      }
                      // Remove scroll listener
                      if (window.currentScrollListener) {
                          window.removeEventListener('scroll', window.currentScrollListener);
                          window.currentScrollListener = null;
                      }
                      // Hide page/Juz indicator
                      hidePageJuzIndicator();
                  }

                  if (tabId === 'qibla') {
                     // Qibla tab is now ready - no auto-initialization needed
                     // User will click the start button when ready
                     
                     // Scroll to show the entire Qibla compass clearly
                     setTimeout(() => {
                         const qiblaContent = document.getElementById('qiblaContent');
                         if (qiblaContent) {
                             qiblaContent.scrollIntoView({ 
                                 behavior: 'smooth', 
                                 block: 'start',
                                 inline: 'nearest' 
                             });
                         }
                     }, 100);
                  }

            
            if (tabId === 'prayer' && isIOS) {
                
            } 

                  if (tabId === 'quran') {
                      try {
                          if (!quranData || !translationData) {
                              await loadQuranData();
                          } else {
                              resetQuranContent();
                          }
                          
                          // Initialize Quran search if not already done
                          if (!document.getElementById('quranSearchInput').hasAttribute('data-initialized')) {
                              initializeQuranSearch();
                              document.getElementById('quranSearchInput').setAttribute('data-initialized', 'true');
                          }
                      } catch (error) {
                          const arabicText = document.getElementById('arabicText');
                          if (arabicText) {
                              arabicText.innerHTML = `
                                  <div class="text-red-500 dark:text-red-400 py-8">
                                      <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                                      <p class="text-xl">${currentLang === 'ar' ? '    ' : 'Error loading data'}</p>
                                      <p class="text-sm mt-4">${error.message}</p>
                                  </div>
                              `;
                          }
                      }
                  }
              });
          });
      }

      // Update loadQuranData function to include more detailed logging
      async function loadQuranData() {
          try {
              // Try to get cached data first
              let quranJson = null;
              let translationJson = null;
              
              try {
                  const cachedQuran = localStorage.getItem('quranData');
                  const cachedTranslation = localStorage.getItem('translationData');
                  
                  if (cachedQuran) {
                      quranJson = JSON.parse(cachedQuran);
                      console.log('Using cached Quran data');
                  }
                  
                  if (cachedTranslation) {
                      translationJson = JSON.parse(cachedTranslation);
                      console.log('Using cached translation data');
                  }
              } catch (error) {
                  console.error('Error reading from cache:', error);
              }

              // If no cached data, fetch from API
              if (!quranJson) {
                  console.log('Fetching Quran data from API...');
                  const quranResponse = await fetch('https://api.alquran.cloud/v1/quran/quran-simple');
                  if (!quranResponse.ok) {
                      throw new Error(`Failed to load Quran data: ${quranResponse.status}`);
                  }
                  quranJson = await quranResponse.json();
                  console.log('Quran data loaded successfully');
                  
                  // Cache the data asynchronously to avoid blocking
                  setTimeout(() => {
                  try {
                      localStorage.setItem('quranData', JSON.stringify(quranJson));
                          console.log('Quran data cached successfully');
                  } catch (error) {
                      console.error('Error caching Quran data:', error);
                  }
                  }, 0);
              }

              if (!translationJson) {
                  console.log('Fetching translation data from API...');
                  const translationResponse = await fetch('https://api.alquran.cloud/v1/quran/en.sahih');
                  if (!translationResponse.ok) {
                      throw new Error(`Failed to load translation: ${translationResponse.status}`);
                  }
                  translationJson = await translationResponse.json();
                  console.log('Translation data loaded successfully');
                  
                  // Cache the data asynchronously to avoid blocking
                  setTimeout(() => {
                  try {
                      localStorage.setItem('translationData', JSON.stringify(translationJson));
                          console.log('Translation data cached successfully');
                  } catch (error) {
                      console.error('Error caching translation data:', error);
                  }
                  }, 0);
              }

              if (!quranJson.data || !quranJson.data.surahs) {
                  throw new Error('Invalid Quran data format');
              }

              quranData = quranJson.data.surahs;

              // Initialize surah menu data asynchronously to avoid blocking
              setTimeout(() => {
                  initializeSurahMenu();
              }, 0);

              if (!translationJson.data || !translationJson.data.surahs) {
                  throw new Error('Invalid translation data format');
              }

              translationData = translationJson.data.surahs;

              currentSurah = null;
              currentAyah = 0;

            //   document.getElementById('btnBookmark').disabled = false;

              let savedBookmark = null;
              console.log("savedBookmark", savedBookmark);
              try {
                  const localStorageBookmark = localStorage.getItem('quranBookmark');
                  if (localStorageBookmark) {
                      savedBookmark = JSON.parse(localStorageBookmark);
                     
                    
                  }
              } catch (error) {
                  console.error('Error reading from localStorage:', error);
              }

              if (!savedBookmark) {
                  try {
                      const sessionStorageBookmark = sessionStorage.getItem('quranBookmark');
                      if (sessionStorageBookmark) {
                          savedBookmark = JSON.parse(sessionStorageBookmark);
                      }
                  } catch (error) {
                      console.error('Error reading from sessionStorage:', error);
                  }
              }

              if (savedBookmark) {
                  currentBookmark = savedBookmark;
                
              } else {
                 
              }

              resetQuranContent();

              // Set initial tafsir state and icon
              isTafsirVisible = false;
         

          } catch (error) {
              console.error('Error loading Quran data:', error);
              showToast(currentLang === 'ar' ? '    ' : 'Error loading data', 'error');
          }
      }

      function resetQuranContent() {
          currentSurah = null;
          currentAyah = 0;
          
          // Update surah menu button text
          const selectedSurahText = document.getElementById('selectedSurahText');
          if (selectedSurahText) {
              selectedSurahText.textContent = languages[currentLang].selectSurah;
          }
          
          // Show quick surahs section when resetting
          const quickSurahsSection = document.getElementById('quickSurahsSection');
          if (quickSurahsSection) {
              quickSurahsSection.style.display = 'block';
          }
          
          let savedBookmark = null;
          
          try {
              const localStorageBookmark = localStorage.getItem('quranBookmark');
              if (localStorageBookmark) {
                  savedBookmark = JSON.parse(localStorageBookmark);
              }
          } catch (error) {
              console.error('Error reading from localStorage:', error);
          }
          
          if (!savedBookmark) {
              try {
                  const sessionStorageBookmark = sessionStorage.getItem('quranBookmark');
                  if (sessionStorageBookmark) {
                      savedBookmark = JSON.parse(sessionStorageBookmark);
                  }
              } catch (error) {
                  console.error('Error reading from sessionStorage:', error);
              }
          }
          
          if (savedBookmark) {
              try {
                  currentBookmark = savedBookmark;
                  
              } catch (error) {
                  try {
                      localStorage.removeItem('quranBookmark');
                      sessionStorage.removeItem('quranBookmark');
                  } catch (storageError) {
                      console.error('Error removing invalid bookmark:', storageError);
                  }
                  currentBookmark = null;
              }
          }
          
          document.getElementById('arabicText').innerHTML = `
              <div class="text-gray-500 dark:text-gray-400 py-2">
                  <i class="fas fa-book-quran text-2xl mb-2"></i>
                  <p class="text-lg">${currentLang === 'ar' ? '  ' : 'Select a Surah to begin'}</p>
                  ${savedBookmark && quranData ? `
                      <div class="mt-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 p-4 max-w-xs mx-auto">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="flex-shrink-0 w-10 h-10 bg-blue-50 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                                  <i class="fas fa-bookmark text-blue-500 text-sm"></i>
                              </div>
                              <div class="flex-1 min-w-0">
                                  <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-1">
                                          ${currentLang === 'ar' ? ' ' : 'Continue Reading'}
                                      </h3>
                                  <p class="text-sm font-medium text-gray-800 dark:text-gray-200 truncate">
                                      ${quranData[savedBookmark.surah].name}
                                      </p>
                                  <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                                      ${quranData[savedBookmark.surah].englishName}
                                  </p>
                              </div>
                              <div class="flex-shrink-0 text-right">
                                  <p class="text-xs text-blue-600 dark:text-blue-400 font-medium">
                                          ${currentLang === 'ar' ? '' : 'Verse'} ${savedBookmark.ayah + 1}
                                      </p>
                                  <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                      ${new Date(savedBookmark.timestamp).toLocaleDateString()}
                                      </p>
                                  </div>
                              </div>
                          <button onclick="goToBookmark()" class="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 shadow-sm hover:shadow-md">
                              <i class="fas fa-play text-sm"></i>
                              <span>${currentLang === 'ar' ? '' : 'Continue'}</span>
                              </button>
                      </div>
                  ` : ''}
              </div>
          `;
          
          document.getElementById('translationText').innerHTML = '';
          
          document.getElementById('btnReadingMode').disabled = true;
      }

      // Add these new functions for notification handling
      async function registerServiceWorker() {
          if ('serviceWorker' in navigator) {
              try {
                  const registration = await navigator.serviceWorker.register('sw.js', {
                      scope: './'
                  });
                  console.log('Service Worker registered with scope:', registration.scope);

                  // For iOS, request background fetch permission
                  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                      try {
                          await registration.periodicSync.register('prayer-times', {
                              minInterval: 15 * 60 * 1000 // 15 minutes
                          });
                          console.log('Periodic sync registered for prayer times');
                      } catch (error) {
                          console.error('Periodic sync registration failed:', error);
                      }
                  }

                  return registration;
              } catch (error) {
                  console.error('Service Worker registration failed:', error);
                  return null;
              }
          }
          return null;
      }

      async function requestNotificationPermission() {
          try {
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              
              // Check if the app is running in standalone mode (added to home screen)
              const isInStandaloneMode = ('standalone' in navigator) && (navigator.standalone);
              
              if (isIOS && !isInStandaloneMode) {
                  // Show instructions for adding to home screen first
                  showTutorial();
                  return false;
              }

              // Check if notifications are supported
              if (!('Notification' in window)) {
                  const notSupportedMessage = currentLang === 'ar'
                      ? '   '
                      : 'Notifications are not supported in this browser';
                  alert(notSupportedMessage);
                  return false;
              }
              
              // Request permission
              const permission = await Notification.requestPermission();
              
              if (permission === 'granted') {
                  try {
                      notificationEnabled = true;
                      document.getElementById('notificationToggle').checked = true;
                
                      if (isIOS) {
                          // For iOS, use basic notifications
                          setupBasicNotifications();
                          // Show success message
                          const successMessage = currentLang === 'ar'
                              ? '   '
                              : 'Notifications enabled successfully';
                          alert(successMessage);
                      } else {
                          // For Android, use push notifications
                          const registration = await registerServiceWorker();
                          if (registration) {
                              try {
                                  const subscription = await registration.pushManager.subscribe({
                                      userVisibleOnly: true,
                                      applicationServerKey: 'BOPaG1Jwr89JCSdQ1ejhuPmyKXGVQLQjI2SJfeaYT-LiUjf44KtxCS_JSq-cVxE9O0q7sExLbs2mO4aO0KWPJcc'
                                  });
                                  localStorage.setItem('pushSubscription', JSON.stringify(subscription));
                                  setupPrayerNotifications();
                                  // Show success message
                                  const successMessage = currentLang === 'ar'
                                      ? '   '
                                      : 'Notifications enabled successfully';
                                  alert(successMessage);
                              } catch (error) {
                                  console.error('Push subscription failed:', error);
                                  setupBasicNotifications();
                              }
                          } else {
                              setupBasicNotifications();
                          }
                      }
                      return true;
                  } catch (error) {
                      console.error('Error setting up notifications:', error);
                      notificationEnabled = false;
                      document.getElementById('notificationToggle').checked = false;
                      
                      if (isIOS) {
                          const iosErrorMessage = currentLang === 'ar'
                              ? '    . :\n\n1.        \n2.       Safari\n3.   '
                              : 'Error enabling notifications. Please:\n\n1. Make sure the app is opened from home screen\n2. Check Safari settings for notifications\n3. Restart the app';
                          alert(iosErrorMessage);
                      } else {
                          const errorMessage = currentLang === 'ar'
                              ? '    '
                              : 'Error enabling notifications';
                          alert(errorMessage);
                      }
                      return false;
                  }
              } else {
                  notificationEnabled = false;
                  document.getElementById('notificationToggle').checked = false;
                  
                  // Show more detailed message for iOS
                  if (isIOS) {
                      const iosPermissionMessage = currentLang === 'ar'
                          ? '   iOS:\n\n1.   \n2.   Safari > \n3.   " "\n4.   '
                          : 'To enable notifications on iOS:\n\n1. Open your device settings\n2. Go to Safari > Settings\n3. Enable "Allow Notifications"\n4. Restart the app';
                      alert(iosPermissionMessage);
                  } else {
                      const permissionDeniedMessage = currentLang === 'ar'
                          ? '     '
                          : 'Please allow notifications in your browser settings';
                      alert(permissionDeniedMessage);
                  }
                  return false;
              }
          } catch (error) {
              console.error('Error requesting notification permission:', error);
              notificationEnabled = false;
              document.getElementById('notificationToggle').checked = false;
              const errorMessage = currentLang === 'ar'
                  ? '    '
                  : 'An error occurred while enabling notifications';
              alert(errorMessage);
              return false;
          }
      }

      function setupBasicNotifications() {
          if (!notificationEnabled) {
              console.log('Notifications not enabled');
              return;
          }

          // Clear any existing timeouts
          clearAllNotificationTimeouts();

          const now = new Date();
          const timings = prayerNotifications;
          
          if (!timings || Object.keys(timings).length === 0) {
              console.log('No prayer times available for notifications');
              return;
          }

          console.log('Setting up notifications for:', now.toDateString());
          console.log('Prayer times:', timings);

          // Schedule notifications for all remaining prayers today
          const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
          let scheduledCount = 0;

          prayerOrder.forEach(prayer => {
              if (timings[prayer]) {
                  const prayerTime = parseTime(timings[prayer], now);
                  const timeUntilPrayer = prayerTime - now;
                  
                  if (timeUntilPrayer > 0) {
                      console.log(`Scheduling ${prayer} notification for ${prayerTime.toLocaleTimeString()} (in ${Math.floor(timeUntilPrayer / 60000)} minutes)`);
                      
                      const timeoutId = setTimeout(() => {
                          showBasicNotification(prayer);
                          // Schedule next day's notifications after Isha
                          if (prayer === 'Isha') {
                              setTimeout(() => {
                                  setupBasicNotifications();
                              }, 60000); // Wait 1 minute after Isha, then setup next day
                          }
                      }, timeUntilPrayer);
                      
                      notificationTimeouts.push(timeoutId);
                      scheduledCount++;
                  }
              }
          });

          console.log(`Scheduled ${scheduledCount} prayer notifications for today`);
          
          // Save notification state
          saveNotificationState();
          
          // If no prayers left today, schedule for tomorrow
          if (scheduledCount === 0) {
              console.log('No more prayers today, scheduling for tomorrow');
              scheduleNextDayNotifications();
          }
      }

      function parseTime(timeString, baseDate) {
          const [hours, minutes] = timeString.split(':').map(Number);
          const date = new Date(baseDate);
          date.setHours(hours, minutes, 0, 0);
          return date;
      }

      function clearAllNotificationTimeouts() {
          notificationTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
          notificationTimeouts = [];
      }

      function scheduleNextDayNotifications() {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          tomorrow.setHours(4, 0, 0, 0); // Schedule at 4 AM tomorrow
          
          const timeUntilTomorrow = tomorrow - new Date();
          
          setTimeout(() => {
              console.log('Setting up notifications for next day');
              fetchPrayerTimes(currentCity).then(() => {
                  setupBasicNotifications();
              });
          }, timeUntilTomorrow);
      }

      function saveNotificationState() {
          const state = {
              enabled: notificationEnabled,
              lastSetup: new Date().toISOString(),
              city: currentCity
          };
          localStorage.setItem('notificationState', JSON.stringify(state));
      }

      function loadNotificationState() {
          try {
              const saved = localStorage.getItem('notificationState');
              if (saved) {
                  const state = JSON.parse(saved);
                  const lastSetup = new Date(state.lastSetup);
                  const now = new Date();
                  
                  // Check if it's the same day
                  if (lastSetup.toDateString() === now.toDateString() && state.enabled) {
                      notificationEnabled = true;
                      document.getElementById('notificationToggle').checked = true;
                      return true;
                  }
              }
          } catch (error) {
              console.error('Error loading notification state:', error);
          }
          return false;
      }

      function showBasicNotification(prayer) {
          if (!notificationEnabled) return;

          const prayerNames = {
              'Fajr': currentLang === 'ar' ? '' : 'Fajr',
              'Dhuhr': currentLang === 'ar' ? '' : 'Dhuhr',
              'Asr': currentLang === 'ar' ? '' : 'Asr',
              'Maghrib': currentLang === 'ar' ? '' : 'Maghrib',
              'Isha': currentLang === 'ar' ? '' : 'Isha'
          };

          const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          const prayerTime = prayerNotifications[prayer];

          try {
              // Play notification sound if available
              try {
                  const audio = new Audio('adhan.mp3');
                  audio.volume = 0.5;
                  audio.play().catch(e => console.log('Audio play failed:', e));
              } catch (audioError) {
                  console.log('Audio not available:', audioError);
              }

              const notification = new Notification(languages[currentLang].prayerTimeNotification, {
                  body: currentLang === 'ar' 
                      ? `    ${prayerNames[prayer]} - ${prayerTime}`
                      : `It's time for ${prayerNames[prayer]} prayer - ${prayerTime}`,
                  icon: 'icon1.png',
                  badge: 'icon1.png',
                  tag: `prayer-${prayer}`,
                  requireInteraction: true,
                  vibrate: [200, 100, 200, 100, 200],
                  badge: 'icon1.png',
                  requireInteraction: true,
                  silent: false
              });

              // Play adhan sound
              const audio = new Audio('adhan.mp3');
              audio.play().catch(error => console.error('Error playing adhan:', error));

              // Setup next notification
              setupBasicNotifications();
          } catch (error) {
              console.error('Error showing notification:', error);
              // Fallback to alert for iOS
              if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                  alert(`${prayerNames[prayer]} ${languages[currentLang].prayerTimeApproachingBody}`);
                  const audio = new Audio('adhan.mp3');
                  audio.play().catch(error => console.error('Error playing adhan:', error));
              }
          }
      }

      async function setupPrayerNotifications() {
          if (!notificationEnabled) return;

          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isInStandaloneMode = ('standalone' in navigator) && (navigator.standalone);

          // For iOS in standalone mode, use background fetch
          if (isIOS && isInStandaloneMode) {
              try {
                  const registration = await navigator.serviceWorker.ready;
                  await registration.periodicSync.register('prayer-times', {
                      minInterval: 15 * 60 * 1000 // 15 minutes
                  });
                  console.log('Periodic sync registered for prayer times');
              } catch (error) {
                  console.error('Periodic sync registration failed:', error);
                  // Fallback to basic notifications
                  setupBasicNotifications();
              }
          } else {
              // For Android or iOS not in standalone mode, use basic notifications
              setupBasicNotifications();
          }
      }

      // Add periodic check for prayer times
      function setupPeriodicChecks() {
          // Check prayer times every hour
          setInterval(() => {
              console.log('Running periodic prayer times check');
              fetchPrayerTimes(currentCity);
          }, 60 * 60 * 1000); // Every hour
      }

      // Add these functions to handle the tutorial
      function showTutorial() {
          // Basic iOS detection
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isInStandaloneMode = window.navigator.standalone === true;
          
          console.log('Showing tutorial for:', {
              isIOS,
              isInStandaloneMode,
              userAgent: navigator.userAgent
          });

          
          const modal = document.getElementById('tutorialModal');
          const iosTutorial = document.getElementById('iosTutorial');
          const androidTutorial = document.getElementById('androidTutorial');
          const title = document.getElementById('tutorialTitle');
          const gotItButton = document.getElementById('gotItButton');
          const iosSteps = document.getElementById('iosSteps');
          const androidSteps = document.getElementById('androidSteps');
          const iosNote = document.getElementById('iosNote');

          // Set language-specific content
          const lang = languages[currentLang];
          title.textContent = lang.tutorialTitle;
          gotItButton.textContent = lang.gotIt;

          // Set text alignment based on language
          const textAlignment = currentLang === 'ar' ? 'text-right' : 'text-left';
          iosSteps.className = `list-decimal list-inside space-y-3 ${textAlignment}`;
          androidSteps.className = `list-decimal list-inside space-y-3 ${textAlignment}`;
          iosNote.className = `mt-4 text-sm text-gray-500 ${textAlignment}`;

          // Set iOS tutorial content
          if (isIOS) {
              iosTutorial.classList.remove('hidden');
              androidTutorial.classList.add('hidden');
              
              // Clear previous steps
              iosSteps.innerHTML = '';
              
              // Add new steps
              lang.tutorialIOS.steps.forEach(step => {
                  const li = document.createElement('li');
                  li.textContent = step;
                  iosSteps.appendChild(li);
              });
              
              // Add note
              iosNote.textContent = lang.tutorialIOS.note;
          } else {
              // Set Android tutorial content
              iosTutorial.classList.add('hidden');
              androidTutorial.classList.remove('hidden');
              
              // Clear previous steps
              androidSteps.innerHTML = '';
              
              // Add new steps
              lang.tutorialAndroid.steps.forEach(step => {
                  const li = document.createElement('li');
                  li.textContent = step;
                  androidSteps.appendChild(li);
              });
          }

          // Show modal with iOS-specific handling
          modal.style.display = 'flex';
          modal.classList.remove('hidden');
          
          // Force a reflow to ensure the modal is visible
          modal.offsetHeight;
          
          // Add a small delay for iOS
          if (isIOS) {
              setTimeout(() => {
                  modal.style.opacity = '1';
              }, 50);
          } else {
              modal.style.opacity = '1';
          }
      }

      function closeTutorial() {
          const modal = document.getElementById('tutorialModal');
          modal.style.opacity = '0';
          
          // Wait for fade out animation
          setTimeout(() => {
              modal.style.display = 'none';
              modal.classList.add('hidden');
          }, 300);
      }

      // Add tafsir cache object at the top
      let tafsirCache = {};
      let currentTafsirSource = '2'; // Default tafsir source (Jalalayn ID)

      // Tafsir source mapping - using AlQuran.cloud API for reliable HTTPS support
      const tafsirSources = {
        // Arabic tafsir from AlQuran.cloud API
        '1': { edition: 'ar.muyassar', name: ' ', language: 'ar', api: 'alquran' },
        '2': { edition: 'ar.jalalayn', name: ' ', language: 'ar', api: 'alquran' },
        '3': { edition: 'ar.saddi', name: ' ', language: 'ar', api: 'alquran' },
        '4': { edition: 'ar.baghawi', name: ' ', language: 'ar', api: 'alquran' },
        '5': { edition: 'ar.qurtubi', name: ' ', language: 'ar', api: 'alquran' },
        '6': { edition: 'ar.kathir', name: '  ', language: 'ar', api: 'alquran' },
        '7': { edition: 'ar.tabari', name: ' ', language: 'ar', api: 'alquran' },
        
        // English tafsir from spa5k tafsir_api
        'en-jalalayn': { slug: 'en-al-jalalayn', name: 'Tafsir al-Jalalayn (English)', language: 'en', api: 'spa5k' },
        'en-kathir': { slug: 'en-tafisr-ibn-kathir', name: 'Tafsir Ibn Kathir (English)', language: 'en', api: 'spa5k' },
        'en-maarif': { slug: 'en-tafsir-maarif-ul-quran', name: 'Ma\'ariful Quran (English)', language: 'en', api: 'spa5k' },
        'en-tazkirul': { slug: 'en-tazkirul-quran', name: 'Tazkirul Quran (English)', language: 'en', api: 'spa5k' }
      };

             // Update getTafsirForAyah to fetch per-ayah tafsir using multiple APIs
       async function getTafsirForAyah(surah, ayah, tafsirSource = null) {
         const source = tafsirSource || currentTafsirSource;
         const tafsirConfig = tafsirSources[source] || tafsirSources['2']; // Default to Jalalayn
         const cacheKey = `tafsir-${source}-${surah + 1}-${ayah + 1}`;
         
        if (tafsirCache[cacheKey]) {
          return tafsirCache[cacheKey];
        }
         
         try {
           let url, response, data;
           
           if (tafsirConfig.api === 'alquran') {
             // Use AlQuran.cloud API for Arabic tafsir
             url = `https://api.alquran.cloud/v1/ayah/${surah + 1}:${ayah + 1}/${tafsirConfig.edition}`;
             response = await fetch(url);
             if (response.ok) {
               const apiData = await response.json();
               // Transform the response to match our expected format
               if (apiData.data && apiData.data.text) {
                 data = { text: apiData.data.text.replace(/<[^>]*>/g, '') }; // Remove HTML tags
               } else {
                 data = { text: currentLang === 'ar' ? '   ' : 'Tafsir not available' };
               }
          tafsirCache[cacheKey] = data;
          return data;
             } else {
               throw new Error(`HTTP ${response.status}`);
             }
           } else if (tafsirConfig.api === 'spa5k') {
             // Use spa5k tafsir_api for English tafsir with multiple CDN fallbacks
             const cdnUrls = [
               `https://raw.githubusercontent.com/spa5k/tafsir_api/main/tafsir/${tafsirConfig.slug}/${surah + 1}/${ayah + 1}.json`,
               `https://cdn.statically.io/gh/spa5k/tafsir_api/main/tafsir/${tafsirConfig.slug}/${surah + 1}/${ayah + 1}.json`,
               `https://rawcdn.githack.com/spa5k/tafsir_api/main/tafsir/${tafsirConfig.slug}/${surah + 1}/${ayah + 1}.json`
             ];
             
             for (const cdnUrl of cdnUrls) {
               try {
                 response = await fetch(cdnUrl);
                 if (response.ok) {
                   data = await response.json();
                   tafsirCache[cacheKey] = data;
                   return data;
                 }
               } catch (cdnError) {
                 console.log(`Failed to fetch from ${cdnUrl}:`, cdnError);
                 continue;
               }
             }
             throw new Error('All CDN sources failed');
           }
        } catch (error) {
           console.log(`Failed to fetch tafsir from API:`, error);
           
           // Fallback to default tafsir if not already using it
           if (source !== '2') {
             return getTafsirForAyah(surah, ayah, '2');
           }
           
          tafsirCache[cacheKey] = { text: currentLang === 'ar' ? '   ' : 'Tafsir not available' };
          return tafsirCache[cacheKey];
        }
      }

      // Store current page/Juz for language switching
      let currentPageNum = null;
      let currentJuzNum = null;

      // Function to update page/Juz indicator in sticky header
      function updatePageJuzIndicator(pageNum, juzNum) {
        const pageJuzIndicator = document.getElementById('pageJuzIndicator');
        const currentPageIndicator = document.getElementById('currentPageIndicator');
        const currentJuzIndicator = document.getElementById('currentJuzIndicator');
        
        if (pageJuzIndicator && currentPageIndicator && currentJuzIndicator) {
          // Store current values
          currentPageNum = pageNum;
          currentJuzNum = juzNum;
          
          // Show the indicator
          pageJuzIndicator.classList.remove('hidden');
          
          // Update page indicator
          currentPageIndicator.textContent = currentLang === 'ar' ? 
            ` ${toArabicNumerals(pageNum)}` : 
            `Page ${pageNum}`;
          
          // Update Juz indicator
          currentJuzIndicator.textContent = currentLang === 'ar' ? 
            ` ${toArabicNumerals(juzNum)}` : 
            `Juz ${juzNum}`;
        }
      }

      // Function to hide page/Juz indicator
      function hidePageJuzIndicator() {
        const pageJuzIndicator = document.getElementById('pageJuzIndicator');
        if (pageJuzIndicator) {
          pageJuzIndicator.classList.add('hidden');
        }
      }

      // Function to detect current visible page and update indicator
      function detectCurrentPageAndJuz() {
        if (!isReadingMode || !quranData || currentSurah === null) {
          hidePageJuzIndicator();
          return;
        }

        // Find all page sections currently visible
        const pageSections = document.querySelectorAll('.page-section');
        if (pageSections.length === 0) {
          // Don't hide immediately, might be during a language change - retry once
          setTimeout(() => {
            const retryPageSections = document.querySelectorAll('.page-section');
            if (retryPageSections.length === 0 && isReadingMode) {
              hidePageJuzIndicator();
            }
          }, 200);
          return;
        }

        let currentPageNum = null;
        let currentJuzNum = null;
        let closestSection = null;
        let closestDistance = Infinity;

        // Get viewport center
        const viewportCenter = window.innerHeight / 2;

        // Find the section closest to viewport center
        pageSections.forEach(section => {
          const rect = section.getBoundingClientRect();
          const sectionCenter = rect.top + (rect.height / 2);
          const distance = Math.abs(sectionCenter - viewportCenter);
          
          // If this section is closer to center or intersects with viewport center
          if (distance < closestDistance || (rect.top <= viewportCenter && rect.bottom >= viewportCenter)) {
            closestDistance = distance;
            closestSection = section;
          }
        });

        // Extract page and Juz info from the closest section
        if (closestSection) {
          // Extract page number from the section
          const pageHeader = closestSection.querySelector('.page-header span');
          if (pageHeader) {
            const pageText = pageHeader.textContent;
            // Look for both Arabic and English numbers
            const pageMatch = pageText.match(/\d+/) || pageText.match(/[-]+/);
            if (pageMatch) {
              let pageNumber = pageMatch[0];
              // Convert Arabic numerals to English if needed
              if (/[-]/.test(pageNumber)) {
                pageNumber = pageNumber.replace(/[-]/g, d => ''.indexOf(d));
              }
              currentPageNum = parseInt(pageNumber);
              
              // Get Juz from the first ayah in this page section
              const firstAyah = closestSection.querySelector('.ayah');
              if (firstAyah) {
                const surahIndex = parseInt(firstAyah.getAttribute('data-surah'));
                const ayahIndex = parseInt(firstAyah.getAttribute('data-ayah'));
                
                if (quranData[surahIndex] && quranData[surahIndex].ayahs[ayahIndex]) {
                  currentJuzNum = quranData[surahIndex].ayahs[ayahIndex].juz;
                }
              }
            }
          }
        }

        // Update indicator if we found valid page/Juz
        if (currentPageNum && currentJuzNum) {
          updatePageJuzIndicator(currentPageNum, currentJuzNum);
        } else {
          console.log('Could not detect page/Juz:', { currentPageNum, currentJuzNum, sectionsFound: pageSections.length });
        }
      }

      // Update displayAyah to fetch tafsir per ayah
      async function displayAyah() {
        const arabicTextElement = document.getElementById('arabicText');
        const translationTextElement = document.getElementById('translationText');
        const surah = quranData && currentSurah !== null ? quranData[currentSurah] : null;
        if (surah && surah.ayahs && surah.ayahs[0]) {
          console.log('First ayah from quranData:', surah.ayahs[0].text);
        }
        if (currentSurah === null || !quranData || !translationData) {
          arabicTextElement.innerHTML = `
            <div class="text-gray-500 dark:text-gray-400 py-2">
              <i class="fas fa-book-quran text-2xl mb-2"></i>
              <p class="text-lg">  </p>
              <p class="text-sm mt-1">Select a Surah to begin</p>
            </div>
          `;
          translationTextElement.innerHTML = '';
          document.getElementById('btnReadingMode').disabled = true;
          return;
        }
        try {
          const translation = translationData[currentSurah];
          if (!surah || !translation) throw new Error('Invalid surah data');
          if (!surah.ayahs || !translation.ayahs) throw new Error('Invalid ayahs data');
          if (
  currentAyah === null ||
  currentAyah === undefined ||
  isNaN(currentAyah) ||
  !surah.ayahs[currentAyah] ||
  !translation.ayahs[currentAyah]
) {
  showToast('Invalid ayah index. Showing the first ayah.', 'error');
  currentAyah = 0;
  // Try again with first ayah
  displayAyah();
  return;
}
          const bismillahText = '   ';
          const bismillahText2 = '   ';
          let bismillahHtml = '';
          let ayahText = surah.ayahs[currentAyah].text;
          let translationAyah = translation.ayahs[currentAyah];
          let ayahNumber = surah.ayahs[currentAyah].numberInSurah;
          let displayedAyahIndex = currentAyah;
          // For all surahs except At-Tawbah, show Bismillah at the top and remove from ayah text if present
          if (currentAyah === 0 && currentSurah !== 8) {
            ayahText = ayahText.replace('   ', '');
            ayahText = ayahText.replace('   ', '');
            
            bismillahHtml = `
              <div class="text-center my-6 text-xl md:text-3xl quran-uthmani-font text-gray-700 dark:text-gray-200 select-none max-w-full md:max-w-2xl mx-auto" dir="rtl" style="font-family: 'Quran.com Font', Arial, sans-serif; letter-spacing: 0.05em; margin-bottom: 2rem;">${bismillahText}</div>
            `;
            // If ayahText is empty after removing Bismillah (e.g., Al-Fatiha where first ayah is only Bismillah), 
            // skip to the actual first content ayah and increment currentAyah accordingly
            if (!ayahText.trim() && surah.ayahs.length > 1) {
              currentAyah = 1; // Actually move to the next ayah
              ayahText = surah.ayahs[1].text;
              ayahText = ayahText.replace('   ', '');
              ayahText = ayahText.replace('   ', '');

              translationAyah = translation.ayahs[1];
              ayahNumber = surah.ayahs[1].numberInSurah;
              displayedAyahIndex = 1;
            }
          } else if (currentAyah === 0 && currentSurah === 8) {
            // For At-Tawbah first verse, no bismillah
            bismillahHtml = '';
          }
          // Log the ayah text as it will be displayed (after Bismillah removal)
          if (currentAyah === 0 && currentSurah !== 8) {
            console.log('First ayah as displayed (after Bismillah removal):', ayahText);
          }
          const bookmarkText = languages[currentLang].bookmarkVerse;
          let tafsirHtml = '';
          if (isTafsirVisible) {
            tafsirHtml = `<div class="text-base text-gray-500 dark:text-gray-400 mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg" style="font-size: ${1 * currentTextSize}rem;">
              <div class="font-semibold mb-2">${currentLang === 'ar' ? '' : 'Tafsir'}:</div>
              <span id="tafsir-loading">${currentLang === 'ar' ? ' ...' : 'Loading...'}</span>
            </div>`;
          }
          // Add mobile navigation buttons for all verses
          let mobileNavHtml = `
              <div class="mobile-nav-buttons">
                <button onclick="prevAyah()" id="btnPrevAyahMobile" class="mobile-nav-btn" title="Previous - ${languages[currentLang].previousVerse}">
                  <i class="fas fa-chevron-${currentLang === 'ar' ? 'right' : 'left'}"></i> ${languages[currentLang].previousVerse}
                </button>
                <button onclick="nextAyah()" id="btnNextAyahMobile" class="mobile-nav-btn" title="Next - ${languages[currentLang].nextVerse}">
                  ${languages[currentLang].nextVerse} <i class="fas fa-chevron-${currentLang === 'ar' ? 'left' : 'right'}"></i>
                </button>
              </div>
            `;

          const html = `
            <div class="mb-6">
              ${bismillahHtml}
              ${mobileNavHtml}
              <div class="text-2xl leading-loose mb-2 text-justify md:text-center w-full md:max-w-2xl mx-auto px-4 md:px-8 text-right" dir="rtl" style="font-size: ${1.5 * currentTextSize}rem; line-height: 2.2; word-spacing: 0.1em; letter-spacing: 0.02em;">
                <span class="ayah" data-surah="${currentSurah}" data-ayah="${displayedAyahIndex}">
                  ${ayahText}
                </span>
                <span class="verse-marker" 
                  onclick="bookmarkAyah(${currentSurah}, ${displayedAyahIndex})"
                  title="${bookmarkText}">
                  <span class="verse-icon"></span><span class="verse-number">${toArabicNumerals(ayahNumber)}</span>
                </span>
              </div>
              ${isTranslationVisible && translationAyah ? `
                <div class="text-lg text-gray-600 dark:text-gray-400 mb-2 text-left" dir="ltr" style="font-size: ${1.125 * currentTextSize}rem;">
                  ${translationAyah.text}
                </div>
              ` : ''}
              ${isTafsirVisible ? tafsirHtml : ''}
              
            </div>
          `;
          arabicTextElement.innerHTML = html;
          translationTextElement.innerHTML = '';
          document.getElementById('btnReadingMode').disabled = false;
          
          // Update tooltip for reading mode button when single verse is displayed
          const readingModeBtn = document.getElementById('btnReadingMode');
          if (readingModeBtn && !isReadingMode) {
              const tooltipText = languages[currentLang].displayFullSurah;
              readingModeBtn.setAttribute('data-tooltip', tooltipText);
              readingModeBtn.classList.add('show-tooltip');
              
              // Auto-hide tooltip after 4 seconds
              setTimeout(() => {
                  if (readingModeBtn.classList.contains('show-tooltip')) {
                      readingModeBtn.classList.remove('show-tooltip');
                  }
              }, 4000);
          }
          
          // Update mobile button states
          const prevMobileBtn = document.getElementById('btnPrevAyahMobile');
          const nextMobileBtn = document.getElementById('btnNextAyahMobile');
          if (prevMobileBtn) prevMobileBtn.disabled = currentAyah === 0 && currentSurah === 0;
          if (nextMobileBtn) nextMobileBtn.disabled = currentAyah >= surah.ayahs.length - 1 && currentSurah >= quranData.length - 1;
          
          // Add event listeners for the ayah elements
          
          updateAyahHighlights();
          // Fetch tafsir if needed
          if (isTafsirVisible) {
            const tafsir = await getTafsirForAyah(currentSurah, displayedAyahIndex);
            const tafsirElem = document.getElementById('tafsir-loading');
            if (tafsirElem) tafsirElem.innerText = tafsir.text || (currentLang === 'ar' ? '   ' : 'Tafsir not available');
          }

          // Update page/Juz indicator for single verse mode
          if (surah && surah.ayahs && surah.ayahs[displayedAyahIndex]) {
            const currentAyahData = surah.ayahs[displayedAyahIndex];
            if (currentAyahData.page && currentAyahData.juz) {
              updatePageJuzIndicator(currentAyahData.page, currentAyahData.juz);
            }
          }
        } catch (error) {
          console.error('Error displaying ayah:', error);
          arabicTextElement.innerHTML = `
            <div class="text-red-500 dark:text-red-400 py-8">
              <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
              <p class="text-xl">    </p>
              <p class="text-lg mt-2">Error displaying verse</p>
            </div>
          `;
          translationTextElement.innerHTML = '';
        }
      }

      function nextAyah() {
          if (currentSurah === null || !quranData) {
              console.log('Cannot navigate: No surah selected or data not loaded');
              return;
          }

          const surah = quranData[currentSurah];
          
          // Debug log for navigation attempt
          console.log('Attempting next ayah navigation:', {
              currentSurah,
              currentAyah,
              totalAyahs: surah.ayahs.length,
              nextAyahIndex: currentAyah + 1,
              isReadingMode,
              surahName: surah.name,
              currentAyahData: surah.ayahs[currentAyah],
              nextAyahData: surah.ayahs[currentAyah + 1]
          });

          if (isReadingMode) {
              // In reading mode, move to next surah
              if (currentSurah < quranData.length - 1) {
                  currentSurah++;
                  currentAyah = 0;
                  // Update surah menu button text
                  updateSurahDropdown();
                  console.log('Moving to next surah:', {
                      from: currentSurah - 1,
                      to: currentSurah,
                      firstAyah: quranData[currentSurah].ayahs[0]
                  });
                  loadReadingModeAyahs();
                  // Scroll to the top of the page when moving to a new surah in reading mode
                  setTimeout(() => {
                      window.scrollTo({ top: 0, behavior: 'smooth' });
                      // Reset progress bar
                      if (isReadingMode) {
                          updateReadingProgress();
                      }
                  }, 100);
              }
          } else {
              // Single verse navigation
              if (currentAyah < surah.ayahs.length - 1) {
                  currentAyah++;
                  console.log('Moving to next ayah:', {
                      from: currentAyah - 1,
                      to: currentAyah,
                      ayahData: surah.ayahs[currentAyah]
                  });
                  displayAyah();
              } else if (currentSurah < quranData.length - 1) {
                  // Move to next surah
                  currentSurah++;
                  currentAyah = 0;
                  // Update surah menu button text
                  updateSurahDropdown();
                  console.log('Moving to next surah:', {
                      from: currentSurah - 1,
                      to: currentSurah,
                      firstAyah: quranData[currentSurah].ayahs[0]
                  });
                  displayAyah();
              }
          }
      }

      function prevAyah() {
          if (currentSurah === null || !quranData) {
              console.log('Cannot navigate: No surah selected or data not loaded');
              return;
          }

          const surah = quranData[currentSurah];
          
          // Debug log for navigation attempt
          console.log('Attempting previous ayah navigation:', {
              currentSurah,
              currentAyah,
              totalAyahs: surah.ayahs.length,
              prevAyahIndex: currentAyah - 1,
              isReadingMode,
              surahName: surah.name,
              currentAyahData: surah.ayahs[currentAyah],
              prevAyahData: surah.ayahs[currentAyah - 1]
          });

          if (isReadingMode) {
              // In reading mode, move to previous surah
              if (currentSurah > 0) {
                  currentSurah--;
                  currentAyah = 0;
                  // Update surah menu button text
                  updateSurahDropdown();
                  console.log('Moving to previous surah:', {
                      from: currentSurah + 1,
                      to: currentSurah,
                      lastAyah: quranData[currentSurah].ayahs[currentAyah]
                  });
                  loadReadingModeAyahs();
                  // Scroll to the top of the page when moving to a previous surah in reading mode
                  setTimeout(() => {
                      window.scrollTo({ top: 0, behavior: 'smooth' });
                      // Reset progress bar
                      if (isReadingMode) {
                          updateReadingProgress();
                      }
                  }, 100);
              }
          } else {
              // Single verse navigation
              if (currentAyah > 0) {
                  currentAyah--;
                  console.log('Moving to previous ayah:', {
                      from: currentAyah + 1,
                      to: currentAyah,
                      ayahData: surah.ayahs[currentAyah]
                  });
                  displayAyah();
              } else if (currentSurah > 0) {
                  // Move to previous surah
                  currentSurah--;
                  currentAyah = quranData[currentSurah].ayahs.length - 1;
                  // Update surah menu button text
                  updateSurahDropdown();
                  console.log('Moving to previous surah:', {
                      from: currentSurah + 1,
                      to: currentSurah,
                      lastAyah: quranData[currentSurah].ayahs[currentAyah]
                  });
                  displayAyah();
              }
          }
      }

      function loadReadingModeAyahs() {
          if (currentSurah === null || !quranData || !translationData) {
              console.log('Cannot load reading mode: No surah selected or data not loaded');
              return;
          }
          
          const surah = quranData[currentSurah];
          const translation = translationData[currentSurah];
          
          // Debug log for reading mode
          console.log('Loading reading mode:', {
              currentSurah,
              currentAyah,
              surahName: surah.name,
              totalAyahs: surah.ayahs.length,
              isReadingMode,
              firstAyah: surah.ayahs[0],
              secondAyah: surah.ayahs[1]
          });
          let ayahText = surah.ayahs[currentAyah].text;
          if (currentAyah === 0 && currentSurah !== 8) {
            ayahText = ayahText.replace('   ', '');
            ayahText = ayahText.replace('   ', '');
          }
            console.log("ayahText",ayahText)
          
          // Load all verses in the surah
          readingModeAyahs = [];
          for (let i = 0; i < surah.ayahs.length; i++) {
              if (surah.ayahs[i] && translation.ayahs[i]) {
                  readingModeAyahs.push({
                      arabic: surah.ayahs[i].text,
                      translation: translation.ayahs[i].text,
                      number: i + 1,
                      page: surah.ayahs[i].page, // Include page number from original data
                      juz: surah.ayahs[i].juz // Include Juz number from original data
                  });
              }
          }
          
          // Set currentAyah to 0 since we're showing the whole surah
          currentAyah = 0;
          
          // Debug log for batch loading
          console.log('Reading mode batch:', {
              totalAyahs: surah.ayahs.length,
              loadedAyahs: readingModeAyahs.map(ayah => ayah.number)
          });
          
          displayReadingModeAyahs();
      }

      // Update displayReadingModeAyahs to fetch tafsir per ayah and group by pages
      async function displayReadingModeAyahsByPages(shouldScrollToBookmark = false, scrollToVerseId = null, targetVerse = null) {
        const arabicText = document.getElementById('arabicText');
        const translationText = document.getElementById('translationText');
        const bookmarkText = languages[currentLang].bookmarkVerse;
        let html = '';
        
        // Group verses by page number
        const pageGroups = {};
        let startIdx = 0;
        const bismillahText = '   ';
        
        
        // Group verses by their page numbers
        for (let index = startIdx; index < readingModeAyahs.length; index++) {
          const ayah = readingModeAyahs[index];
          const pageNum = ayah.page || 1; // fallback to page 1 if no page info
          
          if (!pageGroups[pageNum]) {
            pageGroups[pageNum] = [];
          }
          pageGroups[pageNum].push({
            ayah: ayah,
            originalIndex: index,
            ayahIndex: currentAyah + index
          });
        }
        
        // Insert Bismillah at the top for all surahs except At-Tawbah (9)
        let bismillahHtml = '';
        if (currentSurah !== 8) {
          bismillahHtml = `
            <div class="text-center my-6 text-xl md:text-3xl quran-uthmani-font text-gray-700 dark:text-gray-200 select-none max-w-full md:max-w-2xl mx-auto" dir="rtl" style="font-family: 'Quran.com Font', Arial, sans-serif; letter-spacing: 0.05em; margin-bottom: 2rem;">${bismillahText}</div>
          `;
        }
        
        // Add mobile navigation for reading mode
        let mobileNavReadingHtml = `
            <div class="mobile-nav-buttons">
              <button onclick="prevAyah()" id="btnPrevAyahMobileReading" class="mobile-nav-btn" title="Previous Surah - ${languages[currentLang].previousSurah}">
                <i class="fas fa-chevron-${currentLang === 'ar' ? 'right' : 'left'}"></i> ${languages[currentLang].previousSurah}
              </button>
              <button onclick="nextAyah()" id="btnNextAyahMobileReading" class="mobile-nav-btn" title="Next Surah - ${languages[currentLang].nextSurah}">
                ${languages[currentLang].nextSurah} <i class="fas fa-chevron-${currentLang === 'ar' ? 'left' : 'right'}"></i>
              </button>
            </div>
          `;
        
        html += bismillahHtml;
        html += mobileNavReadingHtml;
        
        // Sort pages numerically and render each page group
        const sortedPages = Object.keys(pageGroups).sort((a, b) => parseInt(a) - parseInt(b));
        
        for (let i = 0; i < sortedPages.length; i++) {
          const pageNum = sortedPages[i];
          const pageVersesData = pageGroups[pageNum];
          
          // Page header with number and Juz
          const juzNum = pageVersesData[0].ayah.juz || 1; // Get Juz from first verse of the page
          html += `<div class="page-section mb-8">
            <div class="page-header text-center mb-6">
              <div class="inline-flex items-center justify-center gap-3">
                <span class="text-xs font-normal text-gray-500 dark:text-gray-400 px-3 py-1 rounded-md bg-gray-50 dark:bg-gray-800/50">${currentLang === 'ar' ? '' : 'Page'} ${currentLang === 'ar' ? toArabicNumerals(pageNum) : pageNum}</span>
                <span class="text-xs font-normal text-gray-500 dark:text-gray-400 px-3 py-1 rounded-md bg-gray-50 dark:bg-gray-800/50">${currentLang === 'ar' ? '' : 'Juz'} ${currentLang === 'ar' ? toArabicNumerals(juzNum) : juzNum}</span>
              </div>
            </div>`;
          
          // Verses for this page
          let pageAyahLine = `<div class="text-2xl leading-loose text-justify md:text-center w-full md:max-w-2xl mx-auto px-4 md:px-8 mb-6 text-right" dir="rtl" style="font-size: ${1.5 * currentTextSize}rem; line-height: 2.2; word-spacing: 0.1em; letter-spacing: 0.02em;">`;
          
          for (let j = 0; j < pageVersesData.length; j++) {
            const verseData = pageVersesData[j];
            let ayahText = verseData.ayah.arabic;
            // Remove Bismillah from first verse if needed
            if (verseData.originalIndex === 0 && currentSurah !== 8) {
              ayahText = ayahText.replace('   ', '');
              ayahText = ayahText.replace('   ', '');
              console.log("ayahText",ayahText)
            console.log("verseData",verseData.originalIndex)
            }
            
            const verseNumber = currentAyah + verseData.originalIndex + 1 - startIdx;
            pageAyahLine += ` <span class="ayah" data-surah="${currentSurah}" data-ayah="${verseData.ayahIndex}">${ayahText}</span> <span class="verse-marker" id="verse-${currentSurah}-${verseData.ayahIndex}" onclick="bookmarkAyah(${currentSurah}, ${verseData.ayahIndex})" title="${bookmarkText}"><span class="verse-icon"></span><span class="verse-number">${toArabicNumerals(verseNumber)}</span></span>`;
        }
          
          pageAyahLine += '</div>';
          html += pageAyahLine;

          // Close page section
          html += '</div>';
          
          // Add separator between pages (except for the last page)
          if (i < sortedPages.length - 1) {
            html += `<div class="page-separator my-8">
              <div class="flex items-center justify-center">
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent w-full max-w-md"></div>
                <div class="mx-4">
                  <div class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full"></div>
                </div>
                <div class="h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent w-full max-w-md"></div>
              </div>
            </div>`;
          }
        }

        if (isTafsirVisible) {
          html += '<div class="mt-6 space-y-4">';
          for (let index = 0; index < readingModeAyahs.length; index++) {
            html += `<div class="text-base text-gray-500 dark:text-gray-400 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg" style="font-size: ${1 * currentTextSize}rem;">
              <div class="font-semibold mb-2">${currentLang === 'ar' ? '' : 'Tafsir'} - ${languages[currentLang].verse} ${index + 1}</div>
              <span id="tafsir-loading-${index}">${currentLang === 'ar' ? ' ...' : 'Loading...'}</span>
            </div>`;
          }
          html += '</div>';
        }
        arabicText.innerHTML = html;
        translationText.innerHTML = '';
        const surah = quranData[currentSurah];

        
        // Update mobile reading mode button states
        const prevMobileReadingBtn = document.getElementById('btnPrevAyahMobileReading');
        const nextMobileReadingBtn = document.getElementById('btnNextAyahMobileReading');
        if (prevMobileReadingBtn) prevMobileReadingBtn.disabled = currentSurah === 0;
        if (nextMobileReadingBtn) nextMobileReadingBtn.disabled = currentSurah >= quranData.length - 1;
        const btn = document.getElementById('btnReadingMode');
        btn.title = `Displaying entire Surah ${surah.name} (${surah.englishName})`;
        // Event listeners for ayah elements are handled by the popover script
        updateAyahHighlights();
        
        // Remove any existing scroll listeners first
        if (window.currentScrollListener) {
          window.removeEventListener('scroll', window.currentScrollListener);
        }
        
        // Add throttled scroll listener for page/Juz detection and progress bar
        let scrollTimeout;
        window.currentScrollListener = () => {
          // Update progress bar immediately for smooth scrolling
          updateReadingProgress();
          
          // Throttle the page/Juz detection
          if (scrollTimeout) clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(detectCurrentPageAndJuz, 50);
        };
        
        window.addEventListener('scroll', window.currentScrollListener, { passive: true });
        
        // Initial detection and progress update
        setTimeout(() => {
            detectCurrentPageAndJuz();
            updateReadingProgress();
        }, 200);
        
        // Fetch tafsir for all ayahs if needed
        if (isTafsirVisible) {
          for (let index = 0; index < readingModeAyahs.length; index++) {
            getTafsirForAyah(currentSurah, currentAyah + index).then(tafsir => {
              const tafsirElem = document.getElementById(`tafsir-loading-${index}`);
              if (tafsirElem) tafsirElem.innerText = tafsir.text || (currentLang === 'ar' ? '   ' : 'Tafsir not available');
            });
          }
        }
        // Scroll logic
        if (shouldScrollToBookmark && currentBookmark && currentBookmark.surah === currentSurah) {
          const verseElem = document.getElementById(`verse-${currentSurah}-${currentBookmark.ayah}`);
          if (verseElem) {
            verseElem.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        } else if (scrollToVerseId) {
          const verseElem = document.getElementById(scrollToVerseId);
          if (verseElem) {
            verseElem.scrollIntoView({ behavior: 'auto', block: 'center' });
          }
        } else if (shouldScrollToBookmark && targetVerse) {
          // Scroll to target verse from search
          const verseElem = document.getElementById(`verse-${targetVerse.surahIndex}-${targetVerse.ayahIndex}`);
          if (verseElem) {
            verseElem.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }

      // In toggleReadingMode, call displayReadingModeAyahs(true) when entering reading mode, otherwise false
      function toggleReadingMode() {
          isReadingMode = !isReadingMode;
          const btn = document.getElementById('btnReadingMode');
          

          
          if (isReadingMode) {
              btn.innerHTML = '<i class="fas fa-times"></i>';
              btn.removeAttribute('data-tooltip');
              btn.classList.remove('show-tooltip');
              btn.setAttribute('title', 'Toggle Reading Mode -   ');
              
              // Check if we have a target verse from search
              let targetVerseForScroll = null;
              if (targetVerseFromSearch) {
                  // Set the current position to the target verse
                  currentSurah = targetVerseFromSearch.surahIndex;
                  currentAyah = targetVerseFromSearch.ayahIndex;
                  // Store the target verse for scrolling before clearing it
                  targetVerseForScroll = { ...targetVerseFromSearch };
                  // Clear the target verse after using it
                  targetVerseFromSearch = null;
              }
              
              loadReadingModeAyahs();
              displayReadingModeAyahsByPages(true, null, targetVerseForScroll); // Pass target verse for scrolling
              

          } else {
              btn.innerHTML = '<i class="fas fa-book-open"></i>';
              btn.removeAttribute('title');
              
              // Show auto-appearing tooltip for single verse mode
              const tooltipText = languages[currentLang].displayFullSurah;
              btn.setAttribute('data-tooltip', tooltipText);
              btn.classList.add('show-tooltip');
              
              // Auto-hide tooltip after 4 seconds
              setTimeout(() => {
                  if (btn.classList.contains('show-tooltip')) {
                      btn.classList.remove('show-tooltip');
                  }
              }, 4000);
              
              // Remove scroll listener when exiting reading mode
              if (window.currentScrollListener) {
                window.removeEventListener('scroll', window.currentScrollListener);
                window.currentScrollListener = null;
              }
              
              // Hide progress bar when exiting reading mode
              hideProgressBar();
              
              displayAyah();
          }
      }

      function bookmarkAyah(surah, ayah) {
        if ((surah === null || surah === undefined) || !quranData) return;      
          // Convert surah and ayah to numbers to ensure proper comparison
          surah = Number(surah);
          ayah = Number(ayah);
          
          // Ensure ayah is within valid range
          const surahData = quranData[surah];
          console.log("surahData", surahData);
          if (!surahData || ayah < 0 || ayah >= surahData.ayahs.length) {
              console.error('Invalid ayah number:', ayah);
              return;
          }
          
          const bookmark = {
              surah: surah,
              ayah: ayah,
              timestamp: new Date().toISOString()
          };
          
          // Check if this is the same bookmark as current
          if (currentBookmark && Number(currentBookmark.surah) === surah && Number(currentBookmark.ayah) === ayah) {
              // Remove bookmark
              currentBookmark = null;
              try {
                  localStorage.removeItem('quranBookmark');
                  sessionStorage.removeItem('quranBookmark');
              } catch (error) {
                  console.error('Error removing bookmark:', error);
              }
             
              showToast(currentLang === 'ar' ? '   ' : 'Bookmark removed', 'info');
          } else {
              // Set bookmark
              currentBookmark = bookmark;
              try {
                  localStorage.setItem('quranBookmark', JSON.stringify(bookmark));
                  // For iOS, also save to sessionStorage as backup
                  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                      sessionStorage.setItem('quranBookmark', JSON.stringify(bookmark));
                  }
              } catch (error) {
                  console.error('Error saving bookmark:', error);
                  // If localStorage fails, try sessionStorage
                  try {
                      sessionStorage.setItem('quranBookmark', JSON.stringify(bookmark));
                  } catch (sessionError) {
                      console.error('Error saving bookmark to sessionStorage:', sessionError);
                  }
              }
             
              showToast(currentLang === 'ar' ? '   ' : 'Bookmark added', 'success');
          }
          
          // Update display
          if (isReadingMode) {
              loadReadingModeAyahs();
              displayReadingModeAyahsByPages(); // Update to use page-based function
          } else {
              displayAyah();
          }
      }

      function toggleBookmark() {
          if (currentSurah === null) return;
          
          bookmarkAyah(currentSurah, currentAyah);
      }

      function goToBookmark() {
          let savedBookmark = null;
          
          // Try localStorage first
          try {
              const localStorageBookmark = localStorage.getItem('quranBookmark');
              if (localStorageBookmark) {
                  savedBookmark = JSON.parse(localStorageBookmark);
              }
          } catch (error) {
              console.error('Error reading from localStorage:', error);
          }
          
          // If no bookmark in localStorage, try sessionStorage
          if (!savedBookmark) {
              try {
                  const sessionStorageBookmark = sessionStorage.getItem('quranBookmark');
                  if (sessionStorageBookmark) {
                      savedBookmark = JSON.parse(sessionStorageBookmark);
                  }
              } catch (error) {
                  console.error('Error reading from sessionStorage:', error);
              }
          }
          
          if (savedBookmark) {
              try {
                  // Store the bookmark position before loading data
                  const bookmarkSurah = savedBookmark.surah;
                  const bookmarkAyah = savedBookmark.ayah;

                  // Set the current surah and ayah
                  currentSurah = bookmarkSurah;
                  currentAyah = bookmarkAyah;
                  
                  // Hide quick surahs section when going to bookmark
                  const quickSurahsSection = document.getElementById('quickSurahsSection');
                  if (quickSurahsSection) {
                      quickSurahsSection.style.display = 'none';
                  }
                  
                  // Update surah menu button text
                  updateSurahDropdown();
                  
                  // Ensure the surah data is loaded
                  if (!quranData || !translationData) {
                      loadQuranData().then(() => {
                          // Restore the bookmark position after data is loaded
                          currentSurah = bookmarkSurah;
                          currentAyah = bookmarkAyah;
                          
                          // After data is loaded, update the display
                          if (isReadingMode) {
                              loadReadingModeAyahs();
                              displayReadingModeAyahsByPages(true); // Scroll to bookmark
                          } else {
                              displayAyah();
                          }
                      });
                  } else {
                      // Data is already loaded, just update the display
                      if (isReadingMode) {
                          loadReadingModeAyahs();
                          displayReadingModeAyahsByPages(true); // Scroll to bookmark
                      } else {
                          displayAyah();
                      }
                  }
              } catch (error) {
                  console.error('Error going to bookmark:', error);
              }
          } else {
              showToast(currentLang === 'ar' ? '    ' : 'No bookmark saved', 'info');
          }
      }

      // Reading Progress Bar Functions
      function updateReadingProgress() {
          if (!isReadingMode || currentSurah === null) {
              hideProgressBar();
              return;
          }

          // Get the main content container
          const quranContent = document.getElementById('quranContent');
          if (!quranContent) return;

          // Calculate scroll progress
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
          
          if (scrollHeight <= 0) {
              hideProgressBar();
              return;
          }

          const progress = Math.min(100, Math.max(0, (scrollTop / scrollHeight) * 100));
          
          // Update progress bar
          const progressBar = document.getElementById('readingProgressBar');
          
          if (progressBar) {
              progressBar.style.width = progress + '%';
              
              // Show progress bar when scrolling
              showProgressBar();
              
              // Hide progress bar after scrolling stops
              clearTimeout(scrollTimeout);
              scrollTimeout = setTimeout(() => {
                  hideProgressBar();
              }, 2000);
          }
      }

      function showProgressBar() {
          const progressContainer = document.getElementById('readingProgressContainer');
          
          if (progressContainer) {
              progressContainer.classList.add('visible');
              progressBarVisible = true;
          }
      }

      function hideProgressBar() {
          const progressContainer = document.getElementById('readingProgressContainer');
          
          if (progressContainer) {
              progressContainer.classList.remove('visible');
              progressBarVisible = false;
          }
      }

      function initializeProgressBar() {
          // Remove any existing scroll listeners
          if (window.currentScrollListener) {
              window.removeEventListener('scroll', window.currentScrollListener);
          }
          
          // Create new scroll listener
          window.currentScrollListener = function() {
              updateReadingProgress();
          };
          
          // Add scroll listener
          window.addEventListener('scroll', window.currentScrollListener, { passive: true });
          
          // Initial progress update
          updateReadingProgress();
      }

      function handleNotificationToggleClick(e) {
        const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
        const isInStandaloneMode = window.navigator.standalone === true;

        if (!e.target.checked) {
          notificationEnabled = false;
          return;
        }

        if (isIOS && !isInStandaloneMode) {
          showTutorial();

         


          e.preventDefault();
          e.target.checked = false;
          return;
        }

        showTutorial();

        requestNotificationPermission().then((success) => {
          if (!success) {
            e.target.checked = false;
          }
        });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Load saved language preference first
            loadLanguagePreference();
            
            tafsirLang = currentLang;
            console.log("tafsirLang", tafsirLang)

            const adhkarView = document.getElementById('adhkarView');
            const adhkarArabicText = document.getElementById('adhkarArabicText');
            if (adhkarView) {
                adhkarView.addEventListener('touchstart', handleTouchStart, false);
                adhkarView.addEventListener('touchend', handleTouchEnd, false);
            }
            if (adhkarArabicText) {
                adhkarArabicText.addEventListener('click', handleDhikrClick);
            }

            setupTabs();
            
            // Initialize daily reminder with today's hadith
            updateDailyReminder();
            
            // Update UI with loaded language
            updateUI();
            
            // Update Hijri date
            updateHijriDate();
            
            // Initialize Tasbih
            loadTasbihState();
            console.log('After updateUI - currentLang:', currentLang);
            


            // Try to load saved prayer times first
            if (!loadPrayerTimes()) {
                // If no saved times or they're from a different day, fetch new times
                await detectCityAndFetchTimes();
            }

            // Load notification state
            loadNotificationState();

            // Add notification toggle handler
            const notificationToggle = document.getElementById('notificationToggle');
            
          if (notificationToggle) {
          notificationToggle.addEventListener('click', handleNotificationToggleClick);
                
                // Setup notifications if they were previously enabled
                if (notificationEnabled && Object.keys(prayerNotifications).length > 0) {
                    console.log('Restoring notification setup');
                    setupBasicNotifications();
                }
                        }


            // Add periodic checks
            setupPeriodicChecks();

            // Load Quran data
            await loadQuranData();
            
            // Initialize font settings
            initializeFontSettings();
            
            // Update settings language
            updateSettingsLanguage();
            
            // Add translation toggle handler
            
            // Add bookmark toggle handler
            
            // Load saved bookmark
            const savedBookmark = localStorage.getItem('quranBookmark');
            if (savedBookmark) {
                try {
                    currentBookmark = JSON.parse(savedBookmark);
                   
                } catch (error) {
                    console.error('Error loading bookmark:', error);
                    localStorage.removeItem('quranBookmark');
                    currentBookmark = null;
                }
            }

         

          
        });

        // Add this function to show toast notifications
        function showToast(message, type = 'info') {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Set icon based on type
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide and remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // iOS-specific detection and handling
        function isIOSStandalone() {
            return window.navigator.standalone === true;
        }

        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }

        function showIOSInstallPrompt() {
            if (isIOS() && !isIOSStandalone()) {
                const modal = document.getElementById('iosInstallModal') || createIOSInstallModal();
                // Force a reflow to ensure the modal is visible
                modal.offsetHeight;
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
                
                // Add a small delay for Safari
                setTimeout(() => {
                    modal.style.opacity = '1';
                }, 50);
            }
        }

        function createIOSInstallModal() {
            const modal = document.createElement('div');
            modal.id = 'iosInstallModal';
            modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50';
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s ease';
            modal.innerHTML = `
    <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-xl rounded-2xl p-8 w-[90%] max-w-lg relative shadow-2xl border border-white/20 dark:border-gray-700/50">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-home text-2xl text-white"></i>
                </div>
                    <h3 class="text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">${languages[currentLang].tutorialTitle}</h3>
                </div>
                <ol class="list-decimal list-inside space-y-4 text-gray-700 dark:text-gray-300 text-left">
                    <li>${languages[currentLang].tutorialIOS.steps[0]}</li>
                    <li>${languages[currentLang].tutorialIOS.steps[1]}</li>
                    <li>${languages[currentLang].tutorialIOS.steps[2]}</li>
                </ol>
                <div class="mt-8 flex justify-center">
                    <button onclick="closeIOSInstallModal()" 
                            class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-8 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                        ${languages[currentLang].gotIt}
                    </button>
                </div>
            </div>
        `;
            document.body.appendChild(modal);
            return modal;
        }

        function closeIOSInstallModal() {
            const modal = document.getElementById('iosInstallModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        // Add this to your document.addEventListener('DOMContentLoaded', ...) section
        document.addEventListener('DOMContentLoaded', async () => {
            // ... existing code ...

            // Add translation select handler
            // Translation selector will be handled in modal initialization

            // ... rest of your existing code ...
        });

        // Add these variables at the top with other variables
        let currentTextSize = 1; // Base size multiplier
        const TEXT_SIZE_STEP = 0.2; // Size change step
        const MIN_TEXT_SIZE = 0.8; // Minimum size multiplier
        const MAX_TEXT_SIZE = 2.0; // Maximum size multiplier

        // Add these functions for text size control
        function increaseTextSize() {
            if (currentTextSize < MAX_TEXT_SIZE) {
                currentTextSize += TEXT_SIZE_STEP;
                updateTextSize();
                saveTextSizePreference();
                updateFontSizeDisplay();
                updateSliderValue();
                // Refresh current display
                if (currentSurah !== null) {
                    if (isReadingMode) {
                        displayReadingModeAyahs();
                    } else {
                        displayAyah();
                    }
                }
            }
        }

        function decreaseTextSize() {
            if (currentTextSize > MIN_TEXT_SIZE) {
                currentTextSize -= TEXT_SIZE_STEP;
                updateTextSize();
                saveTextSizePreference();
                updateFontSizeDisplay();
                updateSliderValue();
                // Refresh current display
                if (currentSurah !== null) {
                    if (isReadingMode) {
                        displayReadingModeAyahs();
                    } else {
                        displayAyah();
                    }
                }
            }
        }

        function updateSliderValue() {
            const slider = document.getElementById('fontSizeSlider');
            if (slider) {
                slider.value = currentTextSize;
            }
        }

        function resetTextSize() {
            currentTextSize = 1;
            updateTextSize();
            saveTextSizePreference();
            updateFontSizeDisplay();
            updateSliderValue();
            // Refresh current display
            if (currentSurah !== null) {
                if (isReadingMode) {
                    displayReadingModeAyahs();
                } else {
                    displayAyah();
                }
            }
        }

        // Quran Settings Menu Functions
        function toggleQuranSettings() {
            const menu = document.getElementById('quranSettingsMenu');
            const isHidden = menu.classList.contains('hidden');
            
            if (isHidden) {
                // Show menu
                menu.classList.remove('hidden');
                setTimeout(() => {
                    menu.classList.remove('translate-x-full');
                }, 10);
                
                // Add overlay
                const overlay = document.createElement('div');
                overlay.className = 'settings-overlay';
                overlay.onclick = toggleQuranSettings;
                document.body.appendChild(overlay);
                
                // Update displays
                updateFontSizeDisplay();
                updateFontSizeSlider();
                updateSettingsLanguage();
            } else {
                // Hide menu
                menu.classList.add('translate-x-full');
                setTimeout(() => {
                    menu.classList.add('hidden');
                }, 300);
                
                // Remove overlay
                const overlay = document.querySelector('.settings-overlay');
                if (overlay) overlay.remove();
            }
        }

        function updateFontSizeDisplay() {
            const display = document.getElementById('currentFontSize');
            if (display) {
                display.textContent = (1.5 * currentTextSize).toFixed(1) + 'rem';
            }
        }

        function updateFontSizeSlider() {
            const slider = document.getElementById('fontSizeSlider');
            if (slider) {
                slider.value = currentTextSize;
                slider.oninput = function() {
                    currentTextSize = parseFloat(this.value);
                    updateTextSize();
                    updateFontSizeDisplay();
                    saveTextSizePreference();
                    // Refresh current display
                    if (currentSurah !== null) {
                        if (isReadingMode) {
                            displayReadingModeAyahs();
                        } else {
                            displayAyah();
                        }
                    }
                };
            }
        }

        function changeFontFamily(fontClass) {
            const arabicText = document.getElementById('arabicText');
            if (arabicText) {
                // Remove all font classes
                arabicText.classList.remove('font-quran-original', 'font-utman-taha', 'font-al-mushaf', 'font-system-arabic');
                // Add selected font class
                arabicText.classList.add(fontClass);
                
                // Save preference
                localStorage.setItem('quranFontFamily', fontClass);
            }
        }

        // Initialize font family radio buttons
        function initializeFontSettings() {
            const fontRadios = document.querySelectorAll('input[name="fontFamily"]');
            const savedFont = localStorage.getItem('quranFontFamily') || 'font-quran-original';
            
            fontRadios.forEach(radio => {
                let expectedValue;
                switch(savedFont) {
                    case 'font-utman-taha':
                        expectedValue = 'utman-taha';
                        break;
                    case 'font-al-mushaf':
                        expectedValue = 'al-mushaf';
                        break;
                    case 'font-system-arabic':
                        expectedValue = 'system-arabic';
                        break;
                    default:
                        expectedValue = 'quran-font';
                }
                
                if (radio.value === expectedValue) {
                    radio.checked = true;
                }
                
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        let fontClass;
                        switch(this.value) {
                            case 'quran-font':
                                fontClass = 'font-quran-original';
                                break;
                            case 'utman-taha':
                                fontClass = 'font-utman-taha';
                                break;
                            case 'al-mushaf':
                                fontClass = 'font-al-mushaf';
                                break;
                            case 'system-arabic':
                                fontClass = 'font-system-arabic';
                                break;
                            default:
                                fontClass = 'font-quran-original';
                        }
                        changeFontFamily(fontClass);
                    }
                });
            });
            
            // Apply saved font
            changeFontFamily(savedFont);
            
            // Initialize other settings
            initializeAudioSettings();
        }



        // Audio Settings Functions
        let currentReciter = 'ar.alafasy';
        let currentPlaybackSpeed = 1;
        let isContinuousPlayEnabled = false;


        function initializeAudioSettings() {
            // Initialize reciter
            const savedReciter = localStorage.getItem('quranReciter') || 'ar.alafasy';
            currentReciter = savedReciter;
            const reciterSelect = document.getElementById('reciterSelect');
            if (reciterSelect) {
                reciterSelect.value = savedReciter;
                reciterSelect.addEventListener('change', function() {
                    currentReciter = this.value;
                    localStorage.setItem('quranReciter', this.value);
                    
                    // Show feedback about reciter change
                    const reciterNames = {
                        'ar.alafasy': currentLang === 'ar' ? ' ' : 'Mishary Al-Afasy',
                        'ar.husary': currentLang === 'ar' ? '  ' : 'Mahmoud Khalil Al-Husary',
                        'ar.minshawi': currentLang === 'ar' ? '  ' : 'Mohamed Siddiq Al-Minshawi',
                        'ar.sudais': currentLang === 'ar' ? '  ' : 'Abdul Rahman As-Sudais',
                        'ar.shuraim': currentLang === 'ar' ? ' ' : 'Saud Ash-Shuraim'
                    };
                    
                    const message = currentLang === 'ar' ? 
                        `  : ${reciterNames[this.value]}` : 
                        `Reciter selected: ${reciterNames[this.value]}`;
                    
                    showToast(message, 'success');
                });
            }

            // Initialize playback speed
            const savedSpeed = localStorage.getItem('quranPlaybackSpeed') || '1';
            currentPlaybackSpeed = parseFloat(savedSpeed);
            const speedSelect = document.getElementById('playbackSpeedSelect');
            if (speedSelect) {
                speedSelect.value = savedSpeed;
                speedSelect.addEventListener('change', function() {
                    currentPlaybackSpeed = parseFloat(this.value);
                    localStorage.setItem('quranPlaybackSpeed', this.value);
                    
                    // Show feedback about speed change
                    const message = currentLang === 'ar' ? 
                        `    : ${this.value}x` : 
                        `Playback speed changed to: ${this.value}x`;
                    
                    showToast(message, 'success');
                });
            }

            // Initialize continuous play toggle
            const savedContinuousPlay = localStorage.getItem('quranContinuousPlay') === 'true';
            isContinuousPlayEnabled = savedContinuousPlay;
            const continuousToggle = document.getElementById('continuousPlayToggle');
            if (continuousToggle) {
                continuousToggle.checked = savedContinuousPlay;
                continuousToggle.addEventListener('change', function() {
                    isContinuousPlayEnabled = this.checked;
                    localStorage.setItem('quranContinuousPlay', this.checked);
                    console.log('Continuous play setting changed:', this.checked);
                    
                    // Show feedback about setting change
                    const message = currentLang === 'ar' ? 
                        (this.checked ? '   ' : '   ') : 
                        (this.checked ? 'Continuous play enabled' : 'Continuous play disabled');
                    
                    showToast(message, 'success');
                });
            }


        }

        // Update settings menu language
        function updateSettingsLanguage() {
            const settingsTexts = {
                ar: {
                    title: ' ',
                    fontSizeTitle: ' ',
                    currentSizeLabel: '  ',
                    resetSizeText: '  ',
                    fontFamilyTitle: ' ',
                    font1Name: '  ',
                    font2Name: '  ',
                    font3Name: ' ',
                    font4Name: '  ',
                    font4Desc: 'Arial, Tahoma',
                                  audioTitle: ' ',
              reciterLabel: '',
              playbackSpeedLabel: ' ',
              continuousPlayLabel: '    ',
              continuousPlayDesc: '       ',

                    speed1: ' (0.5x)',
                    speed2: ' (0.75x)',
                    speed3: ' (1x)',
                    speed4: ' (1.25x)',
                    speed5: ' (1.5x)',
                    settingsBtn: ' ',
                    decreaseBtn: ' ',
                    increaseBtn: ' '
                },
                en: {
                    title: 'Quran Settings',
                    fontSizeTitle: 'Font Size',
                    currentSizeLabel: 'Current Font Size',
                    resetSizeText: 'Reset Size',
                    fontFamilyTitle: 'Font Family',
                    font1Name: 'Original Quran Font',
                    font2Name: 'Utman Taha Font',
                    font3Name: 'Al Mushaf Font',
                    font4Name: 'System Arabic Font',
                    font4Desc: 'Arial, Tahoma',
                                  audioTitle: 'Audio Settings',
              reciterLabel: 'Reciter',
              playbackSpeedLabel: 'Playback Speed',
              continuousPlayLabel: 'Continuous Play Until End of Surah',
              continuousPlayDesc: 'When playing, continues until the last verse of the surah',

                    speed1: 'Slow (0.5x)',
                    speed2: 'Slower (0.75x)',
                    speed3: 'Normal (1x)',
                    speed4: 'Faster (1.25x)',
                    speed5: 'Fast (1.5x)',
                    settingsBtn: 'Quran Settings',
                    decreaseBtn: 'Decrease Font Size',
                    increaseBtn: 'Increase Font Size'
                }
            };

            const texts = settingsTexts[currentLang] || settingsTexts.ar;

            // Update all text elements
            const elements = [
                { id: 'settingsTitle', text: texts.title },
                { id: 'fontSizeTitle', text: texts.fontSizeTitle },
                { id: 'currentSizeLabel', text: texts.currentSizeLabel },
                { id: 'resetSizeText', text: texts.resetSizeText },
                { id: 'fontFamilyTitle', text: texts.fontFamilyTitle },
                { id: 'font1Name', text: texts.font1Name },
                { id: 'font2Name', text: texts.font2Name },
                { id: 'font3Name', text: texts.font3Name },
                { id: 'font4Name', text: texts.font4Name },
                { id: 'font4Desc', text: texts.font4Desc },
                            { id: 'audioTitle', text: texts.audioTitle },
            { id: 'reciterLabel', text: texts.reciterLabel },
            { id: 'playbackSpeedLabel', text: texts.playbackSpeedLabel },
            { id: 'continuousPlayLabel', text: texts.continuousPlayLabel },
            { id: 'continuousPlayDesc', text: texts.continuousPlayDesc },

                { id: 'speed1', text: texts.speed1 },
                { id: 'speed2', text: texts.speed2 },
                { id: 'speed3', text: texts.speed3 },
                { id: 'speed4', text: texts.speed4 },
                { id: 'speed5', text: texts.speed5 }
            ];

            elements.forEach(({ id, text }) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                }
            });

            // Update button titles
            const settingsBtn = document.getElementById('settingsBtn');
            const decreaseBtn = document.getElementById('decreaseBtn');
            const increaseBtn = document.getElementById('increaseBtn');

            if (settingsBtn) settingsBtn.title = texts.settingsBtn;
            if (decreaseBtn) decreaseBtn.title = texts.decreaseBtn;
            if (increaseBtn) increaseBtn.title = texts.increaseBtn;
        }

        // Function to update reciter dropdown options based on current language
        function updateReciterOptions() {
            const reciterSelect = document.getElementById('reciterSelect');
            if (!reciterSelect) return;

            // Store the current selection
            const currentSelection = reciterSelect.value;
            
            // Reciter names for both languages
            const reciterOptions = {
                'ar.alafasy': {
                    ar: ' ',
                    en: 'Mishary Al-Afasy'
                },
                'ar.husary': {
                    ar: '  ',
                    en: 'Mahmoud Khalil Al-Husary'
                },
                'ar.minshawi': {
                    ar: '  ',
                    en: 'Mohamed Siddiq Al-Minshawi'
                },
                'ar.sudais': {
                    ar: '  ',
                    en: 'Abdul Rahman As-Sudais'
                },
                'ar.shuraim': {
                    ar: ' ',
                    en: 'Saud Ash-Shuraim'
                }
            };

            // Clear current options
            reciterSelect.innerHTML = '';

            // Add options with appropriate language
            Object.keys(reciterOptions).forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = reciterOptions[value][currentLang];
                reciterSelect.appendChild(option);
            });

            // Restore the previous selection
            if (currentSelection) {
                reciterSelect.value = currentSelection;
            }
        }

        function updateTextSize() {
            const arabicText = document.getElementById('arabicText');
            const translationText = document.getElementById('translationText');
            
            if (arabicText) {
                arabicText.style.fontSize = `${1.5 * currentTextSize}rem`; // Base size is 1.5rem
            }
            if (translationText) {
                translationText.style.fontSize = `${1.125 * currentTextSize}rem`; // Base size is 1.125rem
            }
        }

        function saveTextSizePreference() {
            try {
                localStorage.setItem('quranTextSize', currentTextSize.toString());
            } catch (error) {
                console.error('Error saving text size preference:', error);
            }
        }

        function loadTextSizePreference() {
            try {
                const savedSize = localStorage.getItem('quranTextSize');
                if (savedSize) {
                    currentTextSize = parseFloat(savedSize);
                    updateTextSize();
                }
            } catch (error) {
                console.error('Error loading text size preference:', error);
            }
        }

        // Add this to your document.addEventListener('DOMContentLoaded', ...) section
        document.addEventListener('DOMContentLoaded', async () => {
            // ... existing code ...
            
            // Load saved text size preference
            loadTextSizePreference();
            
            // ... rest of your existing code ...
        });

        // Add this function to load Tafsir data
        async function loadTafsirData() {
            try {
                // Initialize tafsirData as an object to store surah data
                tafsirData = {};
                console.log('Tafsir data initialized');
            } catch (error) {
                console.error('Error initializing Tafsir data:', error);
                showToast(currentLang === 'ar' ? '    ' : 'Error loading Tafsir', 'error');
            }
        }

        // Add toggle Tafsir function
        function toggleTafsir() {
            isTafsirVisible = !isTafsirVisible;
            
            if (isTafsirVisible) {
                if (currentSurah !== null) {
                    loadTafsirForSurah(currentSurah + 1).then(() => {
                        // Preserve scroll position in reading mode
                        if (isReadingMode) {
                            const centeredId = getCenteredVerseId();
                            displayReadingModeAyahs(false, centeredId);
                        } else {
                            displayAyah();
                        }
                    });
                }
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-book"></i>';
                // Preserve scroll position in reading mode
                if (isReadingMode) {
                    const centeredId = getCenteredVerseId();
                    displayReadingModeAyahs(false, centeredId);
                } else {
                    displayAyah();
                }
            }
        }

        // Update the document.addEventListener('DOMContentLoaded', ...) section
        document.addEventListener('DOMContentLoaded', async () => {
            // ... existing code ...
            
            // Add Tafsir toggle handler
            
            // Load Tafsir data
            await loadTafsirData();
            
            // ... rest of your existing code ...
        });

        // Add a function to load Tafsir for a specific surah
        async function loadTafsirForSurah(surahNumber) {
            try {
                const langCode = tafsirLang === 'ar' ? 'ar-tafsir-muyassar' : 'en-al-jalalayn';
                const response = await fetch(`https://cdn.jsdelivr.net/gh/spa5k/tafsir_api@main/tafsir/${langCode}/${surahNumber}.json`);
                console.log(response);
                if (!response.ok) throw new Error('Failed to fetch Tafsir data');
                const data = await response.json();
                tafsirData[surahNumber - 1] = data; // Store with 0-based index
                console.log(`Tafsir data loaded successfully for Surah ${surahNumber} (${tafsirLang})`);
                console.log('Tafsir data:', tafsirData[surahNumber - 1]);
                console.log('Tafsir ayah keys:', Object.keys(tafsirData[surahNumber - 1].ayahs));
            } catch (error) {
                console.error('Error loading Tafsir data:', error);
                showToast(currentLang === 'ar' ? '    ' : 'Error loading Tafsir', 'error');
            }
        }

        // Surah Side Menu Functionality
        let surahsData = []; // Store surah data for search
        
        // Minimal surah names for immediate display (most commonly accessed)
        const quickSurahList = [
            {index: 0, number: 1, name: '', englishName: 'Al-Fatihah', revelationType: 'Meccan', numberOfAyahs: 7},
            {index: 1, number: 2, name: '', englishName: 'Al-Baqarah', revelationType: 'Medinan', numberOfAyahs: 286},
            {index: 17, number: 18, name: '', englishName: 'Al-Kahf', revelationType: 'Meccan', numberOfAyahs: 110},
            {index: 35, number: 36, name: '', englishName: 'Ya-Sin', revelationType: 'Meccan', numberOfAyahs: 83},
            {index: 54, number: 55, name: '', englishName: 'Ar-Rahman', revelationType: 'Medinan', numberOfAyahs: 78},
            {index: 66, number: 67, name: '', englishName: 'Al-Mulk', revelationType: 'Meccan', numberOfAyahs: 30},
            {index: 109, number: 110, name: '', englishName: 'An-Nasr', revelationType: 'Medinan', numberOfAyahs: 3},
            {index: 111, number: 112, name: '', englishName: 'Al-Ikhlas', revelationType: 'Meccan', numberOfAyahs: 4},
            {index: 112, number: 113, name: '', englishName: 'Al-Falaq', revelationType: 'Meccan', numberOfAyahs: 5},
            {index: 113, number: 114, name: '', englishName: 'An-Nas', revelationType: 'Meccan', numberOfAyahs: 6}
        ];
        
        function initializeSurahMenu() {
            if (!quranData) return;
            
            surahsData = quranData.map((surah, index) => ({
                index: index,
                number: surah.number,
                name: surah.name,
                englishName: surah.englishName,
                revelationType: surah.revelationType,
                numberOfAyahs: surah.numberOfAyahs
            }));
            
            // Check if there's an active search and re-run it with full data
            const searchInput = document.getElementById('surahSearchInput');
            if (searchInput && searchInput.value.trim()) {
                searchSurahs(searchInput.value);
            } else {
                populateSurahList(surahsData);
            }
        }
        
        // Cache DOM elements for better performance
        let surahListCache = null;
        
        function populateSurahList(surahs) {
            const surahList = document.getElementById('surahList');
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Clear existing content
            surahList.innerHTML = '';
            
            // Batch DOM operations
            surahs.forEach(surah => {
                const surahItem = document.createElement('div');
                surahItem.className = 'surah-item p-4 bg-gradient-to-r from-white/70 to-gray-50/70 dark:from-gray-700/70 dark:to-gray-800/70 backdrop-blur-sm rounded-xl hover:from-white/90 hover:to-gray-50/90 dark:hover:from-gray-600/80 dark:hover:to-gray-700/80 cursor-pointer transition-all duration-300 border border-white/30 dark:border-gray-600/50 shadow-md hover:shadow-lg transform hover:scale-[1.02] hover:-translate-y-0.5';
                
                // Use template literals more efficiently
                const number = currentLang === 'ar' ? toArabicNumerals(surah.number) : surah.number;
                const englishName = surah.englishName || surahNamesEnglish[surah.index] || `Surah ${surah.number}`;
                const primaryName = currentLang === 'ar' ? surah.name : englishName;
                const secondaryName = currentLang === 'ar' ? englishName : surah.name;
                // Debug: Check what properties are available
                console.log(`Surah ${surah.number} properties:`, Object.keys(surah));
                console.log(`numberOfAyahs:`, surah.numberOfAyahs);
                console.log(`ayahs length:`, surah.ayahs ? surah.ayahs.length : 'no ayahs array');
                
                // Try multiple ways to get the verse count
                let numberOfAyahs = 0;
                if (surah.numberOfAyahs) {
                    numberOfAyahs = surah.numberOfAyahs;
                } else if (surah.ayahs && Array.isArray(surah.ayahs)) {
                    numberOfAyahs = surah.ayahs.length;
                } else if (surah.verses) {
                    numberOfAyahs = surah.verses;
                } else {
                    // Fallback: Use the known verse counts for each surah
                    const surahVerseCounts = [7,286,200,176,120,165,206,75,129,109,123,111,43,52,99,128,111,110,98,135,112,78,118,64,77,227,93,88,69,60,34,30,73,54,45,83,182,88,75,85,54,53,89,59,37,35,38,29,18,45,60,49,62,55,78,96,29,22,24,13,14,11,11,18,12,12,30,52,52,44,28,28,20,56,40,31,50,40,46,42,29,19,36,25,22,17,19,26,30,20,15,21,11,8,8,19,5,8,8,11,11,8,3,9,5,4,7,3,6,3,5,4,5,6];
                    numberOfAyahs = surahVerseCounts[surah.number - 1] || 0;
                }
                
                console.log(`Final numberOfAyahs for surah ${surah.number}:`, numberOfAyahs);
                const ayahCount = currentLang === 'ar' ? toArabicNumerals(numberOfAyahs) : numberOfAyahs;
                const ayahText = currentLang === 'ar' ? '' : 'verses';
                const revelationType = currentLang === 'ar' ? (surah.revelationType === 'Meccan' ? '' : '') : surah.revelationType;
                
                // Color scheme - all sky blue for consistent appearance
                const colorSchemes = [
                    'from-sky-400 to-sky-600',
                    'from-sky-400 to-sky-600', 
                    'from-sky-400 to-sky-600',
                    'from-sky-400 to-sky-600',
                    'from-sky-400 to-sky-600'
                ];
                const colorScheme = colorSchemes[surah.number % colorSchemes.length];
                
                surahItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-r ${colorScheme} rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                                    ${number}
                                </div>
                                <div class="flex-1">
                                    <div class="font-bold text-gray-800 dark:text-gray-200 text-lg mb-1">
                                        ${primaryName}
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2">
                                        <span>${secondaryName}</span>
                                        <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                        <span class="flex items-center gap-1">
                                            <i class="fas fa-bookmark text-xs"></i>
                                            ${ayahCount} ${ayahText}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs px-3 py-1.5 rounded-full bg-gradient-to-r ${revelationType === 'Meccan' || revelationType === '' ? 'from-amber-100 to-yellow-100 dark:from-amber-900/30 dark:to-yellow-900/30 text-amber-700 dark:text-amber-400' : 'from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 text-green-700 dark:text-green-400'} font-medium shadow-sm">
                            ${revelationType}
                        </div>
                    </div>
                `;
                
                // Use event delegation for better performance
                surahItem.dataset.surahIndex = surah.index;
                fragment.appendChild(surahItem);
            });
            
            // Single DOM append operation
            surahList.appendChild(fragment);
        }
        
        function selectSurah(surahIndex) {
            currentSurah = surahIndex;
                currentAyah = 0;
                isReadingMode = false;
                document.getElementById('btnReadingMode').innerHTML = '<i class="fas fa-book-open"></i>';
                
                // Clear target verse from search when manually selecting a surah
                targetVerseFromSearch = null;
            
            // Update button text
            const surah = quranData[surahIndex];
            const surahName = currentLang === 'ar' ? surah.name : surahNamesEnglish[surahIndex];
            document.getElementById('selectedSurahText').textContent = `${surah.number}. ${surahName}`;
            
            // Close side menu
            closeSurahMenu();
            
            // Hide quick surahs section when a surah is selected
            const quickSurahsSection = document.getElementById('quickSurahsSection');
            if (quickSurahsSection) {
                quickSurahsSection.style.display = 'none';
            }
            
            // Reset zoom on mobile devices
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                setTimeout(() => {
                    const viewport = document.querySelector('meta[name=viewport]');
                    if (viewport) {
                        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
                        // Force a brief re-render to apply zoom reset
                        document.body.style.zoom = '1.0001';
                        setTimeout(() => {
                            document.body.style.zoom = '1';
                        }, 10);
                    }
                }, 100);
            }
                
                // Load Tafsir for the selected surah
                if (isTafsirVisible) {
                loadTafsirForSurah(currentSurah + 1); // +1 because surah numbers start from 1
                }
                
                displayAyah();
        }

        // Function to load quick surah (from quick access buttons)
        function loadQuickSurah(surahNumber) {
            // Clear target verse from search when using quick surah access
            targetVerseFromSearch = null;
            
            // Ensure data is loaded
            if (!quranData) {
                // Show loading state
                const arabicText = document.getElementById('arabicText');
                arabicText.innerHTML = '<div class="text-gray-500 dark:text-gray-400 py-8"><i class="fas fa-spinner fa-spin text-2xl mb-4"></i><p> ...</p></div>';
                
                // Wait for data to load
                const checkData = setInterval(() => {
                    if (quranData) {
                        clearInterval(checkData);
                        selectSurah(surahNumber - 1); // Convert to 0-based index
                    }
                }, 100);
                return;
            }
            
            // Data is available, proceed with selection
            selectSurah(surahNumber - 1); // Convert to 0-based index
        }
        
        function openSurahMenu() {
            const sideMenu = document.getElementById('surahSideMenu');
            const overlay = document.getElementById('surahMenuOverlay');
            
            // Show menu immediately for better UX
            sideMenu.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
            
            // Initialize menu if not done yet
            if (surahsData.length === 0) {
                const surahList = document.getElementById('surahList');
                
                if (!quranData) {
                    // Show quick access list for immediate use
                    surahList.innerHTML = `
                        <div class="p-4 text-center border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-center gap-2 mb-2">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
                                <p class="text-gray-600 dark:text-gray-400 text-sm">
                                    ${currentLang === 'ar' ? ' ...' : 'Loading...'}
                                </p>
                            </div>
                            <p class="text-gray-500 dark:text-gray-500 text-xs">
                                ${currentLang === 'ar' ? '   ' : 'Popular surahs available below'}
                            </p>
                        </div>
                    `;
                    
                    // Show popular surahs immediately
                    populateSurahList(quickSurahList);
                    
                    // Wait for full data to load, then show complete list
                    const checkDataInterval = setInterval(() => {
                        if (quranData) {
                            clearInterval(checkDataInterval);
                            initializeSurahMenu();
                        }
                    }, 100);
            } else {
                    // Data exists but menu not initialized
                    surahList.innerHTML = '<div class="p-4 text-center text-gray-500"> ...</div>';
                    setTimeout(() => {
                        initializeSurahMenu();
                    }, 10);
                }
            }
            

        }
        
        function closeSurahMenu() {
            const sideMenu = document.getElementById('surahSideMenu');
            const overlay = document.getElementById('surahMenuOverlay');
            
            sideMenu.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
            
            // Clear search
            document.getElementById('surahSearchInput').value = '';
            if (surahsData.length > 0) {
                populateSurahList(surahsData);
            }
        }
        
        // Function to remove Arabic diacritics and normalize Alef variants for better search
        function normalizeArabicText(text) {
            return text
                // Remove all Arabic diacritics and marks (comprehensive range)
                .replace(/[\u064B-\u0652\u0670\u0640\u06D6-\u06ED\u08F0-\u08FF]/g, '')
                // Remove Arabic-Indic digits and other marks
                .replace(/[\u06F0-\u06F9]/g, '')
                // Normalize Alef variants:     -> 
                .replace(/[]/g, '')
                // Normalize Teh Marbuta:  -> 
                .replace(//g, '')
                // Remove "" prefix if present
                .replace(/^\s*/g, '')
                .replace(/^\s*/g, '')
                // Remove extra spaces and normalize whitespace
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Function to create search variants for better Arabic matching
        function getSearchVariants(text) {
            const variants = new Set();
            const normalized = normalizeArabicText(text);
            
            // Add original text
            variants.add(text);
            variants.add(normalized);
            
            // Add version without definite article ()
            if (text.startsWith('')) {
                variants.add(text.substring(2));
                variants.add(normalizeArabicText(text.substring(2)));
            }
            
            // Add version with definite article if it doesn't have it
            if (!text.startsWith('') && text.length > 0) {
                variants.add('' + text);
                variants.add('' + normalized);
            }
            
            return Array.from(variants);
        }
        
        // Enhanced fuzzy search for surahs
        function searchSurahs(query) {
            if (!query.trim()) {
                // If no query, show full list if available, otherwise show quick list
                if (surahsData.length > 0) {
                    populateSurahList(surahsData);
                } else {
                    populateSurahList(quickSurahList);
                }
                return;
            }
            
            const searchTerm = query.trim();
            
            // Use full data if available, otherwise search in quick list
            const searchData = surahsData.length > 0 ? surahsData : quickSurahList;
            
            // Enhanced fuzzy matching with comprehensive scoring
            const scoredSurahs = searchData.map(surah => {
                const score = calculateComprehensiveSurahMatchScore(searchTerm, surah);
                return { ...surah, score };
            }).filter(surah => surah.score > 0);
            
            // Sort by score (highest first)
            scoredSurahs.sort((a, b) => b.score - a.score);
            
            // If no results in quick list but full data is loading, show a message
            if (scoredSurahs.length === 0 && surahsData.length === 0 && quranData) {
                const surahList = document.getElementById('surahList');
                surahList.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p class="mb-2">${currentLang === 'ar' ? '       ' : 'No results in quick list'}</p>
                        <p class="text-xs">${currentLang === 'ar' ? '   ...' : 'Loading full list...'}</p>
                    </div>
                `;
                return;
            }
            
            populateSurahList(scoredSurahs);
        }
        
        // Calculate comprehensive match score for fuzzy search
        function calculateComprehensiveSurahMatchScore(searchTerm, surah) {
            const arabicName = surah.name || '';
            const englishName = surah.englishName || '';
            const number = surah.number.toString();
            
            let maxScore = 0;
            
            // Exact matches get highest score
            if (arabicName === searchTerm || englishName.toLowerCase() === searchTerm.toLowerCase() || number === searchTerm) {
                return 1000;
            }
            
            // Check number match
            if (number.includes(searchTerm)) {
                maxScore = Math.max(maxScore, 900);
            }
            
            // Get comprehensive search variants
            const searchVariants = generateComprehensiveSearchVariants(searchTerm);
            const surahVariants = generateComprehensiveSurahVariants(surah);
            
            // Check all combinations
            for (const searchVariant of searchVariants) {
                for (const surahVariant of surahVariants) {
                    const score = calculateStringMatchScore(searchVariant, surahVariant);
                    maxScore = Math.max(maxScore, score);
                }
            }
            
            // Additional similarity scoring based on character length and common patterns
            const similarityScore = calculateSimilarityScore(searchTerm, surah);
            maxScore = Math.max(maxScore, similarityScore);
            
            return maxScore;
        }
        
        // Generate comprehensive search term variants
        function generateComprehensiveSearchVariants(searchTerm) {
            const variants = new Set();
            const original = searchTerm.toLowerCase().trim();
            
            // Add original
            variants.add(original);
            
            // Remove common prefixes
            const prefixes = ['al-', 'al ', 'an-', 'an ', 'as-', 'as ', 'at-', 'at ', 'ar-', 'ar ', 
                             'surat ', 'surah ', ' ', ' '];
            prefixes.forEach(prefix => {
                if (original.startsWith(prefix)) {
                    variants.add(original.substring(prefix.length));
                }
            });
            
            // Add with common prefixes
            variants.add('al-' + original);
            variants.add('al ' + original);
            variants.add('an-' + original);
            variants.add('surat ' + original);
            variants.add('surah ' + original);
            
            // Handle Arabic variations
            if (isArabicText(original)) {
                variants.add(normalizeArabicText(original));
                
                // Handle definite article variations
                if (original.startsWith('')) {
                    variants.add(original.substring(2));
                } else {
                    variants.add('' + original);
                }
                
                // Handle Arabic numeral conversions
                const arabicNumerals = {
                    '': '0', '': '1', '': '2', '': '3', '': '4',
                    '': '5', '': '6', '': '7', '': '8', '': '9'
                };
                let converted = original;
                for (const [arabic, english] of Object.entries(arabicNumerals)) {
                    converted = converted.replace(new RegExp(arabic, 'g'), english);
                }
                if (converted !== original) {
                    variants.add(converted);
                }
            }
            
            // Handle transliteration variations
            const transliterationMap = {
                'waqia': 'waqi\'ah',
                'waqiah': 'waqi\'ah',
                'waqiyah': 'waqi\'ah',
                'waq': 'waqi\'ah',
                'al-waq': 'al-waqi\'ah',
                'alwaq': 'al-waqi\'ah',
                'ikhlas': 'ikhlas',
                'ikhlaas': 'ikhlas',
                'iklas': 'ikhlas',
                'class': 'ikhlas',
                'close': 'ikhlas',
                'nas': 'nas',
                'naas': 'nas',
                'people': 'nas',
                'mankind': 'nas',
                'falaq': 'falaq',
                'falaaq': 'falaq',
                'daybreak': 'falaq',
                'dawn': 'falaq',
                'fajr': 'fajr',
                'baqara': 'baqarah',
                'baqarah': 'baqarah',
                'bakara': 'baqarah',
                'cow': 'baqarah',
                'imran': 'imran',
                'ali imran': 'imran',
                'al imran': 'imran',
                'nisa': 'nisa',
                'nisaa': 'nisa',
                'women': 'nisa',
                'maidah': 'maidah',
                'maidaah': 'maidah',
                'table': 'maidah',
                'anam': 'anam',
                'anaam': 'anam',
                'cattle': 'anam',
                'araf': 'araf',
                'araaf': 'araf',
                'heights': 'araf',
                'anfal': 'anfal',
                'anfaal': 'anfal',
                'spoils': 'anfal',
                'tawbah': 'tawbah',
                'tawba': 'tawbah',
                'toba': 'tawbah',
                'repentance': 'tawbah',
                'yunus': 'yunus',
                'jonah': 'yunus',
                'jonas': 'yunus',
                'hud': 'hud',
                'yusuf': 'yusuf',
                'joseph': 'yusuf',
                'raad': 'raad',
                'ra\'ad': 'raad',
                'thunder': 'raad',
                'ibrahim': 'ibrahim',
                'abraham': 'ibrahim',
                'hijr': 'hijr',
                'nahl': 'nahl',
                'bee': 'nahl',
                'isra': 'isra',
                'israa': 'isra',
                'night journey': 'isra',
                'kahf': 'kahf',
                'cave': 'kahf',
                'maryam': 'maryam',
                'mary': 'maryam',
                'maria': 'maryam',
                'taha': 'taha',
                'ta-ha': 'taha',
                'anbiya': 'anbiya',
                'anbiyaa': 'anbiya',
                'prophets': 'anbiya',
                'hajj': 'hajj',
                'pilgrimage': 'hajj',
                'muminun': 'muminun',
                'mu\'minun': 'muminun',
                'believers': 'muminun',
                'nur': 'nur',
                'noor': 'nur',
                'light': 'nur',
                'furqan': 'furqan',
                'criterion': 'furqan',
                'shuara': 'shuara',
                'shu\'ara': 'shuara',
                'poets': 'shuara',
                'naml': 'naml',
                'ant': 'naml',
                'qasas': 'qasas',
                'stories': 'qasas',
                'ankabut': 'ankabut',
                'spider': 'ankabut',
                'rum': 'rum',
                'romans': 'rum',
                'luqman': 'luqman',
                'lukman': 'luqman',
                'sajda': 'sajda',
                'sajdah': 'sajda',
                'prostration': 'sajda',
                'ahzab': 'ahzab',
                'confederates': 'ahzab',
                'saba': 'saba',
                'sheba': 'saba',
                'fatir': 'fatir',
                'creator': 'fatir',
                'yasin': 'yasin',
                'ya-sin': 'yasin',
                'saffat': 'saffat',
                'ranks': 'saffat',
                'sad': 'sad',
                'zumar': 'zumar',
                'groups': 'zumar',
                'ghafir': 'ghafir',
                'forgiver': 'ghafir',
                'fussilat': 'fussilat',
                'explained': 'fussilat',
                'shura': 'shura',
                'consultation': 'shura',
                'zukhruf': 'zukhruf',
                'ornaments': 'zukhruf',
                'dukhan': 'dukhan',
                'smoke': 'dukhan',
                'jathiya': 'jathiya',
                'kneeling': 'jathiya',
                'ahqaf': 'ahqaf',
                'sand dunes': 'ahqaf',
                'muhammad': 'muhammad',
                'mohammed': 'muhammad',
                'mohamed': 'muhammad',
                'fath': 'fath',
                'victory': 'fath',
                'hujurat': 'hujurat',
                'chambers': 'hujurat',
                'qaf': 'qaf',
                'dhariyat': 'dhariyat',
                'winds': 'dhariyat',
                'tur': 'tur',
                'mount': 'tur',
                'najm': 'najm',
                'star': 'najm',
                'qamar': 'qamar',
                'moon': 'qamar',
                'rahman': 'rahman',
                'most merciful': 'rahman',
                'waqia': 'waqia',
                'waqi\'ah': 'waqia',
                'event': 'waqia',
                'hadid': 'hadid',
                'iron': 'hadid',
                'mujadila': 'mujadila',
                'pleading': 'mujadila',
                'hashr': 'hashr',
                'exile': 'hashr',
                'mumtahina': 'mumtahina',
                'examined': 'mumtahina',
                'saff': 'saff',
                'ranks': 'saff',
                'jumua': 'jumua',
                'jumu\'ah': 'jumua',
                'friday': 'jumua',
                'munafiqun': 'munafiqun',
                'hypocrites': 'munafiqun',
                'taghabun': 'taghabun',
                'mutual loss': 'taghabun',
                'talaq': 'talaq',
                'divorce': 'talaq',
                'tahrim': 'tahrim',
                'prohibition': 'tahrim',
                'mulk': 'mulk',
                'sovereignty': 'mulk',
                'qalam': 'qalam',
                'pen': 'qalam',
                'haqqah': 'haqqah',
                'reality': 'haqqah',
                'maarij': 'maarij',
                'ascending': 'maarij',
                'nuh': 'nuh',
                'noah': 'nuh',
                'jinn': 'jinn',
                'muzzammil': 'muzzammil',
                'wrapped': 'muzzammil',
                'muddathir': 'muddathir',
                'cloaked': 'muddathir',
                'qiyama': 'qiyama',
                'qiyamah': 'qiyama',
                'resurrection': 'qiyama',
                'insan': 'insan',
                'man': 'insan',
                'mursalat': 'mursalat',
                'sent forth': 'mursalat',
                'naba': 'naba',
                'news': 'naba',
                'naziat': 'naziat',
                'pullers': 'naziat',
                'abasa': 'abasa',
                'frowned': 'abasa',
                'takwir': 'takwir',
                'folding': 'takwir',
                'infitar': 'infitar',
                'cleaving': 'infitar',
                'mutaffifin': 'mutaffifin',
                'defrauding': 'mutaffifin',
                'inshiqaq': 'inshiqaq',
                'splitting': 'inshiqaq',
                'buruj': 'buruj',
                'constellations': 'buruj',
                'tariq': 'tariq',
                'night comer': 'tariq',
                'ala': 'ala',
                'a\'la': 'ala',
                'most high': 'ala',
                'ghashiya': 'ghashiya',
                'overwhelming': 'ghashiya',
                'shams': 'shams',
                'sun': 'shams',
                'layl': 'layl',
                'night': 'layl',
                'duha': 'duha',
                'morning': 'duha',
                'sharh': 'sharh',
                'expansion': 'sharh',
                'tin': 'tin',
                'fig': 'tin',
                'alaq': 'alaq',
                'clot': 'alaq',
                'qadr': 'qadr',
                'power': 'qadr',
                'bayyina': 'bayyina',
                'evidence': 'bayyina',
                'zalzala': 'zalzala',
                'earthquake': 'zalzala',
                'adiyat': 'adiyat',
                'chargers': 'adiyat',
                'qaria': 'qaria',
                'qari\'ah': 'qaria',
                'calamity': 'qaria',
                'takathur': 'takathur',
                'competition': 'takathur',
                'asr': 'asr',
                'time': 'asr',
                'humaza': 'humaza',
                'slanderer': 'humaza',
                'fil': 'fil',
                'elephant': 'fil',
                'quraysh': 'quraysh',
                'maun': 'maun',
                'assistance': 'maun',
                'kawthar': 'kawthar',
                'abundance': 'kawthar',
                'kafirun': 'kafirun',
                'disbelievers': 'kafirun',
                'nasr': 'nasr',
                'help': 'nasr',
                'masad': 'masad',
                'palm fiber': 'masad',
                'lahab': 'lahab',
                'flame': 'lahab'
            };
            
            // Add transliteration variants
            for (const [key, value] of Object.entries(transliterationMap)) {
                if (original.includes(key)) {
                    variants.add(original.replace(key, value));
                }
                if (original === key) {
                    variants.add(value);
                }
            }
            
            // Add partial matches for longer terms
            if (original.length > 3) {
                for (let i = 3; i <= original.length; i++) {
                    variants.add(original.substring(0, i));
                }
            }
            
            return Array.from(variants);
        }
        
        // Generate comprehensive surah name variants
        function generateComprehensiveSurahVariants(surah) {
            const variants = new Set();
            const arabicName = surah.name || '';
            const englishName = surah.englishName || '';
            
            // Add original names
            variants.add(arabicName.toLowerCase());
            variants.add(englishName.toLowerCase());
            
            // Add normalized Arabic
            if (arabicName) {
                variants.add(normalizeArabicText(arabicName));
            }
            
            // Add without common prefixes
            const prefixes = ['al-', 'an-', 'as-', 'at-', 'ar-', 'the '];
            prefixes.forEach(prefix => {
                if (englishName.toLowerCase().startsWith(prefix)) {
                    variants.add(englishName.toLowerCase().substring(prefix.length));
                }
            });
            
            // Add comprehensive transliteration variants for all surahs
            const comprehensiveTransliterations = {
                '': ['fatiha', 'fatihah', 'opening'],
                '': ['baqara', 'baqarah', 'bakara', 'cow'],
                ' ': ['imran', 'ali imran', 'al imran'],
                '': ['nisa', 'nisaa', 'women'],
                '': ['maidah', 'maidaah', 'table'],
                '': ['anam', 'anaam', 'cattle'],
                '': ['araf', 'araaf', 'heights'],
                '': ['anfal', 'anfaal', 'spoils'],
                '': ['tawbah', 'tawba', 'toba', 'repentance'],
                '': ['yunus', 'jonah', 'jonas'],
                '': ['hud'],
                '': ['yusuf', 'joseph'],
                '': ['raad', 'ra\'ad', 'thunder'],
                '': ['ibrahim', 'abraham'],
                '': ['hijr'],
                '': ['nahl', 'bee'],
                '': ['isra', 'israa', 'night journey'],
                '': ['kahf', 'cave'],
                '': ['maryam', 'mary', 'maria'],
                '': ['taha', 'ta-ha'],
                '': ['anbiya', 'anbiyaa', 'prophets'],
                '': ['hajj', 'pilgrimage'],
                '': ['muminun', 'mu\'minun', 'believers'],
                '': ['nur', 'noor', 'light'],
                '': ['furqan', 'criterion'],
                '': ['shuara', 'shu\'ara', 'poets'],
                '': ['naml', 'ant'],
                '': ['qasas', 'stories'],
                '': ['ankabut', 'spider'],
                '': ['rum', 'romans'],
                '': ['luqman', 'lukman'],
                '': ['sajda', 'sajdah', 'prostration'],
                '': ['ahzab', 'confederates'],
                '': ['saba', 'sheba'],
                '': ['fatir', 'creator'],
                '': ['yasin', 'ya-sin'],
                '': ['saffat', 'ranks'],
                '': ['sad'],
                '': ['zumar', 'groups'],
                '': ['ghafir', 'forgiver'],
                '': ['fussilat', 'explained'],
                '': ['shura', 'consultation'],
                '': ['zukhruf', 'ornaments'],
                '': ['dukhan', 'smoke'],
                '': ['jathiya', 'kneeling'],
                '': ['ahqaf', 'sand dunes'],
                '': ['muhammad', 'mohammed', 'mohamed'],
                '': ['fath', 'victory'],
                '': ['hujurat', 'chambers'],
                '': ['qaf'],
                '': ['dhariyat', 'winds'],
                '': ['tur', 'mount'],
                '': ['najm', 'star'],
                '': ['qamar', 'moon'],
                '': ['rahman', 'most merciful'],
                '': ['waqia', 'waqi\'ah', 'waqiah', 'waqiyah', 'event'],
                '': ['hadid', 'iron'],
                '': ['mujadila', 'pleading'],
                '': ['hashr', 'exile'],
                '': ['mumtahina', 'examined'],
                '': ['saff', 'ranks'],
                '': ['jumua', 'jumu\'ah', 'friday'],
                '': ['munafiqun', 'hypocrites'],
                '': ['taghabun', 'mutual loss'],
                '': ['talaq', 'divorce'],
                '': ['tahrim', 'prohibition'],
                '': ['mulk', 'sovereignty'],
                '': ['qalam', 'pen'],
                '': ['haqqah', 'reality'],
                '': ['maarij', 'ascending'],
                '': ['nuh', 'noah'],
                '': ['jinn'],
                '': ['muzzammil', 'wrapped'],
                '': ['muddathir', 'cloaked'],
                '': ['qiyama', 'qiyamah', 'resurrection'],
                '': ['insan', 'man'],
                '': ['mursalat', 'sent forth'],
                '': ['naba', 'news'],
                '': ['naziat', 'pullers'],
                '': ['abasa', 'frowned'],
                '': ['takwir', 'folding'],
                '': ['infitar', 'cleaving'],
                '': ['mutaffifin', 'defrauding'],
                '': ['inshiqaq', 'splitting'],
                '': ['buruj', 'constellations'],
                '': ['tariq', 'night comer'],
                '': ['ala', 'a\'la', 'most high'],
                '': ['ghashiya', 'overwhelming'],
                '': ['fajr', 'dawn'],
                '': ['balad', 'city'],
                '': ['shams', 'sun'],
                '': ['layl', 'night'],
                '': ['duha', 'morning'],
                '': ['sharh', 'expansion'],
                '': ['tin', 'fig'],
                '': ['alaq', 'clot'],
                '': ['qadr', 'power'],
                '': ['bayyina', 'evidence'],
                '': ['zalzala', 'earthquake'],
                '': ['adiyat', 'chargers'],
                '': ['qaria', 'qari\'ah', 'calamity'],
                '': ['takathur', 'competition'],
                '': ['asr', 'time'],
                '': ['humaza', 'slanderer'],
                '': ['fil', 'elephant'],
                '': ['quraysh'],
                '': ['maun', 'assistance'],
                '': ['kawthar', 'abundance'],
                '': ['kafirun', 'disbelievers'],
                '': ['nasr', 'help'],
                '': ['masad', 'lahab', 'palm fiber', 'flame'],
                '': ['ikhlas', 'ikhlaas', 'iklas', 'sincerity'],
                '': ['falaq', 'falaaq', 'daybreak'],
                '': ['nas', 'naas', 'people', 'mankind']
            };
            
            // Add transliteration variants
            for (const [arabic, transliterations] of Object.entries(comprehensiveTransliterations)) {
                if (arabicName.includes(arabic)) {
                    transliterations.forEach(t => variants.add(t));
                }
            }
            
            // Add specific Arabic name mappings for better search
            const arabicNameMappings = {
                '': ['ikhlas', 'ikhlaas', 'iklas', 'sincerity', '', ''],
                ' ': ['imran', 'ali imran', 'al imran', '', ' ', 'al-imran'],
                '': ['baqara', 'baqarah', 'bakara', 'cow', '', ''],
                '': ['nisa', 'nisaa', 'women', '', ''],
                '': ['fatiha', 'fatihah', 'opening', '', ''],
                '': ['rahman', 'most merciful', '', ''],
                '': ['nas', 'naas', 'people', 'mankind', '', ''],
                '': ['falaq', 'falaaq', 'daybreak', '', ''],
                '': ['kawthar', 'abundance', '', ''],
                '': ['kafirun', 'disbelievers', '', ''],
                '': ['nasr', 'help', '', ''],
                '': ['masad', 'lahab', 'palm fiber', 'flame', '', ''],
                '': ['ikhlas', 'ikhlaas', 'iklas', 'sincerity', '', ''],
                '': ['falaq', 'falaaq', 'daybreak', '', ''],
                '': ['nas', 'naas', 'people', 'mankind', '', '']
            };
            
            // Add Arabic name mappings
            for (const [arabic, mappings] of Object.entries(arabicNameMappings)) {
                if (arabicName.includes(arabic) || arabic.includes(arabicName)) {
                    mappings.forEach(mapping => variants.add(mapping));
                }
            }
            
            return Array.from(variants);
        }
        
        // Calculate string match score
        function calculateStringMatchScore(search, target) {
            if (!search || !target) return 0;
            
            const searchLower = search.toLowerCase();
            const targetLower = target.toLowerCase();
            
            // Exact match
            if (searchLower === targetLower) return 800;
            
            // Starts with
            if (targetLower.startsWith(searchLower)) return 700;
            
            // Contains
            if (targetLower.includes(searchLower)) return 600;
            
            // Partial match at word boundaries
            const searchWords = searchLower.split(/\s+/);
            const targetWords = targetLower.split(/\s+/);
            
            let wordMatches = 0;
            for (const searchWord of searchWords) {
                for (const targetWord of targetWords) {
                    if (targetWord.startsWith(searchWord)) {
                        wordMatches++;
                        break;
                    }
                }
            }
            
            if (wordMatches > 0) {
                return 500 + (wordMatches * 50);
            }
            
            // Fuzzy match using edit distance
            const editDistance = levenshteinDistance(searchLower, targetLower);
            const maxLength = Math.max(searchLower.length, targetLower.length);
            
            if (editDistance <= 2 && maxLength > 3) {
                return 400 - (editDistance * 50);
            }
            
            if (editDistance <= 3 && maxLength > 5) {
                return 300 - (editDistance * 30);
            }
            
            return 0;
        }
        
        // Calculate similarity score based on character length and patterns
        function calculateSimilarityScore(searchTerm, surah) {
            const arabicName = surah.name || '';
            const englishName = surah.englishName || '';
            
            let maxScore = 0;
            
            // Check length similarity (closer lengths get higher scores)
            const searchLength = searchTerm.length;
            const arabicLength = arabicName.length;
            const englishLength = englishName.length;
            
            // Length similarity scoring
            const arabicLengthDiff = Math.abs(searchLength - arabicLength);
            const englishLengthDiff = Math.abs(searchLength - englishLength);
            
            if (arabicLengthDiff <= 2) {
                maxScore = Math.max(maxScore, 200 - (arabicLengthDiff * 50));
            }
            if (englishLengthDiff <= 2) {
                maxScore = Math.max(maxScore, 200 - (englishLengthDiff * 50));
            }
            
            // Check for common character patterns
            const searchChars = searchTerm.toLowerCase().split('').sort().join('');
            const arabicChars = arabicName.toLowerCase().split('').sort().join('');
            const englishChars = englishName.toLowerCase().split('').sort().join('');
            
            // Character pattern similarity
            const arabicCharSimilarity = calculateCharacterSimilarity(searchChars, arabicChars);
            const englishCharSimilarity = calculateCharacterSimilarity(searchChars, englishChars);
            
            maxScore = Math.max(maxScore, arabicCharSimilarity, englishCharSimilarity);
            
            // Check for word boundary matches
            const searchWords = searchTerm.toLowerCase().split(/\s+/);
            const englishWords = englishName.toLowerCase().split(/\s+/);
            
            let wordBoundaryScore = 0;
            for (const searchWord of searchWords) {
                for (const englishWord of englishWords) {
                    if (englishWord.includes(searchWord) || searchWord.includes(englishWord)) {
                        wordBoundaryScore += 100;
                    }
                }
            }
            maxScore = Math.max(maxScore, wordBoundaryScore);
            
            return maxScore;
        }
        
        // Calculate character similarity between two strings
        function calculateCharacterSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            
            const chars1 = str1.split('');
            const chars2 = str2.split('');
            
            let commonChars = 0;
            let totalChars = Math.max(chars1.length, chars2.length);
            
            for (const char of chars1) {
                if (chars2.includes(char)) {
                    commonChars++;
                    // Remove the matched character to avoid double counting
                    const index = chars2.indexOf(char);
                    chars2.splice(index, 1);
                }
            }
            
            return (commonChars / totalChars) * 150;
        }
        
        // Levenshtein distance for fuzzy matching
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            if (str1.length === 0) return str2.length;
            if (str2.length === 0) return str1.length;
            
            // Initialize matrix
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            // Fill matrix
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // substitution
                            matrix[i][j - 1] + 1,     // insertion
                            matrix[i - 1][j] + 1      // deletion
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // Check if text contains Arabic characters
        function isArabicText(text) {
            const arabicRegex = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
            return arabicRegex.test(text);
        }
        
        // Convert Arabic numerals to regular numbers
        function convertArabicNumerals(text) {
            const arabicNumerals = {
                '': '0', '': '1', '': '2', '': '3', '': '4',
                '': '5', '': '6', '': '7', '': '8', '': '9'
            };
            return text.replace(/[-]/g, match => arabicNumerals[match]);
        }
        
        // Quran Search Functionality
        let quranSearchTimeout;
        let quranSearchResults = [];
        let targetVerseFromSearch = null; // Track the verse selected from search
        
        // Initialize Quran search
        function initializeQuranSearch() {
            const searchInput = document.getElementById('quranSearchInput');
            const searchResults = document.getElementById('quranSearchResults');
            const clearBtn = document.getElementById('quranSearchClearBtn');
            
            if (!searchInput) return;
            
            // Search input event listener
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (quranSearchTimeout) {
                    clearTimeout(quranSearchTimeout);
                }
                
                // Show/hide clear button
                if (query.length > 0) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                    hideQuranSearchResults();
                    return;
                }
                
                // Debounce search
                quranSearchTimeout = setTimeout(() => {
                    performQuranSearch(query);
                }, 300);
            });
            
            // Handle keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideQuranSearchResults();
                    searchInput.blur();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    const firstResult = document.querySelector('#quranSearchResults .search-result-item');
                    if (firstResult) {
                        firstResult.click();
                    }
                }
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    hideQuranSearchResults();
                }
            });
        }
        
        // Perform Quran search
        function performQuranSearch(query) {
            if (!quranData || !translationData) {
                console.log('Quran data not loaded yet');
                return;
            }
            
            const results = [];
            const searchTerm = query.toLowerCase().trim();
            
            // Enhanced search patterns for page and juz (support Arabic numerals)
            const pageMatch = searchTerm.match(/^(page|)\s*(\d+|[-]+)$/i);
            const juzMatch = searchTerm.match(/^(juz|)\s*(\d+|[-]+)$/i);
            
            // If it's a specific page or juz search, prioritize those results
            if (pageMatch) {
                const targetPage = parseInt(convertArabicNumerals(pageMatch[2]));
                // Find the first verse on that page
                for (let surahIndex = 0; surahIndex < quranData.length; surahIndex++) {
                    const surah = quranData[surahIndex];
                    if (!surah) continue;
                    
                    for (let ayahIndex = 0; ayahIndex < surah.ayahs.length; ayahIndex++) {
                        const ayah = surah.ayahs[ayahIndex];
                        if (ayah && ayah.page === targetPage) {
                            const translation = translationData[surahIndex];
                            const translationAyah = translation ? translation.ayahs[ayahIndex] : null;
                            
                            results.push({
                                surahIndex,
                                ayahIndex,
                                surah,
                                ayah,
                                translationAyah,
                                score: 1200, // Highest priority for exact page match
                                matchType: 'page_exact',
                                matchText: `Page ${ayah.page}`
                            });
                            break; // Found first verse on this page
                        }
                    }
                    if (results.length > 0) break; // Found the page
                }
            } else if (juzMatch) {
                const targetJuz = parseInt(convertArabicNumerals(juzMatch[2]));
                // Find the first verse in that juz
                for (let surahIndex = 0; surahIndex < quranData.length; surahIndex++) {
                    const surah = quranData[surahIndex];
                    if (!surah) continue;
                    
                    for (let ayahIndex = 0; ayahIndex < surah.ayahs.length; ayahIndex++) {
                        const ayah = surah.ayahs[ayahIndex];
                        if (ayah && ayah.juz === targetJuz) {
                            const translation = translationData[surahIndex];
                            const translationAyah = translation ? translation.ayahs[ayahIndex] : null;
                            
                            results.push({
                                surahIndex,
                                ayahIndex,
                                surah,
                                ayah,
                                translationAyah,
                                score: 1100, // High priority for exact juz match
                                matchType: 'juz_exact',
                                matchText: `Juz ${ayah.juz}`
                            });
                            break; // Found first verse in this juz
                        }
                    }
                    if (results.length > 0) break; // Found the juz
                }
            } else {
                // Regular search through all surahs and ayahs
                for (let surahIndex = 0; surahIndex < quranData.length; surahIndex++) {
                    const surah = quranData[surahIndex];
                    const translation = translationData[surahIndex];
                    
                    if (!surah || !translation) continue;
                    
                    for (let ayahIndex = 0; ayahIndex < surah.ayahs.length; ayahIndex++) {
                        const ayah = surah.ayahs[ayahIndex];
                        const translationAyah = translation.ayahs[ayahIndex];
                        
                        if (!ayah || !translationAyah) continue;
                        
                        let score = 0;
                        let matchType = '';
                        let matchText = '';
                        
                        // Check verse number
                        if (ayah.numberInSurah.toString().includes(searchTerm) || 
                            ayah.numberInSurah.toString() === searchTerm) {
                            score = 1000;
                            matchType = 'verse';
                            matchText = `Verse ${ayah.numberInSurah}`;
                        }
                        
                        // Check page number
                        else if (ayah.page && ayah.page.toString().includes(searchTerm)) {
                            score = 900;
                            matchType = 'page';
                            matchText = `Page ${ayah.page}`;
                        }
                        
                        // Check juz number
                        else if (ayah.juz && ayah.juz.toString().includes(searchTerm)) {
                            score = 800;
                            matchType = 'juz';
                            matchText = `Juz ${ayah.juz}`;
                        }
                        
                        // Check Arabic text
                        else if (ayah.text.toLowerCase().includes(searchTerm)) {
                            score = 700;
                            matchType = 'arabic';
                            matchText = ayah.text.substring(0, 100) + (ayah.text.length > 100 ? '...' : '');
                        }
                        
                        // Check translation text
                        else if (translationAyah.text.toLowerCase().includes(searchTerm)) {
                            score = 600;
                            matchType = 'translation';
                            matchText = translationAyah.text.substring(0, 100) + (translationAyah.text.length > 100 ? '...' : '');
                        }
                        
                        // Check surah name
                        else if (surah.name.toLowerCase().includes(searchTerm) || 
                                 surah.englishName.toLowerCase().includes(searchTerm)) {
                            score = 500;
                            matchType = 'surah';
                            matchText = `${surah.name} / ${surah.englishName}`;
                        }
                        
                        // Fuzzy search for Arabic text
                        else if (isArabicText(searchTerm)) {
                            const arabicText = normalizeArabicText(ayah.text);
                            const normalizedSearch = normalizeArabicText(searchTerm);
                            
                            if (arabicText.includes(normalizedSearch)) {
                                score = 400;
                                matchType = 'arabic_fuzzy';
                                matchText = ayah.text.substring(0, 100) + (ayah.text.length > 100 ? '...' : '');
                            }
                        }
                        
                        if (score > 0) {
                            results.push({
                                surahIndex,
                                ayahIndex,
                                surah,
                                ayah,
                                translationAyah,
                                score,
                                matchType,
                                matchText
                            });
                        }
                    }
                }
            }
            
            // Sort by score and limit results
            results.sort((a, b) => b.score - a.score);
            quranSearchResults = results.slice(0, 20); // Limit to 20 results
            
            displayQuranSearchResults();
        }
        
        // Display search results
        function displayQuranSearchResults() {
            const resultsContainer = document.getElementById('quranSearchResults');
            
            if (!resultsContainer || quranSearchResults.length === 0) {
                hideQuranSearchResults();
                return;
            }
            
            let html = '';
            
            quranSearchResults.forEach((result, index) => {
                const surahName = currentLang === 'ar' ? result.surah.name : result.surah.englishName;
                const matchTypeIcon = getMatchTypeIcon(result.matchType);
                const matchTypeText = getMatchTypeText(result.matchType);
                
                html += `
                    <div class="search-result-item p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-200 dark:border-gray-600 last:border-b-0 transition-colors"
                         onclick="goToQuranVerse(${result.surahIndex}, ${result.ayahIndex})"
                         data-surah="${result.surahIndex}" 
                         data-ayah="${result.ayahIndex}">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                ${result.ayah.numberInSurah}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-sm font-semibold text-gray-800 dark:text-gray-200">
                                        ${surahName}
                                    </span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">
                                        ${currentLang === 'ar' ? '' : 'Verse'} ${result.ayah.numberInSurah}
                                    </span>
                                    <span class="text-xs text-gray-400 dark:text-gray-500">
                                        ${matchTypeIcon} ${matchTypeText}
                                    </span>
                                </div>
                                <div class="text-sm text-gray-600 dark:text-gray-300 mb-1" dir="rtl">
                                    ${result.ayah.text.substring(0, 80)}${result.ayah.text.length > 80 ? '...' : ''}
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400" dir="ltr">
                                    ${result.translationAyah.text.substring(0, 60)}${result.translationAyah.text.length > 60 ? '...' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            resultsContainer.classList.remove('hidden');
        }
        
        // Get match type icon
        function getMatchTypeIcon(matchType) {
            const icons = {
                'verse': '',
                'page': '',
                'page_exact': '',
                'juz': '',
                'juz_exact': '',
                'arabic': '',
                'translation': '',
                'surah': '',
                'arabic_fuzzy': ''
            };
            return icons[matchType] || '';
        }
        
        // Get match type text
        function getMatchTypeText(matchType) {
            const texts = {
                'verse': currentLang === 'ar' ? ' ' : 'Verse Number',
                'page': currentLang === 'ar' ? ' ' : 'Page Number',
                'page_exact': currentLang === 'ar' ? ' ' : 'Exact Page',
                'juz': currentLang === 'ar' ? ' ' : 'Juz Number',
                'juz_exact': currentLang === 'ar' ? ' ' : 'Exact Juz',
                'arabic': currentLang === 'ar' ? ' ' : 'Arabic Text',
                'translation': currentLang === 'ar' ? '' : 'Translation',
                'surah': currentLang === 'ar' ? ' ' : 'Surah Name',
                'arabic_fuzzy': currentLang === 'ar' ? ' ' : 'Fuzzy Search'
            };
            return texts[matchType] || '';
        }
        
        // Go to specific verse
        function goToQuranVerse(surahIndex, ayahIndex) {
            // Switch to Quran tab if not already there
            if (!document.getElementById('quranContent').classList.contains('active')) {
                switchTab('quran');
            }
            
            // Set current surah and ayah
            currentSurah = surahIndex;
            currentAyah = ayahIndex;
            isReadingMode = false;
            
            // Store the target verse for when user switches to full surah mode
            targetVerseFromSearch = { surahIndex, ayahIndex };
            
            // Update surah menu button
            const surah = quranData[surahIndex];
            const surahName = currentLang === 'ar' ? surah.name : surah.englishName;
            document.getElementById('selectedSurahText').textContent = `${surah.number}. ${surahName}`;
            
            // Display the verse
            displayAyah();
            
            // Hide quick surahs section
            const quickSurahsSection = document.getElementById('quickSurahsSection');
            if (quickSurahsSection) {
                quickSurahsSection.style.display = 'none';
            }
            
            // Hide search results
            hideQuranSearchResults();
            
            // Clear search input
            document.getElementById('quranSearchInput').value = '';
            document.getElementById('quranSearchClearBtn').classList.add('hidden');
            
            // Show success message
            const ayah = quranData[surahIndex].ayahs[ayahIndex];
            showToast(
                currentLang === 'ar' 
                    ? `   ${surahName} -  ${ayah.numberInSurah}` 
                    : `Navigated to ${surahName} - Verse ${ayah.numberInSurah}`,
                'success'
            );
        }
        
        // Hide search results
        function hideQuranSearchResults() {
            const resultsContainer = document.getElementById('quranSearchResults');
            if (resultsContainer) {
                resultsContainer.classList.add('hidden');
            }
        }
        
        // Clear search
        function clearQuranSearch() {
            const searchInput = document.getElementById('quranSearchInput');
            const clearBtn = document.getElementById('quranSearchClearBtn');
            
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
            
            if (clearBtn) {
                clearBtn.classList.add('hidden');
            }
            
            hideQuranSearchResults();
        }
        
        // Event Listeners for Surah Menu
        document.addEventListener('DOMContentLoaded', function() {
            // Surah menu button
            document.getElementById('surahMenuBtn').addEventListener('click', openSurahMenu);
            
            // Close menu button
            document.getElementById('closeSurahMenu').addEventListener('click', closeSurahMenu);
            
            // Overlay click to close
            document.getElementById('surahMenuOverlay').addEventListener('click', closeSurahMenu);
            
            // Search functionality
            document.getElementById('surahSearchInput').addEventListener('input', function(e) {
                searchSurahs(e.target.value);
            });
            
            // Event delegation for surah items (more efficient)
            document.getElementById('surahList').addEventListener('click', function(e) {
                const surahItem = e.target.closest('.surah-item');
                if (surahItem && surahItem.dataset.surahIndex) {
                    selectSurah(parseInt(surahItem.dataset.surahIndex));
                }
            });
            
            // Escape key to close menu
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSurahMenu();
                }
            });
            
            // Initialize Quran search
            initializeQuranSearch();
            
            // Early initialization for better performance
            setTimeout(() => {
                if (quranData && surahsData.length === 0) {
                    initializeSurahMenu();
                }
            }, 1000); // Initialize after 1 second to avoid blocking initial load
        });

            

        // Utility to get the verse closest to the center of the viewport
        function getCenteredVerseId() {
            const verses = document.querySelectorAll('[id^="verse-"]');
            const viewportCenter = window.scrollY + window.innerHeight / 2;
            let closestId = null;
            let minDist = Infinity;
            verses.forEach(verse => {
                const rect = verse.getBoundingClientRect();
                const verseCenter = rect.top + window.scrollY + rect.height / 2;
                const dist = Math.abs(verseCenter - viewportCenter);
                if (dist < minDist) {
                    minDist = dist;
                    closestId = verse.id;
                }
            });
            return closestId;
        }

        // Update playAyahAudio to toggle play/pause and handle interruptions with debounce
        function playAyahAudio(surah, ayah) {
            // Prevent multiple rapid clicks with a debounce flag
            if (window.isPlayingAudio) {
                return;
            }
            window.isPlayingAudio = true;

            // If the same ayah is playing, pause it (do not restart)
            if (window.currentAyahAudio && currentAudioSurah === surah && currentAudioAyah === ayah && !window.currentAyahAudio.paused) {
                window.currentAyahAudio.pause();
                console.log('Ayah audio stopped:', { surah, ayah });
                updateAyahHighlights();
                window.isPlayingAudio = false;
                return;
            }
            // Pause and reset any currently playing audio
            if (window.currentAyahAudio) {
                window.currentAyahAudio.pause();
                window.currentAyahAudio = null;
            }
            // Pad numbers to 3 digits
            const surahStr = (Number(surah) + 1).toString().padStart(3, '0');
            const ayahStr = (Number(ayah) + 1).toString().padStart(3, '0');
            
            // Get selected reciter from settings
            const reciterMapping = {
                'ar.alafasy': 'Alafasy_64kbps',
                'ar.husary': 'Husary_64kbps',
                'ar.minshawi': 'Minshawy_Murattal_128kbps',
                'ar.sudais': 'Abdurrahmaan_As-Sudais_64kbps',
                'ar.shuraim': 'Saood_ash-Shuraym_64kbps'
            };
            
            const selectedReciter = currentReciter || 'ar.alafasy';
            const reciter = reciterMapping[selectedReciter] || 'Alafasy_64kbps';
            const url = `https://everyayah.com/data/${reciter}/${surahStr}${ayahStr}.mp3`;
            const audio = new Audio(url);
            
            // Apply playback speed from settings
            audio.playbackRate = currentPlaybackSpeed || 1;
            
            window.currentAyahAudio = audio;
            currentAudioSurah = surah;
            currentAudioAyah = ayah;
            // Use a promise to handle play to avoid AbortError
            audio.play().then(() => {
                console.log('Ayah audio playing:', { surah, ayah, reciter: selectedReciter, speed: currentPlaybackSpeed });
                updateAyahHighlights();
                

                
                window.isPlayingAudio = false;
            }).catch(error => {
                console.error("Audio play error:", error);
                showToast(currentLang === 'ar' ? '    ' : 'Error playing audio', 'error');
                currentAudioSurah = null;
                currentAudioAyah = null;
                window.currentAyahAudio = null;
                updateAyahHighlights();
                window.isPlayingAudio = false;
            });
            updateAyahHighlights();
            audio.onended = () => {
                // Check if continuous play is enabled and we're not at the end of the surah
                if (isContinuousPlayEnabled && quranData && quranData[surah]) {
                    const currentSurahData = quranData[surah];
                    const nextAyah = ayah + 1;
                    
                    // If there's a next ayah in the current surah, play it
                    if (nextAyah < currentSurahData.ayahs.length) {
                        console.log('Continuous play: moving to next ayah', { surah, nextAyah });
                        // Reset current audio state first
                        currentAudioSurah = null;
                        currentAudioAyah = null;
                        window.currentAyahAudio = null;
                        updateAyahHighlights();
                        window.isPlayingAudio = false;
                        
                        // Small delay to ensure proper state reset
                        setTimeout(() => {
                            playAyahAudio(surah, nextAyah);
                        }, 500);
                        return;
                    } else if (isContinuousPlayEnabled) {
                        // Reached end of surah with continuous play enabled
                        const surahName = quranData[surah]?.name || `Surah ${surah + 1}`;
                        const message = currentLang === 'ar' ? 
                            `  ${surahName}` : 
                            `Finished playing ${surahName}`;
                        showToast(message, 'info');
                    }
                }
                
                // Normal ending behavior (no continuous play or end of surah reached)
                currentAudioSurah = null;
                currentAudioAyah = null;
                window.currentAyahAudio = null;
                updateAyahHighlights();
                window.isPlayingAudio = false;
                console.log('Ayah audio stopped (ended):', { surah, ayah });
            };
        }

        // Function to attach event listeners to ayah elements
        window.attachAyahListeners = function() {
            document.querySelectorAll('.ayah').forEach(ayahElem => {
                ayahElem.addEventListener('click', function() {
                    const surah = this.getAttribute('data-surah');
                    const ayah = this.getAttribute('data-ayah');
                    playAyahAudio(parseInt(surah), parseInt(ayah));
                });
            });
        };

        // Update ayah highlighting based on current playing state
        function updateAyahHighlights() {
            document.querySelectorAll('.ayah').forEach(span => {
                const surah = span.getAttribute('data-surah');
                const ayah = span.getAttribute('data-ayah');
                if (Number(surah) === Number(currentAudioSurah) && Number(ayah) === Number(currentAudioAyah) && window.currentAyahAudio && !window.currentAyahAudio.paused) {
                    span.classList.add('ayah-playing');
                } else {
                    span.classList.remove('ayah-playing');
                }
            });
        }

        let prayerHighlightInterval = null;

        function updateNextPrayerHighlight() {
            console.log("--- updateNextPrayerHighlight --- Triggered at", new Date().toLocaleTimeString());
            if (!prayerNotifications || Object.keys(prayerNotifications).length === 0) {
                console.log("Prayer times not available for highlighting or empty.");
                return;
            }
            // console.log("Current prayerNotifications:", JSON.parse(JSON.stringify(prayerNotifications)));

            const now = new Date();
            // console.log("Device current time for highlight check:", now.toLocaleTimeString());
            const prayerOrder = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            let nextPrayerName = null;

            // Remove existing highlights and restore default backgrounds
            prayerOrder.forEach(prayer => {
                const prayerEl = document.getElementById(`azan-${prayer.toLowerCase()}`);
                if (prayerEl) {
                    prayerEl.classList.remove('next-prayer-highlight');
                    // Ensure default Tailwind backgrounds are present when not highlighted
                    prayerEl.classList.add('bg-gray-100', 'dark:bg-gray-700');
                }
            });

            for (const prayerName of prayerOrder) {
                const prayerTimeStr = prayerNotifications[prayerName];
                if (!prayerTimeStr) continue;

                const [hours, minutes] = prayerTimeStr.split(':').map(Number);
                const prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);

                if (prayerDate > now) {
                    nextPrayerName = prayerName;
                    break;
                }
            }

            if (!nextPrayerName) {
                nextPrayerName = 'Fajr';
            }

            if (nextPrayerName) {
                const nextPrayerEl = document.getElementById(`azan-${nextPrayerName.toLowerCase()}`);
                if (nextPrayerEl) {
                    // Remove default Tailwind backgrounds before applying highlight
                    nextPrayerEl.classList.remove('bg-gray-100', 'dark:bg-gray-700');
                    nextPrayerEl.classList.add('next-prayer-highlight');
                }
            }
        }

        function setupPrayerHighlighting() {
            if (prayerHighlightInterval) {
                clearInterval(prayerHighlightInterval);
            }
            updateNextPrayerHighlight(); // Initial call
            prayerHighlightInterval = setInterval(updateNextPrayerHighlight, 60000); // Update every minute
        }

        // Add modal open/close logic and helper for button click
        function closeAdhkarMenuAndLoad(section) {
          document.getElementById('adhkarMenuModal').classList.add('hidden');
          loadAdhkar(section);
        }
        document.addEventListener('DOMContentLoaded', function() {
          const menuBtn = document.getElementById('adhkarMenuBtn');
          const modal = document.getElementById('adhkarMenuModal');
          const closeBtn = document.getElementById('closeAdhkarMenu');
          // Open modal
          menuBtn.addEventListener('click', function() {
            modal.classList.remove('hidden');
          });
          // Close modal by X
          closeBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
          });
          // Close modal by clicking outside
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.classList.add('hidden');
            }
          });
        });

 
      </script>
      <script>
(function() {
  const quranControls = document.querySelector('.quran-controls-sticky');
  const quranHook = document.getElementById('quranHook');
  let lastScrollY = window.scrollY;
  let controlsHidden = false;
  let ticking = false;
  function onScroll() {
    if (!quranControls || !quranHook) return;
    if (window.scrollY > 120 && !controlsHidden) {
      quranControls.classList.add('quran-controls-hidden');
      quranHook.classList.add('quran-hook-visible');
      controlsHidden = true;
    } else if (window.scrollY <= 120 && controlsHidden) {
      quranControls.classList.remove('quran-controls-hidden');
      quranHook.classList.remove('quran-hook-visible');
      controlsHidden = false;
    }
    ticking = false;
  }
  window.addEventListener('scroll', function() {
    if (!ticking) {
      window.requestAnimationFrame(onScroll);
      ticking = true;
    }
  });
  if (quranHook) {
    quranHook.addEventListener('click', function() {
      if (quranControls) {
        quranControls.classList.remove('quran-controls-hidden');
        quranHook.classList.remove('quran-hook-visible');
        controlsHidden = false;
        // Removed: window.scrollTo({top: 0, behavior: 'smooth'});
      }
    });
  }
})();
      </script>
      <script>
document.addEventListener('DOMContentLoaded', function() {
  var quranHook = document.getElementById('quranHook');
  if (quranHook) {
    // Force layout calculation to prevent jump
    void quranHook.offsetWidth;
  }
});
      </script>

<script>
function updateAzkarTypeLabels() {
  const types = [
    ['Morning', 'sabah'],
    ['Evening', 'masaa'],
    ['WakingSleeping', 'waking_sleeping'],
    ['Home', 'home'],
    ['Bathroom', 'bathroom'],
    ['Eating', 'eating'],
    ['Masjid', 'masjid'],
    ['Traveling', 'traveling'],
    ['Clothes', 'clothes'],
    ['Anxiety', 'anxiety'],
    ['Hardship', 'hardship'],
    ['Istighfar', 'istighfar'],
    ['PatienceGratitude', 'patience_gratitude'],
    ['Rabbana', 'rabbana'],
    ['Prophetic', 'prophetic'],
    ['Prophets', 'prophets'],
    ['Rain', 'rain'],
    ['Patient', 'patient'],
    ['Deceased', 'deceased'],
    ['MarriageChildrenRizq', 'marriage_children_rizq'],
    ['Protection', 'protection'],
    ['Salah', 'salah'],
    ['SujoodTashahhud', 'sujood_tashahhud'],
    ['Qunoot', 'qunoot'],
    ['Tahajjud', 'tahajjud'],
    ['Istikhara', 'istikhara'],
    ['Ramadan', 'ramadan'],
    ['Hajj', 'hajj'],
    ['LaylatAlQadr', 'laylat_al_qadr'],
    ['Eid', 'eid'],
    ['NaturalEvents', 'natural_events']
  ];
  types.forEach(([labelIdPrefix, typeKey]) => {
    const el = document.getElementById('label' + labelIdPrefix);
    if (el) {
      // Set text content first
      if (languages[currentLang].azkarTypes[typeKey]) {
        el.textContent = languages[currentLang].azkarTypes[typeKey];
      }
      
      // Clear any previous dynamic font size classes
      el.classList.remove('text-xs', 'text-sm'); 

      if (currentLang === 'en') {
        el.classList.add('text-xs'); // Smaller font for English labels
      } else { // Arabic
        el.classList.add('text-sm'); // Slightly larger font for Arabic labels
      }
    }
  });
}
document.addEventListener('DOMContentLoaded', updateAzkarTypeLabels);
// Patch switchLanguage to also update azkar labels
const origSwitchLanguage = window.switchLanguage;
window.switchLanguage = function() {
  origSwitchLanguage();
  updateAzkarTypeLabels();
};
      </script>
      <script>
(function() {
    // Initialize tafsir selector when modal is shown
  document.addEventListener('DOMContentLoaded', function() {
    const tafsirModal = document.getElementById('tafsirModal');
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
          const tafsirSelect = document.getElementById('tafsirSelect');
          if (tafsirModal.style.display === 'flex' && tafsirSelect) {
            tafsirSelect.value = currentTafsirSource;
            // Remove existing listeners to avoid duplicates
            tafsirSelect.onchange = function() {
              currentTafsirSource = this.value;
              // Reload tafsir content in modal
              document.getElementById('tafsirModalContent').textContent = currentLang === 'ar' ? ' ...' : 'Loading...';
              loadTafsirContent();
            };
          }
        }
      });
    });
    observer.observe(tafsirModal, { attributes: true });
  });
})();
      </script>

<script>
(function() {
  let popover = document.getElementById('ayahMenuPopover');
  let lastAyahElem = null;
  let popoverAyah = null;
  let popoverSurah = null;

  // Helper to close the popover
  function closePopover() {
    popover.style.display = 'none';
    lastAyahElem = null;
    popoverAyah = null;
    popoverSurah = null;
  }

  // Attach popover to ayah click
  document.addEventListener('click', function(e) {
    // If click is on an ayah
    if (e.target.classList.contains('ayah')) {
      e.preventDefault();
      e.stopPropagation();
      lastAyahElem = e.target;
      popoverAyah = parseInt(e.target.getAttribute('data-ayah'));
      popoverSurah = parseInt(e.target.getAttribute('data-surah'));
      // Position popover with smart viewport-aware positioning
      const rect = e.target.getBoundingClientRect();
      const scrollY = window.scrollY || window.pageYOffset;
      const scrollX = window.scrollX || window.pageXOffset;
      
      // Show popover first to get its dimensions
      popover.style.display = 'block';
      popover.style.visibility = 'hidden'; // Hide while positioning
      
      const popoverRect = popover.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Calculate initial position (centered above the ayah)
      let top = rect.top + scrollY - popoverRect.height - 8;
      let left = rect.left + scrollX + rect.width/2 - popoverRect.width/2;
      
      // Adjust horizontal position to stay within viewport
      const minLeft = 8; // 8px margin from left edge
      const maxLeft = viewportWidth - popoverRect.width - 8; // 8px margin from right edge
      left = Math.max(minLeft, Math.min(left, maxLeft));
      
      // Adjust vertical position for mobile and small screens
      const isMobile = viewportWidth <= 768;
      if (isMobile) {
        // On mobile, if there's not enough space above, position below
        if (top < 60) { // 60px from top to avoid header
          top = rect.bottom + scrollY + 8;
        }
        
        // Ensure popover doesn't go off bottom of screen
        if (top + popoverRect.height > scrollY + viewportHeight - 20) {
          top = scrollY + viewportHeight - popoverRect.height - 20;
        }
        
        // For very short verses on mobile, center the popover more
        if (rect.width < 50) {
          left = viewportWidth/2 - popoverRect.width/2;
        }
      } else {
        // Desktop: ensure popover stays within viewport vertically
        if (top < scrollY + 8) {
          top = rect.bottom + scrollY + 8; // Position below if not enough space above
        }
      }
      
      popover.style.top = top + 'px';
      popover.style.left = left + 'px';
      popover.style.visibility = 'visible';
      // Set direction and alignment based on language
      if (currentLang === 'en') {
        popover.style.direction = 'ltr';
        popover.style.textAlign = 'left';
        } else {
        popover.style.direction = 'rtl';
        popover.style.textAlign = 'right';
      }
      // Update menu text/icons based on current state
      const langIsAr = currentLang === 'ar';
      // Update tooltips based on current state and language
      document.getElementById('ayahMenuTranslation').title = isTranslationVisible ? (langIsAr ? ' ' : 'Hide Translation') : (langIsAr ? ' ' : 'Show Translation');
      document.getElementById('ayahMenuTafsir').title = isTafsirVisible ? (langIsAr ? ' ' : 'Hide Tafsir') : (langIsAr ? ' ' : 'Show Tafsir');
      // Bookmark icon and tooltip
      const isBookmarked = currentBookmark && currentBookmark.surah === popoverSurah && currentBookmark.ayah === popoverAyah;
      document.getElementById('ayahMenuBookmark').querySelector('i').className = isBookmarked ? 'fas fa-bookmark text-yellow-500' : 'far fa-bookmark';
      document.getElementById('ayahMenuBookmark').title = isBookmarked ? (langIsAr ? ' ' : 'Remove Bookmark') : (langIsAr ? ' ' : 'Bookmark');
      // Play/Stop icon and tooltip
      const isPlaying = window.currentAyahAudio && currentAudioSurah === popoverSurah && currentAudioAyah === popoverAyah && !window.currentAyahAudio.paused;
      const playBtn = document.getElementById('ayahMenuPlay');
      playBtn.querySelector('i').className = isPlaying ? 'fas fa-stop' : 'fas fa-play';
      playBtn.title = isPlaying ? (langIsAr ? ' ' : 'Stop Ayah') : (langIsAr ? ' ' : 'Play Ayah');
    } else if (!popover.contains(e.target)) {
      closePopover();
      }
    });
  // Hide popover on scroll
  window.addEventListener('scroll', closePopover);
  // Menu actions
  document.getElementById('ayahMenuPlay').onclick = function() {
    if (popoverSurah !== null && popoverAyah !== null) playAyahAudio(popoverSurah, popoverAyah);
    closePopover();
  };
  document.getElementById('ayahMenuTranslation').onclick = function() {
    if (popoverSurah !== null && popoverAyah !== null) {
      showTranslationModal(popoverSurah, popoverAyah);
    }
    closePopover();
  };
  document.getElementById('ayahMenuTafsir').onclick = function() {
    if (popoverSurah !== null && popoverAyah !== null) {
      showTafsirModal(popoverSurah, popoverAyah);
    }
    closePopover();
  };
  document.getElementById('ayahMenuBookmark').onclick = function() {
    if (popoverSurah !== null && popoverAyah !== null) bookmarkAyah(popoverSurah, popoverAyah);
    closePopover();
  };
})();

// Add tafsir modal functions
let currentTafsirSurah = null;
let currentTafsirAyah = null;

function showTafsirModal(surah, ayah) {
  const modal = document.getElementById('tafsirModal');
  const surahData = quranData[surah];
  const translationAyahs = translationData[surah];
  const ayahData = surahData.ayahs[ayah];
  const translationAyah = translationAyahs.ayahs[ayah];
  
  // Store current ayah for language change
  currentTafsirSurah = surah;
  currentTafsirAyah = ayah;
  
  // Set modal content
  document.getElementById('tafsirModalTitle').textContent = currentLang === 'ar' ? '' : 'Tafsir';
  document.getElementById('tafsirModalAyah').textContent = ayahData.text;
  document.getElementById('tafsirModalTranslation').textContent = translationAyah ? translationAyah.text : '';
  document.getElementById('tafsirModalContent').textContent = currentLang === 'ar' ? ' ...' : 'Loading...';
  
  // Show modal
  modal.style.display = 'flex';
  
  // Load tafsir
  loadTafsirContent();
}

function loadTafsirContent() {
  if (currentTafsirSurah !== null && currentTafsirAyah !== null) {
    getTafsirForAyah(currentTafsirSurah, currentTafsirAyah).then(tafsir => {
      document.getElementById('tafsirModalContent').textContent = tafsir.text || (currentLang === 'ar' ? '   ' : 'Tafsir not available');
    });
  }
}

function closeTafsirModal() {
  document.getElementById('tafsirModal').style.display = 'none';
  currentTafsirSurah = null;
  currentTafsirAyah = null;
}

// Close modal handlers
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('closeTafsirModal').onclick = closeTafsirModal;
  document.getElementById('tafsirModal').onclick = function(e) {
    if (e.target === this) closeTafsirModal();
  };
});

// Add translation modal functions
let currentTranslationSurah = null;
let currentTranslationAyah = null;

function showTranslationModal(surah, ayah) {
  const modal = document.getElementById('translationModal');
  const surahData = quranData[surah];
  const ayahData = surahData.ayahs[ayah];
  
  // Store current ayah for translation change
  currentTranslationSurah = surah;
  currentTranslationAyah = ayah;
  
  // Set modal content
  document.getElementById('translationModalTitle').textContent = currentLang === 'ar' ? '' : 'Translation';
  document.getElementById('translationModalAyah').textContent = ayahData.text;
  document.getElementById('translationModalContent').textContent = currentLang === 'ar' ? ' ...' : 'Loading...';
  
  // Show modal
  modal.style.display = 'flex';
  
  // Load translation
  loadTranslationContent();
}

function loadTranslationContent() {
  if (currentTranslationSurah !== null && currentTranslationAyah !== null) {
    const translationAyahs = translationData[currentTranslationSurah];
    const translationAyah = translationAyahs.ayahs[currentTranslationAyah];
    document.getElementById('translationModalContent').textContent = translationAyah ? translationAyah.text : (currentLang === 'ar' ? '   ' : 'No translation available');
  }
}

function closeTranslationModal() {
  document.getElementById('translationModal').style.display = 'none';
  currentTranslationSurah = null;
  currentTranslationAyah = null;
}

// Close modal handlers for translation modal
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('closeTranslationModal').onclick = closeTranslationModal;
  document.getElementById('translationModal').onclick = function(e) {
    if (e.target === this) closeTranslationModal();
  };
});

// Initialize translation modal dropdown
(function() {
  // Initialize translation language selector when modal is shown
  document.addEventListener('DOMContentLoaded', function() {
    const translationModal = document.getElementById('translationModal');
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
          const translationSelect = document.getElementById('translationSelect');
          if (translationModal.style.display === 'flex' && translationSelect) {
            translationSelect.value = currentTranslationKey;
            // Remove existing listeners to avoid duplicates
            translationSelect.onchange = function() {
              currentTranslationKey = this.value;
              // Reload translation data and content in modal
              handleTranslationChange(this.value).then(() => {
                document.getElementById('translationModalContent').textContent = currentLang === 'ar' ? ' ...' : 'Loading...';
                loadTranslationContent();
              });
            };
          }
        }
      });
    });
    observer.observe(translationModal, { attributes: true });
  });
})();

// Create an alias for backward compatibility
async function displayReadingModeAyahs(shouldScrollToBookmark = false, scrollToVerseId = null) {
  return displayReadingModeAyahsByPages(shouldScrollToBookmark, scrollToVerseId);
}

// Voice Search Functionality
let recognition = null;
let isListening = false;

// Comprehensive iOS Safari voice text normalization
function normalizeiOSVoiceText(text) {
  console.log('normalizeiOSVoiceText - input length:', text.length);
  console.log('normalizeiOSVoiceText - first 5 char codes:', 
    text.substring(0, 5).split('').map((char, i) => `${i}: "${char}" (${char.charCodeAt(0).toString(16)})`));
  
  let normalized = text
    // AGGRESSIVE invisible character removal - iOS Safari adds these at the beginning
    .replace(/^[\u0000-\u001F\u007F-\u009F\u00AD\u061C\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2800\u3000\uFEFF\uFFF9-\uFFFB]+/, '') // Remove leading control chars
    .replace(/[\u0000-\u001F\u007F-\u009F\u00AD\u061C\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2800\u3000\uFEFF\uFFF9-\uFFFB]/g, '') // Remove all control chars
    // Remove specific iOS Safari artifacts
    .replace(/^[\u200E\u200F\u202A\u202B\u202C\u202D\u202E]+/, '') // Remove leading RTL/LTR marks
    .replace(/[\u200E\u200F\u202A\u202B\u202C\u202D\u202E]/g, '') // Remove all RTL/LTR marks
    // Remove zero-width characters that iOS Safari loves to add
    .replace(/^[\u200B\u200C\u200D\uFEFF]+/, '') // Remove leading zero-width chars
    .replace(/[\u200B\u200C\u200D\uFEFF]/g, '') // Remove all zero-width chars
    // Remove non-breaking spaces and other space variants
    .replace(/[\u00A0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000]/g, ' ')
    // Normalize Unicode to NFD (decomposed) then to NFC (composed)
    .normalize('NFD').normalize('NFC')
    // Handle iOS Safari specific Arabic character issues
    .replace(/[\u064B-\u0652\u0670\u0640\u06D6-\u06ED\u08F0-\u08FF]/g, '') // Remove diacritics
    // Normalize specific problematic characters iOS Safari might produce
    .replace(/\u0627\u0644/g, '') // Ensure proper "al" (alef + lam)
    .replace(/\u0641\u0627\u062A\u062D/g, '') // Specific fix for ""
    .replace(/\u0641\u0627\u062A\u062D\u0629/g, '') // Specific fix for ""
    // Normalize alef variants
    .replace(/[\u0623\u0625\u0622\u0671]/g, '\u0627') //     -> 
    // Normalize other common variations
    .replace(/\u0629/g, '\u0647') //  -> 
    // Final cleanup - remove any remaining control characters
    .replace(/[\u0000-\u001F\u007F-\u009F]/g, '')
    // Trim whitespace
    .trim();
  
  console.log('normalizeiOSVoiceText - output length:', normalized.length);
  console.log('normalizeiOSVoiceText - output char codes:', 
    normalized.split('').map((char, i) => `${i}: "${char}" (${char.charCodeAt(0).toString(16)})`));
  
  return normalized;
}

// Enhanced voice search function for iOS Safari compatibility
function performEnhancedVoiceSearch(transcript) {
  console.log('Enhanced voice search - original transcript:', transcript);
  console.log('Enhanced voice search - transcript length:', transcript.length);
  
  // Detailed character analysis
  console.log('Enhanced voice search - character codes:', 
    transcript.split('').map((char, i) => `${i}: "${char}" (${char.charCodeAt(0).toString(16)})`));
  
  // Clean up the transcript for iOS Safari issues
  let cleanedTranscript = transcript
    // Remove any invisible characters that iOS Safari might add
    .replace(/[\u200B-\u200D\uFEFF]/g, '')
    // Remove any extra whitespace
    .replace(/\s+/g, ' ')
    .trim();
  
  console.log('Enhanced voice search - cleaned transcript:', cleanedTranscript);
  console.log('Enhanced voice search - cleaned character codes:', 
    cleanedTranscript.split('').map((char, i) => `${i}: "${char}" (${char.charCodeAt(0).toString(16)})`));
  
  // Let's also check what's in our surah data for comparison
  const searchData = surahsData.length > 0 ? surahsData : quickSurahList;
  const fatihaInData = searchData.find(s => s.name && s.name.includes(''));
  if (fatihaInData) {
    console.log('Enhanced voice search - Al-Fatiha in data:', fatihaInData.name);
    console.log('Enhanced voice search - Al-Fatiha character codes:', 
      fatihaInData.name.split('').map((char, i) => `${i}: "${char}" (${char.charCodeAt(0).toString(16)})`));
  }
  
  // Apply comprehensive iOS Safari character normalization
  const normalizedTranscript = normalizeiOSVoiceText(cleanedTranscript);
  console.log('Enhanced voice search - iOS normalized transcript:', normalizedTranscript);
  console.log('Enhanced voice search - iOS normalized character codes:', 
    normalizedTranscript.split('').map((char, i) => `${i}: "${char}" (${char.charCodeAt(0).toString(16)})`));
  
  // Try the regular search first with normalized text
  searchSurahs(normalizedTranscript);
  
  // Check if we got results
  setTimeout(() => {
    const surahList = document.getElementById('surahList');
    const hasResults = surahList.children.length > 0 && 
                      !surahList.innerHTML.includes('  ') && 
                      !surahList.innerHTML.includes('No results');
    
    console.log('Enhanced voice search - has results after regular search:', hasResults);
    
    if (!hasResults) {
      console.log('Enhanced voice search - no results, trying enhanced matching');
      
      // Try enhanced matching for Arabic text
      const searchData = surahsData.length > 0 ? surahsData : quickSurahList;
      const enhancedResults = searchData.filter(surah => {
        const arabicName = surah.name || '';
        const englishName = surah.englishName || '';
        
                 // Create multiple search variants using normalized transcript
         const searchVariants = [
           normalizedTranscript,
           normalizeArabicText(normalizedTranscript),
           normalizedTranscript.replace(/^/, ''), // Remove "al" prefix
           '' + normalizedTranscript, // Add "al" prefix
           normalizedTranscript.replace(/[]/g, ''), // Normalize Alef
           normalizedTranscript.replace(//g, ''), // Normalize Teh Marbuta
           // Enhanced hamza normalization for voice recognition
           normalizedTranscript.replace(//g, ''), //  ->  (for  -> )
           normalizedTranscript.replace(/([])/g, '$1'), // Add hamza before consonants
           normalizedTranscript.replace(//g, ''), // Remove standalone hamza
           normalizedTranscript.replace(/[]/g, ''), // Remove all hamza variants
           // Also include the original cleaned transcript as fallback
           cleanedTranscript,
           normalizeArabicText(cleanedTranscript),
         ];
        
        // Check each variant against surah names
        return searchVariants.some(variant => {
          if (!variant || variant.length === 0) return false;
          
                     // Flexible matching - check if variant is contained in surah name or vice versa
           const normalizedArabic = normalizeArabicText(arabicName);
           const normalizedVariant = normalizeArabicText(variant);
           
           // Additional hamza-agnostic normalization for both search and surah name
           const hamzaFreeArabic = normalizedArabic.replace(/[]/g, '');
           const hamzaFreeVariant = normalizedVariant.replace(/[]/g, '');
           
           return (
             arabicName.includes(variant) ||
             normalizedArabic.includes(normalizedVariant) ||
             variant.includes(arabicName) ||
             normalizedVariant.includes(normalizedArabic) ||
             englishName.toLowerCase().includes(variant.toLowerCase()) ||
             variant.toLowerCase().includes(englishName.toLowerCase()) ||
             // Hamza-agnostic matching (key for voice recognition)
             hamzaFreeArabic.includes(hamzaFreeVariant) ||
             hamzaFreeVariant.includes(hamzaFreeArabic) ||
             // Partial matching for better voice recognition results
             (normalizedVariant.length >= 3 && normalizedArabic.includes(normalizedVariant)) ||
             (normalizedArabic.length >= 3 && normalizedVariant.includes(normalizedArabic)) ||
             // Hamza-free partial matching
             (hamzaFreeVariant.length >= 3 && hamzaFreeArabic.includes(hamzaFreeVariant)) ||
             (hamzaFreeArabic.length >= 3 && hamzaFreeVariant.includes(hamzaFreeArabic))
           );
        });
      });
      
      console.log('Enhanced voice search - enhanced results count:', enhancedResults.length);
      
             if (enhancedResults.length > 0) {
         populateSurahList(enhancedResults);
       } else {
         // LAST RESORT: Try progressively removing characters from the beginning
         console.log('Enhanced voice search - trying progressive character removal');
         let foundMatch = false;
         
         for (let i = 1; i <= Math.min(5, normalizedTranscript.length); i++) {
           const strippedText = normalizedTranscript.substring(i);
           console.log(`Enhanced voice search - trying without first ${i} chars: "${strippedText}"`);
           
           if (strippedText.length >= 2) { // Only try if we have at least 2 characters left
             const progressiveResults = searchData.filter(surah => {
               const arabicName = surah.name || '';
               const normalizedArabic = normalizeArabicText(arabicName);
               const normalizedStripped = normalizeArabicText(strippedText);
               
               return (
                 arabicName.includes(strippedText) ||
                 normalizedArabic.includes(normalizedStripped) ||
                 strippedText.includes(arabicName) ||
                 normalizedStripped.includes(normalizedArabic)
               );
             });
             
             if (progressiveResults.length > 0) {
               console.log(`Enhanced voice search - found match after removing ${i} chars!`);
               populateSurahList(progressiveResults);
               foundMatch = true;
               break;
             }
           }
         }
         
         if (!foundMatch) {
           // Absolute last resort: show all surahs with a message
           console.log('Enhanced voice search - no matches found even with progressive removal, showing all surahs');
           const surahList = document.getElementById('surahList');
           populateSurahList(searchData);
           
           // Add a message at the top
           const messageDiv = document.createElement('div');
           messageDiv.className = 'p-3 mb-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg text-center';
           messageDiv.innerHTML = `
             <p class="text-sm text-yellow-700 dark:text-yellow-300">
               ${currentLang === 'ar' ? 
                 `    "${normalizedTranscript}" -   ` : 
                 `"${normalizedTranscript}" not found - showing all surahs`
               }
             </p>
           `;
           surahList.insertBefore(messageDiv, surahList.firstChild);
         }
       }
    }
  }, 50);
}

// Function to find the best Surah match from voice alternatives
function findBestSurahMatch(alternatives) {
  if (!alternatives || alternatives.length === 0) return null;
  
  // Get all Surah names in both Arabic and English
  const surahNames = [];
  
  // Add from surahsData if available
  if (surahsData && surahsData.length > 0) {
    surahsData.forEach(surah => {
      if (surah.name) surahNames.push(surah.name);
      if (surah.englishName) surahNames.push(surah.englishName);
      if (surah.englishNameTranslation) surahNames.push(surah.englishNameTranslation);
    });
  }
  
  // Add from quickSurahList if available
  if (quickSurahList && quickSurahList.length > 0) {
    quickSurahList.forEach(surah => {
      if (surah.name) surahNames.push(surah.name);
      if (surah.englishName) surahNames.push(surah.englishName);
      if (surah.englishNameTranslation) surahNames.push(surah.englishNameTranslation);
    });
  }
  
  // Common Surah names as fallback
  const commonSurahNames = [
    '', 'Al-Fatiha', 'Fatiha', 'The Opening',
    '', 'Al-Baqarah', 'Baqarah', 'The Cow',
    ' ', 'Al-Imran', 'Imran', 'Family of Imran',
    '', 'An-Nisa', 'Nisa', 'The Women',
    '', 'Al-Maidah', 'Maidah', 'The Table Spread',
    '', 'Al-Anam', 'Anam', 'The Cattle',
    '', 'Al-Araf', 'Araf', 'The Heights',
    '', 'Al-Anfal', 'Anfal', 'The Spoils of War',
    '', 'At-Tawbah', 'Tawbah', 'The Repentance',
    '', 'Yunus', 'Jonah',
    '', 'Hud',
    '', 'Yusuf', 'Joseph',
    '', 'Ar-Rad', 'Rad', 'The Thunder',
    '', 'Ibrahim', 'Abraham',
    '', 'Al-Hijr', 'Hijr', 'The Rocky Tract',
    '', 'An-Nahl', 'Nahl', 'The Bee',
    '', 'Al-Isra', 'Isra', 'The Night Journey',
    '', 'Al-Kahf', 'Kahf', 'The Cave',
    '', 'Maryam', 'Mary',
    '', 'Ta-Ha', 'Taha',
    '', 'Al-Anbiya', 'Anbiya', 'The Prophets',
    '', 'Al-Hajj', 'Hajj', 'The Pilgrimage',
    '', 'Al-Muminun', 'Muminun', 'The Believers',
    '', 'An-Nur', 'Nur', 'The Light',
    '', 'Al-Furqan', 'Furqan', 'The Criterion',
    '', 'Ash-Shuara', 'Shuara', 'The Poets',
    '', 'An-Naml', 'Naml', 'The Ant',
    '', 'Al-Qasas', 'Qasas', 'The Stories',
    '', 'Al-Ankabut', 'Ankabut', 'The Spider',
    '', 'Ar-Rum', 'Rum', 'The Romans',
    '', 'Luqman',
    '', 'As-Sajdah', 'Sajdah', 'The Prostration',
    '', 'Al-Ahzab', 'Ahzab', 'The Clans',
    '', 'Saba', 'Sheba',
    '', 'Fatir', 'Originator',
    '', 'Ya-Sin', 'Yasin',
    '', 'As-Saffat', 'Saffat', 'Those Ranged in Ranks',
    '', 'Sad',
    '', 'Az-Zumar', 'Zumar', 'The Groups',
    '', 'Ghafir', 'The Forgiver',
    '', 'Fussilat', 'Explained in Detail',
    '', 'Ash-Shura', 'Shura', 'The Consultation',
    '', 'Az-Zukhruf', 'Zukhruf', 'The Gold Adornments',
    '', 'Ad-Dukhan', 'Dukhan', 'The Smoke',
    '', 'Al-Jathiyah', 'Jathiyah', 'The Kneeling',
    '', 'Al-Ahqaf', 'Ahqaf', 'The Wind-Curved Sandhills',
    '', 'Muhammad',
    '', 'Al-Fath', 'Fath', 'The Victory',
    '', 'Al-Hujurat', 'Hujurat', 'The Rooms',
    '', 'Qaf',
    '', 'Adh-Dhariyat', 'Dhariyat', 'The Wind That Scatter',
    '', 'At-Tur', 'Tur', 'The Mount',
    '', 'An-Najm', 'Najm', 'The Star',
    '', 'Al-Qamar', 'Qamar', 'The Moon',
    '', 'Ar-Rahman', 'Rahman', 'The Most Merciful',
    '', 'Al-Waqiah', 'Waqiah', 'The Event',
    '', 'Al-Hadid', 'Hadid', 'The Iron',
    '', 'Al-Mujadilah', 'Mujadilah', 'The Pleading Woman',
    '', 'Al-Hashr', 'Hashr', 'The Exile',
    '', 'Al-Mumtahanah', 'Mumtahanah', 'She That Is To Be Examined',
    '', 'As-Saff', 'Saff', 'The Ranks',
    '', 'Al-Jumuah', 'Jumuah', 'The Friday',
    '', 'Al-Munafiqun', 'Munafiqun', 'The Hypocrites',
    '', 'At-Taghabun', 'Taghabun', 'The Mutual Disillusion',
    '', 'At-Talaq', 'Talaq', 'The Divorce',
    '', 'At-Tahrim', 'Tahrim', 'The Prohibition',
    '', 'Al-Mulk', 'Mulk', 'The Sovereignty',
    '', 'Al-Qalam', 'Qalam', 'The Pen',
    '', 'Al-Haqqah', 'Haqqah', 'The Reality',
    '', 'Al-Maarij', 'Maarij', 'The Ascending Stairways',
    '', 'Nuh', 'Noah',
    '', 'Al-Jinn', 'Jinn', 'The Jinn',
    '', 'Al-Muzzammil', 'Muzzammil', 'The Enshrouded One',
    '', 'Al-Muddaththir', 'Muddaththir', 'The Cloaked One',
    '', 'Al-Qiyamah', 'Qiyamah', 'The Resurrection',
    '', 'Al-Insan', 'Insan', 'The Man',
    '', 'Al-Mursalat', 'Mursalat', 'The Emissaries',
    '', 'An-Naba', 'Naba', 'The Tidings',
    '', 'An-Naziat', 'Naziat', 'Those Who Drag Forth',
    '', 'Abasa', 'He Frowned',
    '', 'At-Takwir', 'Takwir', 'The Overthrowing',
    '', 'Al-Infitar', 'Infitar', 'The Cleaving',
    '', 'Al-Mutaffifin', 'Mutaffifin', 'The Defrauding',
    '', 'Al-Inshiqaq', 'Inshiqaq', 'The Splitting Open',
    '', 'Al-Buruj', 'Buruj', 'The Mansions of the Stars',
    '', 'At-Tariq', 'Tariq', 'The Morning Star',
    '', 'Al-Ala', 'Ala', 'The Most High',
    '', 'Al-Ghashiyah', 'Ghashiyah', 'The Overwhelming',
    '', 'Al-Fajr', 'Fajr', 'The Dawn',
    '', 'Al-Balad', 'Balad', 'The City',
    '', 'Ash-Shams', 'Shams', 'The Sun',
    '', 'Al-Layl', 'Layl', 'The Night',
    '', 'Ad-Duha', 'Duha', 'The Morning Hours',
    '', 'Ash-Sharh', 'Sharh', 'The Relief',
    '', 'At-Tin', 'Tin', 'The Fig',
    '', 'Al-Alaq', 'Alaq', 'The Clot',
    '', 'Al-Qadr', 'Qadr', 'The Power',
    '', 'Al-Bayyinah', 'Bayyinah', 'The Clear Proof',
    '', 'Az-Zalzalah', 'Zalzalah', 'The Earthquake',
    '', 'Al-Adiyat', 'Adiyat', 'The Courser',
    '', 'Al-Qariah', 'Qariah', 'The Calamity',
    '', 'At-Takathur', 'Takathur', 'The Rivalry in World Increase',
    '', 'Al-Asr', 'Asr', 'The Declining Day',
    '', 'Al-Humazah', 'Humazah', 'The Traducer',
    '', 'Al-Fil', 'Fil', 'The Elephant',
    '', 'Quraysh',
    '', 'Al-Maun', 'Maun', 'The Small Kindnesses',
    '', 'Al-Kawthar', 'Kawthar', 'The Abundance',
    '', 'Al-Kafirun', 'Kafirun', 'The Disbelievers',
    '', 'An-Nasr', 'Nasr', 'The Divine Support',
    '', 'Al-Masad', 'Masad', 'The Palm Fiber',
    '', 'Al-Ikhlas', 'Ikhlas', 'The Sincerity',
    '', 'Al-Falaq', 'Falaq', 'The Daybreak',
    '', 'An-Nas', 'Nas', 'The Mankind'
  ];
  
  // Combine all available names
  const allNames = [...new Set([...surahNames, ...commonSurahNames])];
  
  console.log('Available Surah names for matching:', allNames.length);
  
  let bestMatch = null;
  let bestScore = 0;
  
  // Check each alternative against all Surah names
  for (const alternative of alternatives) {
    for (const surahName of allNames) {
      const score = calculateSimilarity(alternative.toLowerCase(), surahName.toLowerCase());
      if (score > bestScore && score > 0.3) { // Minimum similarity threshold
        bestScore = score;
        bestMatch = alternative;
      }
    }
  }
  
  console.log('Best match found:', bestMatch, 'with score:', bestScore);
  return bestMatch;
}

// Enhanced similarity calculation with phonetic matching
function calculateSimilarity(str1, str2) {
  // Normalize Arabic text
  str1 = str1.replace(/[]/g, '').replace(/[]/g, '').replace(//g, '');
  str2 = str2.replace(/[]/g, '').replace(/[]/g, '').replace(//g, '');
  
  // Check for exact match or substring
  if (str1 === str2) return 1.0;
  if (str1.includes(str2) || str2.includes(str1)) return 0.8;
  
  // Phonetic similarity for common voice recognition errors
  const phoneticScore = calculatePhoneticSimilarity(str1, str2);
  if (phoneticScore > 0.6) return phoneticScore;
  
  // Calculate Levenshtein distance
  const matrix = [];
  const len1 = str1.length;
  const len2 = str2.length;
  
  if (len1 === 0) return len2 === 0 ? 1 : 0;
  if (len2 === 0) return 0;
  
  // Initialize matrix
  for (let i = 0; i <= len1; i++) {
    matrix[i] = [i];
  }
  for (let j = 0; j <= len2; j++) {
    matrix[0][j] = j;
  }
  
  // Fill matrix
  for (let i = 1; i <= len1; i++) {
    for (let j = 1; j <= len2; j++) {
      const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
      matrix[i][j] = Math.min(
        matrix[i - 1][j] + 1,      // deletion
        matrix[i][j - 1] + 1,      // insertion
        matrix[i - 1][j - 1] + cost // substitution
      );
    }
  }
  
  const distance = matrix[len1][len2];
  const maxLength = Math.max(len1, len2);
  return (maxLength - distance) / maxLength;
}

// Calculate phonetic similarity for common voice recognition errors
function calculatePhoneticSimilarity(voiceInput, surahName) {
  // Common phonetic mappings for Arabic names misheard as English
  const phoneticMappings = {
         // Al-Fatiha variants
     'a lot': ['al-faatiha', 'al fatiha', 'alfatiha', 'fatiha'],
     'alot': ['al-faatiha', 'al fatiha', 'alfatiha', 'fatiha'],
     'a lot of': ['al-faatiha', 'al fatiha', 'fatiha'],
     'allah': ['al-faatiha', 'al fatiha', 'fatiha'],
     'al fatiha': ['al-faatiha', 'fatiha'],
     'alfatiha': ['al-faatiha', 'fatiha'],
     'fatiha': ['al-faatiha', 'fatiha'],
    
         // Al-Baqarah variants
     'back': ['al-baqara', 'baqara', 'bakara'],
     'back are': ['al-baqara', 'baqara'],
     'baker': ['al-baqara', 'baqara', 'bakara'],
     'backer': ['al-baqara', 'baqara'],
     'baqara': ['al-baqara', 'baqara'],
     'bakara': ['al-baqara', 'baqara'],
    
    // Al-Imran variants
    'all run': ['al-imran', 'imran'],
    'all ran': ['al-imran', 'imran'],
    'elmer': ['al-imran', 'imran'],
    'alimran': ['al-imran', 'imran'],
    
    // An-Nisa variants
    'and lisa': ['an-nisa', 'nisa'],
    'anissa': ['an-nisa', 'nisa'],
    'a lisa': ['an-nisa', 'nisa'],
    
    // Al-Maidah variants
    'my dad': ['al-maidah', 'maidah'],
    'my data': ['al-maidah', 'maidah'],
    'almighty': ['al-maidah', 'maidah'],
    
    // Al-Anam variants
    'and am': ['al-anam', 'anam'],
    'annam': ['al-anam', 'anam'],
    'and i am': ['al-anam', 'anam'],
    
    // Al-Araf variants
    'all rough': ['al-araf', 'araf'],
    'allraf': ['al-araf', 'araf'],
    'a rough': ['al-araf', 'araf'],
    
    // Al-Anfal variants
    'and fall': ['al-anfal', 'anfal'],
    'and fell': ['al-anfal', 'anfal'],
    'awful': ['al-anfal', 'anfal'],
    
    // At-Tawbah variants
    'at toba': ['at-tawbah', 'tawbah'],
    'at tuba': ['at-tawbah', 'tawbah'],
    'a tuba': ['at-tawbah', 'tawbah'],
    
    // Yunus variants
    'you miss': ['yunus', 'jonas'],
    'you ness': ['yunus', 'jonas'],
    'jonas': ['yunus', 'jonas'],
    
    // Yusuf variants
    'you surf': ['yusuf', 'joseph'],
    'joseph': ['yusuf', 'joseph'],
    'you suf': ['yusuf', 'joseph'],
    
    // Ibrahim variants
    'abraham': ['ibrahim'],
    'abe': ['ibrahim'],
    'ibrahim': ['ibrahim'],
    
    // Al-Kahf variants
    'all calf': ['al-kahf', 'kahf'],
    'all half': ['al-kahf', 'kahf'],
    'al calf': ['al-kahf', 'kahf'],
    
    // Maryam variants
    'mary': ['maryam'],
    'maria': ['maryam'],
    'marry': ['maryam'],
    
    // Ta-Ha variants
    'ta ha': ['ta-ha', 'taha'],
    'taha': ['ta-ha', 'taha'],
    'ta-ha': ['ta-ha', 'taha'],
    
    // Ya-Sin variants
    'ya sin': ['ya-sin', 'yasin'],
    'yasin': ['ya-sin', 'yasin'],
    'ya seen': ['ya-sin', 'yasin'],
    'yes in': ['ya-sin', 'yasin'],
    
         // Muhammad variants
     'muhammad': ['muhammad'],
     'mohamed': ['muhammad'],
     'mohammed': ['muhammad'],
     
     // Az-Zumar variants
     'azumar': ['az-zumar', 'zumar'],
     'azuma': ['az-zumar', 'zumar'],
     'ozumo': ['az-zumar', 'zumar'],
     'azumah': ['az-zumar', 'zumar'],
     'izumo': ['az-zumar', 'zumar'],
     'zumar': ['az-zumar', 'zumar'],
    
    // Ar-Rahman variants
    'our man': ['ar-rahman', 'rahman'],
    'rahman': ['ar-rahman', 'rahman'],
    'our rahman': ['ar-rahman', 'rahman'],
    
    // Al-Ikhlas variants
    'all class': ['al-ikhlas', 'ikhlas'],
    'all close': ['al-ikhlas', 'ikhlas'],
    'a class': ['al-ikhlas', 'ikhlas'],
    
         // An-Nas variants
     'and us': ['an-nas', 'nas'],
     'and nas': ['an-nas', 'nas'],
     'a nas': ['an-nas', 'nas'],
     'anas': ['an-nas', 'nas'],
     'nas': ['an-nas', 'nas'],
     'agnes': ['an-nas', 'nas'],
     'agnus': ['an-nas', 'nas'],
     'honest': ['an-nas', 'nas'],
    
         // Al-Falaq variants
     'all flack': ['al-falaq', 'falaq'],
     'all flag': ['al-falaq', 'falaq'],
     'a flag': ['al-falaq', 'falaq'],
     'falak': ['al-falaq', 'falaq'],
     'flak': ['al-falaq', 'falaq'],
     
     // Additional common misheard variants
     'cow': ['al-baqarah', 'baqarah'],
     'the cow': ['al-baqarah', 'baqarah'],
     'women': ['an-nisa', 'nisa'],
     'the women': ['an-nisa', 'nisa'],
     'cave': ['al-kahf', 'kahf'],
     'the cave': ['al-kahf', 'kahf'],
     'light': ['an-nur', 'nur'],
     'the light': ['an-nur', 'nur'],
     'iron': ['al-hadid', 'hadid'],
     'the iron': ['al-hadid', 'hadid'],
     'moon': ['al-qamar', 'qamar'],
     'the moon': ['al-qamar', 'qamar'],
     'sun': ['ash-shams', 'shams'],
     'the sun': ['ash-shams', 'shams'],
     'night': ['al-layl', 'layl'],
     'the night': ['al-layl', 'layl'],
     'dawn': ['al-fajr', 'fajr'],
     'the dawn': ['al-fajr', 'fajr'],
     'elephant': ['al-fil', 'fil'],
     'the elephant': ['al-fil', 'fil'],
     'opening': ['al-fatiha', 'fatiha'],
     'the opening': ['al-fatiha', 'fatiha']
  };
  
  const voiceLower = voiceInput.toLowerCase().trim();
  const surahLower = surahName.toLowerCase().trim();
  
  // Check if voice input matches any phonetic mapping
  if (phoneticMappings[voiceLower]) {
    for (const variant of phoneticMappings[voiceLower]) {
      if (surahLower.includes(variant) || variant.includes(surahLower)) {
        return 0.9; // High confidence for phonetic matches
      }
    }
  }
  
  // Check reverse mapping (if surah name is in the phonetic alternatives)
  for (const [key, variants] of Object.entries(phoneticMappings)) {
    if (variants.some(variant => 
      surahLower.includes(variant) || variant.includes(surahLower)
    )) {
      if (voiceLower.includes(key) || key.includes(voiceLower)) {
        return 0.9;
      }
    }
  }
  
  return 0;
}

// Convert phonetically matched voice input to proper Surah name
function convertPhoneticToSurahName(voiceInput) {
  const phoneticMappings = {
         // Al-Fatiha variants
     'a lot': 'Al-Faatiha',
     'alot': 'Al-Faatiha',
     'a lot of': 'Al-Faatiha',
     'allah': 'Al-Faatiha',
     'al fatiha': 'Al-Faatiha',
     'alfatiha': 'Al-Faatiha',
     'fatiha': 'Al-Faatiha',
    
         // Al-Baqarah variants
     'back': 'Al-Baqara',
     'back are': 'Al-Baqara',
     'baker': 'Al-Baqara',
     'backer': 'Al-Baqara',
     'baqara': 'Al-Baqara',
     'bakara': 'Al-Baqara',
    
    // Al-Imran variants
    'all run': 'Al-Imran',
    'all ran': 'Al-Imran',
    'elmer': 'Al-Imran',
    'alimran': 'Al-Imran',
    
    // An-Nisa variants
    'and lisa': 'An-Nisa',
    'anissa': 'An-Nisa',
    'anisa': 'An-Nisa',
    'aneesa': 'An-Nisa',
    'annisa': 'An-Nisa',
    'enisa': 'An-Nisa',
    'a lisa': 'An-Nisa',
    
    // Al-Maidah variants
    'my dad': 'Al-Maidah',
    'my data': 'Al-Maidah',
    'almighty': 'Al-Maidah',
    
    // Al-Anam variants
    'and am': 'Al-Anam',
    'annam': 'Al-Anam',
    'and i am': 'Al-Anam',
    
    // Al-Araf variants
    'all rough': 'Al-Araf',
    'allraf': 'Al-Araf',
    'a rough': 'Al-Araf',
    
    // Al-Anfal variants
    'and fall': 'Al-Anfal',
    'and fell': 'Al-Anfal',
    'awful': 'Al-Anfal',
    
    // At-Tawbah variants
    'at toba': 'At-Tawbah',
    'at tuba': 'At-Tawbah',
    'a tuba': 'At-Tawbah',
    
    // Yunus variants
    'you miss': 'Yunus',
    'you ness': 'Yunus',
    'jonas': 'Yunus',
    
    // Yusuf variants
    'you surf': 'Yusuf',
    'joseph': 'Yusuf',
    'you suf': 'Yusuf',
    
    // Ibrahim variants
    'abraham': 'Ibrahim',
    'abe': 'Ibrahim',
    
    // Al-Kahf variants
    'all calf': 'Al-Kahf',
    'all half': 'Al-Kahf',
    'al calf': 'Al-Kahf',
    
    // Maryam variants
    'mary': 'Maryam',
    'maria': 'Maryam',
    'marry': 'Maryam',
    
    // Ta-Ha variants
    'ta ha': 'Ta-Ha',
    'taha': 'Ta-Ha',
    
    // Ya-Sin variants
    'ya sin': 'Ya-Sin',
    'yasin': 'Ya-Sin',
    'ya seen': 'Ya-Sin',
    'yes in': 'Ya-Sin',
    
         // Muhammad variants
     'mohamed': 'Muhammad',
     'mohammed': 'Muhammad',
     
     // Az-Zumar variants
     'azumar': 'Az-Zumar',
     'azuma': 'Az-Zumar',
     'ozumo': 'Az-Zumar',
     'azumah': 'Az-Zumar',
     'izumo': 'Az-Zumar',
     'zumar': 'Az-Zumar',
    
    // Ar-Rahman variants
    'our man': 'Ar-Rahman',
    'rahman': 'Ar-Rahman',
    'our rahman': 'Ar-Rahman',
    
    // Al-Ikhlas variants
    'all class': 'Al-Ikhlas',
    'all close': 'Al-Ikhlas',
    'a class': 'Al-Ikhlas',
    
         // An-Nas variants
     'and us': 'An-Nas',
     'and nas': 'An-Nas',
     'a nas': 'An-Nas',
     'anas': 'An-Nas',
     'nas': 'An-Nas',
     'agnes': 'An-Nas',
     'agnus': 'An-Nas',
     'honest': 'An-Nas',
    
         // Al-Falaq variants
     'all flack': 'Al-Falaq',
     'all flag': 'Al-Falaq',
     'a flag': 'Al-Falaq',
     'falak': 'Al-Falaq',
     'flak': 'Al-Falaq',
     
     // Additional common misheard variants
     'cow': 'Al-Baqarah',
     'the cow': 'Al-Baqarah',
     'women': 'An-Nisa',
     'the women': 'An-Nisa',
     'cave': 'Al-Kahf',
     'the cave': 'Al-Kahf',
     'light': 'An-Nur',
     'the light': 'An-Nur',
     'iron': 'Al-Hadid',
     'the iron': 'Al-Hadid',
     'moon': 'Al-Qamar',
     'the moon': 'Al-Qamar',
     'sun': 'Ash-Shams',
     'the sun': 'Ash-Shams',
     'night': 'Al-Layl',
     'the night': 'Al-Layl',
     'dawn': 'Al-Fajr',
     'the dawn': 'Al-Fajr',
     'elephant': 'Al-Fil',
     'the elephant': 'Al-Fil',
     'opening': 'Al-Fatiha',
     'the opening': 'Al-Fatiha'
  };
  
  const voiceLower = voiceInput.toLowerCase().trim();
  const mapped = phoneticMappings[voiceLower];
  
  if (mapped) {
    console.log(`Voice search - Phonetic conversion: "${voiceInput}"  "${mapped}"`);
    return mapped;
  }
  
  // If no phonetic mapping, try to standardize the format
  // Handle case variations like "al-fatiha"  "Al-Fatiha"
  if (voiceLower.startsWith('al-') || voiceLower.startsWith('an-') || voiceLower.startsWith('at-') || voiceLower.startsWith('ar-') || voiceLower.startsWith('as-') || voiceLower.startsWith('ash-')) {
    const parts = voiceInput.split('-');
    if (parts.length >= 2) {
      const prefix = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
      const suffix = parts[1].charAt(0).toUpperCase() + parts[1].slice(1).toLowerCase();
      const standardized = `${prefix}-${suffix}`;
      console.log(`Voice search - Case standardization: "${voiceInput}"  "${standardized}"`);
      return standardized;
    }
  }
  
  // Capitalize first letter for single words
  const capitalized = voiceInput.charAt(0).toUpperCase() + voiceInput.slice(1).toLowerCase();
  if (capitalized !== voiceInput) {
    console.log(`Voice search - Capitalization: "${voiceInput}"  "${capitalized}"`);
    return capitalized;
  }
  
  return voiceInput;
}

function initVoiceSearch() {
  // Check if browser supports speech recognition
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    // Configure speech recognition
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 5; // Get more alternatives for better matching
    
    // Set language based on current app language
    recognition.lang = currentLang === 'ar' ? 'ar-SA' : 'en-US';
    
    // Handle speech recognition results
    recognition.onresult = function(event) {
      // Get all alternatives and find the best match
      const alternatives = [];
      for (let i = 0; i < event.results[0].length; i++) {
        alternatives.push(event.results[0][i].transcript.trim());
      }
      
      console.log('Voice alternatives:', alternatives);
      
      // Find the best matching alternative against Surah names
      const bestMatch = findBestSurahMatch(alternatives);
      let transcript = bestMatch || alternatives[0];
      
      // Convert phonetic matches to proper Surah names
      transcript = convertPhoneticToSurahName(transcript);
      
      console.log('Voice input - best match:', transcript);
      console.log('Voice search - transcript length:', transcript.length);
      console.log('Voice search - transcript characters:', transcript.split('').map(c => c.charCodeAt(0)));
      
      // Set the search input value
      const searchInput = document.getElementById('surahSearchInput');
      searchInput.value = transcript;
      
      // Mobile-specific delay to ensure DOM is ready
      setTimeout(() => {
        console.log('Voice search - triggering search after delay');
        console.log('Voice search - input value after set:', searchInput.value);
        
        // Try multiple event types for better mobile compatibility
        const inputEvent = new Event('input', { bubbles: true, cancelable: true });
        const changeEvent = new Event('change', { bubbles: true, cancelable: true });
        const keyupEvent = new Event('keyup', { bubbles: true, cancelable: true });
        
        searchInput.dispatchEvent(inputEvent);
        searchInput.dispatchEvent(changeEvent);
        searchInput.dispatchEvent(keyupEvent);
        
                 // Direct function call with additional debugging
         console.log('Voice search - calling searchSurahs directly with:', transcript);
         console.log('Voice search - surahsData length:', surahsData ? surahsData.length : 'undefined');
         console.log('Voice search - quickSurahList length:', quickSurahList ? quickSurahList.length : 'undefined');
         
         // Ensure surah data is available before searching
         if ((!surahsData || surahsData.length === 0) && (!quickSurahList || quickSurahList.length === 0)) {
           console.log('Voice search - no surah data available, initializing...');
           // Try to initialize surah menu first
           if (typeof initializeSurahMenu === 'function') {
             initializeSurahMenu();
           }
           // Wait a bit more and try again
           setTimeout(() => {
             console.log('Voice search - retrying search after initialization');
             performEnhancedVoiceSearch(transcript);
           }, 200);
         } else {
           // Debug: Log the first few Surah names to see the format
           if (surahsData && surahsData.length > 0) {
             console.log('Voice search - Sample Surah data format:');
             console.log('First Surah:', surahsData[0]);
             console.log('Second Surah:', surahsData[1]);
           }
           if (quickSurahList && quickSurahList.length > 0) {
             console.log('Voice search - Sample quickSurahList format:');
             console.log('First item:', quickSurahList[0]);
           }
           performEnhancedVoiceSearch(transcript);
         }
        
        // Additional check to see if search worked
        setTimeout(() => {
          const surahList = document.getElementById('surahList');
          console.log('Voice search - surah list content after search:', surahList.innerHTML.length > 0 ? 'Has content' : 'Empty');
        }, 100);
        
      }, 100); // 100ms delay for mobile browsers
      
      // Stop listening
      stopVoiceSearch();
      
      // Show success feedback
      showVoiceSearchFeedback('success', currentLang === 'ar' ? '  : ' + transcript : 'Searching for: ' + transcript);
    };
    
    // Handle speech recognition errors
    recognition.onerror = function(event) {
      console.error('Speech recognition error:', event.error);
      stopVoiceSearch();
      
      let errorMessage = '';
      switch(event.error) {
        case 'no-speech':
          errorMessage = currentLang === 'ar' ? '   ' : 'No speech detected';
          break;
        case 'audio-capture':
          errorMessage = currentLang === 'ar' ? '   ' : 'Microphone not accessible';
          break;
        case 'not-allowed':
          errorMessage = currentLang === 'ar' ? '   ' : 'Microphone permission denied';
          break;
        default:
          errorMessage = currentLang === 'ar' ? '   ' : 'Voice search error';
      }
      
      showVoiceSearchFeedback('error', errorMessage);
    };
    
    // Handle speech recognition end
    recognition.onend = function() {
      stopVoiceSearch();
    };
    
    return true;
  }
  return false;
}

function startVoiceSearch() {
  if (!recognition && !initVoiceSearch()) {
    // Browser doesn't support speech recognition
    showVoiceSearchFeedback('error', currentLang === 'ar' ? '    ' : 'Voice search not supported');
    return;
  }
  
  if (isListening) {
    stopVoiceSearch();
    return;
  }
  
  // Update language if changed
  recognition.lang ='ar';
  
  // Start listening
  isListening = true;
  recognition.start();
  
  // Update UI
  const voiceBtn = document.getElementById('voiceSearchBtn');
  const voiceStatus = document.getElementById('voiceSearchStatus');
  const statusText = document.getElementById('voiceSearchStatusText');
  
  voiceBtn.innerHTML = '<i class="fas fa-stop text-white text-xs"></i>';
  voiceBtn.classList.add('animate-pulse');
  voiceBtn.title = currentLang === 'ar' ? '  ' : 'Stop voice search';
  
  voiceStatus.classList.remove('hidden');
  statusText.textContent = currentLang === 'ar' ? ' ...   ' : 'Listening... Say surah name';
}

function stopVoiceSearch() {
  if (recognition) {
    recognition.stop();
  }
  
  isListening = false;
  
  // Update UI
  const voiceBtn = document.getElementById('voiceSearchBtn');
  const voiceStatus = document.getElementById('voiceSearchStatus');
  
  voiceBtn.innerHTML = '<i class="fas fa-microphone text-white text-xs"></i>';
  voiceBtn.classList.remove('animate-pulse');
  voiceBtn.title = currentLang === 'ar' ? ' ' : 'Voice Search';
  
  voiceStatus.classList.add('hidden');
}

function showVoiceSearchFeedback(type, message) {
  const statusDiv = document.getElementById('voiceSearchStatus');
  const statusText = document.getElementById('voiceSearchStatusText');
  const icon = statusDiv.querySelector('i');
  
  // Update icon and color based on type
  if (type === 'success') {
    icon.className = 'fas fa-check text-green-500 mr-1';
    statusText.className = 'text-green-600 dark:text-green-400';
  } else if (type === 'error') {
    icon.className = 'fas fa-exclamation-triangle text-red-500 mr-1';
    statusText.className = 'text-red-600 dark:text-red-400';
  }
  
  statusText.textContent = message;
  statusDiv.classList.remove('hidden');
  
  // Hide after 3 seconds
  setTimeout(() => {
    statusDiv.classList.add('hidden');
    statusText.className = 'text-gray-600 dark:text-gray-400';
    icon.className = 'fas fa-circle text-red-500 animate-pulse mr-1';
  }, 3000);
}

// Initialize voice search when page loads
document.addEventListener('DOMContentLoaded', function() {
  initVoiceSearch();
  
  // Update voice search language when app language changes
  const originalSwitchLanguage = window.switchLanguage;
  window.switchLanguage = function() {
    originalSwitchLanguage();
    if (recognition) {
      recognition.lang = currentLang === 'ar';
    }
  };
});
      </script>

<!-- Tafsir Popup Modal -->
<div id="tafsirModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20000;" class="flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
    <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-3">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="tafsirModalTitle"></h3>
        <select id="tafsirSelect" class="bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm" title="Select Tafsir -  ">
          <optgroup label="Arabic Tafsir -  ">
            <option value="1"> </option>
            <option value="2"> </option>
            <option value="3"> </option>
            <option value="4"> </option>
            <option value="5"> </option>
            <option value="6">  </option>
            <option value="7"> </option>
          </optgroup>
          <optgroup label="English Tafsir">
            <option value="en-jalalayn">Tafsir al-Jalalayn (English)</option>
            <option value="en-kathir">Tafsir Ibn Kathir (English)</option>
            <option value="en-maarif">Ma'ariful Quran (English)</option>
            <option value="en-tazkirul">Tazkirul Quran (English)</option>
          </optgroup>
        </select>
      </div>
      <button id="closeTafsirModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl">&times;</button>
    </div>
    <div class="p-4">
      <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
        <div class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2" id="tafsirModalAyah"></div>
        <div class="text-lg text-gray-600 dark:text-gray-400" id="tafsirModalTranslation">Translation</div>
      </div>
      <div class="text-base text-gray-700 dark:text-gray-300 leading-relaxed" id="tafsirModalContent"> ...</div>
    </div>
  </div>
</div>

<!-- Translation Popup Modal -->
<div id="translationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20000;" class="flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
    <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-3">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="translationModalTitle"></h3>
        <select id="translationSelect" class="bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm" title="Select Translation -  ">
          <optgroup label="English">
            <option value="en.sahih">English (Sahih Intl)</option>
            <option value="en.pickthall">English (Pickthall)</option>
            <option value="en.yusufali">English (Yusuf Ali)</option>
            <option value="en.hilali">English (Hilali-Khan)</option>
            <option value="en.arberry">English (Arberry)</option>
            <option value="en.asad">English (Muhammad Asad)</option>
            <option value="en.daryabadi">English (Daryabadi)</option>
            <option value="en.shakir">English (Shakir)</option>
          </optgroup>
          <optgroup label="European">
            <option value="fr.hamidullah">Franais (Hamidullah)</option>
            <option value="fr.leclerc">Franais (Leclerc)</option>
            <option value="de.bubenheim">Deutsch (Bubenheim)</option>
            <option value="de.khoury">Deutsch (Khoury)</option>
            <option value="es.cortes">Espaol (Corts)</option>
            <option value="es.garcia">Espaol (Garca)</option>
            <option value="it.piccardo">Italiano (Piccardo)</option>
            <option value="pt.elhayek">Portugus (El Hayek)</option>
            <option value="ru.kuliev"> ()</option>
            <option value="ru.osmanov"> ()</option>
            <option value="nl.keyzer">Nederlands (Keyzer)</option>
            <option value="bs.korkut">Bosanski (Korkut)</option>
            <option value="cs.hrbek">etina (Hrbek)</option>
            <option value="no.berg">Norsk (Berg)</option>
            <option value="sv.bernstrom">Svenska (Bernstrm)</option>
            <option value="sq.ahmeti">Shqip (Ahmeti)</option>
          </optgroup>
          <optgroup label="Middle East & Central Asia">
            <option value="tr.diyanet">Trke (Diyanet)</option>
            <option value="tr.bulac">Trke (Bula)</option>
            <option value="ur.junagarhi"> ( )</option>
            <option value="ur.kanzuliman"> ( )</option>
            <option value="fa.ansarian"> ()</option>
            <option value="fa.makarem"> ( )</option>
            <option value="az.mammadaliyev">Azrbaycan (Mmmdliyev)</option>
            <option value="ku.asan"> ()</option>
          </optgroup>
          <optgroup label="South & Southeast Asia">
            <option value="id.indonesian">Bahasa Indonesia (Kementerian Agama)</option>
            <option value="ms.basmeih">Bahasa Melayu (Basmeih)</option>
            <option value="bn.bengali"> ( )</option>
            <option value="hi.hindi"> ( )</option>
            <option value="ta.tamil"> ( )</option>
            <option value="th.thai"> ()</option>
          </optgroup>
          <optgroup label="East Asia">
            <option value="zh.jian"> ()</option>
            <option value="ja.japanese"> ()</option>
            <option value="ko.korean"> ()</option>
          </optgroup>
          <optgroup label="African">
            <option value="ha.gumi">Hausa (Abubakar Gumi)</option>
            <option value="sw.barwani">Kiswahili (Barwani)</option>
            <option value="so.abduh">Soomaali (Abduh)</option>
            <option value="am.sadiq"> ()</option>
            <option value="yo.mikail">Yorb (Mikail)</option>
          </optgroup>
        </select>
      </div>
      <button id="closeTranslationModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl">&times;</button>
    </div>
    <div class="p-4">
      <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
        <div class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2" id="translationModalAyah"></div>
      </div>
      <div class="text-base text-gray-700 dark:text-gray-300 leading-relaxed" id="translationModalContent">Translation</div>
    </div>
  </div>
</div>

<!-- Surah Selection Side Menu -->
    <div id="surahSideMenu" class="fixed inset-y-0 left-0 w-80 bg-white/95 dark:bg-gray-900/95 shadow-2xl transform -translate-x-full transition-transform duration-200 ease-in-out z-30 overflow-hidden border-r border-white/20 dark:border-gray-700/50 islamic-pattern">
  <div class="flex flex-col h-full">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-white/20 dark:border-gray-700/50 bg-gradient-to-r from-white/80 to-gray-50/80 dark:from-gray-800/80 dark:to-gray-900/80 backdrop-blur-sm">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full flex items-center justify-center shadow-lg">
          <i class="fas fa-book-open text-white text-sm"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="surahMenuTitle"> </h3>
      </div>
      <button id="closeSurahMenu" class="w-10 h-10 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white rounded-full flex items-center justify-center transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105 backdrop-blur-sm">
        <i class="fas fa-times text-sm"></i>
      </button>
    </div>
    
    <!-- Search Box -->
    <div class="p-6 border-b border-white/20 dark:border-gray-700/50 bg-gradient-to-r from-white/60 to-gray-50/60 dark:from-gray-800/60 dark:to-gray-900/60 backdrop-blur-sm">
      <div class="relative">
        <input 
          type="text" 
          id="surahSearchInput" 
          placeholder="  ... Search surah..."
          class="w-full px-4 py-3 pl-12 pr-16 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border border-white/30 dark:border-gray-600/50 rounded-xl focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500/50 dark:focus:ring-emerald-400/50 dark:focus:border-emerald-400/50 text-base text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 shadow-lg transition-all duration-200"
          style="font-size: 16px;"
        >
        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 w-6 h-6 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full flex items-center justify-center">
          <i class="fas fa-search text-white text-xs"></i>
        </div>
        <button 
          id="voiceSearchBtn" 
          class="absolute right-4 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 rounded-full flex items-center justify-center transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500/50"
          title="  - Voice Search"
          onclick="startVoiceSearch()"
        >
          <i class="fas fa-microphone text-white text-xs"></i>
        </button>
      </div>
      <!-- Voice Search Status -->
      <div id="voiceSearchStatus" class="mt-2 text-sm text-center text-gray-600 dark:text-gray-400 hidden">
        <i class="fas fa-circle text-red-500 animate-pulse mr-1"></i>
        <span id="voiceSearchStatusText"> ... Listening...</span>
      </div>
    </div>
    
    <!-- Surah List -->
    <div class="flex-1 overflow-y-auto bg-gradient-to-b from-white/50 to-gray-50/50 dark:from-gray-800/50 dark:to-gray-900/50 backdrop-blur-sm">
      <div id="surahList" class="p-4 space-y-2">
        <!-- Surah items will be populated here -->
      </div>
    </div>
  </div>
</div>

<!-- Overlay for side menu -->
<div id="surahMenuOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-20 hidden transition-all duration-300"></div>

</body>
</html>


